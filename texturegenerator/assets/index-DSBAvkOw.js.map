{"version":3,"mappings":"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","names":["WebGLContext","gl","canvas","textures","framebuffers","programs","constructor","options","this","document","createElement","getContext","antialias","preserveDrawingBuffer","premultipliedAlpha","alpha","Error","getExtension","console","warn","resize","width","height","viewport","createTextureFromImageData","imageData","texture","createTexture","bindTexture","TEXTURE_2D","texImage2D","RGBA8","RGBA","UNSIGNED_BYTE","data","texParameteri","TEXTURE_WRAP_S","REPEAT","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","push","createRenderTarget","CLAMP_TO_EDGE","createFramebuffer","fb","bindFramebuffer","FRAMEBUFFER","framebufferTexture2D","COLOR_ATTACHMENT0","status","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","readPixels","framebuffer","pixels","Uint8ClampedArray","ImageData","registerProgram","program","clearTemporaryResources","deleteTexture","deleteFramebuffer","dispose","deleteProgram","compileShader","type","source","shader","createShader","shaderSource","getShaderParameter","COMPILE_STATUS","info","getShaderInfoLog","deleteShader","createProgram","vertexSource","fragmentSource","vertexShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","attributes","Map","numAttribs","ACTIVE_ATTRIBUTES","i","getActiveAttrib","set","name","getAttribLocation","uniforms","numUniforms","ACTIVE_UNIFORMS","getActiveUniform","location","getUniformLocation","FULLSCREEN_VERTEX_SHADER","COMMON_GLSL","NORMAL_FRAGMENT_SHADER","ROUGHNESS_FRAGMENT_SHADER","METALLIC_FRAGMENT_SHADER","TraditionalPBRGenerator","ctx","vao","normalProgram","roughnessProgram","metallicProgram","basecolorProgram","createVertexArray","buffer","createBuffer","vertices","Float32Array","bindVertexArray","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","enableVertexAttribArray","vertexAttribPointer","FLOAT","createFullscreenQuad","generate","input","params","inputTexture","texelSize","basecolor","renderPass","u_texelSize","u_shadowReduction","shadowReduction","u_highlightReduction","highlightReduction","normal","u_strength","normalStrength","roughness","u_scale","roughnessScale","u_offset","roughnessOffset","metallic","u_threshold","metallicThreshold","renderTarget","useProgram","texUniform","get","uniform1i","unit","activeTexture","TEXTURE0","value","Object","entries","Array","isArray","length","uniform2fv","uniform3fv","uniform4fv","uniform1f","drawArrays","TRIANGLE_STRIP","renderFullscreenPass","result","flipImageDataY","rowSize","y","srcOffset","dstOffset","subarray","WASM_SIMD_VALIDATION_BYTES","Uint8Array","async","detectCapabilities","caps","webgpu","webgpuAdapter","webgpuFP16","webnn","wasm","WebAssembly","wasmSimd","wasmThreads","estimatedMemoryMB","webgl2","webgpuResult","wasmSimdResult","wasmThreadsResult","webgl2Result","memoryResult","Promise","allSettled","detectWebGPU","detectWasmSimd","detectWasmThreads","detectWebGL2","estimateMemory","adapter","fp16","navigator","globalThis","gpu","requestAdapter","powerPreference","features","has","validate","SharedArrayBuffer","byteLength","estimatedMB","deviceMemory","perfMemory","performance","memory","jsHeapSizeLimit","heapLimitMB","Math","min","max","round","BACKEND_PRIORITY","selectBackend","model","availableBackends","available","backend","isBackendAvailable","getAvailableBackends","selectModelVariant","models","preferredQuant","getPreferredQuantization","exactMatch","find","m","quantization","backends","includes","compatible","filter","InferenceErrorCode","InferenceError","message","code","recoverable","suggestion","super","STORE_NAME","META_STORE_NAME","CACHE_VERSION","ModelCache","db","initPromise","init","resolve","reject","request","indexedDB","open","onerror","CACHE_ERROR","onsuccess","onupgradeneeded","event","target","objectStoreNames","contains","createObjectStore","isCached","modelId","meta","getMetadata","cacheVersion","delete","transaction","objectStore","error","getExternalData","put","descriptor","metadata","cachedAt","Date","now","sizeBytes","putMetadata","putExternalData","deleteMetadata","listCached","getAllKeys","keys","getCacheSize","cachedIds","totalSize","id","clearAll","clear","oncomplete","close","cacheInstance","getModelCache","MODEL_BASE_URL","ModelLoader","manifestPromise","loadManifest","fetchManifest","getModel","getAvailableModels","loadModelData","onProgress","cache","cachedData","loadedBytes","totalBytes","progress","downloadModel","e","loadExternalData","externalDataPath","url","downloadWithProgress","getModelUrl","path","getExternalDataUrl","preloadModels","modelIds","clearCache","getCacheStats","cachedModels","totalSizeBytes","response","fetch","ok","json","version","MODEL_NOT_FOUND","contentLength","headers","body","arrayBuffer","parseInt","reader","getReader","chunks","done","read","offset","chunk","MODEL_LOAD_FAILED","loaderInstance","getModelLoader","InferenceWorkerBridge","worker","state","pendingRequests","nextRequestId","currentModel","currentBackend","getState","getCurrentModel","getCurrentBackend","initialize","doInitialize","infer","SESSION_NOT_READY","WORKER_ERROR","requestId","slice","postMessage","payload","isReady","terminate","Worker","onmessage","handleMessage","bind","handleError","loader","modelUrl","externalDataUrl","timeout","setTimeout","clearTimeout","errorMsg","handleResult","handleProgress","handleWorkerError","outputData","stage","bridgeInstance","getWorkerBridge","resizeImageData","targetWidth","targetHeight","sourceCanvas","OffscreenCanvas","putImageData","targetCtx","imageSmoothingEnabled","imageSmoothingQuality","drawImage","getImageData","cropFromSquare","originalWidth","originalHeight","offsetX","floor","offsetY","DEEPBUMP_MODEL_PREFIX","QUALITY_PRESETS","fast","resolution","useAI","upscale","expectedTime","balanced","quality","DeepBumpGenerator","capabilities","selectedBackend","selectedModel","lastError","getLastError","getBackend","isAvailable","generateNormalMap","preset","processedInput","wasNonSquare","size","save","scale","restore","translate","padToSquare","modelResolution","bridge","mappedProgress","output","squareSize","deepbumpModels","startsWith","BACKEND_NOT_SUPPORTED","String","generatorInstance","getDeepBumpGenerator","isDeepBumpAvailable","DEFAULT_UNIFIED_CONFIG","normalMethod","heightMethod","aiQualityPreset","UnifiedPBRGenerator","traditionalGen","config","aiAvailable","setConfig","getConfig","isAIAvailable","traditionalMaps","deepbump","err","integrateHeightFromNormal","generateSobelHeight","gradX","gradY","idx","nx","ny","nz","invNz","heightMap","iter","x","avgNeighbors","gradContrib","minH","Infinity","maxH","range","normalized","byteValue","gray","accumulated","MAX_DIMENSION","loadImageFile","file","match","URL","createObjectURL","img","Image","onload","src","loadImage","willReadFrequently","imageToImageData","loadImageFromUrl","revokeObjectURL","imageDataToBlob","toBlob","blob","downloadImageData","filename","a","href","download","click","downloadBlob","renderToCanvas","DEFAULT_STAGES","weight","ProgressBar","container","bar","label","detail","startTime","stages","isVisible","parentElement","className","style","cssText","innerHTML","track","appendChild","show","display","update","hide","stageProgress","overallProgress","foundStage","s","percent","stageLabel","formatStageName","percentLabel","elapsed","elapsedStr","formatTime","remaining","remainingStr","textContent","complete","background","color","reset","destroy","remove","charAt","toUpperCase","ms","seconds","toFixed","ChannelControls","onChangeCallback","initialConfig","render","onChange","callback","setAIAvailable","createInfoDisplay","createMethodSelect","createHeightSelect","createQualitySelect","method","group","labelEl","_field","aiEnabled","select","traditionalOption","selected","aiOption","disabled","addEventListener","notifyChange","opt","optEl","key","presetKey","partial","PreviewControls","createGeometrySelect","createAutoRotateToggle","createSlider","tiling","lightIntensity","ambientIntensity","geometries","geom","geometry","checkbox","checked","autoRotate","field","step","newValue","parseFloat","ThreeDverseErrorCode","ThreeDverseError","statusCode","AUTH_STORAGE_KEY","ThreeDverseAuth","userApiKey","user","stateCallbacks","Set","apiUrl","clientId","publicApiKey","restoreFromStorage","setApiKey","getUser","isAuthenticated","onStateChange","add","apiKey","userId","displayName","expiresAt","setState","persistToStorage","validateApiKey","getAuthHeaders","logout","UNAUTHORIZED","UNKNOWN","NETWORK_ERROR","loginWithApiKey","clearStorage","api_key","getApiUrl","endpoint","handleApiError","errorMessage","errorCode","FORBIDDEN","NOT_FOUND","RATE_LIMITED","localStorage","setItem","JSON","stringify","stored","getItem","parse","removeItem","authInstance","getAuth","FolderBrowser","auth","cachedFolders","listRootFolders","listFolders","forceRefresh","cacheKey","folders","map","f","uuid","folder_id","parentUuid","createdAt","created_at","updatedAt","updated_at","sort","b","localeCompare","getFolder","folderUuid","createFolder","folder","searchFolders","query","allFolders","lowerQuery","toLowerCase","browserInstance","getFolderBrowser","POLL_INTERVAL","TextureUploader","uploadPBRMaps","maps","baseName","channels","suffix","uploadJobs","channel","uploadJob","uploadTexture","jobId","UPLOAD_FAILED","job","results","pendingJobs","pollAttempts","sleep","assetId","findAssetInFolder","splice","j","join","CONVERSION_FAILED","formData","FormData","append","errorText","text","upload_task_id","getUploadStatus","assetUuid","generated_assets","asset_id","waitForConversion","attempts","notFoundCount","asset","replace","sourceResponse","sourceData","sourceFile","source_files","main_asset","uploaderInstance","getTextureUploader","MaterialCreator","createPBRMaterial","shaderRef","dataJson","buildMaterialDataJson","properties","constantsJson","buildConstantsJson","isDoubleSided","MATERIAL_CREATE_FAILED","toISOString","albedoTexture","normalTexture","roughnessTexture","metallicTexture","albedo","roughnessFactor","metallicFactor","normalScale","emissive","alphaMode","alphaCutoff","doubleSided","heightMapTexture","textureTransform","rotation","constants","MATERIAL_PARALLAX","updateMaterial","materialUuid","updates","data_json","getMaterial","shader_ref","deleteMaterial","creatorInstance","getMaterialCreator","uploadAndCreateMaterial","materialName","uploader","creator","material","LoginPanel","_config","callbacks","unsubscribeAuth","panelEl","inputEl","buttonEl","statusEl","errorEl","showRememberMe","autoValidate","subscribeToAuth","onLogin","classList","refresh","applyStyles","querySelector","handleLogin","getElementById","head","updateUI","formEl","logoutBtn","handleLogout","trim","notifyCallbacks","success","FolderPicker","selectedFolder","isLoading","pickerEl","selectEl","createBtnEl","refreshBtnEl","allowCreate","placeholder","onSelect","getSelectedFolder","loadFolders","setEnabled","enabled","handleSelect","handleCreate","browser","updateSelect","defaultFolderUuid","defaultFolder","option","prompt","newFolder","UploadStatus","channelProgressEls","overallProgressEl","messageEl","resultEl","start","setActiveChannels","updateMessage","allChannels","el","updateProgress","updateChannelProgress","updateOverallProgress","showResult","forEach","progressBar","statusText","querySelectorAll","getAttribute","total","infoEl","html","DEFAULT_SHORTCUTS","ctrl","description","shift","alt","regenerate","matchesShortcut","shortcut","ctrlKey","shiftKey","altKey","metaKey","formatShortcut","parts","isMac","platform","keyDisplay","KeyboardShortcuts","shortcuts","handlers","boundHandler","action","handleKeyDown","stop","removeEventListener","on","handler","onAll","unsubscribers","unsub","setShortcut","current","resetToDefaults","getShortcuts","getFormattedShortcut","tagName","isContentEditable","allowInInputs","findMatchingAction","preventDefault","stopPropagation","allowedActions","saveToStorage","loadFromStorage","parsed","ShortcutsHelpDialog","visible","parent","closeBtn","updateContent","toggle","list","categories","File","Export","Generation","View","category","actions","keyboardInstance","helpDialogInstance","OfflineManager","statusListeners","prefetchListeners","currentStatus","window","updateStatus","getStatus","cacheSizeBytes","modelsReady","some","isOnline","onLine","isModelCached","prefetchModels","notifyPrefetchListeners","downloadProgress","formatCacheSize","bytes","canWorkOffline","onStatusChange","onPrefetchProgress","l","offlineManagerInstance","getOfflineManager","DEFAULT_CONFIG","showCacheSize","showModelList","compact","DownloadProgress","progressMap","unsubscribe","offline","startPrefetch","from","values","every","p","showCompletion","prefetchBtn","clearBtn","handleClearCache","updateCacheStatus","formattedSize","listEl","statusClass","progressPercent","getStatusText","hasErrors","ErrorSeverity","PBRGeneratorError","severity","recoveryAction","details","timestamp","toUserMessage","UNKNOWN_ERROR","TIMEOUT_ERROR","WEBGPU_NOT_SUPPORTED","WEBGL2_NOT_SUPPORTED","GPU_CONTEXT_LOST","SHADER_COMPILATION_ERROR","MODEL_CORRUPT","INFERENCE_OOM","INFERENCE_FAILED","IMAGE_LOAD_FAILED","IMAGE_TOO_LARGE","IMAGE_INVALID_FORMAT","GENERATION_FAILED","AUTH_FAILED","AUTH_EXPIRED","AUTH_INVALID_KEY","UPLOAD_QUOTA_EXCEEDED","FOLDER_NOT_FOUND","API_ERROR","INDEXEDDB_ERROR","QUOTA_EXCEEDED","ErrorHandler","errorLog","maxLogSize","listeners","handle","pbrError","normalize","log","notify","classifyError","originalError","msg","stack","listener","onError","getErrorLog","clearLog","handlerInstance","getErrorHandler","position","autoDismissMs","maxVisible","ErrorBoundary","errors","nextId","showError","oldest","dismissError","element","createErrorElement","requestAnimationFrame","entry","FATAL","dismissTimeout","dismiss","index","findIndex","dataset","errorId","icon","getSeverityIcon","actionButton","createActionButton","dismissBtn","recoveryBtn","executeRecovery","INFO","WARNING","ERROR","_id","retry","none","reload","clearCacheAndRetry","dispatchEvent","CustomEvent","__vitePreload","then","modelCache","boundaryInstance","BatchProcessor","items","processing","addFiles","files","updateItemList","updateStats","updateButtons","startProcessing","item","updateItem","onProcess","totalItems","completed","failed","onComplete","exportAll","onExport","isProcessing","getStats","pending","dropZone","fileInput","dataTransfer","startBtn","exportBtn","truncateFilename","formatSize","getStatusIndicator","btn","closest","stats","totalEl","pendingEl","completeEl","hasPending","hasComplete","maxLen","ext","split","pop","DEFAULT_PREVIEW_CONFIG","rotationSpeed","lightDirection","lightColor","ambientColor","PBRPreview","geometryType","basecolorTexture","animationId","lastFrameTime","cameraDistance","cameraRotationX","cameraRotationY","isDragging","lastMouseX","lastMouseY","initializeShaders","initializeGeometry","setupInteraction","startRenderLoop","vertShader","fragShader","modelMatrix","viewMatrix","projectionMatrix","normalMatrix","cameraPosition","basecolorMap","normalMap","roughnessMap","metallicMap","useBasecolorMap","useNormalMap","useRoughnessMap","useMetallicMap","baseColor","textureTiling","textureOffset","setGeometry","createVAO","posBuffer","positions","normBuffer","normals","texBuffer","texcoords","tanBuffer","tangents","indexBuffer","ELEMENT_ARRAY_BUFFER","indices","clientX","clientY","dx","dy","PI","deltaY","radius","segments","rings","v","theta","sinTheta","sin","cosTheta","cos","u","phi","sinPhi","cosPhi","px","py","pz","tx","ty","tz","c","d","Uint16Array","vertexCount","indexCount","createSphere","createCube","subdivisionsX","subdivisionsY","halfWidth","halfHeight","createPlane","deleteVertexArray","setMaps","LINEAR_MIPMAP_LINEAR","generateMipmap","time","dt","clientWidth","clientHeight","clearColor","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","enable","DEPTH_TEST","CULL_FACE","aspect","projMatrix","perspectiveMatrix","camX","camY","camZ","lookAtMatrix","rotationMatrix","normalMatrixFromModel","uniformMatrix4fv","uniformMatrix3fv","uniform3f","drawElements","TRIANGLES","UNSIGNED_SHORT","samplerLocation","useLocation","fov","near","far","tan","nf","eye","up","zAxis","xAxis","cross","yAxis","dot","angle","axis","z","t","len","sqrt","cancelAnimationFrame","PerformanceProfiler","metrics","activeTimers","maxHistoryPerMetric","end","endTime","duration","record","fn","timeAsync","history","durations","sum","reduce","count","totalMs","minMs","maxMs","avgMs","lastMs","getMetricNames","getAllStats","logSummary","groupEnd","exportedAt","profilerInstance","capabilitiesEl","controls","previewGrid","preview3DSection","previewCanvas","previewControlsContainer","inputCanvas","basecolorCanvas","normalCanvas","roughnessCanvas","metallicCanvas","heightCanvas","heightPreviewItem","shadowReductionInput","highlightReductionInput","normalStrengthInput","roughnessScaleInput","roughnessOffsetInput","metallicThresholdInput","shadowReductionValue","highlightReductionValue","normalStrengthValue","roughnessScaleValue","roughnessOffsetValue","metallicThresholdValue","exportInput","exportBasecolor","exportNormal","exportRoughness","exportMetallic","exportHeight","traditionalGenerator","unifiedGenerator","currentInput","currentMaps","currentAINormal","currentFilename","useAINormal","currentQualityPreset","unifiedConfig","channelControls","previewControls","pbrPreview","loginPanel","folderPicker","uploadStatus","updateUploadButtonState","uploadBtn","materialNameInput","hasAuth","hasFolder","hasMaps","hasName","handleUploadTo3dverse","setStatus","createSubfolderCheckbox","targetFolderUuid","folderBrowser","mapsToUpload","activeChannels","initTraditionalGenerator","processImageTraditional","updateNormalDisplay","update3DPreview","processImageUnified","usingAI","_channel","statusMsg","previewMaps","generateAINormalMap","handleFile","channelControlsEl","updateValueDisplay","clipboardData","getAsFile","loadImageFromClipboard","normalToExport","errorHandler","profiler","offlineManager","keyboardShortcuts","shortcutsHelp","batchProcessor","regenerateMaps","cycleQuality","direction","presetKeys","currentIndex","k","newIndex","perfInfo","getPerformanceInfo","wasmFeatures","aiStatus","backendName","getBackendDisplayName","displayCapabilities","progressContainer","marginBottom","parentNode","insertBefore","setupAIControls","createChannelControlsContainer","setupChannelControls","setup3DPreview","threeDverseSection","nextSibling","applyThreeDverseSectionStyles","loginContainer","folderContainer","statusContainer","setup3dverseIntegration","initCapabilities","exportAllMaps","setupDownloadProgress","batchBtn","addBatchModeButton","setupBatchProcessor","newStatus","checkOfflineStatus","reason"],"ignoreList":[],"sources":["../../src/webgl/context.ts","../../src/webgl/shader.ts","../../src/generators/shaders/common.glsl.ts","../../src/generators/shaders/normal.frag.ts","../../src/generators/shaders/roughness.frag.ts","../../src/generators/shaders/metallic.frag.ts","../../src/generators/traditional/index.ts","../../src/generators/shaders/basecolor.frag.ts","../../src/inference/backend-detector.ts","../../src/inference/backend-selector.ts","../../src/types/inference.ts","../../src/inference/model-cache.ts","../../src/inference/model-loader.ts","../../src/inference/worker/worker-bridge.ts","../../src/generators/ai/preprocessor.ts","../../src/generators/ai/deepbump.ts","../../src/generators/unified.ts","../../src/generators/index.ts","../../src/utils/image-loader.ts","../../src/utils/export.ts","../../src/ui/progress-bar.ts","../../src/ui/channel-controls.ts","../../src/ui/preview-controls.ts","../../src/types/threedverse.ts","../../src/threedverse/auth.ts","../../src/threedverse/folder-browser.ts","../../src/threedverse/texture-uploader.ts","../../src/threedverse/material-creator.ts","../../src/threedverse/index.ts","../../src/ui/login-panel.ts","../../src/ui/folder-picker.ts","../../src/ui/upload-status.ts","../../src/ui/keyboard-shortcuts.ts","../../src/utils/offline.ts","../../src/ui/download-progress.ts","../../src/utils/error-handler.ts","../../src/ui/error-boundary.ts","../../src/ui/batch-processor.ts","../../src/preview/pbr-preview.ts","../../src/preview/shaders/pbr.vert.ts","../../src/preview/shaders/pbr.frag.ts","../../src/preview/geometry.ts","../../src/utils/performance.ts","../../src/main.ts"],"sourcesContent":["/**\n * WebGL2 context management for PBR texture generation.\n * Handles context creation, extension loading, and resource cleanup.\n */\n\nexport interface WebGLContextOptions {\n  antialias?: boolean;\n  preserveDrawingBuffer?: boolean;\n}\n\nexport class WebGLContext {\n  public readonly gl: WebGL2RenderingContext;\n  public readonly canvas: HTMLCanvasElement;\n\n  private textures: WebGLTexture[] = [];\n  private framebuffers: WebGLFramebuffer[] = [];\n  private programs: WebGLProgram[] = [];\n\n  constructor(options: WebGLContextOptions = {}) {\n    this.canvas = document.createElement('canvas');\n    const gl = this.canvas.getContext('webgl2', {\n      antialias: options.antialias ?? false,\n      preserveDrawingBuffer: options.preserveDrawingBuffer ?? true,\n      premultipliedAlpha: false,\n      alpha: true,\n    });\n\n    if (!gl) {\n      throw new Error('WebGL2 not supported');\n    }\n\n    this.gl = gl;\n\n    // Enable required extensions\n    const floatExt = gl.getExtension('EXT_color_buffer_float');\n    if (!floatExt) {\n      console.warn('EXT_color_buffer_float not available, some features may be limited');\n    }\n  }\n\n  /**\n   * Resize the canvas to match dimensions\n   */\n  resize(width: number, height: number): void {\n    this.canvas.width = width;\n    this.canvas.height = height;\n    this.gl.viewport(0, 0, width, height);\n  }\n\n  /**\n   * Create a texture from ImageData\n   */\n  createTextureFromImageData(imageData: ImageData): WebGLTexture {\n    const gl = this.gl;\n    const texture = gl.createTexture();\n    if (!texture) throw new Error('Failed to create texture');\n\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(\n      gl.TEXTURE_2D,\n      0,\n      gl.RGBA8,\n      imageData.width,\n      imageData.height,\n      0,\n      gl.RGBA,\n      gl.UNSIGNED_BYTE,\n      imageData.data\n    );\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\n    this.textures.push(texture);\n    return texture;\n  }\n\n  /**\n   * Create an empty render target texture\n   */\n  createRenderTarget(width: number, height: number): WebGLTexture {\n    const gl = this.gl;\n    const texture = gl.createTexture();\n    if (!texture) throw new Error('Failed to create render target');\n\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(\n      gl.TEXTURE_2D,\n      0,\n      gl.RGBA8,\n      width,\n      height,\n      0,\n      gl.RGBA,\n      gl.UNSIGNED_BYTE,\n      null\n    );\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\n    this.textures.push(texture);\n    return texture;\n  }\n\n  /**\n   * Create a framebuffer with texture attachment\n   */\n  createFramebuffer(texture: WebGLTexture): WebGLFramebuffer {\n    const gl = this.gl;\n    const fb = gl.createFramebuffer();\n    if (!fb) throw new Error('Failed to create framebuffer');\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n\n    const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    if (status !== gl.FRAMEBUFFER_COMPLETE) {\n      throw new Error(`Framebuffer incomplete: ${status}`);\n    }\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    this.framebuffers.push(fb);\n    return fb;\n  }\n\n  /**\n   * Read pixels from a framebuffer\n   */\n  readPixels(framebuffer: WebGLFramebuffer, width: number, height: number): ImageData {\n    const gl = this.gl;\n    gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);\n\n    const pixels = new Uint8ClampedArray(width * height * 4);\n    gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    return new ImageData(pixels, width, height);\n  }\n\n  /**\n   * Register a program for cleanup\n   */\n  registerProgram(program: WebGLProgram): void {\n    this.programs.push(program);\n  }\n\n  /**\n   * Clean up textures and framebuffers (keep programs)\n   * Call this between generate() calls to prevent memory leaks\n   */\n  clearTemporaryResources(): void {\n    const gl = this.gl;\n\n    for (const texture of this.textures) {\n      gl.deleteTexture(texture);\n    }\n    for (const fb of this.framebuffers) {\n      gl.deleteFramebuffer(fb);\n    }\n\n    this.textures = [];\n    this.framebuffers = [];\n  }\n\n  /**\n   * Clean up all resources\n   */\n  dispose(): void {\n    const gl = this.gl;\n\n    for (const texture of this.textures) {\n      gl.deleteTexture(texture);\n    }\n    for (const fb of this.framebuffers) {\n      gl.deleteFramebuffer(fb);\n    }\n    for (const program of this.programs) {\n      gl.deleteProgram(program);\n    }\n\n    this.textures = [];\n    this.framebuffers = [];\n    this.programs = [];\n  }\n}\n","/**\n * WebGL2 shader compilation and program management.\n */\n\nexport interface ShaderProgram {\n  program: WebGLProgram;\n  attributes: Map<string, number>;\n  uniforms: Map<string, WebGLUniformLocation>;\n}\n\n/**\n * Compile a shader from source\n */\nfunction compileShader(gl: WebGL2RenderingContext, type: number, source: string): WebGLShader {\n  const shader = gl.createShader(type);\n  if (!shader) throw new Error('Failed to create shader');\n\n  gl.shaderSource(shader, source);\n  gl.compileShader(shader);\n\n  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n    const info = gl.getShaderInfoLog(shader);\n    gl.deleteShader(shader);\n    throw new Error(`Shader compilation failed: ${info}`);\n  }\n\n  return shader;\n}\n\n/**\n * Create a shader program from vertex and fragment sources\n */\nexport function createProgram(\n  gl: WebGL2RenderingContext,\n  vertexSource: string,\n  fragmentSource: string\n): ShaderProgram {\n  const vertexShader = compileShader(gl, gl.VERTEX_SHADER, vertexSource);\n  const fragmentShader = compileShader(gl, gl.FRAGMENT_SHADER, fragmentSource);\n\n  const program = gl.createProgram();\n  if (!program) throw new Error('Failed to create program');\n\n  gl.attachShader(program, vertexShader);\n  gl.attachShader(program, fragmentShader);\n  gl.linkProgram(program);\n\n  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n    const info = gl.getProgramInfoLog(program);\n    gl.deleteProgram(program);\n    gl.deleteShader(vertexShader);\n    gl.deleteShader(fragmentShader);\n    throw new Error(`Program linking failed: ${info}`);\n  }\n\n  // Cleanup shaders (attached to program, no longer needed)\n  gl.deleteShader(vertexShader);\n  gl.deleteShader(fragmentShader);\n\n  // Extract attributes\n  const attributes = new Map<string, number>();\n  const numAttribs = gl.getProgramParameter(program, gl.ACTIVE_ATTRIBUTES);\n  for (let i = 0; i < numAttribs; i++) {\n    const info = gl.getActiveAttrib(program, i);\n    if (info) {\n      attributes.set(info.name, gl.getAttribLocation(program, info.name));\n    }\n  }\n\n  // Extract uniforms\n  const uniforms = new Map<string, WebGLUniformLocation>();\n  const numUniforms = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);\n  for (let i = 0; i < numUniforms; i++) {\n    const info = gl.getActiveUniform(program, i);\n    if (info) {\n      const location = gl.getUniformLocation(program, info.name);\n      if (location) {\n        uniforms.set(info.name, location);\n      }\n    }\n  }\n\n  return { program, attributes, uniforms };\n}\n\n/**\n * Standard fullscreen quad vertex shader\n */\nexport const FULLSCREEN_VERTEX_SHADER = `#version 300 es\nprecision highp float;\n\nin vec2 a_position;\nout vec2 v_uv;\n\nvoid main() {\n  v_uv = a_position * 0.5 + 0.5;\n  gl_Position = vec4(a_position, 0.0, 1.0);\n}\n`;\n\n/**\n * Create a fullscreen quad VAO\n */\nexport function createFullscreenQuad(gl: WebGL2RenderingContext): WebGLVertexArrayObject {\n  const vao = gl.createVertexArray();\n  if (!vao) throw new Error('Failed to create VAO');\n\n  const buffer = gl.createBuffer();\n  if (!buffer) throw new Error('Failed to create buffer');\n\n  const vertices = new Float32Array([\n    -1, -1,\n     1, -1,\n    -1,  1,\n     1,  1,\n  ]);\n\n  gl.bindVertexArray(vao);\n  gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n  gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);\n  gl.enableVertexAttribArray(0);\n  gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);\n  gl.bindVertexArray(null);\n\n  return vao;\n}\n\n/**\n * Render a fullscreen pass\n */\nexport function renderFullscreenPass(\n  gl: WebGL2RenderingContext,\n  program: ShaderProgram,\n  vao: WebGLVertexArrayObject,\n  uniforms: Record<string, number | number[]>,\n  textures: { unit: number; texture: WebGLTexture }[],\n  framebuffer: WebGLFramebuffer | null\n): void {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);\n  gl.useProgram(program.program);\n  gl.bindVertexArray(vao);\n\n  // Bind textures\n  for (const { unit, texture } of textures) {\n    gl.activeTexture(gl.TEXTURE0 + unit);\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n  }\n\n  // Set uniforms\n  for (const [name, value] of Object.entries(uniforms)) {\n    const location = program.uniforms.get(name);\n    if (location) {\n      if (Array.isArray(value)) {\n        if (value.length === 2) {\n          gl.uniform2fv(location, value);\n        } else if (value.length === 3) {\n          gl.uniform3fv(location, value);\n        } else if (value.length === 4) {\n          gl.uniform4fv(location, value);\n        }\n      } else {\n        gl.uniform1f(location, value);\n      }\n    }\n  }\n\n  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\n  gl.bindVertexArray(null);\n}\n","/**\n * Common GLSL functions shared across PBR shaders.\n * Exported as TypeScript strings for bundling with Vite.\n */\n\nexport const COMMON_GLSL = `\n// Luminance calculation using Rec. 709 coefficients\nfloat luminance(vec3 color) {\n  return dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\n\n// Saturation: difference between max and min channel\nfloat saturation(vec3 color) {\n  float maxC = max(max(color.r, color.g), color.b);\n  float minC = min(min(color.r, color.g), color.b);\n  return maxC - minC;\n}\n\n// Convert RGB to HSL\nvec3 rgb2hsl(vec3 color) {\n  float maxC = max(max(color.r, color.g), color.b);\n  float minC = min(min(color.r, color.g), color.b);\n  float l = (maxC + minC) * 0.5;\n\n  if (maxC == minC) {\n    return vec3(0.0, 0.0, l);\n  }\n\n  float d = maxC - minC;\n  float s = l > 0.5 ? d / (2.0 - maxC - minC) : d / (maxC + minC);\n\n  float h;\n  if (maxC == color.r) {\n    h = (color.g - color.b) / d + (color.g < color.b ? 6.0 : 0.0);\n  } else if (maxC == color.g) {\n    h = (color.b - color.r) / d + 2.0;\n  } else {\n    h = (color.r - color.g) / d + 4.0;\n  }\n  h /= 6.0;\n\n  return vec3(h, s, l);\n}\n`;\n","/**\n * Normal map generation shader using Sobel operator.\n * Converts height information derived from luminance into tangent-space normals.\n */\n\nimport { COMMON_GLSL } from './common.glsl.ts';\n\nexport const NORMAL_FRAGMENT_SHADER = `#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_strength;\nuniform vec2 u_texelSize;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${COMMON_GLSL}\n\nvoid main() {\n  // Sample 3x3 neighborhood using luminance as height\n  float tl = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, -u_texelSize.y)).rgb);\n  float t  = luminance(texture(u_texture, v_uv + vec2(0.0, -u_texelSize.y)).rgb);\n  float tr = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, -u_texelSize.y)).rgb);\n  float l  = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, 0.0)).rgb);\n  float r  = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, 0.0)).rgb);\n  float bl = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, u_texelSize.y)).rgb);\n  float b  = luminance(texture(u_texture, v_uv + vec2(0.0, u_texelSize.y)).rgb);\n  float br = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, u_texelSize.y)).rgb);\n\n  // Sobel operator\n  float dX = (tr + 2.0 * r + br) - (tl + 2.0 * l + bl);\n  float dY = (bl + 2.0 * b + br) - (tl + 2.0 * t + tr);\n\n  // Construct and normalize the normal vector\n  vec3 normal = normalize(vec3(dX * u_strength, dY * u_strength, 1.0));\n\n  // Pack from [-1,1] to [0,1] for storage\n  normal = normal * 0.5 + 0.5;\n\n  fragColor = vec4(normal, 1.0);\n}\n`;\n","/**\n * Roughness map generation shader.\n * Uses local variance analysis to estimate surface roughness.\n * High variance = rough surface, low variance = smooth surface.\n */\n\nimport { COMMON_GLSL } from './common.glsl.ts';\n\nexport const ROUGHNESS_FRAGMENT_SHADER = `#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_scale;\nuniform float u_offset;\nuniform vec2 u_texelSize;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${COMMON_GLSL}\n\nvoid main() {\n  // Sample 3x3 neighborhood\n  float samples[9];\n  int idx = 0;\n  for (int y = -1; y <= 1; y++) {\n    for (int x = -1; x <= 1; x++) {\n      vec2 offset = vec2(float(x), float(y)) * u_texelSize;\n      samples[idx] = luminance(texture(u_texture, v_uv + offset).rgb);\n      idx++;\n    }\n  }\n\n  // Calculate mean\n  float mean = 0.0;\n  for (int i = 0; i < 9; i++) {\n    mean += samples[i];\n  }\n  mean /= 9.0;\n\n  // Calculate variance\n  float variance = 0.0;\n  for (int i = 0; i < 9; i++) {\n    float diff = samples[i] - mean;\n    variance += diff * diff;\n  }\n  variance /= 9.0;\n\n  // Map variance to roughness\n  // High variance = high local detail = rough surface\n  // Low variance = flat area = could be smooth or rough depending on luminance\n  float roughness = sqrt(variance) * 4.0; // Scale variance to useful range\n\n  // Dark areas tend to be rougher (absorption)\n  // Light areas with low variance tend to be smooth (reflection)\n  float lumFactor = 1.0 - mean * 0.3;\n\n  roughness = roughness * lumFactor;\n\n  // Apply user controls\n  roughness = roughness * u_scale + u_offset;\n  roughness = clamp(roughness, 0.0, 1.0);\n\n  // Invert so that smooth areas are dark, rough areas are bright\n  // This matches common PBR conventions where white = rough\n  roughness = 0.5 + roughness * 0.5;\n\n  fragColor = vec4(vec3(roughness), 1.0);\n}\n`;\n","/**\n * Metallic map generation shader.\n * Uses saturation and luminance heuristics to estimate metallicity.\n *\n * Heuristics:\n * - Metals tend to have colored reflections (moderate saturation)\n * - Metals tend to be bright (high luminance)\n * - Dielectrics tend to have neutral highlights (low saturation in bright areas)\n * - Pure metals have very specific color ranges (gold, copper, etc.)\n */\n\nimport { COMMON_GLSL } from './common.glsl.ts';\n\nexport const METALLIC_FRAGMENT_SHADER = `#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${COMMON_GLSL}\n\n// Check if color is in metallic range (gold, copper, silver, etc.)\nfloat metallicColorScore(vec3 color) {\n  vec3 hsl = rgb2hsl(color);\n  float h = hsl.x;\n  float s = hsl.y;\n  float l = hsl.z;\n\n  float score = 0.0;\n\n  // Gold range: hue 30-60 degrees (0.08-0.17 normalized)\n  if (h > 0.08 && h < 0.17 && s > 0.3 && l > 0.4) {\n    score = max(score, 0.7);\n  }\n\n  // Copper range: hue 10-30 degrees (0.03-0.08 normalized)\n  if (h > 0.03 && h < 0.08 && s > 0.4 && l > 0.3) {\n    score = max(score, 0.6);\n  }\n\n  // Silver/chrome: very low saturation, high luminance\n  if (s < 0.15 && l > 0.6) {\n    score = max(score, 0.5);\n  }\n\n  return score;\n}\n\nvoid main() {\n  vec3 color = texture(u_texture, v_uv).rgb;\n  float lum = luminance(color);\n  float sat = saturation(color);\n\n  // Base metallic estimation\n  // High luminance + moderate saturation suggests metal\n  // Low saturation + high luminance could be chrome/silver\n  float metallic = 0.0;\n\n  // Check for metallic color ranges\n  metallic = metallicColorScore(color);\n\n  // Boost for high luminance areas with some color\n  if (lum > 0.5 && sat > 0.1 && sat < 0.6) {\n    metallic = max(metallic, lum * 0.4);\n  }\n\n  // Very bright, low saturation = potential chrome/silver\n  if (lum > 0.7 && sat < 0.2) {\n    metallic = max(metallic, 0.3);\n  }\n\n  // Apply threshold - creates more binary output\n  // Values below threshold become 0, above become scaled\n  metallic = smoothstep(u_threshold - 0.2, u_threshold + 0.2, metallic);\n\n  fragColor = vec4(vec3(metallic), 1.0);\n}\n`;\n","/**\n * Traditional algorithm-based PBR generator using WebGL2 shaders.\n * Implements Sobel-based normal generation, variance-based roughness,\n * and saturation-based metallic estimation.\n */\n\nimport { WebGLContext } from '../../webgl/context.ts';\nimport {\n  createProgram,\n  createFullscreenQuad,\n  renderFullscreenPass,\n  FULLSCREEN_VERTEX_SHADER,\n  ShaderProgram,\n} from '../../webgl/shader.ts';\nimport { NORMAL_FRAGMENT_SHADER } from '../shaders/normal.frag.ts';\nimport { ROUGHNESS_FRAGMENT_SHADER } from '../shaders/roughness.frag.ts';\nimport { METALLIC_FRAGMENT_SHADER } from '../shaders/metallic.frag.ts';\nimport { BASECOLOR_FRAGMENT_SHADER } from '../shaders/basecolor.frag.ts';\nimport type { PBRGenerator, PBRMaps, PBRGeneratorParams } from '../index.ts';\n\nexport class TraditionalPBRGenerator implements PBRGenerator {\n  private ctx: WebGLContext;\n  private vao: WebGLVertexArrayObject;\n  private normalProgram: ShaderProgram;\n  private roughnessProgram: ShaderProgram;\n  private metallicProgram: ShaderProgram;\n  private basecolorProgram: ShaderProgram;\n\n  constructor() {\n    this.ctx = new WebGLContext();\n\n    const gl = this.ctx.gl;\n    this.vao = createFullscreenQuad(gl);\n\n    // Compile all shader programs\n    this.normalProgram = createProgram(gl, FULLSCREEN_VERTEX_SHADER, NORMAL_FRAGMENT_SHADER);\n    this.roughnessProgram = createProgram(gl, FULLSCREEN_VERTEX_SHADER, ROUGHNESS_FRAGMENT_SHADER);\n    this.metallicProgram = createProgram(gl, FULLSCREEN_VERTEX_SHADER, METALLIC_FRAGMENT_SHADER);\n    this.basecolorProgram = createProgram(gl, FULLSCREEN_VERTEX_SHADER, BASECOLOR_FRAGMENT_SHADER);\n\n    // Register programs for cleanup\n    this.ctx.registerProgram(this.normalProgram.program);\n    this.ctx.registerProgram(this.roughnessProgram.program);\n    this.ctx.registerProgram(this.metallicProgram.program);\n    this.ctx.registerProgram(this.basecolorProgram.program);\n  }\n\n  generate(input: ImageData, params: PBRGeneratorParams): PBRMaps {\n    const { width, height } = input;\n\n    // Clear previous textures and framebuffers to prevent memory leaks\n    this.ctx.clearTemporaryResources();\n\n    // Resize context to match input\n    this.ctx.resize(width, height);\n\n    // Create input texture\n    const inputTexture = this.ctx.createTextureFromImageData(input);\n\n    // Texel size for shader calculations\n    const texelSize = [1.0 / width, 1.0 / height];\n\n    // Generate each map\n    // Note: u_texture sampler is set separately in renderPass with uniform1i\n    const basecolor = this.renderPass(\n      this.basecolorProgram,\n      inputTexture,\n      {\n        u_texelSize: texelSize,\n        u_shadowReduction: params.shadowReduction,\n        u_highlightReduction: params.highlightReduction,\n      },\n      width,\n      height\n    );\n\n    const normal = this.renderPass(\n      this.normalProgram,\n      inputTexture,\n      {\n        u_strength: params.normalStrength,\n        u_texelSize: texelSize,\n      },\n      width,\n      height\n    );\n\n    const roughness = this.renderPass(\n      this.roughnessProgram,\n      inputTexture,\n      {\n        u_scale: params.roughnessScale,\n        u_offset: params.roughnessOffset,\n        u_texelSize: texelSize,\n      },\n      width,\n      height\n    );\n\n    const metallic = this.renderPass(\n      this.metallicProgram,\n      inputTexture,\n      {\n        u_threshold: params.metallicThreshold,\n      },\n      width,\n      height\n    );\n\n    return { basecolor, normal, roughness, metallic };\n  }\n\n  private renderPass(\n    program: ShaderProgram,\n    inputTexture: WebGLTexture,\n    uniforms: Record<string, number | number[]>,\n    width: number,\n    height: number\n  ): ImageData {\n    const gl = this.ctx.gl;\n\n    // Create render target\n    const renderTarget = this.ctx.createRenderTarget(width, height);\n    const framebuffer = this.ctx.createFramebuffer(renderTarget);\n\n    // Set texture unit uniform\n    gl.useProgram(program.program);\n    const texUniform = program.uniforms.get('u_texture');\n    if (texUniform) {\n      gl.uniform1i(texUniform, 0);\n    }\n\n    // Render\n    renderFullscreenPass(\n      gl,\n      program,\n      this.vao,\n      uniforms,\n      [{ unit: 0, texture: inputTexture }],\n      framebuffer\n    );\n\n    // Read back pixels\n    const result = this.ctx.readPixels(framebuffer, width, height);\n\n    // Flip Y coordinate (WebGL renders upside down)\n    return this.flipImageDataY(result);\n  }\n\n  private flipImageDataY(imageData: ImageData): ImageData {\n    const { data, width, height } = imageData;\n    const result = new Uint8ClampedArray(data.length);\n    const rowSize = width * 4;\n\n    for (let y = 0; y < height; y++) {\n      const srcOffset = y * rowSize;\n      const dstOffset = (height - 1 - y) * rowSize;\n      result.set(data.subarray(srcOffset, srcOffset + rowSize), dstOffset);\n    }\n\n    return new ImageData(result, width, height);\n  }\n\n  dispose(): void {\n    this.ctx.dispose();\n  }\n}\n","/**\n * Albedo extraction shader.\n * Removes shadows and highlights to extract base color.\n * Uses local normalization and shadow reduction techniques.\n */\n\nexport const BASECOLOR_FRAGMENT_SHADER = `#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform vec2 u_texelSize;\nuniform float u_shadowReduction;   // 0.0 = none, 1.0 = full\nuniform float u_highlightReduction; // 0.0 = none, 1.0 = full\n\nin vec2 v_uv;\nout vec4 fragColor;\n\nvoid main() {\n  vec3 color = texture(u_texture, v_uv).rgb;\n  float lum = dot(color, vec3(0.299, 0.587, 0.114));\n\n  // Target: mid-gray (0.5)\n  vec3 midGray = vec3(0.5);\n\n  // Shadow reduction: blend dark pixels toward mid-gray\n  float shadowBlend = 0.0;\n  if (lum < 0.5) {\n    float darkness = 1.0 - lum * 2.0; // 1.0 at black, 0.0 at mid-gray\n    shadowBlend = darkness * u_shadowReduction;\n  }\n\n  // Highlight reduction: blend bright pixels toward mid-gray\n  float highlightBlend = 0.0;\n  if (lum > 0.5) {\n    float brightness = (lum - 0.5) * 2.0; // 0.0 at mid-gray, 1.0 at white\n    highlightBlend = brightness * u_highlightReduction;\n  }\n\n  // Simple additive adjustment (no division)\n  vec3 result = color;\n  result += (midGray - color) * shadowBlend;\n  result += (midGray - result) * highlightBlend;\n\n  fragColor = vec4(clamp(result, 0.0, 1.0), 1.0);\n}\n`;\n","/**\n * Backend capability detection for AI inference.\n * Detects WebGPU, WebNN, WASM capabilities and estimates available memory.\n */\n\nimport type { BackendCapabilities } from '../types/inference.ts';\n\n/**\n * SIMD detection WASM bytecode.\n * Validates a minimal WASM module using v128 SIMD instructions.\n */\nconst WASM_SIMD_VALIDATION_BYTES = new Uint8Array([\n  0, 97, 115, 109,    // \\0asm magic\n  1, 0, 0, 0,         // version 1\n  1, 5, 1, 96, 0, 1, 123,  // type section: func () -> v128\n  3, 2, 1, 0,         // function section\n  10, 10, 1, 8, 0,    // code section\n  65, 0,              // i32.const 0\n  253, 15,            // v128.load_splat\n  253, 98,            // i8x16.splat\n  11                  // end\n]);\n\n/**\n * Detect all browser capabilities for AI inference.\n */\nexport async function detectCapabilities(): Promise<BackendCapabilities> {\n  const caps: BackendCapabilities = {\n    webgpu: false,\n    webgpuAdapter: null,\n    webgpuFP16: false,\n    webnn: false,\n    wasm: typeof WebAssembly !== 'undefined',\n    wasmSimd: false,\n    wasmThreads: false,\n    estimatedMemoryMB: 2048, // Conservative default\n    webgl2: false,\n  };\n\n  // Run all detection in parallel where possible\n  const [webgpuResult, wasmSimdResult, wasmThreadsResult, webgl2Result, memoryResult] = await Promise.allSettled([\n    detectWebGPU(),\n    detectWasmSimd(),\n    detectWasmThreads(),\n    detectWebGL2(),\n    estimateMemory(),\n  ]);\n\n  // Apply WebGPU results\n  if (webgpuResult.status === 'fulfilled' && webgpuResult.value) {\n    caps.webgpu = true;\n    caps.webgpuAdapter = webgpuResult.value.adapter;\n    caps.webgpuFP16 = webgpuResult.value.fp16;\n  }\n\n  // Apply WASM SIMD result\n  if (wasmSimdResult.status === 'fulfilled') {\n    caps.wasmSimd = wasmSimdResult.value;\n  }\n\n  // Apply WASM threads result\n  if (wasmThreadsResult.status === 'fulfilled') {\n    caps.wasmThreads = wasmThreadsResult.value;\n  }\n\n  // Apply WebGL2 result\n  if (webgl2Result.status === 'fulfilled') {\n    caps.webgl2 = webgl2Result.value;\n  }\n\n  // Apply memory estimation\n  if (memoryResult.status === 'fulfilled') {\n    caps.estimatedMemoryMB = memoryResult.value;\n  }\n\n  // WebNN detection (synchronous check)\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  caps.webnn = 'ml' in navigator || 'MLContext' in (globalThis as any);\n\n  return caps;\n}\n\n/**\n * Detect WebGPU availability and features.\n */\nasync function detectWebGPU(): Promise<{ adapter: GPUAdapter; fp16: boolean } | null> {\n  if (!('gpu' in navigator)) {\n    return null;\n  }\n\n  try {\n    const adapter = await navigator.gpu.requestAdapter({\n      powerPreference: 'high-performance',\n    });\n\n    if (!adapter) {\n      return null;\n    }\n\n    // Check for FP16 shader support\n    const fp16 = adapter.features.has('shader-f16');\n\n    return { adapter, fp16 };\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Detect WASM SIMD support.\n */\nasync function detectWasmSimd(): Promise<boolean> {\n  try {\n    return WebAssembly.validate(WASM_SIMD_VALIDATION_BYTES);\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Detect WASM threads support (SharedArrayBuffer).\n */\nasync function detectWasmThreads(): Promise<boolean> {\n  try {\n    // SharedArrayBuffer requires cross-origin isolation\n    if (typeof SharedArrayBuffer === 'undefined') {\n      return false;\n    }\n\n    // Test actual SharedArrayBuffer creation\n    const sab = new SharedArrayBuffer(1);\n    return sab.byteLength === 1;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Detect WebGL2 support.\n */\nasync function detectWebGL2(): Promise<boolean> {\n  try {\n    const canvas = document.createElement('canvas');\n    const gl = canvas.getContext('webgl2');\n    return gl !== null;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Estimate available memory for inference.\n * Uses multiple heuristics since precise memory info is limited in browsers.\n */\nasync function estimateMemory(): Promise<number> {\n  let estimatedMB = 2048; // Default conservative estimate\n\n  // Try navigator.deviceMemory (approximate total device RAM in GB)\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const deviceMemory = (navigator as any).deviceMemory;\n  if (typeof deviceMemory === 'number' && deviceMemory > 0) {\n    // Assume 50% of device RAM is usable for inference\n    estimatedMB = deviceMemory * 1024 * 0.5;\n  }\n\n  // Try performance.memory (Chrome-specific, shows JS heap)\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const perfMemory = (performance as any).memory;\n  if (perfMemory && typeof perfMemory.jsHeapSizeLimit === 'number') {\n    // Use heap limit as an upper bound\n    const heapLimitMB = perfMemory.jsHeapSizeLimit / (1024 * 1024);\n    estimatedMB = Math.min(estimatedMB, heapLimitMB * 0.8);\n  }\n\n  // Apply reasonable bounds\n  estimatedMB = Math.max(512, Math.min(estimatedMB, 16384));\n\n  return Math.round(estimatedMB);\n}\n\n/**\n * Get a human-readable description of capabilities.\n */\nexport function describeCapabilities(caps: BackendCapabilities): string {\n  const features: string[] = [];\n\n  if (caps.webgpu) {\n    features.push(`WebGPU${caps.webgpuFP16 ? ' (FP16)' : ''}`);\n  }\n  if (caps.webnn) {\n    features.push('WebNN');\n  }\n  if (caps.wasm) {\n    const wasmFeatures: string[] = [];\n    if (caps.wasmSimd) wasmFeatures.push('SIMD');\n    if (caps.wasmThreads) wasmFeatures.push('Threads');\n    features.push(`WASM${wasmFeatures.length ? ` (${wasmFeatures.join(', ')})` : ''}`);\n  }\n  if (caps.webgl2) {\n    features.push('WebGL2');\n  }\n\n  return `Available: ${features.join(', ')}. ~${caps.estimatedMemoryMB}MB memory`;\n}\n","/**\n * Backend selection logic for AI inference.\n * Selects the optimal backend based on capabilities and model requirements.\n */\n\nimport type { BackendCapabilities, InferenceBackend, ModelDescriptor } from '../types/inference.ts';\n\n/**\n * Minimum memory overhead multiplier for inference.\n * Model needs this times its size for intermediate buffers.\n */\nconst MEMORY_OVERHEAD_MULTIPLIER = 2.0;\n\n/**\n * Backend priority order (most performant first)\n */\nconst BACKEND_PRIORITY: InferenceBackend[] = [\n  'webgpu-fp16',\n  'webgpu-fp32',\n  'webnn',\n  'wasm',\n];\n\n/**\n * Select the best available backend for a given model.\n *\n * @param caps - Detected browser capabilities\n * @param model - Model descriptor (optional, for memory/compatibility checks)\n * @returns Selected backend or null if no compatible backend\n */\nexport function selectBackend(\n  caps: BackendCapabilities,\n  model?: ModelDescriptor\n): InferenceBackend | null {\n  const availableBackends = getAvailableBackends(caps);\n\n  if (availableBackends.length === 0) {\n    return null;\n  }\n\n  // If no model specified, return best available\n  if (!model) {\n    return availableBackends[0];\n  }\n\n  // Filter by model compatibility\n  const compatibleBackends = availableBackends.filter(\n    backend => model.backends.includes(backend)\n  );\n\n  if (compatibleBackends.length === 0) {\n    return null;\n  }\n\n  // Filter by memory requirements\n  const memoryCompatible = compatibleBackends.filter(backend => {\n    const requiredMemory = getRequiredMemory(model, backend);\n    return caps.estimatedMemoryMB >= requiredMemory;\n  });\n\n  // Return best compatible backend, or best available if none meet memory reqs\n  // (let it fail at runtime with better error message)\n  return memoryCompatible.length > 0 ? memoryCompatible[0] : compatibleBackends[0];\n}\n\n/**\n * Get all available backends in priority order.\n */\nexport function getAvailableBackends(caps: BackendCapabilities): InferenceBackend[] {\n  const available: InferenceBackend[] = [];\n\n  for (const backend of BACKEND_PRIORITY) {\n    if (isBackendAvailable(caps, backend)) {\n      available.push(backend);\n    }\n  }\n\n  return available;\n}\n\n/**\n * Check if a specific backend is available.\n */\nexport function isBackendAvailable(caps: BackendCapabilities, backend: InferenceBackend): boolean {\n  switch (backend) {\n    case 'webgpu-fp16':\n      return caps.webgpu && caps.webgpuFP16;\n    case 'webgpu-fp32':\n      return caps.webgpu;\n    case 'webnn':\n      return caps.webnn;\n    case 'wasm':\n      // WASM is always available, but SIMD makes it usable\n      return caps.wasm && caps.wasmSimd;\n    default:\n      return false;\n  }\n}\n\n/**\n * Calculate required memory for a model on a specific backend.\n */\nexport function getRequiredMemory(model: ModelDescriptor, backend: InferenceBackend): number {\n  const baseMemory = model.requiredMemoryMB;\n\n  // Different backends have different memory characteristics\n  switch (backend) {\n    case 'webgpu-fp16':\n      // FP16 halves memory usage for weights\n      return baseMemory * 0.6 * MEMORY_OVERHEAD_MULTIPLIER;\n    case 'webgpu-fp32':\n      // FP32 uses full precision\n      return baseMemory * MEMORY_OVERHEAD_MULTIPLIER;\n    case 'webnn':\n      // WebNN varies by hardware, assume similar to WebGPU\n      return baseMemory * MEMORY_OVERHEAD_MULTIPLIER;\n    case 'wasm':\n      // WASM needs more overhead for emulation\n      return baseMemory * MEMORY_OVERHEAD_MULTIPLIER * 1.5;\n    default:\n      return baseMemory * MEMORY_OVERHEAD_MULTIPLIER;\n  }\n}\n\n/**\n * Get expected performance tier for a backend.\n */\nexport function getPerformanceTier(backend: InferenceBackend): 'fast' | 'medium' | 'slow' {\n  switch (backend) {\n    case 'webgpu-fp16':\n      return 'fast';\n    case 'webgpu-fp32':\n    case 'webnn':\n      return 'medium';\n    case 'wasm':\n      return 'slow';\n    default:\n      return 'slow';\n  }\n}\n\n/**\n * Get human-readable backend name.\n */\nexport function getBackendDisplayName(backend: InferenceBackend): string {\n  switch (backend) {\n    case 'webgpu-fp16':\n      return 'WebGPU (FP16)';\n    case 'webgpu-fp32':\n      return 'WebGPU (FP32)';\n    case 'webnn':\n      return 'WebNN';\n    case 'wasm':\n      return 'WASM';\n    default:\n      return 'Unknown';\n  }\n}\n\n/**\n * Get ONNX Runtime execution provider name for a backend.\n */\nexport function getOnnxExecutionProvider(backend: InferenceBackend): string {\n  switch (backend) {\n    case 'webgpu-fp16':\n    case 'webgpu-fp32':\n      return 'webgpu';\n    case 'webnn':\n      return 'webnn';\n    case 'wasm':\n      return 'wasm';\n    default:\n      return 'wasm';\n  }\n}\n\n/**\n * Select model variant for a backend.\n * Returns the model path (e.g., _fp16.onnx vs _int8.onnx).\n */\nexport function selectModelVariant(\n  models: ModelDescriptor[],\n  backend: InferenceBackend\n): ModelDescriptor | null {\n  // Prefer models optimized for the backend\n  const preferredQuant = getPreferredQuantization(backend);\n\n  // First try exact match\n  const exactMatch = models.find(m =>\n    m.quantization === preferredQuant && m.backends.includes(backend)\n  );\n  if (exactMatch) return exactMatch;\n\n  // Fallback to any compatible model\n  const compatible = models.filter(m => m.backends.includes(backend));\n  return compatible.length > 0 ? compatible[0] : null;\n}\n\n/**\n * Get preferred quantization for a backend.\n */\nfunction getPreferredQuantization(backend: InferenceBackend): string {\n  switch (backend) {\n    case 'webgpu-fp16':\n      return 'fp16';\n    case 'webgpu-fp32':\n      return 'fp32';\n    case 'webnn':\n      return 'fp16';\n    case 'wasm':\n      return 'int8';\n    default:\n      return 'fp32';\n  }\n}\n","/**\n * Type definitions for AI inference system.\n * Covers backend capabilities, model management, and worker communication.\n */\n\n/**\n * Browser capability detection results\n */\nexport interface BackendCapabilities {\n  /** WebGPU API available */\n  webgpu: boolean;\n  /** WebGPU adapter reference (null if unavailable) */\n  webgpuAdapter: GPUAdapter | null;\n  /** FP16 shader support available */\n  webgpuFP16: boolean;\n  /** WebNN API available */\n  webnn: boolean;\n  /** WASM available (always true in modern browsers) */\n  wasm: boolean;\n  /** WASM SIMD support */\n  wasmSimd: boolean;\n  /** WASM threads support (SharedArrayBuffer) */\n  wasmThreads: boolean;\n  /** Estimated available memory in MB */\n  estimatedMemoryMB: number;\n  /** WebGL2 available */\n  webgl2: boolean;\n}\n\n/**\n * Available inference backends in priority order\n */\nexport type InferenceBackend = 'webgpu-fp16' | 'webgpu-fp32' | 'webnn' | 'wasm';\n\n/**\n * Model quantization types\n */\nexport type ModelQuantization = 'fp32' | 'fp16' | 'int8' | 'int4';\n\n/**\n * Model descriptor from manifest\n */\nexport interface ModelDescriptor {\n  /** Unique model identifier */\n  id: string;\n  /** Display name */\n  name: string;\n  /** Model file path (relative to models directory) */\n  path: string;\n  /** External data file path (for models >2GB) */\n  externalDataPath?: string;\n  /** Model size in bytes */\n  sizeBytes: number;\n  /** Quantization type */\n  quantization: ModelQuantization;\n  /** Compatible backends */\n  backends: InferenceBackend[];\n  /** Input tensor shape [batch, channels, height, width] */\n  inputShape: [number, number, number, number];\n  /** Output channels (e.g., 3 for normal map RGB) */\n  outputChannels: number;\n  /** Required memory for inference (MB) */\n  requiredMemoryMB: number;\n}\n\n/**\n * Model manifest file structure\n */\nexport interface ModelManifest {\n  version: string;\n  models: ModelDescriptor[];\n}\n\n/**\n * Model cache entry metadata\n */\nexport interface ModelCacheEntry {\n  /** Model ID */\n  modelId: string;\n  /** Cache timestamp */\n  cachedAt: number;\n  /** Model file size */\n  sizeBytes: number;\n  /** Cache version for invalidation */\n  cacheVersion: string;\n}\n\n/**\n * Download progress information\n */\nexport interface DownloadProgress {\n  /** Model being downloaded */\n  modelId: string;\n  /** Bytes downloaded */\n  loadedBytes: number;\n  /** Total bytes */\n  totalBytes: number;\n  /** Progress percentage 0-1 */\n  progress: number;\n}\n\n/**\n * Worker message types\n */\nexport type WorkerMessageType =\n  | 'init'\n  | 'ready'\n  | 'error'\n  | 'infer'\n  | 'result'\n  | 'progress'\n  | 'dispose';\n\n/**\n * Base worker message structure\n */\nexport interface WorkerMessageBase {\n  type: WorkerMessageType;\n  id?: number;\n}\n\n/**\n * Initialize worker message\n */\nexport interface WorkerInitMessage extends WorkerMessageBase {\n  type: 'init';\n  payload: {\n    modelUrl: string;\n    externalDataUrl?: string;\n    backend: InferenceBackend;\n  };\n}\n\n/**\n * Worker ready message\n */\nexport interface WorkerReadyMessage extends WorkerMessageBase {\n  type: 'ready';\n}\n\n/**\n * Worker error message\n */\nexport interface WorkerErrorMessage extends WorkerMessageBase {\n  type: 'error';\n  payload: {\n    code: string;\n    message: string;\n  };\n}\n\n/**\n * Inference request message\n */\nexport interface WorkerInferMessage extends WorkerMessageBase {\n  type: 'infer';\n  id: number;\n  payload: {\n    imageData: ArrayBuffer;\n    width: number;\n    height: number;\n  };\n}\n\n/**\n * Inference result message\n */\nexport interface WorkerResultMessage extends WorkerMessageBase {\n  type: 'result';\n  id: number;\n  payload: {\n    outputData: ArrayBuffer;\n    width: number;\n    height: number;\n  };\n}\n\n/**\n * Inference progress message\n */\nexport interface WorkerProgressMessage extends WorkerMessageBase {\n  type: 'progress';\n  id: number;\n  payload: {\n    stage: string;\n    progress: number;\n  };\n}\n\n/**\n * Dispose worker message\n */\nexport interface WorkerDisposeMessage extends WorkerMessageBase {\n  type: 'dispose';\n}\n\n/**\n * Union of all worker messages\n */\nexport type WorkerMessage =\n  | WorkerInitMessage\n  | WorkerReadyMessage\n  | WorkerErrorMessage\n  | WorkerInferMessage\n  | WorkerResultMessage\n  | WorkerProgressMessage\n  | WorkerDisposeMessage;\n\n/**\n * Inference session state\n */\nexport type SessionState = 'uninitialized' | 'loading' | 'ready' | 'busy' | 'error' | 'disposed';\n\n/**\n * Error codes for inference operations\n */\nexport enum InferenceErrorCode {\n  BACKEND_NOT_SUPPORTED = 'BACKEND_NOT_SUPPORTED',\n  MODEL_NOT_FOUND = 'MODEL_NOT_FOUND',\n  MODEL_LOAD_FAILED = 'MODEL_LOAD_FAILED',\n  INFERENCE_FAILED = 'INFERENCE_FAILED',\n  OUT_OF_MEMORY = 'OUT_OF_MEMORY',\n  WORKER_ERROR = 'WORKER_ERROR',\n  SESSION_NOT_READY = 'SESSION_NOT_READY',\n  CACHE_ERROR = 'CACHE_ERROR',\n}\n\n/**\n * Inference error with recovery information\n */\nexport class InferenceError extends Error {\n  constructor(\n    message: string,\n    public readonly code: InferenceErrorCode,\n    public readonly recoverable: boolean = false,\n    public readonly suggestion?: string\n  ) {\n    super(message);\n    this.name = 'InferenceError';\n  }\n}\n","/**\n * Model caching using IndexedDB and Cache API.\n * Provides persistent storage for ONNX models to avoid re-downloading.\n */\n\nimport type { ModelDescriptor, ModelCacheEntry } from '../types/inference.ts';\nimport { InferenceError, InferenceErrorCode } from '../types/inference.ts';\n\nconst DB_NAME = 'pbr-texture-gen-models';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'models';\nconst META_STORE_NAME = 'metadata';\nconst CACHE_VERSION = '1.0.0';\n\n/**\n * Model cache manager for persistent model storage.\n */\nexport class ModelCache {\n  private db: IDBDatabase | null = null;\n  private initPromise: Promise<void> | null = null;\n\n  /**\n   * Initialize the IndexedDB database.\n   */\n  async init(): Promise<void> {\n    if (this.db) return;\n    if (this.initPromise) return this.initPromise;\n\n    this.initPromise = new Promise((resolve, reject) => {\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n      request.onerror = () => {\n        reject(new InferenceError(\n          'Failed to open model cache database',\n          InferenceErrorCode.CACHE_ERROR,\n          true,\n          'Model caching disabled, models will be re-downloaded each session'\n        ));\n      };\n\n      request.onsuccess = () => {\n        this.db = request.result;\n        resolve();\n      };\n\n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n\n        // Store for model blobs\n        if (!db.objectStoreNames.contains(STORE_NAME)) {\n          db.createObjectStore(STORE_NAME);\n        }\n\n        // Store for metadata\n        if (!db.objectStoreNames.contains(META_STORE_NAME)) {\n          db.createObjectStore(META_STORE_NAME);\n        }\n      };\n    });\n\n    return this.initPromise;\n  }\n\n  /**\n   * Check if a model is cached.\n   */\n  async isCached(modelId: string): Promise<boolean> {\n    await this.init();\n    if (!this.db) return false;\n\n    try {\n      const meta = await this.getMetadata(modelId);\n      if (!meta) return false;\n\n      // Check cache version\n      if (meta.cacheVersion !== CACHE_VERSION) {\n        await this.delete(modelId);\n        return false;\n      }\n\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Get cached model data.\n   */\n  async get(modelId: string): Promise<ArrayBuffer | null> {\n    await this.init();\n    if (!this.db) return null;\n\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction(STORE_NAME, 'readonly');\n      const store = transaction.objectStore(STORE_NAME);\n      const request = store.get(modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve(request.result || null);\n    });\n  }\n\n  /**\n   * Get external data file if cached.\n   */\n  async getExternalData(modelId: string): Promise<ArrayBuffer | null> {\n    return this.get(`${modelId}_external`);\n  }\n\n  /**\n   * Store a model in cache.\n   */\n  async put(modelId: string, data: ArrayBuffer, descriptor: ModelDescriptor): Promise<void> {\n    await this.init();\n    if (!this.db) return;\n\n    // Store model data\n    await new Promise<void>((resolve, reject) => {\n      const transaction = this.db!.transaction(STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(STORE_NAME);\n      const request = store.put(data, modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n\n    // Store metadata\n    const metadata: ModelCacheEntry = {\n      modelId,\n      cachedAt: Date.now(),\n      sizeBytes: descriptor.sizeBytes,\n      cacheVersion: CACHE_VERSION,\n    };\n\n    await this.putMetadata(modelId, metadata);\n  }\n\n  /**\n   * Store external data file.\n   */\n  async putExternalData(modelId: string, data: ArrayBuffer): Promise<void> {\n    await this.init();\n    if (!this.db) return;\n\n    await new Promise<void>((resolve, reject) => {\n      const transaction = this.db!.transaction(STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(STORE_NAME);\n      const request = store.put(data, `${modelId}_external`);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n\n  /**\n   * Delete a cached model.\n   */\n  async delete(modelId: string): Promise<void> {\n    await this.init();\n    if (!this.db) return;\n\n    // Delete model data\n    await new Promise<void>((resolve, reject) => {\n      const transaction = this.db!.transaction(STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(STORE_NAME);\n      const request = store.delete(modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n\n    // Delete external data if exists\n    await new Promise<void>((resolve) => {\n      const transaction = this.db!.transaction(STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(STORE_NAME);\n      const request = store.delete(`${modelId}_external`);\n      request.onsuccess = () => resolve();\n      request.onerror = () => resolve(); // Ignore errors\n    });\n\n    // Delete metadata\n    await this.deleteMetadata(modelId);\n  }\n\n  /**\n   * Get all cached model IDs.\n   */\n  async listCached(): Promise<string[]> {\n    await this.init();\n    if (!this.db) return [];\n\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction(META_STORE_NAME, 'readonly');\n      const store = transaction.objectStore(META_STORE_NAME);\n      const request = store.getAllKeys();\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => {\n        const keys = request.result as string[];\n        resolve(keys);\n      };\n    });\n  }\n\n  /**\n   * Get total cache size in bytes.\n   */\n  async getCacheSize(): Promise<number> {\n    await this.init();\n    if (!this.db) return 0;\n\n    const cachedIds = await this.listCached();\n    let totalSize = 0;\n\n    for (const id of cachedIds) {\n      const meta = await this.getMetadata(id);\n      if (meta) {\n        totalSize += meta.sizeBytes;\n      }\n    }\n\n    return totalSize;\n  }\n\n  /**\n   * Clear all cached models.\n   */\n  async clearAll(): Promise<void> {\n    await this.init();\n    if (!this.db) return;\n\n    await new Promise<void>((resolve, reject) => {\n      const transaction = this.db!.transaction([STORE_NAME, META_STORE_NAME], 'readwrite');\n      transaction.objectStore(STORE_NAME).clear();\n      transaction.objectStore(META_STORE_NAME).clear();\n\n      transaction.oncomplete = () => resolve();\n      transaction.onerror = () => reject(transaction.error);\n    });\n  }\n\n  /**\n   * Close the database connection.\n   */\n  close(): void {\n    if (this.db) {\n      this.db.close();\n      this.db = null;\n      this.initPromise = null;\n    }\n  }\n\n  // Private metadata helpers\n\n  private async getMetadata(modelId: string): Promise<ModelCacheEntry | null> {\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction(META_STORE_NAME, 'readonly');\n      const store = transaction.objectStore(META_STORE_NAME);\n      const request = store.get(modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve(request.result || null);\n    });\n  }\n\n  private async putMetadata(modelId: string, metadata: ModelCacheEntry): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction(META_STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(META_STORE_NAME);\n      const request = store.put(metadata, modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n\n  private async deleteMetadata(modelId: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction(META_STORE_NAME, 'readwrite');\n      const store = transaction.objectStore(META_STORE_NAME);\n      const request = store.delete(modelId);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n}\n\n// Singleton instance\nlet cacheInstance: ModelCache | null = null;\n\n/**\n * Get the global model cache instance.\n */\nexport function getModelCache(): ModelCache {\n  if (!cacheInstance) {\n    cacheInstance = new ModelCache();\n  }\n  return cacheInstance;\n}\n","/**\n * Model loading with caching and progress tracking.\n * Handles fetching models from CDN and caching in IndexedDB.\n */\n\nimport type { ModelDescriptor, ModelManifest, DownloadProgress } from '../types/inference.ts';\nimport { InferenceError, InferenceErrorCode } from '../types/inference.ts';\nimport { getModelCache } from './model-cache.ts';\n\n/** Base URL for model files, can be overridden via environment */\nconst MODEL_BASE_URL = import.meta.env.VITE_MODEL_CDN_URL || '/models';\n\n/** Progress callback type */\nexport type ProgressCallback = (progress: DownloadProgress) => void;\n\n/**\n * Model loader with caching support.\n */\nexport class ModelLoader {\n  private manifestPromise: Promise<ModelManifest> | null = null;\n\n  /**\n   * Load the model manifest.\n   */\n  async loadManifest(): Promise<ModelManifest> {\n    if (this.manifestPromise) {\n      return this.manifestPromise;\n    }\n\n    this.manifestPromise = this.fetchManifest();\n    return this.manifestPromise;\n  }\n\n  /**\n   * Get a model descriptor by ID.\n   */\n  async getModel(modelId: string): Promise<ModelDescriptor | null> {\n    const manifest = await this.loadManifest();\n    return manifest.models.find(m => m.id === modelId) || null;\n  }\n\n  /**\n   * Get all available models.\n   */\n  async getAvailableModels(): Promise<ModelDescriptor[]> {\n    const manifest = await this.loadManifest();\n    return manifest.models;\n  }\n\n  /**\n   * Load model data, using cache if available.\n   *\n   * @param model - Model descriptor\n   * @param onProgress - Progress callback\n   * @returns ArrayBuffer of model data\n   */\n  async loadModelData(\n    model: ModelDescriptor,\n    onProgress?: ProgressCallback\n  ): Promise<ArrayBuffer> {\n    const cache = getModelCache();\n\n    // Check cache first\n    if (await cache.isCached(model.id)) {\n      const cachedData = await cache.get(model.id);\n      if (cachedData) {\n        onProgress?.({\n          modelId: model.id,\n          loadedBytes: model.sizeBytes,\n          totalBytes: model.sizeBytes,\n          progress: 1,\n        });\n        return cachedData;\n      }\n    }\n\n    // Download from network\n    const data = await this.downloadModel(model, onProgress);\n\n    // Cache for next time\n    try {\n      await cache.put(model.id, data, model);\n    } catch (e) {\n      // Cache failure is non-fatal\n      console.warn('Failed to cache model:', e);\n    }\n\n    return data;\n  }\n\n  /**\n   * Load external data file if model requires it.\n   */\n  async loadExternalData(\n    model: ModelDescriptor,\n    onProgress?: ProgressCallback\n  ): Promise<ArrayBuffer | null> {\n    if (!model.externalDataPath) {\n      return null;\n    }\n\n    const cache = getModelCache();\n\n    // Check cache\n    if (await cache.isCached(model.id)) {\n      const cachedData = await cache.getExternalData(model.id);\n      if (cachedData) {\n        return cachedData;\n      }\n    }\n\n    // Download\n    const url = `${MODEL_BASE_URL}/${model.externalDataPath}`;\n    const data = await this.downloadWithProgress(url, model.id, onProgress);\n\n    // Cache\n    try {\n      await cache.putExternalData(model.id, data);\n    } catch (e) {\n      console.warn('Failed to cache external data:', e);\n    }\n\n    return data;\n  }\n\n  /**\n   * Get URL for a model (for ONNX Runtime to load directly).\n   */\n  getModelUrl(model: ModelDescriptor): string {\n    return `${MODEL_BASE_URL}/${model.path}`;\n  }\n\n  /**\n   * Get URL for external data file.\n   */\n  getExternalDataUrl(model: ModelDescriptor): string | null {\n    if (!model.externalDataPath) return null;\n    return `${MODEL_BASE_URL}/${model.externalDataPath}`;\n  }\n\n  /**\n   * Preload models into cache.\n   */\n  async preloadModels(\n    modelIds: string[],\n    onProgress?: (modelId: string, progress: number) => void\n  ): Promise<void> {\n    for (const modelId of modelIds) {\n      const model = await this.getModel(modelId);\n      if (!model) continue;\n\n      await this.loadModelData(model, (progress) => {\n        onProgress?.(modelId, progress.progress);\n      });\n\n      if (model.externalDataPath) {\n        await this.loadExternalData(model);\n      }\n    }\n  }\n\n  /**\n   * Clear model cache.\n   */\n  async clearCache(): Promise<void> {\n    const cache = getModelCache();\n    await cache.clearAll();\n  }\n\n  /**\n   * Get cache statistics.\n   */\n  async getCacheStats(): Promise<{ cachedModels: string[]; totalSizeBytes: number }> {\n    const cache = getModelCache();\n    const cachedModels = await cache.listCached();\n    const totalSizeBytes = await cache.getCacheSize();\n    return { cachedModels, totalSizeBytes };\n  }\n\n  // Private methods\n\n  private async fetchManifest(): Promise<ModelManifest> {\n    try {\n      const response = await fetch(`${MODEL_BASE_URL}/manifest.json`);\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      return await response.json();\n    } catch (e) {\n      // Return empty manifest if file doesn't exist yet\n      console.warn('Model manifest not found, using empty manifest');\n      return { version: '1.0.0', models: [] };\n    }\n  }\n\n  private async downloadModel(\n    model: ModelDescriptor,\n    onProgress?: ProgressCallback\n  ): Promise<ArrayBuffer> {\n    const url = `${MODEL_BASE_URL}/${model.path}`;\n    return this.downloadWithProgress(url, model.id, onProgress);\n  }\n\n  private async downloadWithProgress(\n    url: string,\n    modelId: string,\n    onProgress?: ProgressCallback\n  ): Promise<ArrayBuffer> {\n    try {\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new InferenceError(\n          `Failed to download model: HTTP ${response.status}`,\n          InferenceErrorCode.MODEL_NOT_FOUND,\n          false\n        );\n      }\n\n      // If no content-length, can't show progress\n      const contentLength = response.headers.get('content-length');\n      if (!contentLength || !response.body) {\n        const data = await response.arrayBuffer();\n        onProgress?.({\n          modelId,\n          loadedBytes: data.byteLength,\n          totalBytes: data.byteLength,\n          progress: 1,\n        });\n        return data;\n      }\n\n      // Stream with progress\n      const totalBytes = parseInt(contentLength, 10);\n      const reader = response.body.getReader();\n      const chunks: Uint8Array[] = [];\n      let loadedBytes = 0;\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        chunks.push(value);\n        loadedBytes += value.length;\n\n        onProgress?.({\n          modelId,\n          loadedBytes,\n          totalBytes,\n          progress: loadedBytes / totalBytes,\n        });\n      }\n\n      // Combine chunks\n      const result = new Uint8Array(loadedBytes);\n      let offset = 0;\n      for (const chunk of chunks) {\n        result.set(chunk, offset);\n        offset += chunk.length;\n      }\n\n      return result.buffer;\n    } catch (e) {\n      if (e instanceof InferenceError) throw e;\n\n      throw new InferenceError(\n        `Failed to download model: ${e instanceof Error ? e.message : 'Unknown error'}`,\n        InferenceErrorCode.MODEL_LOAD_FAILED,\n        true,\n        'Check network connection and try again'\n      );\n    }\n  }\n}\n\n// Singleton instance\nlet loaderInstance: ModelLoader | null = null;\n\n/**\n * Get the global model loader instance.\n */\nexport function getModelLoader(): ModelLoader {\n  if (!loaderInstance) {\n    loaderInstance = new ModelLoader();\n  }\n  return loaderInstance;\n}\n","/**\n * Main thread bridge for communicating with the inference worker.\n * Provides a clean async API for model loading and inference.\n */\n\nimport type {\n  WorkerMessage,\n  WorkerResultMessage,\n  WorkerProgressMessage,\n  WorkerErrorMessage,\n  InferenceBackend,\n  SessionState,\n  ModelDescriptor,\n} from '../../types/inference.ts';\nimport { InferenceError, InferenceErrorCode } from '../../types/inference.ts';\nimport { getModelLoader } from '../model-loader.ts';\n\n/** Progress callback for inference operations */\nexport type InferenceProgressCallback = (stage: string, progress: number) => void;\n\n/**\n * Pending inference request.\n */\ninterface PendingRequest {\n  resolve: (data: ImageData) => void;\n  reject: (error: Error) => void;\n  onProgress?: InferenceProgressCallback;\n}\n\n/**\n * Bridge to the inference worker.\n * Manages worker lifecycle and provides async inference API.\n */\nexport class InferenceWorkerBridge {\n  private worker: Worker | null = null;\n  private state: SessionState = 'uninitialized';\n  private pendingRequests: Map<number, PendingRequest> = new Map();\n  private nextRequestId = 1;\n  private initPromise: Promise<void> | null = null;\n  private currentModel: ModelDescriptor | null = null;\n  private currentBackend: InferenceBackend | null = null;\n\n  /**\n   * Get current session state.\n   */\n  getState(): SessionState {\n    return this.state;\n  }\n\n  /**\n   * Get currently loaded model.\n   */\n  getCurrentModel(): ModelDescriptor | null {\n    return this.currentModel;\n  }\n\n  /**\n   * Get current backend.\n   */\n  getCurrentBackend(): InferenceBackend | null {\n    return this.currentBackend;\n  }\n\n  /**\n   * Initialize the worker and load a model.\n   *\n   * @param model - Model descriptor to load\n   * @param backend - Backend to use for inference\n   */\n  async initialize(model: ModelDescriptor, backend: InferenceBackend): Promise<void> {\n    // Reuse existing session if model/backend match\n    if (\n      this.state === 'ready' &&\n      this.currentModel?.id === model.id &&\n      this.currentBackend === backend\n    ) {\n      return;\n    }\n\n    // Wait for any pending init\n    if (this.initPromise) {\n      await this.initPromise;\n      if (\n        this.currentModel?.id === model.id &&\n        this.currentBackend === backend\n      ) {\n        return;\n      }\n    }\n\n    this.initPromise = this.doInitialize(model, backend);\n    return this.initPromise;\n  }\n\n  /**\n   * Run inference on an image.\n   *\n   * @param imageData - Input image\n   * @param onProgress - Progress callback\n   * @returns Output image data\n   */\n  async infer(imageData: ImageData, onProgress?: InferenceProgressCallback): Promise<ImageData> {\n    if (this.state !== 'ready') {\n      throw new InferenceError(\n        'Session not ready for inference',\n        InferenceErrorCode.SESSION_NOT_READY,\n        true,\n        'Initialize the session first'\n      );\n    }\n\n    if (!this.worker) {\n      throw new InferenceError(\n        'Worker not initialized',\n        InferenceErrorCode.WORKER_ERROR,\n        true\n      );\n    }\n\n    this.state = 'busy';\n\n    const requestId = this.nextRequestId++;\n    const { width, height, data } = imageData;\n\n    // Convert to transferable ArrayBuffer\n    const buffer = data.buffer.slice(0);\n\n    return new Promise<ImageData>((resolve, reject) => {\n      this.pendingRequests.set(requestId, { resolve, reject, onProgress });\n\n      this.worker!.postMessage(\n        {\n          type: 'infer',\n          id: requestId,\n          payload: {\n            imageData: buffer,\n            width,\n            height,\n          },\n        },\n        [buffer]\n      );\n    });\n  }\n\n  /**\n   * Check if session is ready for inference.\n   */\n  isReady(): boolean {\n    return this.state === 'ready';\n  }\n\n  /**\n   * Dispose the worker and free resources.\n   */\n  dispose(): void {\n    if (this.worker) {\n      this.worker.postMessage({ type: 'dispose' });\n      this.worker.terminate();\n      this.worker = null;\n    }\n\n    // Reject pending requests\n    for (const [, request] of this.pendingRequests) {\n      request.reject(new InferenceError(\n        'Session disposed',\n        InferenceErrorCode.SESSION_NOT_READY,\n        false\n      ));\n    }\n    this.pendingRequests.clear();\n\n    this.state = 'disposed';\n    this.currentModel = null;\n    this.currentBackend = null;\n    this.initPromise = null;\n  }\n\n  // Private methods\n\n  private async doInitialize(model: ModelDescriptor, backend: InferenceBackend): Promise<void> {\n    // Dispose existing worker if any\n    if (this.worker) {\n      this.dispose();\n    }\n\n    this.state = 'loading';\n\n    try {\n      // Create new worker\n      // Note: The worker URL depends on build configuration\n      // Vite handles worker bundling with ?worker suffix\n      this.worker = new Worker(\n        new URL('./inference-worker.ts', import.meta.url),\n        { type: 'module' }\n      );\n\n      // Set up message handler\n      this.worker.onmessage = this.handleMessage.bind(this);\n      this.worker.onerror = this.handleError.bind(this);\n\n      // Get model URL\n      const loader = getModelLoader();\n      const modelUrl = loader.getModelUrl(model);\n      const externalDataUrl = loader.getExternalDataUrl(model);\n\n      // Wait for ready message\n      await new Promise<void>((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          reject(new InferenceError(\n            'Timeout waiting for worker initialization',\n            InferenceErrorCode.MODEL_LOAD_FAILED,\n            true\n          ));\n        }, 60000); // 60 second timeout for large models\n\n        // Temporary handler for init\n        const initHandler = (event: MessageEvent<WorkerMessage>) => {\n          const message = event.data;\n          if (message.type === 'ready') {\n            clearTimeout(timeout);\n            resolve();\n          } else if (message.type === 'error') {\n            clearTimeout(timeout);\n            const errorMsg = message as WorkerErrorMessage;\n            reject(new InferenceError(\n              errorMsg.payload.message,\n              errorMsg.payload.code as InferenceErrorCode,\n              true\n            ));\n          }\n        };\n\n        // Replace message handler temporarily\n        this.worker!.onmessage = initHandler;\n\n        // Send init message\n        this.worker!.postMessage({\n          type: 'init',\n          payload: {\n            modelUrl,\n            externalDataUrl,\n            backend,\n          },\n        });\n      });\n\n      // Restore normal message handler\n      this.worker.onmessage = this.handleMessage.bind(this);\n\n      this.state = 'ready';\n      this.currentModel = model;\n      this.currentBackend = backend;\n    } catch (e) {\n      this.state = 'error';\n      this.initPromise = null;\n      throw e;\n    }\n  }\n\n  private handleMessage(event: MessageEvent<WorkerMessage>): void {\n    const message = event.data;\n\n    switch (message.type) {\n      case 'result':\n        this.handleResult(message as WorkerResultMessage);\n        break;\n\n      case 'progress':\n        this.handleProgress(message as WorkerProgressMessage);\n        break;\n\n      case 'error':\n        this.handleWorkerError(message as WorkerErrorMessage);\n        break;\n    }\n  }\n\n  private handleResult(message: WorkerResultMessage): void {\n    const request = this.pendingRequests.get(message.id);\n    if (!request) return;\n\n    this.pendingRequests.delete(message.id);\n    this.state = 'ready';\n\n    const { outputData, width, height } = message.payload;\n    const imageData = new ImageData(\n      new Uint8ClampedArray(outputData),\n      width,\n      height\n    );\n\n    request.resolve(imageData);\n  }\n\n  private handleProgress(message: WorkerProgressMessage): void {\n    const request = this.pendingRequests.get(message.id);\n    if (!request || !request.onProgress) return;\n\n    request.onProgress(message.payload.stage, message.payload.progress);\n  }\n\n  private handleWorkerError(message: WorkerErrorMessage): void {\n    const request = message.id ? this.pendingRequests.get(message.id) : null;\n\n    if (request) {\n      this.pendingRequests.delete(message.id!);\n      this.state = 'ready';\n      request.reject(new InferenceError(\n        message.payload.message,\n        message.payload.code as InferenceErrorCode,\n        true\n      ));\n    } else {\n      // Global error\n      console.error('Worker error:', message.payload);\n      this.state = 'error';\n    }\n  }\n\n  private handleError(event: ErrorEvent): void {\n    console.error('Worker error event:', event);\n    this.state = 'error';\n\n    // Reject all pending requests\n    for (const [, request] of this.pendingRequests) {\n      request.reject(new InferenceError(\n        event.message || 'Worker error',\n        InferenceErrorCode.WORKER_ERROR,\n        true\n      ));\n    }\n    this.pendingRequests.clear();\n  }\n}\n\n// Singleton instance\nlet bridgeInstance: InferenceWorkerBridge | null = null;\n\n/**\n * Get the global worker bridge instance.\n */\nexport function getWorkerBridge(): InferenceWorkerBridge {\n  if (!bridgeInstance) {\n    bridgeInstance = new InferenceWorkerBridge();\n  }\n  return bridgeInstance;\n}\n","/**\n * Image preprocessing utilities for AI inference.\n * Handles conversion between ImageData and ONNX tensor formats.\n */\n\n/**\n * Resize ImageData to target dimensions using canvas.\n * Maintains aspect ratio by cropping to square if needed.\n */\nexport function resizeImageData(\n  imageData: ImageData,\n  targetWidth: number,\n  targetHeight: number\n): ImageData {\n  const { width, height } = imageData;\n\n  // If already target size, return as-is\n  if (width === targetWidth && height === targetHeight) {\n    return imageData;\n  }\n\n  // Create offscreen canvas for resize\n  const sourceCanvas = new OffscreenCanvas(width, height);\n  const sourceCtx = sourceCanvas.getContext('2d')!;\n  sourceCtx.putImageData(imageData, 0, 0);\n\n  const targetCanvas = new OffscreenCanvas(targetWidth, targetHeight);\n  const targetCtx = targetCanvas.getContext('2d')!;\n\n  // Use high quality interpolation\n  targetCtx.imageSmoothingEnabled = true;\n  targetCtx.imageSmoothingQuality = 'high';\n\n  // Draw scaled image\n  targetCtx.drawImage(sourceCanvas, 0, 0, targetWidth, targetHeight);\n\n  return targetCtx.getImageData(0, 0, targetWidth, targetHeight);\n}\n\n/**\n * Pad ImageData to make it square (for non-square inputs).\n * Pads with edge pixels to minimize artifacts.\n */\nexport function padToSquare(imageData: ImageData): ImageData {\n  const { width, height } = imageData;\n\n  if (width === height) {\n    return imageData;\n  }\n\n  const size = Math.max(width, height);\n  const canvas = new OffscreenCanvas(size, size);\n  const ctx = canvas.getContext('2d')!;\n\n  // Fill with edge color to minimize seams\n  const sourceCanvas = new OffscreenCanvas(width, height);\n  const sourceCtx = sourceCanvas.getContext('2d')!;\n  sourceCtx.putImageData(imageData, 0, 0);\n\n  // Center the image\n  const offsetX = Math.floor((size - width) / 2);\n  const offsetY = Math.floor((size - height) / 2);\n\n  // Draw centered\n  ctx.drawImage(sourceCanvas, offsetX, offsetY);\n\n  // Mirror edges to fill padding\n  if (offsetX > 0) {\n    // Left edge\n    ctx.save();\n    ctx.scale(-1, 1);\n    ctx.drawImage(sourceCanvas, 0, 0, 1, height, -offsetX, offsetY, offsetX, height);\n    ctx.restore();\n    // Right edge\n    ctx.save();\n    ctx.translate(size, 0);\n    ctx.scale(-1, 1);\n    ctx.drawImage(sourceCanvas, width - 1, 0, 1, height, 0, offsetY, offsetX, height);\n    ctx.restore();\n  }\n\n  if (offsetY > 0) {\n    // Top edge\n    ctx.save();\n    ctx.scale(1, -1);\n    ctx.drawImage(sourceCanvas, 0, 0, width, 1, offsetX, -offsetY, width, offsetY);\n    ctx.restore();\n    // Bottom edge\n    ctx.save();\n    ctx.translate(0, size);\n    ctx.scale(1, -1);\n    ctx.drawImage(sourceCanvas, 0, height - 1, width, 1, offsetX, 0, width, offsetY);\n    ctx.restore();\n  }\n\n  return ctx.getImageData(0, 0, size, size);\n}\n\n/**\n * Crop ImageData back from padded square to original dimensions.\n */\nexport function cropFromSquare(\n  imageData: ImageData,\n  originalWidth: number,\n  originalHeight: number\n): ImageData {\n  const { width, height } = imageData;\n\n  if (width === originalWidth && height === originalHeight) {\n    return imageData;\n  }\n\n  const offsetX = Math.floor((width - originalWidth) / 2);\n  const offsetY = Math.floor((height - originalHeight) / 2);\n\n  const canvas = new OffscreenCanvas(width, height);\n  const ctx = canvas.getContext('2d')!;\n  ctx.putImageData(imageData, 0, 0);\n\n  return ctx.getImageData(offsetX, offsetY, originalWidth, originalHeight);\n}\n\n/**\n * Convert ImageData RGBA to Float32Array in NCHW format.\n * Normalized to [0, 1] range.\n */\nexport function imageDataToNCHW(imageData: ImageData): Float32Array {\n  const { data, width, height } = imageData;\n  const pixelCount = width * height;\n  const float32Data = new Float32Array(3 * pixelCount);\n\n  for (let i = 0; i < pixelCount; i++) {\n    float32Data[i] = data[i * 4] / 255;                          // R -> channel 0\n    float32Data[pixelCount + i] = data[i * 4 + 1] / 255;         // G -> channel 1\n    float32Data[2 * pixelCount + i] = data[i * 4 + 2] / 255;     // B -> channel 2\n  }\n\n  return float32Data;\n}\n\n/**\n * Convert Float32Array NCHW output to ImageData RGBA.\n * Expects values in [0, 1] range for normal map (will be stored as-is).\n */\nexport function nchwToImageData(\n  data: Float32Array,\n  width: number,\n  height: number,\n  channels: number = 3\n): ImageData {\n  const pixelCount = width * height;\n  const result = new Uint8ClampedArray(pixelCount * 4);\n\n  if (channels >= 3) {\n    for (let i = 0; i < pixelCount; i++) {\n      result[i * 4] = Math.round(clamp(data[i], 0, 1) * 255);                      // R\n      result[i * 4 + 1] = Math.round(clamp(data[pixelCount + i], 0, 1) * 255);     // G\n      result[i * 4 + 2] = Math.round(clamp(data[2 * pixelCount + i], 0, 1) * 255); // B\n      result[i * 4 + 3] = 255;                                                      // A\n    }\n  } else {\n    // Grayscale - replicate to RGB\n    for (let i = 0; i < pixelCount; i++) {\n      const value = Math.round(clamp(data[i], 0, 1) * 255);\n      result[i * 4] = value;\n      result[i * 4 + 1] = value;\n      result[i * 4 + 2] = value;\n      result[i * 4 + 3] = 255;\n    }\n  }\n\n  return new ImageData(result, width, height);\n}\n\n/**\n * Apply DeepBump-specific preprocessing.\n * DeepBump expects input normalized to [-1, 1] for some models,\n * or [0, 1] for others. This handles both cases.\n */\nexport function preprocessForDeepBump(\n  imageData: ImageData,\n  normalizeRange: 'unit' | 'signed' = 'unit'\n): Float32Array {\n  const { data, width, height } = imageData;\n  const pixelCount = width * height;\n  const float32Data = new Float32Array(3 * pixelCount);\n\n  if (normalizeRange === 'signed') {\n    // Normalize to [-1, 1]\n    for (let i = 0; i < pixelCount; i++) {\n      float32Data[i] = (data[i * 4] / 255) * 2 - 1;\n      float32Data[pixelCount + i] = (data[i * 4 + 1] / 255) * 2 - 1;\n      float32Data[2 * pixelCount + i] = (data[i * 4 + 2] / 255) * 2 - 1;\n    }\n  } else {\n    // Normalize to [0, 1]\n    for (let i = 0; i < pixelCount; i++) {\n      float32Data[i] = data[i * 4] / 255;\n      float32Data[pixelCount + i] = data[i * 4 + 1] / 255;\n      float32Data[2 * pixelCount + i] = data[i * 4 + 2] / 255;\n    }\n  }\n\n  return float32Data;\n}\n\n/**\n * Post-process DeepBump normal map output.\n * Converts from model output space to standard tangent-space normal map format.\n */\nexport function postprocessDeepBumpNormal(\n  data: Float32Array,\n  width: number,\n  height: number,\n  outputRange: 'unit' | 'signed' = 'signed'\n): ImageData {\n  const pixelCount = width * height;\n  const result = new Uint8ClampedArray(pixelCount * 4);\n\n  for (let i = 0; i < pixelCount; i++) {\n    let r = data[i];\n    let g = data[pixelCount + i];\n    let b = data[2 * pixelCount + i];\n\n    if (outputRange === 'signed') {\n      // Model outputs [-1, 1], convert to [0, 1] for storage\n      r = (r + 1) * 0.5;\n      g = (g + 1) * 0.5;\n      b = (b + 1) * 0.5;\n    }\n\n    // Clamp and convert to 8-bit\n    result[i * 4] = Math.round(clamp(r, 0, 1) * 255);\n    result[i * 4 + 1] = Math.round(clamp(g, 0, 1) * 255);\n    result[i * 4 + 2] = Math.round(clamp(b, 0, 1) * 255);\n    result[i * 4 + 3] = 255;\n  }\n\n  return new ImageData(result, width, height);\n}\n\n/**\n * Utility: clamp value to range.\n */\nfunction clamp(value: number, min: number, max: number): number {\n  return Math.max(min, Math.min(max, value));\n}\n\n/**\n * Process image in tiles for large inputs.\n * Useful for inputs larger than model's native resolution.\n */\nexport function createTileIterator(\n  width: number,\n  height: number,\n  tileSize: number,\n  overlap: number = 32\n): Array<{ x: number; y: number; w: number; h: number }> {\n  const tiles: Array<{ x: number; y: number; w: number; h: number }> = [];\n  const step = tileSize - overlap;\n\n  for (let y = 0; y < height; y += step) {\n    for (let x = 0; x < width; x += step) {\n      tiles.push({\n        x,\n        y,\n        w: Math.min(tileSize, width - x),\n        h: Math.min(tileSize, height - y),\n      });\n    }\n  }\n\n  return tiles;\n}\n\n/**\n * Extract a tile from ImageData.\n */\nexport function extractTile(\n  imageData: ImageData,\n  x: number,\n  y: number,\n  w: number,\n  h: number\n): ImageData {\n  const canvas = new OffscreenCanvas(imageData.width, imageData.height);\n  const ctx = canvas.getContext('2d')!;\n  ctx.putImageData(imageData, 0, 0);\n  return ctx.getImageData(x, y, w, h);\n}\n\n/**\n * Blend a tile back into the result.\n * Uses linear blending in overlap regions.\n */\nexport function blendTile(\n  result: Uint8ClampedArray,\n  resultWidth: number,\n  tile: ImageData,\n  x: number,\n  y: number,\n  overlap: number\n): void {\n  const { data: tileData, width: tileWidth, height: tileHeight } = tile;\n\n  for (let ty = 0; ty < tileHeight; ty++) {\n    for (let tx = 0; tx < tileWidth; tx++) {\n      const rx = x + tx;\n      const ry = y + ty;\n      const resultIdx = (ry * resultWidth + rx) * 4;\n      const tileIdx = (ty * tileWidth + tx) * 4;\n\n      // Calculate blend weight based on distance from edge\n      let weight = 1.0;\n      if (tx < overlap) weight *= tx / overlap;\n      if (ty < overlap) weight *= ty / overlap;\n      if (tileWidth - tx < overlap) weight *= (tileWidth - tx) / overlap;\n      if (tileHeight - ty < overlap) weight *= (tileHeight - ty) / overlap;\n\n      // Blend\n      if (result[resultIdx + 3] === 0) {\n        // First write\n        result[resultIdx] = tileData[tileIdx];\n        result[resultIdx + 1] = tileData[tileIdx + 1];\n        result[resultIdx + 2] = tileData[tileIdx + 2];\n        result[resultIdx + 3] = 255;\n      } else {\n        // Blend with existing\n        result[resultIdx] = Math.round(result[resultIdx] * (1 - weight) + tileData[tileIdx] * weight);\n        result[resultIdx + 1] = Math.round(result[resultIdx + 1] * (1 - weight) + tileData[tileIdx + 1] * weight);\n        result[resultIdx + 2] = Math.round(result[resultIdx + 2] * (1 - weight) + tileData[tileIdx + 2] * weight);\n      }\n    }\n  }\n}\n","/**\n * DeepBump AI normal map generator.\n * Uses ONNX Runtime Web for inference via Web Worker.\n */\n\nimport {\n  getWorkerBridge,\n  getModelLoader,\n  selectBackend,\n  selectModelVariant,\n  detectCapabilities,\n  type InferenceProgressCallback,\n  type BackendCapabilities,\n  type InferenceBackend,\n  type ModelDescriptor,\n} from '../../inference/index.ts';\nimport { InferenceError, InferenceErrorCode } from '../../types/inference.ts';\nimport {\n  resizeImageData,\n  padToSquare,\n  cropFromSquare,\n} from './preprocessor.ts';\n\n/** DeepBump model identifier prefix */\nconst DEEPBUMP_MODEL_PREFIX = 'deepbump';\n\n/** Quality preset configuration */\nexport interface QualityPreset {\n  name: string;\n  /** Processing resolution (model input size) */\n  resolution: number;\n  /** Use AI model or fall back to traditional */\n  useAI: boolean;\n  /** Upscale result to original resolution */\n  upscale: boolean;\n  /** Expected inference time description */\n  expectedTime: string;\n}\n\n/** Available quality presets */\nexport const QUALITY_PRESETS: Record<string, QualityPreset> = {\n  fast: {\n    name: 'Fast Preview',\n    resolution: 256,\n    useAI: false,\n    upscale: true,\n    expectedTime: '<100ms (Traditional)',\n  },\n  balanced: {\n    name: 'Balanced (AI)',\n    resolution: 256,  // DeepBump model native resolution\n    useAI: true,\n    upscale: true,\n    expectedTime: '2-10s (WASM)',\n  },\n  quality: {\n    name: 'High Quality (AI)',\n    resolution: 256,  // DeepBump model native resolution\n    useAI: true,\n    upscale: true,\n    expectedTime: '2-10s (WASM)',\n  },\n};\n\n/** DeepBump generator state */\nexport type DeepBumpState = 'uninitialized' | 'initializing' | 'ready' | 'busy' | 'error';\n\n/**\n * DeepBump normal map generator using ONNX Runtime.\n */\nexport class DeepBumpGenerator {\n  private capabilities: BackendCapabilities | null = null;\n  private selectedBackend: InferenceBackend | null = null;\n  private selectedModel: ModelDescriptor | null = null;\n  private state: DeepBumpState = 'uninitialized';\n  private initPromise: Promise<void> | null = null;\n  private lastError: Error | null = null;\n\n  /**\n   * Get current generator state.\n   */\n  getState(): DeepBumpState {\n    return this.state;\n  }\n\n  /**\n   * Get last error if state is 'error'.\n   */\n  getLastError(): Error | null {\n    return this.lastError;\n  }\n\n  /**\n   * Get selected backend.\n   */\n  getBackend(): InferenceBackend | null {\n    return this.selectedBackend;\n  }\n\n  /**\n   * Get selected model.\n   */\n  getModel(): ModelDescriptor | null {\n    return this.selectedModel;\n  }\n\n  /**\n   * Check if AI generation is available.\n   */\n  isAvailable(): boolean {\n    return this.state === 'ready';\n  }\n\n  /**\n   * Initialize the generator.\n   * Detects capabilities, selects backend, and loads model.\n   */\n  async initialize(): Promise<void> {\n    if (this.state === 'ready') {\n      return;\n    }\n\n    if (this.initPromise) {\n      return this.initPromise;\n    }\n\n    this.initPromise = this.doInitialize();\n    return this.initPromise;\n  }\n\n  /**\n   * Generate AI normal map from input image.\n   *\n   * @param input - Source image\n   * @param preset - Quality preset to use\n   * @param onProgress - Progress callback\n   * @returns Generated normal map\n   */\n  async generateNormalMap(\n    input: ImageData,\n    preset: QualityPreset = QUALITY_PRESETS.balanced,\n    onProgress?: InferenceProgressCallback\n  ): Promise<ImageData> {\n    // Ensure initialized\n    if (this.state !== 'ready') {\n      await this.initialize();\n    }\n\n    if (this.state !== 'ready') {\n      throw new InferenceError(\n        'DeepBump generator not ready',\n        InferenceErrorCode.SESSION_NOT_READY,\n        true,\n        this.lastError?.message\n      );\n    }\n\n    this.state = 'busy';\n    const originalWidth = input.width;\n    const originalHeight = input.height;\n\n    try {\n      onProgress?.('preprocessing', 0.05);\n\n      // Preprocess: resize to model input resolution\n      let processedInput = input;\n\n      // Pad to square if needed\n      const wasNonSquare = input.width !== input.height;\n      if (wasNonSquare) {\n        processedInput = padToSquare(processedInput);\n      }\n\n      // Resize to model resolution\n      const modelResolution = preset.resolution;\n      if (processedInput.width !== modelResolution || processedInput.height !== modelResolution) {\n        processedInput = resizeImageData(processedInput, modelResolution, modelResolution);\n      }\n\n      onProgress?.('preprocessing', 0.1);\n\n      // Run inference\n      const bridge = getWorkerBridge();\n      const result = await bridge.infer(processedInput, (stage, progress) => {\n        // Map worker progress to overall progress (0.1 to 0.9)\n        const mappedProgress = 0.1 + progress * 0.8;\n        onProgress?.(stage, mappedProgress);\n      });\n\n      onProgress?.('postprocessing', 0.9);\n\n      // Post-process: resize back to original dimensions\n      let output = result;\n\n      // Resize back if we downscaled\n      if (preset.upscale && (result.width !== originalWidth || result.height !== originalHeight)) {\n        // First uncrop if we padded\n        if (wasNonSquare) {\n          const squareSize = Math.max(originalWidth, originalHeight);\n          output = resizeImageData(output, squareSize, squareSize);\n          output = cropFromSquare(output, originalWidth, originalHeight);\n        } else {\n          output = resizeImageData(output, originalWidth, originalHeight);\n        }\n      } else if (wasNonSquare) {\n        // Just uncrop\n        output = cropFromSquare(output, originalWidth, originalHeight);\n      }\n\n      onProgress?.('complete', 1.0);\n\n      this.state = 'ready';\n      return output;\n    } catch (e) {\n      this.state = 'ready'; // Allow retry\n      throw e;\n    }\n  }\n\n  /**\n   * Dispose the generator and free resources.\n   */\n  dispose(): void {\n    const bridge = getWorkerBridge();\n    bridge.dispose();\n    this.state = 'uninitialized';\n    this.initPromise = null;\n    this.selectedModel = null;\n    this.selectedBackend = null;\n  }\n\n  // Private implementation\n\n  private async doInitialize(): Promise<void> {\n    this.state = 'initializing';\n    this.lastError = null;\n\n    try {\n      // Detect capabilities\n      this.capabilities = await detectCapabilities();\n\n      // Get available DeepBump models\n      const loader = getModelLoader();\n      const allModels = await loader.getAvailableModels();\n      const deepbumpModels = allModels.filter(m => m.id.startsWith(DEEPBUMP_MODEL_PREFIX));\n\n      if (deepbumpModels.length === 0) {\n        throw new InferenceError(\n          'No DeepBump models found in manifest',\n          InferenceErrorCode.MODEL_NOT_FOUND,\n          false,\n          'Ensure model files are present in /public/models/'\n        );\n      }\n\n      // Select best backend\n      this.selectedBackend = selectBackend(this.capabilities);\n      if (!this.selectedBackend) {\n        throw new InferenceError(\n          'No compatible inference backend available',\n          InferenceErrorCode.BACKEND_NOT_SUPPORTED,\n          false,\n          'WebGPU or WASM with SIMD required'\n        );\n      }\n\n      // Select model variant for backend\n      this.selectedModel = selectModelVariant(deepbumpModels, this.selectedBackend);\n      if (!this.selectedModel) {\n        throw new InferenceError(\n          `No DeepBump model compatible with ${this.selectedBackend}`,\n          InferenceErrorCode.MODEL_NOT_FOUND,\n          false\n        );\n      }\n\n      // Initialize worker with model\n      const bridge = getWorkerBridge();\n      await bridge.initialize(this.selectedModel, this.selectedBackend);\n\n      this.state = 'ready';\n    } catch (e) {\n      this.state = 'error';\n      this.lastError = e instanceof Error ? e : new Error(String(e));\n      this.initPromise = null;\n      throw e;\n    }\n  }\n}\n\n// Singleton instance\nlet generatorInstance: DeepBumpGenerator | null = null;\n\n/**\n * Get the global DeepBump generator instance.\n */\nexport function getDeepBumpGenerator(): DeepBumpGenerator {\n  if (!generatorInstance) {\n    generatorInstance = new DeepBumpGenerator();\n  }\n  return generatorInstance;\n}\n\n/**\n * Check if DeepBump AI is available for use.\n * Quick check without full initialization.\n */\nexport async function isDeepBumpAvailable(): Promise<boolean> {\n  try {\n    const caps = await detectCapabilities();\n    const backend = selectBackend(caps);\n    if (!backend) return false;\n\n    const loader = getModelLoader();\n    const allModels = await loader.getAvailableModels();\n    const deepbumpModels = allModels.filter(m => m.id.startsWith(DEEPBUMP_MODEL_PREFIX));\n\n    if (deepbumpModels.length === 0) return false;\n\n    const model = selectModelVariant(deepbumpModels, backend);\n    return model !== null;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get expected performance info for current system.\n */\nexport async function getPerformanceInfo(): Promise<{\n  backend: string;\n  model: string;\n  expectedTime: string;\n} | null> {\n  try {\n    const caps = await detectCapabilities();\n    const backend = selectBackend(caps);\n    if (!backend) return null;\n\n    const loader = getModelLoader();\n    const allModels = await loader.getAvailableModels();\n    const deepbumpModels = allModels.filter(m => m.id.startsWith(DEEPBUMP_MODEL_PREFIX));\n    const model = selectModelVariant(deepbumpModels, backend);\n    if (!model) return null;\n\n    let expectedTime: string;\n    switch (backend) {\n      case 'webgpu-fp16':\n        expectedTime = '2-5 seconds';\n        break;\n      case 'webgpu-fp32':\n        expectedTime = '5-10 seconds';\n        break;\n      case 'webnn':\n        expectedTime = '5-15 seconds';\n        break;\n      case 'wasm':\n        expectedTime = '20-60 seconds';\n        break;\n      default:\n        expectedTime = 'Unknown';\n    }\n\n    return {\n      backend,\n      model: model.id,\n      expectedTime,\n    };\n  } catch {\n    return null;\n  }\n}\n","/**\n * Unified PBR generator that combines traditional and AI methods.\n * Supports configurable generation methods per channel and provides\n * a single interface for full PBR stack generation.\n */\n\nimport type { PBRMaps, PBRGeneratorParams } from './index.ts';\nimport { TraditionalPBRGenerator } from './traditional/index.ts';\nimport {\n  getDeepBumpGenerator,\n  isDeepBumpAvailable,\n  QUALITY_PRESETS,\n  type QualityPreset,\n} from './ai/index.ts';\n\n/**\n * Generation method for each PBR channel\n */\nexport type GenerationMethod = 'traditional' | 'ai';\n\n/**\n * Height map generation method\n */\nexport type HeightMethod = 'integrated' | 'sobel' | 'none';\n\n/**\n * Configuration for unified PBR generation\n */\nexport interface UnifiedPBRConfig {\n  /** Method for normal map generation (AI available via DeepBump) */\n  normalMethod: GenerationMethod;\n  /** Method for height map generation */\n  heightMethod: HeightMethod;\n  /** AI quality preset (used when normalMethod is 'ai') */\n  aiQualityPreset: QualityPreset;\n}\n\n/**\n * Extended PBR maps including optional height\n */\nexport interface ExtendedPBRMaps extends PBRMaps {\n  /** Height map (optional, generated from normals) */\n  height: ImageData | null;\n}\n\n/**\n * Progress callback for unified generation\n */\nexport type UnifiedProgressCallback = (\n  channel: 'basecolor' | 'normal' | 'roughness' | 'metallic' | 'height',\n  progress: number,\n  status: string\n) => void;\n\n/**\n * Default unified configuration\n */\nexport const DEFAULT_UNIFIED_CONFIG: UnifiedPBRConfig = {\n  normalMethod: 'traditional',\n  heightMethod: 'none',\n  aiQualityPreset: QUALITY_PRESETS.quality,\n};\n\n/**\n * Unified PBR generator that combines multiple generation methods.\n */\nexport class UnifiedPBRGenerator {\n  private traditionalGen: TraditionalPBRGenerator | null = null;\n  private config: UnifiedPBRConfig;\n  private aiAvailable: boolean = false;\n\n  constructor(config: Partial<UnifiedPBRConfig> = {}) {\n    this.config = { ...DEFAULT_UNIFIED_CONFIG, ...config };\n  }\n\n  /**\n   * Initialize the generator and check AI availability.\n   */\n  async initialize(): Promise<void> {\n    // Check AI availability for normal maps (only channel with AI support)\n    this.aiAvailable = await isDeepBumpAvailable();\n\n    if (!this.aiAvailable && this.config.normalMethod === 'ai') {\n      console.warn('AI not available for normal maps, falling back to traditional');\n      this.config.normalMethod = 'traditional';\n    }\n  }\n\n  /**\n   * Update configuration.\n   */\n  setConfig(config: Partial<UnifiedPBRConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n\n  /**\n   * Get current configuration.\n   */\n  getConfig(): UnifiedPBRConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Check if AI is available.\n   */\n  isAIAvailable(): boolean {\n    return this.aiAvailable;\n  }\n\n  /**\n   * Generate all PBR maps using configured methods.\n   * - Basecolor: Traditional (albedo extraction with shadow/highlight reduction)\n   * - Normal: Traditional (Sobel) or AI (DeepBump)\n   * - Roughness: Traditional (variance-based)\n   * - Metallic: Traditional (color heuristics)\n   * - Height: Optional (integrated from normal or Sobel)\n   */\n  async generate(\n    input: ImageData,\n    params: PBRGeneratorParams,\n    onProgress?: UnifiedProgressCallback\n  ): Promise<ExtendedPBRMaps> {\n    // Get or create traditional generator\n    if (!this.traditionalGen) {\n      this.traditionalGen = new TraditionalPBRGenerator();\n    }\n\n    // Generate all traditional maps first\n    onProgress?.('basecolor', 0, 'Processing basecolor...');\n    const traditionalMaps = this.traditionalGen.generate(input, params);\n    onProgress?.('basecolor', 1, 'Basecolor complete');\n\n    // Normal map: use AI if configured and available\n    onProgress?.('normal', 0, 'Generating normal map...');\n    let normal: ImageData;\n    if (this.config.normalMethod === 'ai' && this.aiAvailable) {\n      try {\n        const deepbump = getDeepBumpGenerator();\n        await deepbump.initialize();\n        normal = await deepbump.generateNormalMap(\n          input,\n          this.config.aiQualityPreset,\n          (stage, progress) => {\n            onProgress?.('normal', progress, `Normal map: ${stage}`);\n          }\n        );\n      } catch (err) {\n        console.warn('AI normal generation failed, falling back to traditional:', err);\n        normal = traditionalMaps.normal;\n      }\n    } else {\n      normal = traditionalMaps.normal;\n    }\n    onProgress?.('normal', 1, 'Normal map complete');\n\n    // Roughness and metallic: always traditional\n    onProgress?.('roughness', 0, 'Generating roughness map...');\n    const roughness = traditionalMaps.roughness;\n    onProgress?.('roughness', 1, 'Roughness map complete');\n\n    onProgress?.('metallic', 0, 'Generating metallic map...');\n    const metallic = traditionalMaps.metallic;\n    onProgress?.('metallic', 1, 'Metallic map complete');\n\n    // Height map if requested\n    onProgress?.('height', 0, 'Generating height map...');\n    let height: ImageData | null = null;\n    if (this.config.heightMethod === 'integrated') {\n      height = this.integrateHeightFromNormal(normal);\n    } else if (this.config.heightMethod === 'sobel') {\n      height = this.generateSobelHeight(input);\n    }\n    onProgress?.('height', 1, 'Height map complete');\n\n    return { basecolor: traditionalMaps.basecolor, normal, roughness, metallic, height };\n  }\n\n  /**\n   * Integrate height map from normal map using Poisson integration.\n   * This is a simplified iterative approach suitable for real-time use.\n   */\n  private integrateHeightFromNormal(normal: ImageData): ImageData {\n    const { width, height, data } = normal;\n    const result = new Uint8ClampedArray(width * height * 4);\n\n    // Extract gradients from normal map\n    const gradX = new Float32Array(width * height);\n    const gradY = new Float32Array(width * height);\n\n    for (let i = 0; i < width * height; i++) {\n      const idx = i * 4;\n      // Normal is in tangent space: X right, Y up, Z out\n      // Convert from [0,1] to [-1,1]\n      const nx = (data[idx] / 255) * 2 - 1;\n      const ny = (data[idx + 1] / 255) * 2 - 1;\n      const nz = (data[idx + 2] / 255) * 2 - 1;\n\n      // Gradient = -nx/nz, -ny/nz (partial derivatives of height)\n      const invNz = nz !== 0 ? 1 / nz : 0;\n      gradX[i] = -nx * invNz;\n      gradY[i] = -ny * invNz;\n    }\n\n    // Simple iterative integration (Jacobi method)\n    const heightMap = new Float32Array(width * height);\n    const iterations = 50;\n\n    for (let iter = 0; iter < iterations; iter++) {\n      for (let y = 1; y < height - 1; y++) {\n        for (let x = 1; x < width - 1; x++) {\n          const i = y * width + x;\n\n          // Average of neighbors plus gradient contribution\n          const left = heightMap[i - 1];\n          const right = heightMap[i + 1];\n          const up = heightMap[i - width];\n          const down = heightMap[i + width];\n\n          const avgNeighbors = (left + right + up + down) / 4;\n          const gradContrib = (gradX[i - 1] - gradX[i + 1] + gradY[i - width] - gradY[i + width]) / 4;\n\n          heightMap[i] = avgNeighbors + gradContrib;\n        }\n      }\n    }\n\n    // Normalize height to [0, 1]\n    let minH = Infinity, maxH = -Infinity;\n    for (let i = 0; i < heightMap.length; i++) {\n      minH = Math.min(minH, heightMap[i]);\n      maxH = Math.max(maxH, heightMap[i]);\n    }\n    const range = maxH - minH || 1;\n\n    for (let i = 0; i < width * height; i++) {\n      const normalized = (heightMap[i] - minH) / range;\n      const byteValue = Math.round(normalized * 255);\n      const idx = i * 4;\n      result[idx] = byteValue;\n      result[idx + 1] = byteValue;\n      result[idx + 2] = byteValue;\n      result[idx + 3] = 255;\n    }\n\n    return new ImageData(result, width, height);\n  }\n\n  /**\n   * Generate height map using Sobel gradient magnitude.\n   * Simple approach that works well for many textures.\n   */\n  private generateSobelHeight(input: ImageData): ImageData {\n    const { width, height, data } = input;\n    const result = new Uint8ClampedArray(width * height * 4);\n\n    // Convert to grayscale first\n    const gray = new Float32Array(width * height);\n    for (let i = 0; i < width * height; i++) {\n      const idx = i * 4;\n      gray[i] = (0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2]) / 255;\n    }\n\n    // Apply Sobel and integrate\n    const heightMap = new Float32Array(width * height);\n\n    // Row-wise integration of horizontal gradients\n    for (let y = 0; y < height; y++) {\n      let accumulated = 0;\n      for (let x = 1; x < width; x++) {\n        const idx = y * width + x;\n        const grad = gray[idx] - gray[idx - 1];\n        accumulated += grad;\n        heightMap[idx] = accumulated;\n      }\n    }\n\n    // Normalize to [0, 1]\n    let minH = Infinity, maxH = -Infinity;\n    for (let i = 0; i < heightMap.length; i++) {\n      minH = Math.min(minH, heightMap[i]);\n      maxH = Math.max(maxH, heightMap[i]);\n    }\n    const range = maxH - minH || 1;\n\n    for (let i = 0; i < width * height; i++) {\n      // Invert so bright = high\n      const normalized = 1 - (heightMap[i] - minH) / range;\n      const byteValue = Math.round(normalized * 255);\n      const idx = i * 4;\n      result[idx] = byteValue;\n      result[idx + 1] = byteValue;\n      result[idx + 2] = byteValue;\n      result[idx + 3] = 255;\n    }\n\n    return new ImageData(result, width, height);\n  }\n\n  /**\n   * Dispose resources.\n   */\n  dispose(): void {\n    if (this.traditionalGen) {\n      this.traditionalGen.dispose();\n      this.traditionalGen = null;\n    }\n  }\n}\n\n","/**\n * PBR map generator interface and types.\n */\n\nexport interface PBRMaps {\n  basecolor: ImageData;\n  normal: ImageData;\n  roughness: ImageData;\n  metallic: ImageData;\n}\n\nexport interface PBRGeneratorParams {\n  normalStrength: number;\n  roughnessScale: number;\n  roughnessOffset: number;\n  metallicThreshold: number;\n  shadowReduction: number;    // 0.0 = none, 1.0 = full\n  highlightReduction: number; // 0.0 = none, 1.0 = full\n}\n\nexport const DEFAULT_PARAMS: PBRGeneratorParams = {\n  normalStrength: 1.0,\n  roughnessScale: 1.0,\n  roughnessOffset: 0.0,\n  metallicThreshold: 0.5,\n  shadowReduction: 0.5,\n  highlightReduction: 0.3,\n};\n\nexport interface PBRGenerator {\n  generate(input: ImageData, params: PBRGeneratorParams): PBRMaps;\n  dispose(): void;\n}\n\n// Re-export unified generator\nexport {\n  UnifiedPBRGenerator,\n  DEFAULT_UNIFIED_CONFIG,\n  type UnifiedPBRConfig,\n  type ExtendedPBRMaps,\n  type GenerationMethod,\n  type HeightMethod,\n  type UnifiedProgressCallback,\n} from './unified.ts';\n","/**\n * Image loading utilities for texture input.\n * Supports PNG, JPEG, WebP up to 4096x4096.\n */\n\nconst MAX_DIMENSION = 4096;\n\n/**\n * Load an image file and convert to ImageData.\n */\nexport async function loadImageFile(file: File): Promise<ImageData> {\n  // Validate file type\n  if (!file.type.match(/^image\\/(png|jpeg|webp)$/)) {\n    throw new Error('Unsupported file type. Use PNG, JPEG, or WebP.');\n  }\n\n  // Create object URL and load image\n  const url = URL.createObjectURL(file);\n  try {\n    return await loadImageFromUrl(url);\n  } finally {\n    URL.revokeObjectURL(url);\n  }\n}\n\n/**\n * Load an image from URL and convert to ImageData.\n */\nexport async function loadImageFromUrl(url: string): Promise<ImageData> {\n  const img = await loadImage(url);\n  return imageToImageData(img);\n}\n\n/**\n * Load an Image element from URL.\n */\nfunction loadImage(url: string): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.onload = () => resolve(img);\n    img.onerror = () => reject(new Error('Failed to load image'));\n    img.src = url;\n  });\n}\n\n/**\n * Convert HTMLImageElement to ImageData.\n * Resizes if necessary to stay within MAX_DIMENSION.\n */\nfunction imageToImageData(img: HTMLImageElement): ImageData {\n  let { width, height } = img;\n\n  // Check dimensions\n  if (width > MAX_DIMENSION || height > MAX_DIMENSION) {\n    const scale = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);\n    width = Math.floor(width * scale);\n    height = Math.floor(height * scale);\n    console.warn(`Image resized to ${width}x${height} (max ${MAX_DIMENSION}px)`);\n  }\n\n  // Draw to canvas to get ImageData\n  const canvas = document.createElement('canvas');\n  canvas.width = width;\n  canvas.height = height;\n\n  const ctx = canvas.getContext('2d', { willReadFrequently: true });\n  if (!ctx) {\n    throw new Error('Failed to get 2D context');\n  }\n\n  ctx.drawImage(img, 0, 0, width, height);\n  return ctx.getImageData(0, 0, width, height);\n}\n\n/**\n * Load image from clipboard paste event.\n */\nexport async function loadImageFromClipboard(event: ClipboardEvent): Promise<ImageData | null> {\n  const items = event.clipboardData?.items;\n  if (!items) return null;\n\n  for (const item of items) {\n    if (item.type.match(/^image\\//)) {\n      const file = item.getAsFile();\n      if (file) {\n        return loadImageFile(file);\n      }\n    }\n  }\n\n  return null;\n}\n","/**\n * PNG export utilities for generated PBR maps.\n */\n\n/**\n * Convert ImageData to a PNG Blob.\n */\nexport function imageDataToBlob(imageData: ImageData): Promise<Blob> {\n  const canvas = document.createElement('canvas');\n  canvas.width = imageData.width;\n  canvas.height = imageData.height;\n\n  const ctx = canvas.getContext('2d');\n  if (!ctx) {\n    throw new Error('Failed to get 2D context');\n  }\n\n  ctx.putImageData(imageData, 0, 0);\n\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(\n      (blob) => {\n        if (blob) {\n          resolve(blob);\n        } else {\n          reject(new Error('Failed to create blob'));\n        }\n      },\n      'image/png',\n      1.0\n    );\n  });\n}\n\n/**\n * Download ImageData as a PNG file.\n */\nexport async function downloadImageData(imageData: ImageData, filename: string): Promise<void> {\n  const blob = await imageDataToBlob(imageData);\n  downloadBlob(blob, filename);\n}\n\n/**\n * Download a Blob as a file.\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = filename;\n  a.click();\n  URL.revokeObjectURL(url);\n}\n\n/**\n * Render ImageData to a canvas element.\n */\nexport function renderToCanvas(imageData: ImageData, canvas: HTMLCanvasElement): void {\n  canvas.width = imageData.width;\n  canvas.height = imageData.height;\n\n  const ctx = canvas.getContext('2d');\n  if (!ctx) {\n    throw new Error('Failed to get 2D context');\n  }\n\n  ctx.putImageData(imageData, 0, 0);\n}\n","/**\n * Progress bar component for AI inference.\n * Shows stage-based progress with estimated time remaining.\n */\n\n/** Progress stage information */\nexport interface ProgressStage {\n  name: string;\n  weight: number; // Relative weight for overall progress calculation\n}\n\n/** Default stages for AI inference */\nexport const DEFAULT_STAGES: ProgressStage[] = [\n  { name: 'preprocessing', weight: 0.1 },\n  { name: 'inference', weight: 0.7 },\n  { name: 'postprocessing', weight: 0.1 },\n  { name: 'complete', weight: 0.1 },\n];\n\n/**\n * Progress bar manager.\n */\nexport class ProgressBar {\n  private container: HTMLElement;\n  private bar: HTMLElement;\n  private label: HTMLElement;\n  private detail: HTMLElement;\n  private startTime: number = 0;\n  private stages: ProgressStage[];\n  private isVisible: boolean = false;\n\n  constructor(parentElement: HTMLElement, stages: ProgressStage[] = DEFAULT_STAGES) {\n    this.stages = stages;\n\n    // Create container\n    this.container = document.createElement('div');\n    this.container.className = 'progress-container';\n    this.container.style.cssText = `\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      padding: 16px;\n      background: #2a2a4a;\n      border-radius: 8px;\n      margin: 16px 0;\n    `;\n\n    // Create label\n    this.label = document.createElement('div');\n    this.label.className = 'progress-label';\n    this.label.style.cssText = `\n      display: flex;\n      justify-content: space-between;\n      font-size: 14px;\n      color: #ccc;\n    `;\n    this.label.innerHTML = '<span class=\"stage\">Initializing...</span><span class=\"percent\">0%</span>';\n\n    // Create bar track\n    const track = document.createElement('div');\n    track.className = 'progress-track';\n    track.style.cssText = `\n      height: 8px;\n      background: #3a3a5a;\n      border-radius: 4px;\n      overflow: hidden;\n    `;\n\n    // Create bar fill\n    this.bar = document.createElement('div');\n    this.bar.className = 'progress-bar';\n    this.bar.style.cssText = `\n      height: 100%;\n      width: 0%;\n      background: linear-gradient(90deg, #5a5aff, #8a8aff);\n      border-radius: 4px;\n      transition: width 0.2s ease-out;\n    `;\n\n    track.appendChild(this.bar);\n\n    // Create detail text\n    this.detail = document.createElement('div');\n    this.detail.className = 'progress-detail';\n    this.detail.style.cssText = `\n      font-size: 12px;\n      color: #888;\n      text-align: center;\n    `;\n\n    // Assemble\n    this.container.appendChild(this.label);\n    this.container.appendChild(track);\n    this.container.appendChild(this.detail);\n    parentElement.appendChild(this.container);\n  }\n\n  /**\n   * Show the progress bar and start timing.\n   */\n  show(): void {\n    this.startTime = performance.now();\n    this.container.style.display = 'flex';\n    this.isVisible = true;\n    this.update('preprocessing', 0);\n  }\n\n  /**\n   * Hide the progress bar.\n   */\n  hide(): void {\n    this.container.style.display = 'none';\n    this.isVisible = false;\n  }\n\n  /**\n   * Update progress.\n   *\n   * @param stage - Current stage name\n   * @param stageProgress - Progress within current stage (0-1)\n   */\n  update(stage: string, stageProgress: number): void {\n    if (!this.isVisible) return;\n\n    // Calculate overall progress based on stage weights\n    let overallProgress = 0;\n    let foundStage = false;\n\n    for (const s of this.stages) {\n      if (s.name === stage) {\n        overallProgress += s.weight * stageProgress;\n        foundStage = true;\n        break;\n      }\n      overallProgress += s.weight;\n    }\n\n    if (!foundStage) {\n      // Unknown stage, use raw progress\n      overallProgress = stageProgress;\n    }\n\n    const percent = Math.round(overallProgress * 100);\n\n    // Update bar\n    this.bar.style.width = `${percent}%`;\n\n    // Update label\n    const stageLabel = this.formatStageName(stage);\n    const percentLabel = `${percent}%`;\n    this.label.innerHTML = `<span class=\"stage\">${stageLabel}</span><span class=\"percent\">${percentLabel}</span>`;\n\n    // Update detail with elapsed time\n    const elapsed = performance.now() - this.startTime;\n    const elapsedStr = this.formatTime(elapsed);\n\n    if (overallProgress > 0.1 && overallProgress < 1) {\n      // Estimate remaining time\n      const estimatedTotal = elapsed / overallProgress;\n      const remaining = estimatedTotal - elapsed;\n      const remainingStr = this.formatTime(remaining);\n      this.detail.textContent = `Elapsed: ${elapsedStr} | Remaining: ~${remainingStr}`;\n    } else {\n      this.detail.textContent = `Elapsed: ${elapsedStr}`;\n    }\n  }\n\n  /**\n   * Mark as complete with total time.\n   */\n  complete(): void {\n    const elapsed = performance.now() - this.startTime;\n    const elapsedStr = this.formatTime(elapsed);\n\n    this.bar.style.width = '100%';\n    this.label.innerHTML = '<span class=\"stage\">Complete</span><span class=\"percent\">100%</span>';\n    this.detail.textContent = `Total time: ${elapsedStr}`;\n\n    // Change bar color to green\n    this.bar.style.background = 'linear-gradient(90deg, #4a8a4a, #6aca6a)';\n\n    // Hide after delay\n    setTimeout(() => this.hide(), 2000);\n  }\n\n  /**\n   * Show error state.\n   */\n  error(message: string): void {\n    this.bar.style.background = '#aa4a4a';\n    this.label.innerHTML = '<span class=\"stage\">Error</span><span class=\"percent\">--</span>';\n    this.detail.textContent = message;\n    this.detail.style.color = '#f88';\n  }\n\n  /**\n   * Reset to initial state.\n   */\n  reset(): void {\n    this.bar.style.width = '0%';\n    this.bar.style.background = 'linear-gradient(90deg, #5a5aff, #8a8aff)';\n    this.detail.style.color = '#888';\n    this.hide();\n  }\n\n  /**\n   * Remove the component from DOM.\n   */\n  destroy(): void {\n    this.container.remove();\n  }\n\n  // Helpers\n\n  private formatStageName(stage: string): string {\n    switch (stage) {\n      case 'preprocessing':\n        return 'Preprocessing image...';\n      case 'inference':\n        return 'Running AI inference...';\n      case 'postprocessing':\n        return 'Post-processing output...';\n      case 'complete':\n        return 'Complete';\n      default:\n        return stage.charAt(0).toUpperCase() + stage.slice(1) + '...';\n    }\n  }\n\n  private formatTime(ms: number): string {\n    if (ms < 1000) {\n      return `${Math.round(ms)}ms`;\n    }\n    const seconds = ms / 1000;\n    if (seconds < 60) {\n      return `${seconds.toFixed(1)}s`;\n    }\n    const minutes = Math.floor(seconds / 60);\n    const remainingSeconds = Math.round(seconds % 60);\n    return `${minutes}m ${remainingSeconds}s`;\n  }\n}\n\n/**\n * Create a progress bar callback for use with AI generators.\n */\nexport function createProgressCallback(progressBar: ProgressBar): (stage: string, progress: number) => void {\n  return (stage: string, progress: number) => {\n    progressBar.update(stage, progress);\n  };\n}\n","/**\n * Channel-specific controls for unified PBR generation.\n * Normal map supports AI (DeepBump), other channels use traditional algorithms.\n */\n\nimport type {\n  UnifiedPBRConfig,\n  GenerationMethod,\n  HeightMethod,\n} from '../generators/unified.ts';\nimport { QUALITY_PRESETS } from '../generators/ai/index.ts';\n\n/**\n * Event for configuration changes\n */\nexport interface ConfigChangeEvent {\n  config: Partial<UnifiedPBRConfig>;\n}\n\n/**\n * Channel controls component\n */\nexport class ChannelControls {\n  private container: HTMLElement;\n  private config: UnifiedPBRConfig;\n  private aiAvailable: boolean;\n  private onChangeCallback: ((event: ConfigChangeEvent) => void) | null = null;\n\n  constructor(\n    container: HTMLElement,\n    initialConfig: UnifiedPBRConfig,\n    aiAvailable: boolean = false\n  ) {\n    this.container = container;\n    this.config = { ...initialConfig };\n    this.aiAvailable = aiAvailable;\n    this.render();\n  }\n\n  /**\n   * Set change callback\n   */\n  onChange(callback: (event: ConfigChangeEvent) => void): void {\n    this.onChangeCallback = callback;\n  }\n\n  /**\n   * Update AI availability (call after initialization)\n   */\n  setAIAvailable(available: boolean): void {\n    this.aiAvailable = available;\n    this.render();\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): UnifiedPBRConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Set configuration externally (updates UI to match)\n   */\n  setConfig(config: Partial<UnifiedPBRConfig>): void {\n    this.config = { ...this.config, ...config };\n    this.render();\n  }\n\n  /**\n   * Render the controls\n   */\n  private render(): void {\n    this.container.innerHTML = '';\n    this.container.className = 'channel-controls';\n    this.container.style.cssText = `\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n      gap: 15px;\n      padding: 15px;\n      background: #2a3a4a;\n      border-radius: 8px;\n      margin-bottom: 20px;\n    `;\n\n    // Albedo - traditional only (info display)\n    this.container.appendChild(\n      this.createInfoDisplay('Albedo', 'Shadow/Highlight Reduction')\n    );\n\n    // Normal method (AI available via DeepBump)\n    this.container.appendChild(\n      this.createMethodSelect(\n        'Normal Map',\n        'normalMethod',\n        this.config.normalMethod,\n        this.aiAvailable\n      )\n    );\n\n    // Roughness - traditional only (info display)\n    this.container.appendChild(\n      this.createInfoDisplay('Roughness', 'Variance-based')\n    );\n\n    // Metallic - traditional only (info display)\n    this.container.appendChild(\n      this.createInfoDisplay('Metallic', 'Color Heuristics')\n    );\n\n    // Height method\n    this.container.appendChild(\n      this.createHeightSelect()\n    );\n\n    // AI Quality preset (only if AI is available)\n    if (this.aiAvailable) {\n      this.container.appendChild(\n        this.createQualitySelect()\n      );\n    }\n  }\n\n  /**\n   * Create info display for channels with only traditional method\n   */\n  private createInfoDisplay(label: string, method: string): HTMLElement {\n    const group = document.createElement('div');\n    group.className = 'control-group';\n    group.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    `;\n\n    const labelEl = document.createElement('label');\n    labelEl.textContent = label;\n    labelEl.style.cssText = 'font-size: 12px; color: #aaa;';\n\n    const display = document.createElement('div');\n    display.style.cssText = `\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: #8a8aaa;\n      border-radius: 4px;\n      font-size: 14px;\n    `;\n    display.textContent = method;\n\n    group.appendChild(labelEl);\n    group.appendChild(display);\n    return group;\n  }\n\n  /**\n   * Create method select for normal map (only channel with AI support)\n   */\n  private createMethodSelect(\n    label: string,\n    _field: 'normalMethod',\n    value: GenerationMethod,\n    aiEnabled: boolean\n  ): HTMLElement {\n    const group = document.createElement('div');\n    group.className = 'control-group';\n    group.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    `;\n\n    const labelEl = document.createElement('label');\n    labelEl.textContent = label;\n    labelEl.style.cssText = 'font-size: 12px; color: #aaa;';\n\n    const select = document.createElement('select');\n    select.style.cssText = `\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    `;\n\n    // Traditional option (always available)\n    const traditionalOption = document.createElement('option');\n    traditionalOption.value = 'traditional';\n    traditionalOption.textContent = 'Traditional';\n    if (value === 'traditional') traditionalOption.selected = true;\n    select.appendChild(traditionalOption);\n\n    // AI option (if available)\n    const aiOption = document.createElement('option');\n    aiOption.value = 'ai';\n    aiOption.textContent = aiEnabled ? 'AI Enhanced' : 'AI (unavailable)';\n    aiOption.disabled = !aiEnabled;\n    if (value === 'ai') aiOption.selected = true;\n    select.appendChild(aiOption);\n\n    select.addEventListener('change', () => {\n      this.config.normalMethod = select.value as GenerationMethod;\n      this.notifyChange({ normalMethod: select.value as GenerationMethod });\n    });\n\n    group.appendChild(labelEl);\n    group.appendChild(select);\n    return group;\n  }\n\n  /**\n   * Create height method select\n   */\n  private createHeightSelect(): HTMLElement {\n    const group = document.createElement('div');\n    group.className = 'control-group';\n    group.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    `;\n\n    const labelEl = document.createElement('label');\n    labelEl.textContent = 'Height Map';\n    labelEl.style.cssText = 'font-size: 12px; color: #aaa;';\n\n    const select = document.createElement('select');\n    select.style.cssText = `\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    `;\n\n    const options: { value: HeightMethod; label: string }[] = [\n      { value: 'none', label: 'None' },\n      { value: 'integrated', label: 'From Normal (Integrated)' },\n      { value: 'sobel', label: 'From Color (Sobel)' },\n    ];\n\n    for (const opt of options) {\n      const optEl = document.createElement('option');\n      optEl.value = opt.value;\n      optEl.textContent = opt.label;\n      if (this.config.heightMethod === opt.value) optEl.selected = true;\n      select.appendChild(optEl);\n    }\n\n    select.addEventListener('change', () => {\n      this.config.heightMethod = select.value as HeightMethod;\n      this.notifyChange({ heightMethod: select.value as HeightMethod });\n    });\n\n    group.appendChild(labelEl);\n    group.appendChild(select);\n    return group;\n  }\n\n  /**\n   * Create AI quality preset select\n   */\n  private createQualitySelect(): HTMLElement {\n    const group = document.createElement('div');\n    group.className = 'control-group';\n    group.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    `;\n\n    const labelEl = document.createElement('label');\n    labelEl.textContent = 'AI Quality';\n    labelEl.style.cssText = 'font-size: 12px; color: #aaa;';\n\n    const select = document.createElement('select');\n    select.style.cssText = `\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    `;\n\n    for (const [key, preset] of Object.entries(QUALITY_PRESETS)) {\n      const optEl = document.createElement('option');\n      optEl.value = key;\n      optEl.textContent = `${preset.name} - ${preset.expectedTime}`;\n      if (this.config.aiQualityPreset.name === preset.name) optEl.selected = true;\n      select.appendChild(optEl);\n    }\n\n    select.addEventListener('change', () => {\n      const presetKey = select.value as keyof typeof QUALITY_PRESETS;\n      this.config.aiQualityPreset = QUALITY_PRESETS[presetKey];\n      this.notifyChange({ aiQualityPreset: QUALITY_PRESETS[presetKey] });\n    });\n\n    group.appendChild(labelEl);\n    group.appendChild(select);\n    return group;\n  }\n\n  /**\n   * Notify change callback\n   */\n  private notifyChange(partial: Partial<UnifiedPBRConfig>): void {\n    if (this.onChangeCallback) {\n      this.onChangeCallback({ config: partial });\n    }\n  }\n}\n\n/**\n * Create a styled container for channel controls\n */\nexport function createChannelControlsContainer(): HTMLElement {\n  const container = document.createElement('div');\n  container.id = 'channelControls';\n  container.className = 'hidden';\n  return container;\n}\n","/**\n * Controls for PBR material preview.\n * Provides UI for geometry selection, lighting, and texture settings.\n */\n\nimport type { PreviewConfig, PreviewGeometryType } from '../preview/index.ts';\n\n/**\n * Event for preview configuration changes\n */\nexport interface PreviewConfigChangeEvent {\n  config: Partial<PreviewConfig>;\n}\n\n/**\n * Preview controls component\n */\nexport class PreviewControls {\n  private container: HTMLElement;\n  private config: PreviewConfig;\n  private onChangeCallback: ((event: PreviewConfigChangeEvent) => void) | null = null;\n\n  constructor(container: HTMLElement, initialConfig: PreviewConfig) {\n    this.container = container;\n    this.config = { ...initialConfig };\n    this.render();\n  }\n\n  /**\n   * Set change callback\n   */\n  onChange(callback: (event: PreviewConfigChangeEvent) => void): void {\n    this.onChangeCallback = callback;\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): PreviewConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Render the controls\n   */\n  private render(): void {\n    this.container.innerHTML = '';\n    this.container.className = 'preview-controls';\n    this.container.style.cssText = `\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n      gap: 10px;\n      padding: 10px;\n      background: #2a2a4a;\n      border-radius: 8px;\n      margin-bottom: 10px;\n    `;\n\n    // Geometry select\n    this.container.appendChild(this.createGeometrySelect());\n\n    // Auto-rotate toggle\n    this.container.appendChild(this.createAutoRotateToggle());\n\n    // Tiling X\n    this.container.appendChild(\n      this.createSlider('Tiling X', 'tilingX', 1, 8, 1, this.config.tiling[0])\n    );\n\n    // Tiling Y\n    this.container.appendChild(\n      this.createSlider('Tiling Y', 'tilingY', 1, 8, 1, this.config.tiling[1])\n    );\n\n    // Light intensity\n    this.container.appendChild(\n      this.createSlider('Light', 'lightIntensity', 0, 5, 0.1, this.config.lightIntensity)\n    );\n\n    // Ambient intensity\n    this.container.appendChild(\n      this.createSlider('Ambient', 'ambientIntensity', 0, 2, 0.1, this.config.ambientIntensity)\n    );\n  }\n\n  /**\n   * Create geometry select\n   */\n  private createGeometrySelect(): HTMLElement {\n    const group = document.createElement('div');\n    group.style.cssText = 'display: flex; flex-direction: column; gap: 3px;';\n\n    const label = document.createElement('label');\n    label.textContent = 'Shape';\n    label.style.cssText = 'font-size: 11px; color: #888;';\n\n    const select = document.createElement('select');\n    select.style.cssText = `\n      padding: 6px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 12px;\n    `;\n\n    const geometries: { value: PreviewGeometryType; label: string }[] = [\n      { value: 'sphere', label: 'Sphere' },\n      { value: 'cube', label: 'Cube' },\n      { value: 'plane', label: 'Plane' },\n    ];\n\n    for (const geom of geometries) {\n      const opt = document.createElement('option');\n      opt.value = geom.value;\n      opt.textContent = geom.label;\n      if (this.config.geometry === geom.value) opt.selected = true;\n      select.appendChild(opt);\n    }\n\n    select.addEventListener('change', () => {\n      this.config.geometry = select.value as PreviewGeometryType;\n      this.notifyChange({ geometry: this.config.geometry });\n    });\n\n    group.appendChild(label);\n    group.appendChild(select);\n    return group;\n  }\n\n  /**\n   * Create auto-rotate toggle\n   */\n  private createAutoRotateToggle(): HTMLElement {\n    const group = document.createElement('div');\n    group.style.cssText = 'display: flex; flex-direction: column; gap: 3px;';\n\n    const label = document.createElement('label');\n    label.textContent = 'Auto-Rotate';\n    label.style.cssText = 'font-size: 11px; color: #888;';\n\n    const checkbox = document.createElement('input');\n    checkbox.type = 'checkbox';\n    checkbox.checked = this.config.autoRotate;\n    checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';\n\n    checkbox.addEventListener('change', () => {\n      this.config.autoRotate = checkbox.checked;\n      this.notifyChange({ autoRotate: this.config.autoRotate });\n    });\n\n    group.appendChild(label);\n    group.appendChild(checkbox);\n    return group;\n  }\n\n  /**\n   * Create a slider control\n   */\n  private createSlider(\n    label: string,\n    field: string,\n    min: number,\n    max: number,\n    step: number,\n    value: number\n  ): HTMLElement {\n    const group = document.createElement('div');\n    group.style.cssText = 'display: flex; flex-direction: column; gap: 3px;';\n\n    const labelEl = document.createElement('label');\n    labelEl.textContent = `${label}: ${value.toFixed(1)}`;\n    labelEl.style.cssText = 'font-size: 11px; color: #888;';\n\n    const input = document.createElement('input');\n    input.type = 'range';\n    input.min = String(min);\n    input.max = String(max);\n    input.step = String(step);\n    input.value = String(value);\n    input.style.cssText = 'width: 100%;';\n\n    input.addEventListener('input', () => {\n      const newValue = parseFloat(input.value);\n      labelEl.textContent = `${label}: ${newValue.toFixed(1)}`;\n\n      // Update config based on field\n      if (field === 'tilingX') {\n        this.config.tiling = [newValue, this.config.tiling[1]];\n        this.notifyChange({ tiling: this.config.tiling });\n      } else if (field === 'tilingY') {\n        this.config.tiling = [this.config.tiling[0], newValue];\n        this.notifyChange({ tiling: this.config.tiling });\n      } else if (field === 'lightIntensity') {\n        this.config.lightIntensity = newValue;\n        this.notifyChange({ lightIntensity: newValue });\n      } else if (field === 'ambientIntensity') {\n        this.config.ambientIntensity = newValue;\n        this.notifyChange({ ambientIntensity: newValue });\n      }\n    });\n\n    group.appendChild(labelEl);\n    group.appendChild(input);\n    return group;\n  }\n\n  /**\n   * Notify change callback\n   */\n  private notifyChange(partial: Partial<PreviewConfig>): void {\n    if (this.onChangeCallback) {\n      this.onChangeCallback({ config: partial });\n    }\n  }\n}\n\n/**\n * Create a styled container for preview controls\n */\nexport function createPreviewControlsContainer(): HTMLElement {\n  const container = document.createElement('div');\n  container.id = 'previewControls';\n  return container;\n}\n","/**\n * Type definitions for 3dverse integration.\n * Covers authentication, asset management, and Livelink communication.\n */\n\n/**\n * 3dverse authentication configuration\n */\nexport interface ThreeDverseAuthConfig {\n  /** API base URL */\n  apiUrl: string;\n  /** OAuth client ID (if using OAuth flow) */\n  clientId?: string;\n  /** Public API key (if using API key auth) */\n  publicApiKey?: string;\n  /** User API key (if using direct API key) */\n  userApiKey?: string;\n}\n\n/**\n * Authentication token response\n */\nexport interface AuthTokenResponse {\n  /** Access token */\n  accessToken: string;\n  /** Token type (Bearer) */\n  tokenType: string;\n  /** Expiration time in seconds */\n  expiresIn: number;\n  /** Refresh token (if available) */\n  refreshToken?: string;\n}\n\n/**\n * Authenticated user information\n */\nexport interface AuthenticatedUser {\n  /** User ID */\n  userId: string;\n  /** User email */\n  email?: string;\n  /** Display name */\n  displayName?: string;\n  /** Token expiration timestamp */\n  expiresAt: number;\n}\n\n/**\n * Authentication state\n */\nexport type AuthState = 'unauthenticated' | 'authenticating' | 'authenticated' | 'error';\n\n/**\n * 3dverse folder structure\n */\nexport interface ThreeDverseFolder {\n  /** Folder UUID */\n  uuid: string;\n  /** Folder name */\n  name: string;\n  /** Parent folder UUID (null for root) */\n  parentUuid: string | null;\n  /** Creation timestamp */\n  createdAt: string;\n  /** Last modification timestamp */\n  updatedAt: string;\n}\n\n/**\n * 3dverse asset types\n */\nexport type AssetType = 'texture' | 'material' | 'mesh' | 'scene' | 'animation' | 'shader';\n\n/**\n * 3dverse asset descriptor\n */\nexport interface ThreeDverseAsset {\n  /** Asset UUID */\n  uuid: string;\n  /** Asset name */\n  name: string;\n  /** Asset type */\n  type: AssetType;\n  /** Folder UUID */\n  folderUuid: string;\n  /** Creation timestamp */\n  createdAt: string;\n  /** Last modification timestamp */\n  updatedAt: string;\n  /** Asset-specific metadata */\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * Texture asset descriptor\n */\nexport interface TextureAsset extends ThreeDverseAsset {\n  type: 'texture';\n  metadata: {\n    width: number;\n    height: number;\n    format: string;\n    mipLevels?: number;\n  };\n}\n\n/**\n * Material asset descriptor\n */\nexport interface MaterialAsset extends ThreeDverseAsset {\n  type: 'material';\n  metadata: {\n    shaderRef: string;\n    dataJson: Record<string, unknown>;\n    constantsJson?: Record<string, unknown>;\n  };\n}\n\n/**\n * Upload job status\n */\nexport type UploadJobStatus = 'pending' | 'processing' | 'complete' | 'failed';\n\n/**\n * Source file upload job\n */\nexport interface UploadJob {\n  /** Job UUID */\n  jobId: string;\n  /** Original filename */\n  filename: string;\n  /** Job status */\n  status: UploadJobStatus;\n  /** Progress percentage (0-100) */\n  progress: number;\n  /** Resulting asset UUID (when complete) */\n  assetUuid?: string;\n  /** Error message (when failed) */\n  errorMessage?: string;\n}\n\n/**\n * PBR texture asset references\n */\nexport interface PBRTextureAssets {\n  /** Basecolor/albedo texture UUID */\n  basecolor: string;\n  /** Normal map texture UUID */\n  normal: string;\n  /** Roughness texture UUID */\n  roughness: string;\n  /** Metallic texture UUID */\n  metallic: string;\n  /** Height map texture UUID (optional) */\n  height?: string;\n}\n\n/**\n * Material creation parameters\n */\nexport interface MaterialCreateParams {\n  /** Material name */\n  name: string;\n  /** Folder UUID for the material */\n  folderUuid: string;\n  /** Shader reference UUID */\n  shaderRef?: string;\n  /** PBR texture references */\n  textures: PBRTextureAssets;\n  /** Additional material properties */\n  properties?: {\n    /** Roughness multiplier */\n    roughnessFactor?: number;\n    /** Metallic multiplier */\n    metallicFactor?: number;\n    /** Normal scale */\n    normalScale?: number;\n    /** UV tiling */\n    tiling?: [number, number];\n  };\n}\n\n/**\n * Livelink entity descriptor\n */\nexport interface LivelinkEntity {\n  /** Runtime entity ID */\n  rtid: string;\n  /** Entity name */\n  name: string;\n  /** Entity components */\n  components: string[];\n  /** Has material_ref component */\n  hasMaterialRef: boolean;\n}\n\n/**\n * Upload progress event\n */\nexport interface UploadProgressEvent {\n  /** Channel being uploaded */\n  channel: 'basecolor' | 'normal' | 'roughness' | 'metallic' | 'height';\n  /** Upload progress (0-1) */\n  progress: number;\n  /** Status message */\n  status: string;\n  /** Job ID */\n  jobId?: string;\n}\n\n/**\n * Upload complete event\n */\nexport interface UploadCompleteEvent {\n  /** All texture asset UUIDs */\n  textures: PBRTextureAssets;\n  /** Created material UUID */\n  materialUuid?: string;\n}\n\n/**\n * 3dverse API error\n */\nexport interface ThreeDverseApiError {\n  /** Error code */\n  code: string;\n  /** Error message */\n  message: string;\n  /** HTTP status code */\n  statusCode: number;\n  /** Additional error details */\n  details?: Record<string, unknown>;\n}\n\n/**\n * 3dverse error codes\n */\nexport enum ThreeDverseErrorCode {\n  UNAUTHORIZED = 'UNAUTHORIZED',\n  FORBIDDEN = 'FORBIDDEN',\n  NOT_FOUND = 'NOT_FOUND',\n  RATE_LIMITED = 'RATE_LIMITED',\n  UPLOAD_FAILED = 'UPLOAD_FAILED',\n  CONVERSION_FAILED = 'CONVERSION_FAILED',\n  MATERIAL_CREATE_FAILED = 'MATERIAL_CREATE_FAILED',\n  LIVELINK_ERROR = 'LIVELINK_ERROR',\n  NETWORK_ERROR = 'NETWORK_ERROR',\n  UNKNOWN = 'UNKNOWN',\n}\n\n/**\n * 3dverse error class\n */\nexport class ThreeDverseError extends Error {\n  constructor(\n    message: string,\n    public readonly code: ThreeDverseErrorCode,\n    public readonly statusCode?: number,\n    public readonly recoverable: boolean = false,\n    public readonly suggestion?: string\n  ) {\n    super(message);\n    this.name = 'ThreeDverseError';\n  }\n}\n","/**\n * 3dverse authentication module.\n * Handles API key authentication and token management.\n *\n * Note: Currently implements simple API key authentication.\n * OAuth flow can be added later if needed.\n */\n\nimport {\n  type ThreeDverseAuthConfig,\n  type AuthenticatedUser,\n  type AuthState,\n  ThreeDverseError,\n  ThreeDverseErrorCode,\n} from '../types/threedverse.ts';\n\n/**\n * Default 3dverse API URL\n */\nconst DEFAULT_API_URL = 'https://api.3dverse.com/app/v1';\n\n/**\n * Local storage key for persisted auth\n */\nconst AUTH_STORAGE_KEY = 'pbr_gen_3dverse_auth';\n\n/**\n * Auth state change callback type\n */\nexport type AuthStateCallback = (state: AuthState, user: AuthenticatedUser | null) => void;\n\n/**\n * 3dverse authentication manager.\n * Manages authentication state and provides auth headers for API calls.\n */\nexport class ThreeDverseAuth {\n  private config: ThreeDverseAuthConfig;\n  private userApiKey: string | null = null;\n  private user: AuthenticatedUser | null = null;\n  private state: AuthState = 'unauthenticated';\n  private stateCallbacks: Set<AuthStateCallback> = new Set();\n\n  constructor(config: Partial<ThreeDverseAuthConfig> = {}) {\n    this.config = {\n      apiUrl: config.apiUrl || DEFAULT_API_URL,\n      clientId: config.clientId,\n      publicApiKey: config.publicApiKey,\n      userApiKey: config.userApiKey,\n    };\n\n    // Try to restore from localStorage\n    this.restoreFromStorage();\n\n    // If config provides API key directly, use it\n    if (config.userApiKey) {\n      this.setApiKey(config.userApiKey);\n    }\n  }\n\n  /**\n   * Get current authentication state.\n   */\n  getState(): AuthState {\n    return this.state;\n  }\n\n  /**\n   * Get authenticated user info.\n   */\n  getUser(): AuthenticatedUser | null {\n    return this.user;\n  }\n\n  /**\n   * Check if authenticated.\n   */\n  isAuthenticated(): boolean {\n    return this.state === 'authenticated' && this.userApiKey !== null;\n  }\n\n  /**\n   * Subscribe to auth state changes.\n   */\n  onStateChange(callback: AuthStateCallback): () => void {\n    this.stateCallbacks.add(callback);\n    // Immediately call with current state\n    callback(this.state, this.user);\n    // Return unsubscribe function\n    return () => this.stateCallbacks.delete(callback);\n  }\n\n  /**\n   * Set API key for authentication.\n   * This is the simplest auth method for development.\n   */\n  setApiKey(apiKey: string): void {\n    this.userApiKey = apiKey;\n    this.user = {\n      userId: 'api-key-user',\n      displayName: 'API Key User',\n      expiresAt: Date.now() + 365 * 24 * 60 * 60 * 1000, // 1 year\n    };\n    this.setState('authenticated');\n    this.persistToStorage();\n  }\n\n  /**\n   * Validate the current API key by making a test request.\n   */\n  async validateApiKey(): Promise<boolean> {\n    if (!this.userApiKey) {\n      return false;\n    }\n\n    try {\n      this.setState('authenticating');\n\n      // Try to list root folders as a validation check\n      const response = await fetch(`${this.config.apiUrl}/folders`, {\n        method: 'GET',\n        headers: this.getAuthHeaders(),\n      });\n\n      if (response.ok) {\n        this.setState('authenticated');\n        return true;\n      } else if (response.status === 401) {\n        this.logout();\n        throw new ThreeDverseError(\n          'Invalid API key',\n          ThreeDverseErrorCode.UNAUTHORIZED,\n          401,\n          true,\n          'Please check your API key and try again'\n        );\n      } else {\n        throw new ThreeDverseError(\n          `API validation failed: ${response.status}`,\n          ThreeDverseErrorCode.UNKNOWN,\n          response.status,\n          true\n        );\n      }\n    } catch (err) {\n      if (err instanceof ThreeDverseError) {\n        throw err;\n      }\n      this.setState('error');\n      throw new ThreeDverseError(\n        'Network error during validation',\n        ThreeDverseErrorCode.NETWORK_ERROR,\n        undefined,\n        true,\n        'Check your internet connection'\n      );\n    }\n  }\n\n  /**\n   * Login with API key.\n   * Validates the key and updates auth state.\n   */\n  async loginWithApiKey(apiKey: string): Promise<void> {\n    this.setApiKey(apiKey);\n    await this.validateApiKey();\n  }\n\n  /**\n   * Logout and clear auth state.\n   */\n  logout(): void {\n    this.userApiKey = null;\n    this.user = null;\n    this.setState('unauthenticated');\n    this.clearStorage();\n  }\n\n  /**\n   * Get authorization headers for API requests.\n   */\n  getAuthHeaders(): Record<string, string> {\n    if (!this.userApiKey) {\n      throw new ThreeDverseError(\n        'Not authenticated',\n        ThreeDverseErrorCode.UNAUTHORIZED,\n        401,\n        true,\n        'Please login first'\n      );\n    }\n\n    return {\n      'api_key': this.userApiKey,\n    };\n  }\n\n  /**\n   * Get the API base URL.\n   */\n  getApiUrl(): string {\n    return this.config.apiUrl;\n  }\n\n  /**\n   * Make an authenticated API request.\n   */\n  async request<T>(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<T> {\n    if (!this.isAuthenticated()) {\n      throw new ThreeDverseError(\n        'Not authenticated',\n        ThreeDverseErrorCode.UNAUTHORIZED,\n        401,\n        true,\n        'Please login first'\n      );\n    }\n\n    const url = `${this.config.apiUrl}${endpoint}`;\n    const headers = {\n      ...this.getAuthHeaders(),\n      ...options.headers,\n    };\n\n    const response = await fetch(url, {\n      ...options,\n      headers,\n    });\n\n    if (!response.ok) {\n      await this.handleApiError(response);\n    }\n\n    // Handle 204 No Content\n    if (response.status === 204) {\n      return undefined as unknown as T;\n    }\n\n    return response.json();\n  }\n\n  /**\n   * Handle API error responses.\n   */\n  private async handleApiError(response: Response): Promise<never> {\n    let errorMessage = `API error: ${response.status}`;\n    let errorCode = ThreeDverseErrorCode.UNKNOWN;\n\n    try {\n      const errorData = await response.json();\n      errorMessage = errorData.message || errorMessage;\n    } catch {\n      // Response body not JSON\n    }\n\n    switch (response.status) {\n      case 401:\n        errorCode = ThreeDverseErrorCode.UNAUTHORIZED;\n        this.logout();\n        break;\n      case 403:\n        errorCode = ThreeDverseErrorCode.FORBIDDEN;\n        break;\n      case 404:\n        errorCode = ThreeDverseErrorCode.NOT_FOUND;\n        break;\n      case 429:\n        errorCode = ThreeDverseErrorCode.RATE_LIMITED;\n        break;\n    }\n\n    throw new ThreeDverseError(\n      errorMessage,\n      errorCode,\n      response.status,\n      response.status === 429 || response.status >= 500\n    );\n  }\n\n  /**\n   * Update auth state and notify listeners.\n   */\n  private setState(state: AuthState): void {\n    this.state = state;\n    for (const callback of this.stateCallbacks) {\n      callback(this.state, this.user);\n    }\n  }\n\n  /**\n   * Persist auth to localStorage.\n   */\n  private persistToStorage(): void {\n    if (this.userApiKey) {\n      try {\n        const data = {\n          apiKey: this.userApiKey,\n          user: this.user,\n        };\n        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));\n      } catch {\n        // Storage not available\n      }\n    }\n  }\n\n  /**\n   * Restore auth from localStorage.\n   */\n  private restoreFromStorage(): void {\n    try {\n      const stored = localStorage.getItem(AUTH_STORAGE_KEY);\n      if (stored) {\n        const data = JSON.parse(stored);\n        if (data.apiKey && data.user) {\n          this.userApiKey = data.apiKey;\n          this.user = data.user;\n          this.state = 'authenticated';\n        }\n      }\n    } catch {\n      // Storage not available or corrupted\n    }\n  }\n\n  /**\n   * Clear persisted auth.\n   */\n  private clearStorage(): void {\n    try {\n      localStorage.removeItem(AUTH_STORAGE_KEY);\n    } catch {\n      // Storage not available\n    }\n  }\n}\n\n/**\n * Singleton instance for global access.\n */\nlet authInstance: ThreeDverseAuth | null = null;\n\n/**\n * Get or create the auth singleton.\n */\nexport function getAuth(config?: Partial<ThreeDverseAuthConfig>): ThreeDverseAuth {\n  if (!authInstance) {\n    authInstance = new ThreeDverseAuth(config);\n  }\n  return authInstance;\n}\n\n/**\n * Reset the auth singleton (for testing).\n */\nexport function resetAuth(): void {\n  if (authInstance) {\n    authInstance.logout();\n  }\n  authInstance = null;\n}\n","/**\n * 3dverse folder browser.\n * Lists and navigates folders for asset organization.\n */\n\nimport { type ThreeDverseFolder, ThreeDverseError, ThreeDverseErrorCode } from '../types/threedverse.ts';\nimport { getAuth, type ThreeDverseAuth } from './auth.ts';\n\n/**\n * Folder API response - API returns array directly\n */\ninterface FolderApiResponse {\n  folder_id: string;\n  name: string;\n  subfolders: string[];\n  created_at: string;\n  updated_at?: string;\n}\n\n/**\n * Folder browser for navigating 3dverse asset folders.\n */\nexport class FolderBrowser {\n  private auth: ThreeDverseAuth;\n  private cachedFolders: Map<string, ThreeDverseFolder[]> = new Map();\n\n  constructor(auth?: ThreeDverseAuth) {\n    this.auth = auth || getAuth();\n  }\n\n  /**\n   * List folders in the root.\n   */\n  async listRootFolders(): Promise<ThreeDverseFolder[]> {\n    return this.listFolders();\n  }\n\n  /**\n   * List all folders (flat list).\n   * The API returns all folders, not hierarchical.\n   */\n  async listFolders(forceRefresh = false): Promise<ThreeDverseFolder[]> {\n    const cacheKey = 'all';\n\n    if (!forceRefresh && this.cachedFolders.has(cacheKey)) {\n      return this.cachedFolders.get(cacheKey)!;\n    }\n\n    try {\n      // API returns array directly, not { folders: [...] }\n      const response = await this.auth.request<FolderApiResponse[]>('/folders');\n\n      const folders: ThreeDverseFolder[] = (response || []).map((f) => ({\n        uuid: f.folder_id,\n        name: f.name,\n        parentUuid: null, // API doesn't provide parent info in list\n        createdAt: f.created_at,\n        updatedAt: f.updated_at || f.created_at, // Fallback to created_at if not provided\n      }));\n\n      // Sort by name\n      folders.sort((a, b) => a.name.localeCompare(b.name));\n\n      this.cachedFolders.set(cacheKey, folders);\n      return folders;\n    } catch (err) {\n      if (err instanceof ThreeDverseError) {\n        throw err;\n      }\n      throw new ThreeDverseError(\n        'Failed to list folders',\n        ThreeDverseErrorCode.NETWORK_ERROR,\n        undefined,\n        true\n      );\n    }\n  }\n\n  /**\n   * Get a specific folder by UUID.\n   */\n  async getFolder(folderUuid: string): Promise<ThreeDverseFolder> {\n    try {\n      const response = await this.auth.request<FolderApiResponse>(`/folders/${folderUuid}`);\n\n      return {\n        uuid: response.folder_id,\n        name: response.name,\n        parentUuid: null,\n        createdAt: response.created_at,\n        updatedAt: response.updated_at || response.created_at,\n      };\n    } catch (err) {\n      if (err instanceof ThreeDverseError) {\n        throw err;\n      }\n      throw new ThreeDverseError(\n        'Failed to get folder',\n        ThreeDverseErrorCode.NETWORK_ERROR,\n        undefined,\n        true\n      );\n    }\n  }\n\n  /**\n   * Create a new folder.\n   * @param name - Folder name\n   * @param parentUuid - Optional parent folder UUID to create subfolder\n   */\n  async createFolder(name: string, parentUuid?: string): Promise<ThreeDverseFolder> {\n    try {\n      // Use different endpoint for subfolder creation\n      const endpoint = parentUuid ? `/folders/${parentUuid}/folders` : '/folders';\n\n      const response = await this.auth.request<FolderApiResponse>(endpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ name }),\n      });\n\n      const folder: ThreeDverseFolder = {\n        uuid: response.folder_id,\n        name: response.name,\n        parentUuid: parentUuid || null,\n        createdAt: response.created_at,\n        updatedAt: response.updated_at || response.created_at,\n      };\n\n      // Invalidate cache\n      this.cachedFolders.clear();\n\n      return folder;\n    } catch (err) {\n      if (err instanceof ThreeDverseError) {\n        throw err;\n      }\n      throw new ThreeDverseError(\n        'Failed to create folder',\n        ThreeDverseErrorCode.NETWORK_ERROR,\n        undefined,\n        true\n      );\n    }\n  }\n\n  /**\n   * Clear the folder cache.\n   */\n  clearCache(): void {\n    this.cachedFolders.clear();\n  }\n\n  /**\n   * Search folders by name.\n   */\n  async searchFolders(query: string): Promise<ThreeDverseFolder[]> {\n    const allFolders = await this.listFolders();\n    const lowerQuery = query.toLowerCase();\n    return allFolders.filter((f) => f.name.toLowerCase().includes(lowerQuery));\n  }\n}\n\n/**\n * Singleton folder browser instance.\n */\nlet browserInstance: FolderBrowser | null = null;\n\n/**\n * Get or create the folder browser singleton.\n */\nexport function getFolderBrowser(): FolderBrowser {\n  if (!browserInstance) {\n    browserInstance = new FolderBrowser();\n  }\n  return browserInstance;\n}\n\n/**\n * Reset the folder browser singleton.\n */\nexport function resetFolderBrowser(): void {\n  if (browserInstance) {\n    browserInstance.clearCache();\n  }\n  browserInstance = null;\n}\n","/**\n * 3dverse texture uploader.\n * Handles uploading PBR texture maps to 3dverse via Asset API.\n */\n\nimport {\n  type UploadJob,\n  type UploadJobStatus,\n  type PBRTextureAssets,\n  type UploadProgressEvent,\n  ThreeDverseError,\n  ThreeDverseErrorCode,\n} from '../types/threedverse.ts';\nimport type { ExtendedPBRMaps } from '../generators/index.ts';\nimport { imageDataToBlob } from '../utils/export.ts';\nimport { getAuth, type ThreeDverseAuth } from './auth.ts';\n\n/**\n * Upload response from 3dverse API\n */\ninterface UploadResponse {\n  upload_task_id: string;\n}\n\n/**\n * Source file status response\n */\ninterface SourceFileStatusResponse {\n  source_file_id: string;\n  status: 'pending' | 'processing' | 'uploaded';\n  generated_assets?: Array<{\n    asset_id: string;\n    type: string;\n    name: string;\n  }>;\n  error?: string;\n}\n\n/**\n * Progress callback type\n */\nexport type UploadProgressCallback = (event: UploadProgressEvent) => void;\n\n/**\n * Polling interval for conversion status (ms)\n */\nconst POLL_INTERVAL = 2000;\n\n/**\n * Maximum polling attempts\n */\nconst MAX_POLL_ATTEMPTS = 60; // 2 minutes max\n\n/**\n * Texture uploader for 3dverse.\n */\nexport class TextureUploader {\n  private auth: ThreeDverseAuth;\n\n  constructor(auth?: ThreeDverseAuth) {\n    this.auth = auth || getAuth();\n  }\n\n  /**\n   * Upload all PBR maps to 3dverse.\n   * Uploads all files first, then waits for conversions to complete.\n   */\n  async uploadPBRMaps(\n    maps: ExtendedPBRMaps,\n    folderUuid: string,\n    baseName: string,\n    onProgress?: UploadProgressCallback\n  ): Promise<PBRTextureAssets> {\n    // Prepare upload tasks\n    const channels: Array<{\n      key: keyof PBRTextureAssets;\n      imageData: ImageData;\n      suffix: string;\n    }> = [\n      { key: 'basecolor', imageData: maps.basecolor, suffix: '_basecolor' },\n      { key: 'normal', imageData: maps.normal, suffix: '_normal' },\n      { key: 'roughness', imageData: maps.roughness, suffix: '_roughness' },\n      { key: 'metallic', imageData: maps.metallic, suffix: '_metallic' },\n    ];\n\n    // Add height if available\n    if (maps.height) {\n      channels.push({ key: 'height', imageData: maps.height, suffix: '_height' });\n    }\n\n    // Phase 1: Upload all files\n    const uploadJobs: Array<{\n      key: keyof PBRTextureAssets;\n      filename: string;\n      jobId: string;\n    }> = [];\n\n    for (const channel of channels) {\n      const filename = `${baseName}${channel.suffix}.png`;\n\n      onProgress?.({\n        channel: channel.key as UploadProgressEvent['channel'],\n        progress: 0,\n        status: `Uploading ${channel.key}...`,\n      });\n\n      try {\n        const uploadJob = await this.uploadTexture(\n          channel.imageData,\n          folderUuid,\n          filename\n        );\n\n        uploadJobs.push({\n          key: channel.key,\n          filename,\n          jobId: uploadJob.jobId,\n        });\n\n        onProgress?.({\n          channel: channel.key as UploadProgressEvent['channel'],\n          progress: 0.3,\n          status: `${channel.key} uploaded`,\n          jobId: uploadJob.jobId,\n        });\n      } catch (err) {\n        const message = err instanceof Error ? err.message : 'Upload failed';\n        throw new ThreeDverseError(\n          `Failed to upload ${channel.key}: ${message}`,\n          ThreeDverseErrorCode.UPLOAD_FAILED,\n          undefined,\n          true\n        );\n      }\n    }\n\n    // Phase 2: Wait for all conversions\n    // Notify UI that we're now converting\n    for (const job of uploadJobs) {\n      onProgress?.({\n        channel: job.key as UploadProgressEvent['channel'],\n        progress: 0.5,\n        status: 'Converting...',\n        jobId: job.jobId,\n      });\n    }\n\n    // Poll for all conversions to complete\n    const results: Partial<PBRTextureAssets> = {};\n    const pendingJobs = [...uploadJobs];\n    let pollAttempts = 0;\n\n    while (pendingJobs.length > 0 && pollAttempts < MAX_POLL_ATTEMPTS) {\n      // Wait before polling\n      await this.sleep(POLL_INTERVAL);\n      pollAttempts++;\n\n      // Check each pending job\n      for (let i = pendingJobs.length - 1; i >= 0; i--) {\n        const job = pendingJobs[i];\n\n        try {\n          const assetId = await this.findAssetInFolder(folderUuid, job.filename);\n\n          if (assetId) {\n            results[job.key] = assetId;\n            pendingJobs.splice(i, 1);\n\n            onProgress?.({\n              channel: job.key as UploadProgressEvent['channel'],\n              progress: 1,\n              status: 'Ready',\n              jobId: job.jobId,\n            });\n          }\n        } catch {\n          // Ignore errors during polling, keep trying\n        }\n      }\n    }\n\n    if (pendingJobs.length > 0) {\n      throw new ThreeDverseError(\n        `Conversion timed out for: ${pendingJobs.map(j => j.key).join(', ')}`,\n        ThreeDverseErrorCode.CONVERSION_FAILED,\n        undefined,\n        true\n      );\n    }\n\n    return results as PBRTextureAssets;\n  }\n\n  /**\n   * Upload a single texture to 3dverse.\n   */\n  async uploadTexture(\n    imageData: ImageData,\n    folderUuid: string,\n    filename: string\n  ): Promise<UploadJob> {\n    // Convert ImageData to Blob\n    const blob = await imageDataToBlob(imageData);\n\n    // Create FormData\n    const formData = new FormData();\n    formData.append('file', blob, filename);\n\n    // Upload to 3dverse\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/folders/${folderUuid}/source-files`, {\n      method: 'POST',\n      headers: this.auth.getAuthHeaders(),\n      body: formData,\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new ThreeDverseError(\n        `Upload failed: ${response.status} - ${errorText}`,\n        ThreeDverseErrorCode.UPLOAD_FAILED,\n        response.status\n      );\n    }\n\n    const data = await response.json() as UploadResponse;\n\n    return {\n      jobId: data.upload_task_id,\n      filename,\n      status: 'pending',\n      progress: 0,\n    };\n  }\n\n  /**\n   * Check the status of an upload job.\n   * Returns null if task not found (404) - caller should handle retry.\n   */\n  async getUploadStatus(jobId: string): Promise<UploadJob | null> {\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/upload-tasks/${jobId}`, {\n      method: 'GET',\n      headers: this.auth.getAuthHeaders(),\n    });\n\n    // 404 means task not found - might be still initializing or already completed\n    if (response.status === 404) {\n      return null;\n    }\n\n    if (!response.ok) {\n      throw new ThreeDverseError(\n        `Failed to get upload status: ${response.status}`,\n        ThreeDverseErrorCode.UPLOAD_FAILED,\n        response.status\n      );\n    }\n\n    const data = await response.json() as SourceFileStatusResponse;\n\n    let status: UploadJobStatus = 'pending';\n    let progress = 0;\n    let assetUuid: string | undefined;\n\n    switch (data.status) {\n      case 'pending':\n        status = 'pending';\n        progress = 0.25;\n        break;\n      case 'processing':\n        status = 'processing';\n        progress = 0.5;\n        break;\n      case 'uploaded':\n        status = 'complete';\n        progress = 1;\n        // Get the texture asset UUID from generated assets\n        assetUuid = data.generated_assets?.find(a => a.type === 'texture')?.asset_id;\n        break;\n    }\n\n    return {\n      jobId,\n      filename: '',\n      status,\n      progress,\n      assetUuid,\n      errorMessage: data.error,\n    };\n  }\n\n  /**\n   * Wait for a conversion to complete.\n   * Handles 404 (task not found) by retrying - task may still be initializing\n   * or may have completed very quickly.\n   */\n  async waitForConversion(jobId: string, folderUuid?: string, filename?: string): Promise<string> {\n    let attempts = 0;\n    let notFoundCount = 0;\n    const MAX_NOT_FOUND = 5; // Allow some 404s before giving up\n\n    // Initial delay - give the server time to index the task\n    await this.sleep(500);\n\n    while (attempts < MAX_POLL_ATTEMPTS) {\n      const status = await this.getUploadStatus(jobId);\n\n      // Handle task not found\n      if (status === null) {\n        notFoundCount++;\n        if (notFoundCount >= MAX_NOT_FOUND) {\n          // Task consistently not found - it may have completed instantly\n          // Try to find the asset by searching the folder\n          if (folderUuid && filename) {\n            const asset = await this.findAssetInFolder(folderUuid, filename);\n            if (asset) {\n              return asset;\n            }\n          }\n          throw new ThreeDverseError(\n            'Upload task not found - may have completed but asset not located',\n            ThreeDverseErrorCode.UPLOAD_FAILED,\n            404,\n            true,\n            'Try uploading again'\n          );\n        }\n        await this.sleep(POLL_INTERVAL);\n        attempts++;\n        continue;\n      }\n\n      if (status.status === 'complete' && status.assetUuid) {\n        return status.assetUuid;\n      }\n\n      if (status.status === 'failed') {\n        throw new ThreeDverseError(\n          `Conversion failed: ${status.errorMessage || 'Unknown error'}`,\n          ThreeDverseErrorCode.CONVERSION_FAILED,\n          undefined,\n          false\n        );\n      }\n\n      // Wait before polling again\n      await this.sleep(POLL_INTERVAL);\n      attempts++;\n    }\n\n    throw new ThreeDverseError(\n      'Conversion timed out',\n      ThreeDverseErrorCode.CONVERSION_FAILED,\n      undefined,\n      true,\n      'Try uploading a smaller texture'\n    );\n  }\n\n  /**\n   * Try to find an asset in a folder by filename.\n   * First checks source-files for conversion status, then textures.\n   */\n  async findAssetInFolder(folderUuid: string, filename: string): Promise<string | null> {\n    try {\n      const apiUrl = this.auth.getApiUrl();\n      const baseName = filename.replace(/\\.[^.]+$/, '');\n\n      // First, check source-files to see if our file was converted\n      const sourceResponse = await fetch(`${apiUrl}/folders/${folderUuid}/source-files`, {\n        method: 'GET',\n        headers: this.auth.getAuthHeaders(),\n      });\n\n      if (sourceResponse.ok) {\n        const sourceData = await sourceResponse.json();\n        const sourceFiles = Array.isArray(sourceData) ? sourceData : sourceData.source_files || [];\n\n        const sourceFile = sourceFiles.find((s: any) => s.name?.startsWith(baseName));\n        if (sourceFile) {\n          // Check if it has main_asset (the converted texture)\n          if (sourceFile.main_asset?.asset_id) {\n            return sourceFile.main_asset.asset_id;\n          }\n          // No asset yet - still converting\n          return null;\n        }\n      }\n\n      // Fallback: check textures directly\n      const response = await fetch(`${apiUrl}/folders/${folderUuid}/assets`, {\n        method: 'GET',\n        headers: this.auth.getAuthHeaders(),\n      });\n\n      if (!response.ok) {\n        return null;\n      }\n\n      const data = await response.json();\n      const assets = (data.textures || []) as Array<{ asset_id: string; name: string }>;\n\n      // Find asset whose name starts with our base name\n      const asset = assets.find(a => a.name.startsWith(baseName));\n      return asset?.asset_id || null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Sleep helper.\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n}\n\n/**\n * Singleton uploader instance.\n */\nlet uploaderInstance: TextureUploader | null = null;\n\n/**\n * Get or create the texture uploader singleton.\n */\nexport function getTextureUploader(): TextureUploader {\n  if (!uploaderInstance) {\n    uploaderInstance = new TextureUploader();\n  }\n  return uploaderInstance;\n}\n\n/**\n * Reset the texture uploader singleton.\n */\nexport function resetTextureUploader(): void {\n  uploaderInstance = null;\n}\n","/**\n * 3dverse material creator.\n * Creates PBR materials from uploaded textures.\n */\n\nimport {\n  type MaterialAsset,\n  type MaterialCreateParams,\n  type PBRTextureAssets,\n  ThreeDverseError,\n  ThreeDverseErrorCode,\n} from '../types/threedverse.ts';\nimport { getAuth, type ThreeDverseAuth } from './auth.ts';\n\n/**\n * Material API response\n */\ninterface MaterialApiResponse {\n  asset_id: string;\n  name: string;\n  type: string;\n  created_at: string;\n  updated_at: string;\n}\n\n/**\n * PBR shader UUIDs in 3dverse.\n */\nconst PBR_SHADER_OPAQUE = 'f2a549e5-4f72-4cef-a5ab-48873c209e0c';\n// Transparent shader UUID kept for potential future use\n// const PBR_SHADER_TRANSPARENT = 'a740058e-27a0-48e3-af37-70ae93cc0b67';\n\nconst DEFAULT_PBR_SHADER_UUID = PBR_SHADER_OPAQUE;\n\n/**\n * Material creator for 3dverse.\n */\nexport class MaterialCreator {\n  private auth: ThreeDverseAuth;\n\n  constructor(auth?: ThreeDverseAuth) {\n    this.auth = auth || getAuth();\n  }\n\n  /**\n   * Create a PBR material from texture assets.\n   */\n  async createPBRMaterial(params: MaterialCreateParams): Promise<MaterialAsset> {\n    const shaderRef = params.shaderRef || DEFAULT_PBR_SHADER_UUID;\n\n    // Build the material data JSON\n    const dataJson = this.buildMaterialDataJson(params.textures, params.properties);\n\n    // Build constants JSON for spec constants (e.g., parallax)\n    const constantsJson = this.buildConstantsJson(params.textures);\n\n    const body: Record<string, unknown> = {\n      name: params.name,\n      shaderRef: shaderRef,\n      dataJson: dataJson,\n      isDoubleSided: false,\n    };\n\n    // Add constantsJson if present (for parallax etc)\n    if (constantsJson) {\n      body.constantsJson = constantsJson;\n    }\n\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/folders/${params.folderUuid}/assets/materials`, {\n      method: 'POST',\n      headers: {\n        ...this.auth.getAuthHeaders(),\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new ThreeDverseError(\n        `Failed to create material: ${response.status} - ${errorText}`,\n        ThreeDverseErrorCode.MATERIAL_CREATE_FAILED,\n        response.status\n      );\n    }\n\n    const data = await response.json() as MaterialApiResponse;\n\n    return {\n      uuid: data.asset_id,\n      name: params.name, // Use the name we sent, API response only has asset_id\n      type: 'material',\n      folderUuid: params.folderUuid,\n      createdAt: data.created_at || new Date().toISOString(),\n      updatedAt: data.updated_at || new Date().toISOString(),\n      metadata: {\n        shaderRef,\n        dataJson,\n        constantsJson: constantsJson || undefined,\n      },\n    };\n  }\n\n  /**\n   * Build the material data JSON for 3dverse PBR shader.\n   */\n  private buildMaterialDataJson(\n    textures: PBRTextureAssets,\n    properties?: MaterialCreateParams['properties']\n  ): Record<string, unknown> {\n    const dataJson: Record<string, unknown> = {\n      // Texture references\n      albedoTexture: textures.basecolor,\n      normalTexture: textures.normal,\n      roughnessTexture: textures.roughness,\n      metallicTexture: textures.metallic,\n\n      // Multiplier factors (1 = use texture as-is)\n      albedo: [1, 1, 1, 1],\n      roughness: properties?.roughnessFactor ?? 1,\n      metallic: properties?.metallicFactor ?? 1,\n      normal: properties?.normalScale ?? 1,\n\n      // Emission (disabled by default)\n      emissive: [0, 0, 0],\n\n      // Alpha settings\n      alphaMode: 'OPAQUE',\n      alphaCutoff: 0.5,\n\n      // Double-sided\n      doubleSided: false,\n    };\n\n    // Add height texture if available\n    if (textures.height) {\n      dataJson.heightMapTexture = textures.height;\n    }\n\n    // Add tiling if specified\n    if (properties?.tiling) {\n      dataJson.textureTransform = {\n        scale: properties.tiling,\n        offset: [0, 0],\n        rotation: 0,\n      };\n    }\n\n    return dataJson;\n  }\n\n  /**\n   * Build constants JSON for shader spec constants.\n   */\n  private buildConstantsJson(textures: PBRTextureAssets): Record<string, unknown> | null {\n    const constants: Record<string, unknown> = {};\n\n    // Enable parallax if height texture is present\n    if (textures.height) {\n      constants.MATERIAL_PARALLAX = true;\n    }\n\n    return Object.keys(constants).length > 0 ? constants : null;\n  }\n\n  /**\n   * Update an existing material.\n   */\n  async updateMaterial(\n    materialUuid: string,\n    updates: Partial<MaterialCreateParams>\n  ): Promise<void> {\n    const body: Record<string, unknown> = {};\n\n    if (updates.name) {\n      body.name = updates.name;\n    }\n\n    if (updates.textures || updates.properties) {\n      // Need to rebuild the data JSON\n      // For simplicity, we fetch current material first\n      // In production, this should be optimized\n      body.data_json = this.buildMaterialDataJson(\n        updates.textures!,\n        updates.properties\n      );\n    }\n\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/assets/${materialUuid}`, {\n      method: 'PATCH',\n      headers: {\n        ...this.auth.getAuthHeaders(),\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new ThreeDverseError(\n        `Failed to update material: ${response.status} - ${errorText}`,\n        ThreeDverseErrorCode.MATERIAL_CREATE_FAILED,\n        response.status\n      );\n    }\n  }\n\n  /**\n   * Get a material by UUID.\n   */\n  async getMaterial(materialUuid: string): Promise<MaterialAsset> {\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/assets/${materialUuid}`, {\n      method: 'GET',\n      headers: this.auth.getAuthHeaders(),\n    });\n\n    if (!response.ok) {\n      throw new ThreeDverseError(\n        `Failed to get material: ${response.status}`,\n        ThreeDverseErrorCode.NOT_FOUND,\n        response.status\n      );\n    }\n\n    const data = await response.json();\n\n    return {\n      uuid: data.asset_id,\n      name: data.name,\n      type: 'material',\n      folderUuid: data.folder_id,\n      createdAt: data.created_at,\n      updatedAt: data.updated_at,\n      metadata: {\n        shaderRef: data.shader_ref,\n        dataJson: data.data_json,\n      },\n    };\n  }\n\n  /**\n   * Delete a material.\n   */\n  async deleteMaterial(materialUuid: string): Promise<void> {\n    const apiUrl = this.auth.getApiUrl();\n    const response = await fetch(`${apiUrl}/assets/${materialUuid}`, {\n      method: 'DELETE',\n      headers: this.auth.getAuthHeaders(),\n    });\n\n    if (!response.ok && response.status !== 404) {\n      throw new ThreeDverseError(\n        `Failed to delete material: ${response.status}`,\n        ThreeDverseErrorCode.UNKNOWN,\n        response.status\n      );\n    }\n  }\n}\n\n/**\n * Singleton creator instance.\n */\nlet creatorInstance: MaterialCreator | null = null;\n\n/**\n * Get or create the material creator singleton.\n */\nexport function getMaterialCreator(): MaterialCreator {\n  if (!creatorInstance) {\n    creatorInstance = new MaterialCreator();\n  }\n  return creatorInstance;\n}\n\n/**\n * Reset the material creator singleton.\n */\nexport function resetMaterialCreator(): void {\n  creatorInstance = null;\n}\n","/**\n * 3dverse integration module.\n * Provides authentication, asset upload, material creation, and entity manipulation.\n */\n\n// Re-export types\nexport type {\n  ThreeDverseAuthConfig,\n  AuthTokenResponse,\n  AuthenticatedUser,\n  AuthState,\n  ThreeDverseFolder,\n  AssetType,\n  ThreeDverseAsset,\n  TextureAsset,\n  MaterialAsset,\n  UploadJob,\n  UploadJobStatus,\n  PBRTextureAssets,\n  MaterialCreateParams,\n  LivelinkEntity,\n  UploadProgressEvent,\n  UploadCompleteEvent,\n  ThreeDverseApiError,\n} from '../types/threedverse.ts';\n\nexport {\n  ThreeDverseError,\n  ThreeDverseErrorCode,\n} from '../types/threedverse.ts';\n\n// Auth\nexport {\n  ThreeDverseAuth,\n  getAuth,\n  resetAuth,\n  type AuthStateCallback,\n} from './auth.ts';\n\n// Folder browser\nexport {\n  FolderBrowser,\n  getFolderBrowser,\n  resetFolderBrowser,\n} from './folder-browser.ts';\n\n// Texture uploader\nexport {\n  TextureUploader,\n  getTextureUploader,\n  resetTextureUploader,\n  type UploadProgressCallback,\n} from './texture-uploader.ts';\n\n// Material creator\nexport {\n  MaterialCreator,\n  getMaterialCreator,\n  resetMaterialCreator,\n} from './material-creator.ts';\n\n// Material applicator\nexport {\n  MaterialApplicator,\n  getMaterialApplicator,\n  resetMaterialApplicator,\n  type LivelinkSession,\n  type LivelinkEntityHandle,\n} from './material-applicator.ts';\n\n/**\n * Convenience function to upload PBR maps and create a material in one call.\n */\nimport type { ExtendedPBRMaps } from '../generators/index.ts';\nimport type { UploadProgressEvent, PBRTextureAssets, MaterialAsset } from '../types/threedverse.ts';\nimport { getAuth } from './auth.ts';\nimport { getTextureUploader } from './texture-uploader.ts';\nimport { getMaterialCreator } from './material-creator.ts';\n\nexport interface UploadAndCreateResult {\n  textures: PBRTextureAssets;\n  material: MaterialAsset;\n}\n\n/**\n * Upload PBR maps and create a material.\n * This is the main entry point for 3dverse integration.\n */\nexport async function uploadAndCreateMaterial(\n  maps: ExtendedPBRMaps,\n  folderUuid: string,\n  materialName: string,\n  onProgress?: (event: UploadProgressEvent) => void\n): Promise<UploadAndCreateResult> {\n  // Ensure authenticated\n  const auth = getAuth();\n  if (!auth.isAuthenticated()) {\n    throw new Error('Not authenticated with 3dverse');\n  }\n\n  // Upload textures and wait for all conversions\n  const uploader = getTextureUploader();\n  const textures = await uploader.uploadPBRMaps(\n    maps,\n    folderUuid,\n    materialName,\n    onProgress\n  );\n\n  // Create material with converted texture UUIDs\n  const creator = getMaterialCreator();\n  const material = await creator.createPBRMaterial({\n    name: materialName,\n    folderUuid,\n    textures,\n  });\n\n  return { textures, material };\n}\n","/**\n * 3dverse login panel UI component.\n * Provides API key input and authentication status.\n */\n\nimport {\n  getAuth,\n  type AuthState,\n  type AuthenticatedUser,\n  ThreeDverseError,\n} from '../threedverse/index.ts';\n\n/**\n * Login panel configuration\n */\nexport interface LoginPanelConfig {\n  /** Show remember me option */\n  showRememberMe?: boolean;\n  /** Auto-validate on input */\n  autoValidate?: boolean;\n}\n\n/**\n * Login event details\n */\nexport interface LoginEvent {\n  success: boolean;\n  user?: AuthenticatedUser;\n  error?: string;\n}\n\n/**\n * Login callback type\n */\nexport type LoginCallback = (event: LoginEvent) => void;\n\n/**\n * Login panel UI component.\n */\nexport class LoginPanel {\n  private container: HTMLElement;\n  private _config: LoginPanelConfig;\n  private callbacks: Set<LoginCallback> = new Set();\n  private unsubscribeAuth: (() => void) | null = null;\n\n  // UI elements\n  private panelEl: HTMLDivElement | null = null;\n  private inputEl: HTMLInputElement | null = null;\n  private buttonEl: HTMLButtonElement | null = null;\n  private statusEl: HTMLDivElement | null = null;\n  private errorEl: HTMLDivElement | null = null;\n\n  constructor(container: HTMLElement, config: LoginPanelConfig = {}) {\n    this.container = container;\n    this._config = {\n      showRememberMe: true,\n      autoValidate: false,\n      ...config,\n    };\n    this.render();\n    this.subscribeToAuth();\n  }\n\n  /**\n   * Get current configuration.\n   */\n  getConfig(): LoginPanelConfig {\n    return { ...this._config };\n  }\n\n  /**\n   * Subscribe to login events.\n   */\n  onLogin(callback: LoginCallback): () => void {\n    this.callbacks.add(callback);\n    return () => this.callbacks.delete(callback);\n  }\n\n  /**\n   * Show the login panel.\n   */\n  show(): void {\n    if (this.panelEl) {\n      this.panelEl.classList.remove('hidden');\n    }\n  }\n\n  /**\n   * Hide the login panel.\n   */\n  hide(): void {\n    if (this.panelEl) {\n      this.panelEl.classList.add('hidden');\n    }\n  }\n\n  /**\n   * Refresh the panel state (re-render based on current auth state).\n   */\n  refresh(): void {\n    this.render();\n    this.subscribeToAuth();\n  }\n\n  /**\n   * Dispose of the component.\n   */\n  dispose(): void {\n    if (this.unsubscribeAuth) {\n      this.unsubscribeAuth();\n    }\n    this.container.innerHTML = '';\n    this.callbacks.clear();\n  }\n\n  /**\n   * Render the login panel.\n   */\n  private render(): void {\n    this.panelEl = document.createElement('div');\n    this.panelEl.className = 'login-panel';\n    this.panelEl.innerHTML = `\n      <div class=\"login-panel__header\">\n        <h3>3dverse Connection</h3>\n      </div>\n      <div class=\"login-panel__content\">\n        <div class=\"login-panel__status\"></div>\n        <div class=\"login-panel__form\">\n          <label for=\"apiKeyInput\">API Key</label>\n          <input\n            type=\"password\"\n            id=\"apiKeyInput\"\n            placeholder=\"Enter your 3dverse API key\"\n            autocomplete=\"off\"\n          />\n          <button type=\"button\" class=\"login-btn\">Connect</button>\n        </div>\n        <div class=\"login-panel__error\"></div>\n        <div class=\"login-panel__help\">\n          <a href=\"https://console.3dverse.com/settings/api-keys\" target=\"_blank\" rel=\"noopener\">\n            Get your API key from 3dverse Console\n          </a>\n        </div>\n      </div>\n    `;\n\n    // Apply styles\n    this.applyStyles();\n\n    // Get references\n    this.inputEl = this.panelEl.querySelector('#apiKeyInput');\n    this.buttonEl = this.panelEl.querySelector('.login-btn');\n    this.statusEl = this.panelEl.querySelector('.login-panel__status');\n    this.errorEl = this.panelEl.querySelector('.login-panel__error');\n\n    // Event listeners\n    this.buttonEl?.addEventListener('click', () => this.handleLogin());\n    this.inputEl?.addEventListener('keypress', (e) => {\n      if (e.key === 'Enter') {\n        this.handleLogin();\n      }\n    });\n\n    this.container.appendChild(this.panelEl);\n  }\n\n  /**\n   * Apply component styles.\n   */\n  private applyStyles(): void {\n    if (!document.getElementById('login-panel-styles')) {\n      const style = document.createElement('style');\n      style.id = 'login-panel-styles';\n      style.textContent = `\n        .login-panel {\n          background: #2a2a4a;\n          border-radius: 8px;\n          padding: 15px;\n          margin-bottom: 20px;\n        }\n        .login-panel.hidden {\n          display: none;\n        }\n        .login-panel__header h3 {\n          margin: 0 0 10px;\n          font-size: 14px;\n          color: #fff;\n        }\n        .login-panel__status {\n          font-size: 12px;\n          margin-bottom: 10px;\n        }\n        .login-panel__status.connected {\n          color: #8f8;\n        }\n        .login-panel__status.disconnected {\n          color: #888;\n        }\n        .login-panel__status.connecting {\n          color: #ff8;\n        }\n        .login-panel__form {\n          display: flex;\n          gap: 10px;\n          align-items: flex-end;\n        }\n        .login-panel__form.hidden {\n          display: none;\n        }\n        .login-panel__form label {\n          font-size: 12px;\n          color: #aaa;\n          display: block;\n          margin-bottom: 4px;\n        }\n        .login-panel__form input {\n          flex: 1;\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #1a1a2e;\n          color: #fff;\n          font-size: 14px;\n        }\n        .login-panel__form input:focus {\n          outline: none;\n          border-color: #7878ff;\n        }\n        .login-btn {\n          padding: 8px 16px;\n          background: #5a5aaa;\n          border: none;\n          border-radius: 4px;\n          color: white;\n          font-size: 14px;\n          cursor: pointer;\n          white-space: nowrap;\n        }\n        .login-btn:hover {\n          background: #6a6acc;\n        }\n        .login-btn:disabled {\n          background: #3a3a5a;\n          cursor: not-allowed;\n        }\n        .logout-btn {\n          padding: 6px 12px;\n          background: #5a3a3a;\n          border: none;\n          border-radius: 4px;\n          color: white;\n          font-size: 12px;\n          cursor: pointer;\n          margin-left: 10px;\n        }\n        .logout-btn:hover {\n          background: #6a4a4a;\n        }\n        .login-panel__error {\n          color: #f88;\n          font-size: 12px;\n          margin-top: 10px;\n        }\n        .login-panel__error:empty {\n          display: none;\n        }\n        .login-panel__help {\n          margin-top: 10px;\n          font-size: 11px;\n        }\n        .login-panel__help a {\n          color: #7878ff;\n          text-decoration: none;\n        }\n        .login-panel__help a:hover {\n          text-decoration: underline;\n        }\n      `;\n      document.head.appendChild(style);\n    }\n  }\n\n  /**\n   * Subscribe to auth state changes.\n   */\n  private subscribeToAuth(): void {\n    const auth = getAuth();\n    this.unsubscribeAuth = auth.onStateChange((state, user) => {\n      this.updateUI(state, user);\n    });\n  }\n\n  /**\n   * Update UI based on auth state.\n   */\n  private updateUI(state: AuthState, user: AuthenticatedUser | null): void {\n    if (!this.statusEl || !this.inputEl || !this.buttonEl || !this.panelEl) return;\n\n    const formEl = this.panelEl.querySelector('.login-panel__form') as HTMLDivElement;\n\n    switch (state) {\n      case 'authenticated':\n        this.statusEl.className = 'login-panel__status connected';\n        this.statusEl.innerHTML = `\n          Connected as ${user?.displayName || 'API Key User'}\n          <button class=\"logout-btn\">Disconnect</button>\n        `;\n        formEl?.classList.add('hidden');\n\n        // Add logout handler\n        const logoutBtn = this.statusEl.querySelector('.logout-btn');\n        logoutBtn?.addEventListener('click', () => this.handleLogout());\n        break;\n\n      case 'authenticating':\n        this.statusEl.className = 'login-panel__status connecting';\n        this.statusEl.textContent = 'Connecting...';\n        this.buttonEl.disabled = true;\n        this.inputEl.disabled = true;\n        break;\n\n      case 'error':\n        this.statusEl.className = 'login-panel__status disconnected';\n        this.statusEl.textContent = 'Connection failed';\n        this.buttonEl.disabled = false;\n        this.inputEl.disabled = false;\n        formEl?.classList.remove('hidden');\n        break;\n\n      case 'unauthenticated':\n      default:\n        this.statusEl.className = 'login-panel__status disconnected';\n        this.statusEl.textContent = 'Not connected';\n        this.buttonEl.disabled = false;\n        this.inputEl.disabled = false;\n        formEl?.classList.remove('hidden');\n        break;\n    }\n  }\n\n  /**\n   * Handle login button click.\n   */\n  private async handleLogin(): Promise<void> {\n    if (!this.inputEl || !this.errorEl) return;\n\n    const apiKey = this.inputEl.value.trim();\n    if (!apiKey) {\n      this.errorEl.textContent = 'Please enter an API key';\n      return;\n    }\n\n    this.errorEl.textContent = '';\n\n    try {\n      const auth = getAuth();\n      await auth.loginWithApiKey(apiKey);\n\n      // Clear input\n      this.inputEl.value = '';\n\n      // Notify listeners\n      this.notifyCallbacks({\n        success: true,\n        user: auth.getUser() || undefined,\n      });\n    } catch (err) {\n      const message = err instanceof ThreeDverseError\n        ? err.message\n        : 'Connection failed';\n      this.errorEl.textContent = message;\n\n      this.notifyCallbacks({\n        success: false,\n        error: message,\n      });\n    }\n  }\n\n  /**\n   * Handle logout button click.\n   */\n  private handleLogout(): void {\n    const auth = getAuth();\n    auth.logout();\n\n    this.notifyCallbacks({\n      success: false,\n    });\n  }\n\n  /**\n   * Notify all callbacks.\n   */\n  private notifyCallbacks(event: LoginEvent): void {\n    for (const callback of this.callbacks) {\n      callback(event);\n    }\n  }\n}\n\n/**\n * Create a login panel container element.\n */\nexport function createLoginPanelContainer(): HTMLDivElement {\n  const container = document.createElement('div');\n  container.id = 'loginPanelContainer';\n  return container;\n}\n","/**\n * 3dverse folder picker UI component.\n * Allows selecting a destination folder for asset uploads.\n */\n\nimport {\n  type ThreeDverseFolder,\n  getFolderBrowser,\n  ThreeDverseError,\n} from '../threedverse/index.ts';\n\n/**\n * Folder selection event\n */\nexport interface FolderSelectEvent {\n  folder: ThreeDverseFolder;\n}\n\n/**\n * Folder selection callback type\n */\nexport type FolderSelectCallback = (event: FolderSelectEvent) => void;\n\n/**\n * Folder picker configuration\n */\nexport interface FolderPickerConfig {\n  /** Allow creating new folders */\n  allowCreate?: boolean;\n  /** Default selected folder UUID */\n  defaultFolderUuid?: string;\n  /** Placeholder text */\n  placeholder?: string;\n}\n\n/**\n * Folder picker UI component.\n */\nexport class FolderPicker {\n  private container: HTMLElement;\n  private config: FolderPickerConfig;\n  private callbacks: Set<FolderSelectCallback> = new Set();\n  private selectedFolder: ThreeDverseFolder | null = null;\n  private folders: ThreeDverseFolder[] = [];\n  private isLoading = false;\n\n  // UI elements\n  private pickerEl: HTMLDivElement | null = null;\n  private selectEl: HTMLSelectElement | null = null;\n  private createBtnEl: HTMLButtonElement | null = null;\n  private refreshBtnEl: HTMLButtonElement | null = null;\n  private statusEl: HTMLDivElement | null = null;\n\n  constructor(container: HTMLElement, config: FolderPickerConfig = {}) {\n    this.container = container;\n    this.config = {\n      allowCreate: true,\n      placeholder: 'Select a folder',\n      ...config,\n    };\n    this.render();\n  }\n\n  /**\n   * Subscribe to folder selection events.\n   */\n  onSelect(callback: FolderSelectCallback): () => void {\n    this.callbacks.add(callback);\n    return () => this.callbacks.delete(callback);\n  }\n\n  /**\n   * Get the selected folder.\n   */\n  getSelectedFolder(): ThreeDverseFolder | null {\n    return this.selectedFolder;\n  }\n\n  /**\n   * Refresh the folder list.\n   */\n  async refresh(): Promise<void> {\n    await this.loadFolders(true);\n  }\n\n  /**\n   * Enable/disable the picker.\n   */\n  setEnabled(enabled: boolean): void {\n    if (this.selectEl) {\n      this.selectEl.disabled = !enabled;\n    }\n    if (this.createBtnEl) {\n      this.createBtnEl.disabled = !enabled;\n    }\n    if (this.refreshBtnEl) {\n      this.refreshBtnEl.disabled = !enabled;\n    }\n  }\n\n  /**\n   * Show the picker.\n   */\n  show(): void {\n    if (this.pickerEl) {\n      this.pickerEl.classList.remove('hidden');\n    }\n  }\n\n  /**\n   * Hide the picker.\n   */\n  hide(): void {\n    if (this.pickerEl) {\n      this.pickerEl.classList.add('hidden');\n    }\n  }\n\n  /**\n   * Dispose of the component.\n   */\n  dispose(): void {\n    this.container.innerHTML = '';\n    this.callbacks.clear();\n  }\n\n  /**\n   * Render the folder picker.\n   */\n  private render(): void {\n    this.pickerEl = document.createElement('div');\n    this.pickerEl.className = 'folder-picker';\n    this.pickerEl.innerHTML = `\n      <div class=\"folder-picker__header\">\n        <label>Destination Folder</label>\n      </div>\n      <div class=\"folder-picker__content\">\n        <select class=\"folder-select\">\n          <option value=\"\">Loading folders...</option>\n        </select>\n        <button type=\"button\" class=\"folder-refresh-btn\" title=\"Refresh folders\">\n          <span class=\"icon\">&#8635;</span>\n        </button>\n        ${this.config.allowCreate ? `\n          <button type=\"button\" class=\"folder-create-btn\" title=\"Create new folder\">\n            <span class=\"icon\">+</span>\n          </button>\n        ` : ''}\n      </div>\n      <div class=\"folder-picker__status\"></div>\n    `;\n\n    // Apply styles\n    this.applyStyles();\n\n    // Get references\n    this.selectEl = this.pickerEl.querySelector('.folder-select');\n    this.refreshBtnEl = this.pickerEl.querySelector('.folder-refresh-btn');\n    this.createBtnEl = this.pickerEl.querySelector('.folder-create-btn');\n    this.statusEl = this.pickerEl.querySelector('.folder-picker__status');\n\n    // Event listeners\n    this.selectEl?.addEventListener('change', () => this.handleSelect());\n    this.refreshBtnEl?.addEventListener('click', () => this.loadFolders(true));\n    this.createBtnEl?.addEventListener('click', () => this.handleCreate());\n\n    this.container.appendChild(this.pickerEl);\n\n    // Load folders\n    this.loadFolders();\n  }\n\n  /**\n   * Apply component styles.\n   */\n  private applyStyles(): void {\n    if (!document.getElementById('folder-picker-styles')) {\n      const style = document.createElement('style');\n      style.id = 'folder-picker-styles';\n      style.textContent = `\n        .folder-picker {\n          margin-bottom: 15px;\n        }\n        .folder-picker.hidden {\n          display: none;\n        }\n        .folder-picker__header label {\n          font-size: 12px;\n          color: #aaa;\n          display: block;\n          margin-bottom: 4px;\n        }\n        .folder-picker__content {\n          display: flex;\n          gap: 8px;\n          align-items: center;\n        }\n        .folder-select {\n          flex: 1;\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #1a1a2e;\n          color: #fff;\n          font-size: 14px;\n          cursor: pointer;\n        }\n        .folder-select:focus {\n          outline: none;\n          border-color: #7878ff;\n        }\n        .folder-select:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .folder-refresh-btn,\n        .folder-create-btn {\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #2a2a4a;\n          color: #fff;\n          font-size: 16px;\n          cursor: pointer;\n        }\n        .folder-refresh-btn:hover,\n        .folder-create-btn:hover {\n          background: #3a3a5a;\n        }\n        .folder-refresh-btn:disabled,\n        .folder-create-btn:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .folder-refresh-btn.loading .icon {\n          animation: spin 1s linear infinite;\n        }\n        @keyframes spin {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        .folder-picker__status {\n          font-size: 11px;\n          color: #888;\n          margin-top: 4px;\n        }\n        .folder-picker__status:empty {\n          display: none;\n        }\n        .folder-picker__status.error {\n          color: #f88;\n        }\n      `;\n      document.head.appendChild(style);\n    }\n  }\n\n  /**\n   * Load folders from 3dverse.\n   */\n  private async loadFolders(forceRefresh = false): Promise<void> {\n    if (this.isLoading) return;\n    this.isLoading = true;\n\n    if (this.refreshBtnEl) {\n      this.refreshBtnEl.classList.add('loading');\n    }\n    if (this.statusEl) {\n      this.statusEl.textContent = '';\n      this.statusEl.className = 'folder-picker__status';\n    }\n\n    try {\n      const browser = getFolderBrowser();\n      this.folders = await browser.listFolders(forceRefresh);\n\n      this.updateSelect();\n\n      // Try to restore selected folder\n      if (this.config.defaultFolderUuid) {\n        const defaultFolder = this.folders.find(f => f.uuid === this.config.defaultFolderUuid);\n        if (defaultFolder) {\n          this.selectedFolder = defaultFolder;\n          if (this.selectEl) {\n            this.selectEl.value = defaultFolder.uuid;\n          }\n        }\n      }\n    } catch (err) {\n      const message = err instanceof ThreeDverseError\n        ? err.message\n        : 'Failed to load folders';\n\n      if (this.statusEl) {\n        this.statusEl.textContent = message;\n        this.statusEl.className = 'folder-picker__status error';\n      }\n\n      if (this.selectEl) {\n        this.selectEl.innerHTML = `<option value=\"\">${this.config.placeholder}</option>`;\n      }\n    } finally {\n      this.isLoading = false;\n      if (this.refreshBtnEl) {\n        this.refreshBtnEl.classList.remove('loading');\n      }\n    }\n  }\n\n  /**\n   * Update the select element with folders.\n   */\n  private updateSelect(): void {\n    if (!this.selectEl) return;\n\n    this.selectEl.innerHTML = `<option value=\"\">${this.config.placeholder}</option>`;\n\n    for (const folder of this.folders) {\n      const option = document.createElement('option');\n      option.value = folder.uuid;\n      option.textContent = folder.name;\n      this.selectEl.appendChild(option);\n    }\n  }\n\n  /**\n   * Handle folder selection.\n   */\n  private handleSelect(): void {\n    if (!this.selectEl) return;\n\n    const uuid = this.selectEl.value;\n    if (!uuid) {\n      this.selectedFolder = null;\n      return;\n    }\n\n    const folder = this.folders.find(f => f.uuid === uuid);\n    if (folder) {\n      this.selectedFolder = folder;\n      this.notifyCallbacks({ folder });\n    }\n  }\n\n  /**\n   * Handle create folder button click.\n   */\n  private async handleCreate(): Promise<void> {\n    const name = prompt('Enter folder name:');\n    if (!name) return;\n\n    if (this.statusEl) {\n      this.statusEl.textContent = 'Creating folder...';\n      this.statusEl.className = 'folder-picker__status';\n    }\n\n    try {\n      const browser = getFolderBrowser();\n      const newFolder = await browser.createFolder(name.trim());\n\n      // Refresh list and select new folder\n      await this.loadFolders(true);\n\n      this.selectedFolder = newFolder;\n      if (this.selectEl) {\n        this.selectEl.value = newFolder.uuid;\n      }\n\n      this.notifyCallbacks({ folder: newFolder });\n\n      if (this.statusEl) {\n        this.statusEl.textContent = `Created folder: ${newFolder.name}`;\n      }\n    } catch (err) {\n      const message = err instanceof ThreeDverseError\n        ? err.message\n        : 'Failed to create folder';\n\n      if (this.statusEl) {\n        this.statusEl.textContent = message;\n        this.statusEl.className = 'folder-picker__status error';\n      }\n    }\n  }\n\n  /**\n   * Notify all callbacks.\n   */\n  private notifyCallbacks(event: FolderSelectEvent): void {\n    for (const callback of this.callbacks) {\n      callback(event);\n    }\n  }\n}\n\n/**\n * Create a folder picker container element.\n */\nexport function createFolderPickerContainer(): HTMLDivElement {\n  const container = document.createElement('div');\n  container.id = 'folderPickerContainer';\n  return container;\n}\n","/**\n * Upload status UI component.\n * Shows progress of PBR texture upload and material creation.\n */\n\nimport type { UploadProgressEvent, MaterialAsset, PBRTextureAssets } from '../types/threedverse.ts';\n\n/**\n * Upload status state\n */\nexport type UploadState = 'idle' | 'uploading' | 'complete' | 'error';\n\n/**\n * Upload completion event\n */\nexport interface UploadCompleteEvent {\n  textures: PBRTextureAssets;\n  material?: MaterialAsset;\n}\n\n/**\n * Upload status callback type\n */\nexport type UploadStatusCallback = (state: UploadState, data?: UploadCompleteEvent | string) => void;\n\n/**\n * Upload status UI component.\n */\nexport class UploadStatus {\n  private container: HTMLElement;\n  private callbacks: Set<UploadStatusCallback> = new Set();\n  private state: UploadState = 'idle';\n\n  // UI elements\n  private statusEl: HTMLDivElement | null = null;\n  private channelProgressEls: Map<string, HTMLDivElement> = new Map();\n  private overallProgressEl: HTMLDivElement | null = null;\n  private messageEl: HTMLDivElement | null = null;\n  private resultEl: HTMLDivElement | null = null;\n\n  constructor(container: HTMLElement) {\n    this.container = container;\n    this.render();\n  }\n\n  /**\n   * Subscribe to status changes.\n   */\n  onChange(callback: UploadStatusCallback): () => void {\n    this.callbacks.add(callback);\n    return () => this.callbacks.delete(callback);\n  }\n\n  /**\n   * Get current state.\n   */\n  getState(): UploadState {\n    return this.state;\n  }\n\n  /**\n   * Start upload display.\n   * @param channels - List of channels being uploaded (e.g., ['basecolor', 'normal', 'roughness', 'metallic'])\n   */\n  start(channels?: string[]): void {\n    this.state = 'uploading';\n    this.reset();\n    this.setActiveChannels(channels || ['basecolor', 'normal', 'roughness', 'metallic']);\n    this.show();\n    this.updateMessage('Preparing upload...');\n  }\n\n  /**\n   * Set which channels are active (being uploaded).\n   * Inactive channels will be hidden.\n   */\n  setActiveChannels(channels: string[]): void {\n    const allChannels = ['basecolor', 'normal', 'roughness', 'metallic', 'height'];\n    for (const channel of allChannels) {\n      const el = this.channelProgressEls.get(channel);\n      if (el) {\n        if (channels.includes(channel)) {\n          el.style.display = 'flex';\n        } else {\n          el.style.display = 'none';\n        }\n      }\n    }\n  }\n\n  /**\n   * Update progress for a channel.\n   */\n  updateProgress(event: UploadProgressEvent): void {\n    this.updateChannelProgress(event.channel, event.progress, event.status);\n    this.updateMessage(event.status);\n    this.updateOverallProgress();\n  }\n\n  /**\n   * Show completion state.\n   */\n  complete(textures: PBRTextureAssets, material?: MaterialAsset): void {\n    this.state = 'complete';\n\n    // Update all channels to complete\n    const channels = ['basecolor', 'normal', 'roughness', 'metallic', 'height'] as const;\n    for (const channel of channels) {\n      if (textures[channel]) {\n        this.updateChannelProgress(channel, 1, 'Complete');\n      }\n    }\n\n    this.updateOverallProgress();\n    this.updateMessage('Upload complete!');\n    this.showResult(textures, material);\n\n    this.notifyCallbacks(this.state, { textures, material });\n  }\n\n  /**\n   * Show error state.\n   */\n  error(message: string): void {\n    this.state = 'error';\n    this.updateMessage(`Error: ${message}`);\n    if (this.messageEl) {\n      this.messageEl.classList.add('error');\n    }\n    this.notifyCallbacks(this.state, message);\n  }\n\n  /**\n   * Reset the component.\n   */\n  reset(): void {\n    this.state = 'idle';\n    this.channelProgressEls.forEach(el => {\n      const progressBar = el.querySelector('.channel-progress-fill') as HTMLDivElement;\n      const statusText = el.querySelector('.channel-status') as HTMLSpanElement;\n      if (progressBar) progressBar.style.width = '0%';\n      if (statusText) statusText.textContent = 'Pending';\n    });\n    if (this.overallProgressEl) {\n      this.overallProgressEl.style.width = '0%';\n    }\n    if (this.messageEl) {\n      this.messageEl.textContent = '';\n      this.messageEl.classList.remove('error');\n    }\n    if (this.resultEl) {\n      this.resultEl.classList.add('hidden');\n    }\n  }\n\n  /**\n   * Show the component.\n   */\n  show(): void {\n    if (this.statusEl) {\n      this.statusEl.classList.remove('hidden');\n    }\n  }\n\n  /**\n   * Hide the component.\n   */\n  hide(): void {\n    if (this.statusEl) {\n      this.statusEl.classList.add('hidden');\n    }\n  }\n\n  /**\n   * Dispose of the component.\n   */\n  dispose(): void {\n    this.container.innerHTML = '';\n    this.callbacks.clear();\n    this.channelProgressEls.clear();\n  }\n\n  /**\n   * Render the component.\n   */\n  private render(): void {\n    this.statusEl = document.createElement('div');\n    this.statusEl.className = 'upload-status hidden';\n    this.statusEl.innerHTML = `\n      <div class=\"upload-status__header\">\n        <h4>Uploading to 3dverse</h4>\n      </div>\n      <div class=\"upload-status__progress-container\">\n        ${['basecolor', 'normal', 'roughness', 'metallic', 'height']\n          .map(channel => `\n            <div class=\"channel-progress\" data-channel=\"${channel}\">\n              <span class=\"channel-name\">${channel}</span>\n              <div class=\"channel-progress-bar\">\n                <div class=\"channel-progress-fill\"></div>\n              </div>\n              <span class=\"channel-status\">Pending</span>\n            </div>\n          `).join('')}\n        <div class=\"overall-progress\">\n          <span class=\"channel-name\">Overall</span>\n          <div class=\"channel-progress-bar overall\">\n            <div class=\"channel-progress-fill\"></div>\n          </div>\n          <span class=\"channel-status\"></span>\n        </div>\n      </div>\n      <div class=\"upload-status__message\"></div>\n      <div class=\"upload-status__result hidden\">\n        <h5>Created Material</h5>\n        <div class=\"result-info\"></div>\n      </div>\n    `;\n\n    // Apply styles\n    this.applyStyles();\n\n    // Get references\n    this.messageEl = this.statusEl.querySelector('.upload-status__message');\n    this.resultEl = this.statusEl.querySelector('.upload-status__result');\n    this.overallProgressEl = this.statusEl.querySelector('.overall-progress .channel-progress-fill');\n\n    // Cache channel progress elements\n    const channelEls = this.statusEl.querySelectorAll('.channel-progress[data-channel]');\n    channelEls.forEach(el => {\n      const channel = el.getAttribute('data-channel');\n      if (channel) {\n        this.channelProgressEls.set(channel, el as HTMLDivElement);\n      }\n    });\n\n    this.container.appendChild(this.statusEl);\n  }\n\n  /**\n   * Apply component styles.\n   */\n  private applyStyles(): void {\n    if (!document.getElementById('upload-status-styles')) {\n      const style = document.createElement('style');\n      style.id = 'upload-status-styles';\n      style.textContent = `\n        .upload-status {\n          background: #2a2a4a;\n          border-radius: 8px;\n          padding: 15px;\n          margin-bottom: 20px;\n        }\n        .upload-status.hidden {\n          display: none;\n        }\n        .upload-status__header h4 {\n          margin: 0 0 15px;\n          font-size: 14px;\n          color: #fff;\n        }\n        .upload-status__progress-container {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n        }\n        .channel-progress {\n          display: flex;\n          align-items: center;\n          gap: 10px;\n        }\n        .channel-progress .channel-name {\n          width: 80px;\n          font-size: 12px;\n          color: #aaa;\n          text-transform: capitalize;\n        }\n        .channel-progress-bar {\n          flex: 1;\n          height: 8px;\n          background: #1a1a2e;\n          border-radius: 4px;\n          overflow: hidden;\n        }\n        .channel-progress-bar.overall {\n          height: 12px;\n        }\n        .channel-progress-fill {\n          height: 100%;\n          background: #5a8aaa;\n          border-radius: 4px;\n          width: 0%;\n          transition: width 0.3s ease;\n        }\n        .channel-progress.complete .channel-progress-fill {\n          background: #5a8a5a;\n        }\n        .channel-progress.error .channel-progress-fill {\n          background: #8a5a5a;\n        }\n        .overall-progress .channel-progress-fill {\n          background: #7878ff;\n        }\n        .channel-progress .channel-status {\n          width: 80px;\n          font-size: 11px;\n          color: #888;\n          text-align: right;\n        }\n        .upload-status__message {\n          margin-top: 15px;\n          font-size: 12px;\n          color: #aaa;\n          text-align: center;\n        }\n        .upload-status__message.error {\n          color: #f88;\n        }\n        .upload-status__result {\n          margin-top: 15px;\n          padding-top: 15px;\n          border-top: 1px solid #3a3a5a;\n        }\n        .upload-status__result.hidden {\n          display: none;\n        }\n        .upload-status__result h5 {\n          margin: 0 0 10px;\n          font-size: 12px;\n          color: #8f8;\n        }\n        .result-info {\n          font-size: 11px;\n          color: #888;\n        }\n        .result-info .uuid {\n          font-family: monospace;\n          background: #1a1a2e;\n          padding: 2px 6px;\n          border-radius: 3px;\n        }\n      `;\n      document.head.appendChild(style);\n    }\n  }\n\n  /**\n   * Update channel progress.\n   */\n  private updateChannelProgress(channel: string, progress: number, status: string): void {\n    const el = this.channelProgressEls.get(channel);\n    if (!el) return;\n\n    const progressBar = el.querySelector('.channel-progress-fill') as HTMLDivElement;\n    const statusText = el.querySelector('.channel-status') as HTMLSpanElement;\n\n    if (progressBar) {\n      progressBar.style.width = `${Math.round(progress * 100)}%`;\n    }\n    if (statusText) {\n      statusText.textContent = status;\n    }\n\n    // Update class for styling\n    el.classList.remove('complete', 'error');\n    if (progress >= 1) {\n      el.classList.add('complete');\n    }\n  }\n\n  /**\n   * Update overall progress bar.\n   */\n  private updateOverallProgress(): void {\n    if (!this.overallProgressEl) return;\n\n    let total = 0;\n    let complete = 0;\n\n    this.channelProgressEls.forEach((el, channel) => {\n      // Skip height if not present (it might not be uploaded)\n      if (channel === 'height') {\n        const statusText = el.querySelector('.channel-status') as HTMLSpanElement;\n        if (statusText?.textContent === 'Pending') return;\n      }\n\n      const progressBar = el.querySelector('.channel-progress-fill') as HTMLDivElement;\n      if (progressBar) {\n        const width = parseFloat(progressBar.style.width) || 0;\n        total++;\n        complete += width / 100;\n      }\n    });\n\n    const overallProgress = total > 0 ? (complete / total) * 100 : 0;\n    this.overallProgressEl.style.width = `${overallProgress}%`;\n  }\n\n  /**\n   * Update status message.\n   */\n  private updateMessage(message: string): void {\n    if (this.messageEl) {\n      this.messageEl.textContent = message;\n    }\n  }\n\n  /**\n   * Show the result section.\n   */\n  private showResult(textures: PBRTextureAssets, material?: MaterialAsset): void {\n    if (!this.resultEl) return;\n\n    const infoEl = this.resultEl.querySelector('.result-info') as HTMLDivElement;\n    if (!infoEl) return;\n\n    let html = `<p>Textures uploaded: ${Object.keys(textures).length}</p>`;\n\n    if (material) {\n      html += `\n        <p>Material: ${material.name}</p>\n        <p>UUID: <span class=\"uuid\">${material.uuid}</span></p>\n      `;\n    }\n\n    infoEl.innerHTML = html;\n    this.resultEl.classList.remove('hidden');\n  }\n\n  /**\n   * Notify all callbacks.\n   */\n  private notifyCallbacks(state: UploadState, data?: UploadCompleteEvent | string): void {\n    for (const callback of this.callbacks) {\n      callback(state, data);\n    }\n  }\n}\n\n/**\n * Create an upload status container element.\n */\nexport function createUploadStatusContainer(): HTMLDivElement {\n  const container = document.createElement('div');\n  container.id = 'uploadStatusContainer';\n  return container;\n}\n","/**\n * Keyboard shortcuts manager for the PBR texture generator.\n * Provides hotkey bindings with customization support.\n */\n\n/**\n * Shortcut action types\n */\nexport type ShortcutAction =\n  | 'open-file'\n  | 'export-all'\n  | 'export-basecolor'\n  | 'export-normal'\n  | 'export-roughness'\n  | 'export-metallic'\n  | 'export-height'\n  | 'toggle-ai'\n  | 'toggle-preview'\n  | 'regenerate'\n  | 'upload-3dverse'\n  | 'toggle-help'\n  | 'increase-quality'\n  | 'decrease-quality';\n\n/**\n * Shortcut definition\n */\nexport interface ShortcutDef {\n  key: string;\n  ctrl?: boolean;\n  shift?: boolean;\n  alt?: boolean;\n  meta?: boolean;\n  description: string;\n}\n\n/**\n * Default keyboard shortcuts\n */\nexport const DEFAULT_SHORTCUTS: Record<ShortcutAction, ShortcutDef> = {\n  'open-file': {\n    key: 'o',\n    ctrl: true,\n    description: 'Open file',\n  },\n  'export-all': {\n    key: 's',\n    ctrl: true,\n    shift: true,\n    description: 'Export all maps',\n  },\n  'export-basecolor': {\n    key: '1',\n    alt: true,\n    description: 'Export basecolor',\n  },\n  'export-normal': {\n    key: '2',\n    alt: true,\n    description: 'Export normal map',\n  },\n  'export-roughness': {\n    key: '3',\n    alt: true,\n    description: 'Export roughness',\n  },\n  'export-metallic': {\n    key: '4',\n    alt: true,\n    description: 'Export metallic',\n  },\n  'export-height': {\n    key: '5',\n    alt: true,\n    description: 'Export height',\n  },\n  'toggle-ai': {\n    key: 'a',\n    ctrl: true,\n    description: 'Toggle AI normal generation',\n  },\n  'toggle-preview': {\n    key: 'p',\n    ctrl: true,\n    description: 'Toggle 3D preview',\n  },\n  'regenerate': {\n    key: 'r',\n    ctrl: true,\n    description: 'Regenerate maps',\n  },\n  'upload-3dverse': {\n    key: 'u',\n    ctrl: true,\n    shift: true,\n    description: 'Upload to 3dverse',\n  },\n  'toggle-help': {\n    key: '/',\n    ctrl: true,\n    description: 'Show keyboard shortcuts',\n  },\n  'increase-quality': {\n    key: '+',\n    ctrl: true,\n    description: 'Increase quality',\n  },\n  'decrease-quality': {\n    key: '-',\n    ctrl: true,\n    description: 'Decrease quality',\n  },\n};\n\n/**\n * Check if a keyboard event matches a shortcut definition\n */\nfunction matchesShortcut(event: KeyboardEvent, shortcut: ShortcutDef): boolean {\n  const key = event.key.toLowerCase();\n  const shortcutKey = shortcut.key.toLowerCase();\n\n  // Check key\n  if (key !== shortcutKey) return false;\n\n  // Check modifiers\n  if (!!shortcut.ctrl !== event.ctrlKey) return false;\n  if (!!shortcut.shift !== event.shiftKey) return false;\n  if (!!shortcut.alt !== event.altKey) return false;\n  if (!!shortcut.meta !== event.metaKey) return false;\n\n  return true;\n}\n\n/**\n * Format shortcut for display\n */\nexport function formatShortcut(shortcut: ShortcutDef): string {\n  const parts: string[] = [];\n\n  // Platform-specific modifier display\n  const isMac = navigator.platform.toLowerCase().includes('mac');\n\n  if (shortcut.ctrl) parts.push(isMac ? 'Cmd' : 'Ctrl');\n  if (shortcut.alt) parts.push(isMac ? 'Option' : 'Alt');\n  if (shortcut.shift) parts.push('Shift');\n  if (shortcut.meta) parts.push(isMac ? 'Cmd' : 'Win');\n\n  // Format key\n  let keyDisplay = shortcut.key.toUpperCase();\n  if (keyDisplay === ' ') keyDisplay = 'Space';\n  if (keyDisplay === '/') keyDisplay = '?';\n  parts.push(keyDisplay);\n\n  return parts.join('+');\n}\n\n/**\n * Keyboard shortcuts manager\n */\nexport class KeyboardShortcuts {\n  private shortcuts: Map<ShortcutAction, ShortcutDef> = new Map();\n  private handlers: Map<ShortcutAction, () => void> = new Map();\n  private enabled = true;\n  private boundHandler: (e: KeyboardEvent) => void;\n\n  constructor() {\n    // Initialize with defaults\n    for (const [action, shortcut] of Object.entries(DEFAULT_SHORTCUTS)) {\n      this.shortcuts.set(action as ShortcutAction, { ...shortcut });\n    }\n\n    // Bind handler\n    this.boundHandler = this.handleKeyDown.bind(this);\n  }\n\n  /**\n   * Start listening for keyboard events\n   */\n  start(): void {\n    document.addEventListener('keydown', this.boundHandler);\n  }\n\n  /**\n   * Stop listening for keyboard events\n   */\n  stop(): void {\n    document.removeEventListener('keydown', this.boundHandler);\n  }\n\n  /**\n   * Enable or disable shortcuts\n   */\n  setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n  }\n\n  /**\n   * Register a handler for a shortcut action\n   */\n  on(action: ShortcutAction, handler: () => void): () => void {\n    this.handlers.set(action, handler);\n    return () => this.handlers.delete(action);\n  }\n\n  /**\n   * Register multiple handlers\n   */\n  onAll(handlers: Partial<Record<ShortcutAction, () => void>>): () => void {\n    const unsubscribers: (() => void)[] = [];\n\n    for (const [action, handler] of Object.entries(handlers)) {\n      if (handler) {\n        unsubscribers.push(this.on(action as ShortcutAction, handler));\n      }\n    }\n\n    return () => unsubscribers.forEach((unsub) => unsub());\n  }\n\n  /**\n   * Customize a shortcut\n   */\n  setShortcut(action: ShortcutAction, shortcut: Partial<ShortcutDef>): void {\n    const current = this.shortcuts.get(action);\n    if (current) {\n      this.shortcuts.set(action, { ...current, ...shortcut });\n    }\n  }\n\n  /**\n   * Reset shortcuts to defaults\n   */\n  resetToDefaults(): void {\n    for (const [action, shortcut] of Object.entries(DEFAULT_SHORTCUTS)) {\n      this.shortcuts.set(action as ShortcutAction, { ...shortcut });\n    }\n  }\n\n  /**\n   * Get all shortcuts for display\n   */\n  getShortcuts(): Map<ShortcutAction, ShortcutDef> {\n    return new Map(this.shortcuts);\n  }\n\n  /**\n   * Get formatted shortcut string\n   */\n  getFormattedShortcut(action: ShortcutAction): string {\n    const shortcut = this.shortcuts.get(action);\n    if (!shortcut) return '';\n    return formatShortcut(shortcut);\n  }\n\n  /**\n   * Handle keydown events\n   */\n  private handleKeyDown(event: KeyboardEvent): void {\n    if (!this.enabled) return;\n\n    // Don't trigger shortcuts when typing in input fields\n    const target = event.target as HTMLElement;\n    if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {\n      // Allow some shortcuts even in inputs\n      const allowInInputs: ShortcutAction[] = ['toggle-help'];\n      if (!this.findMatchingAction(event, allowInInputs)) {\n        return;\n      }\n    }\n\n    // Find matching shortcut\n    for (const [action, shortcut] of this.shortcuts) {\n      if (matchesShortcut(event, shortcut)) {\n        const handler = this.handlers.get(action);\n        if (handler) {\n          event.preventDefault();\n          event.stopPropagation();\n          handler();\n          return;\n        }\n      }\n    }\n  }\n\n  /**\n   * Find matching action from a subset\n   */\n  private findMatchingAction(\n    event: KeyboardEvent,\n    allowedActions: ShortcutAction[]\n  ): ShortcutAction | null {\n    for (const action of allowedActions) {\n      const shortcut = this.shortcuts.get(action);\n      if (shortcut && matchesShortcut(event, shortcut)) {\n        return action;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Save shortcuts to localStorage\n   */\n  saveToStorage(): void {\n    const data: Record<string, ShortcutDef> = {};\n    for (const [action, shortcut] of this.shortcuts) {\n      data[action] = shortcut;\n    }\n    localStorage.setItem('pbr-keyboard-shortcuts', JSON.stringify(data));\n  }\n\n  /**\n   * Load shortcuts from localStorage\n   */\n  loadFromStorage(): void {\n    try {\n      const data = localStorage.getItem('pbr-keyboard-shortcuts');\n      if (data) {\n        const parsed = JSON.parse(data) as Record<string, ShortcutDef>;\n        for (const [action, shortcut] of Object.entries(parsed)) {\n          if (this.shortcuts.has(action as ShortcutAction)) {\n            this.shortcuts.set(action as ShortcutAction, shortcut);\n          }\n        }\n      }\n    } catch {\n      console.warn('Failed to load keyboard shortcuts from storage');\n    }\n  }\n}\n\n/**\n * Keyboard shortcuts help dialog\n */\nexport class ShortcutsHelpDialog {\n  private container: HTMLElement;\n  private visible = false;\n\n  constructor(parent: HTMLElement = document.body) {\n    this.container = document.createElement('div');\n    this.container.className = 'shortcuts-help-dialog hidden';\n    this.container.innerHTML = this.render();\n    parent.appendChild(this.container);\n\n    // Close on click outside\n    this.container.addEventListener('click', (e) => {\n      if (e.target === this.container) {\n        this.hide();\n      }\n    });\n\n    // Close button\n    const closeBtn = this.container.querySelector('.close-btn');\n    closeBtn?.addEventListener('click', () => this.hide());\n\n    this.applyStyles();\n  }\n\n  /**\n   * Show the dialog\n   */\n  show(shortcuts: Map<ShortcutAction, ShortcutDef>): void {\n    this.updateContent(shortcuts);\n    this.container.classList.remove('hidden');\n    this.visible = true;\n  }\n\n  /**\n   * Hide the dialog\n   */\n  hide(): void {\n    this.container.classList.add('hidden');\n    this.visible = false;\n  }\n\n  /**\n   * Toggle visibility\n   */\n  toggle(shortcuts: Map<ShortcutAction, ShortcutDef>): void {\n    if (this.visible) {\n      this.hide();\n    } else {\n      this.show(shortcuts);\n    }\n  }\n\n  /**\n   * Check if visible\n   */\n  isVisible(): boolean {\n    return this.visible;\n  }\n\n  /**\n   * Render the dialog structure\n   */\n  private render(): string {\n    return `\n      <div class=\"shortcuts-dialog-content\">\n        <div class=\"shortcuts-dialog-header\">\n          <h2>Keyboard Shortcuts</h2>\n          <button class=\"close-btn\">&times;</button>\n        </div>\n        <div class=\"shortcuts-list\"></div>\n      </div>\n    `;\n  }\n\n  /**\n   * Update shortcuts list content\n   */\n  private updateContent(shortcuts: Map<ShortcutAction, ShortcutDef>): void {\n    const list = this.container.querySelector('.shortcuts-list');\n    if (!list) return;\n\n    const categories: Record<string, ShortcutAction[]> = {\n      'File': ['open-file', 'export-all'],\n      'Export': ['export-basecolor', 'export-normal', 'export-roughness', 'export-metallic', 'export-height'],\n      'Generation': ['toggle-ai', 'regenerate', 'increase-quality', 'decrease-quality'],\n      'View': ['toggle-preview', 'toggle-help'],\n      '3dverse': ['upload-3dverse'],\n    };\n\n    let html = '';\n    for (const [category, actions] of Object.entries(categories)) {\n      html += `<div class=\"shortcuts-category\"><h3>${category}</h3>`;\n      for (const action of actions) {\n        const shortcut = shortcuts.get(action);\n        if (shortcut) {\n          html += `\n            <div class=\"shortcut-row\">\n              <span class=\"shortcut-desc\">${shortcut.description}</span>\n              <span class=\"shortcut-key\">${formatShortcut(shortcut)}</span>\n            </div>\n          `;\n        }\n      }\n      html += '</div>';\n    }\n\n    list.innerHTML = html;\n  }\n\n  /**\n   * Apply dialog styles\n   */\n  private applyStyles(): void {\n    if (document.getElementById('shortcuts-help-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'shortcuts-help-styles';\n    style.textContent = `\n      .shortcuts-help-dialog {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.7);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10000;\n        backdrop-filter: blur(4px);\n      }\n      .shortcuts-help-dialog.hidden {\n        display: none;\n      }\n      .shortcuts-dialog-content {\n        background: #2a2a4a;\n        border-radius: 12px;\n        max-width: 500px;\n        width: 90%;\n        max-height: 80vh;\n        overflow: auto;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n      }\n      .shortcuts-dialog-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 16px 20px;\n        border-bottom: 1px solid #3a3a5a;\n      }\n      .shortcuts-dialog-header h2 {\n        margin: 0;\n        font-size: 18px;\n        color: #fff;\n      }\n      .shortcuts-dialog-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 24px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .shortcuts-dialog-header .close-btn:hover {\n        color: #fff;\n      }\n      .shortcuts-list {\n        padding: 16px 20px;\n      }\n      .shortcuts-category {\n        margin-bottom: 16px;\n      }\n      .shortcuts-category h3 {\n        font-size: 12px;\n        color: #888;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        margin: 0 0 8px 0;\n      }\n      .shortcut-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 8px 0;\n        border-bottom: 1px solid #3a3a5a;\n      }\n      .shortcut-row:last-child {\n        border-bottom: none;\n      }\n      .shortcut-desc {\n        color: #ccc;\n        font-size: 14px;\n      }\n      .shortcut-key {\n        background: #3a3a5a;\n        color: #fff;\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        font-family: monospace;\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Destroy the dialog\n   */\n  destroy(): void {\n    this.container.remove();\n  }\n}\n\n// Singleton instance\nlet keyboardInstance: KeyboardShortcuts | null = null;\nlet helpDialogInstance: ShortcutsHelpDialog | null = null;\n\n/**\n * Get global keyboard shortcuts manager\n */\nexport function getKeyboardShortcuts(): KeyboardShortcuts {\n  if (!keyboardInstance) {\n    keyboardInstance = new KeyboardShortcuts();\n    keyboardInstance.loadFromStorage();\n  }\n  return keyboardInstance;\n}\n\n/**\n * Get global help dialog\n */\nexport function getShortcutsHelpDialog(): ShortcutsHelpDialog {\n  if (!helpDialogInstance) {\n    helpDialogInstance = new ShortcutsHelpDialog();\n  }\n  return helpDialogInstance;\n}\n","/**\n * Offline mode support for the PBR texture generator.\n * Provides model caching, offline detection, and local export.\n */\n\nimport { getModelCache } from '../inference/model-cache.ts';\nimport { getModelLoader } from '../inference/model-loader.ts';\n\n/**\n * Offline status\n */\nexport interface OfflineStatus {\n  /** Browser is online */\n  isOnline: boolean;\n  /** All required models are cached */\n  modelsReady: boolean;\n  /** List of cached models */\n  cachedModels: string[];\n  /** Total cache size in bytes */\n  cacheSizeBytes: number;\n}\n\n/**\n * Model prefetch progress\n */\nexport interface PrefetchProgress {\n  modelId: string;\n  progress: number;\n  status: 'pending' | 'downloading' | 'cached' | 'error';\n  error?: string;\n}\n\n/**\n * Offline manager for handling offline functionality\n */\nexport class OfflineManager {\n  private statusListeners: Set<(status: OfflineStatus) => void> = new Set();\n  private prefetchListeners: Set<(progress: Map<string, PrefetchProgress>) => void> = new Set();\n  private currentStatus: OfflineStatus | null = null;\n\n  constructor() {\n    // Listen for online/offline events\n    if (typeof window !== 'undefined') {\n      window.addEventListener('online', () => this.updateStatus());\n      window.addEventListener('offline', () => this.updateStatus());\n    }\n  }\n\n  /**\n   * Get current offline status\n   */\n  async getStatus(): Promise<OfflineStatus> {\n    const cache = getModelCache();\n    const cachedModels = await cache.listCached();\n    const cacheSizeBytes = await cache.getCacheSize();\n\n    // Check if required models are cached\n    const requiredModels = ['deepbump_fp16', 'deepbump_int8'];\n    const modelsReady = requiredModels.some((m) => cachedModels.includes(m));\n\n    this.currentStatus = {\n      isOnline: navigator.onLine,\n      modelsReady,\n      cachedModels,\n      cacheSizeBytes,\n    };\n\n    return this.currentStatus;\n  }\n\n  /**\n   * Check if a specific model is cached\n   */\n  async isModelCached(modelId: string): Promise<boolean> {\n    const cache = getModelCache();\n    return cache.isCached(modelId);\n  }\n\n  /**\n   * Prefetch all available models for offline use\n   */\n  async prefetchModels(\n    onProgress?: (progress: Map<string, PrefetchProgress>) => void\n  ): Promise<void> {\n    const loader = getModelLoader();\n    const models = await loader.getAvailableModels();\n\n    if (models.length === 0) {\n      console.warn('No models available for prefetch');\n      return;\n    }\n\n    const progress = new Map<string, PrefetchProgress>();\n\n    // Initialize progress\n    for (const model of models) {\n      progress.set(model.id, {\n        modelId: model.id,\n        progress: 0,\n        status: 'pending',\n      });\n    }\n\n    onProgress?.(progress);\n    this.notifyPrefetchListeners(progress);\n\n    // Download models sequentially to avoid overwhelming\n    for (const model of models) {\n      try {\n        progress.set(model.id, {\n          modelId: model.id,\n          progress: 0,\n          status: 'downloading',\n        });\n        onProgress?.(progress);\n        this.notifyPrefetchListeners(progress);\n\n        await loader.loadModelData(model, (downloadProgress) => {\n          progress.set(model.id, {\n            modelId: model.id,\n            progress: downloadProgress.progress,\n            status: 'downloading',\n          });\n          onProgress?.(progress);\n          this.notifyPrefetchListeners(progress);\n        });\n\n        // Also load external data if present\n        if (model.externalDataPath) {\n          await loader.loadExternalData(model);\n        }\n\n        progress.set(model.id, {\n          modelId: model.id,\n          progress: 1,\n          status: 'cached',\n        });\n        onProgress?.(progress);\n        this.notifyPrefetchListeners(progress);\n      } catch (e) {\n        progress.set(model.id, {\n          modelId: model.id,\n          progress: 0,\n          status: 'error',\n          error: e instanceof Error ? e.message : 'Unknown error',\n        });\n        onProgress?.(progress);\n        this.notifyPrefetchListeners(progress);\n      }\n    }\n\n    await this.updateStatus();\n  }\n\n  /**\n   * Clear all cached models\n   */\n  async clearCache(): Promise<void> {\n    const loader = getModelLoader();\n    await loader.clearCache();\n    await this.updateStatus();\n  }\n\n  /**\n   * Get cache statistics\n   */\n  async getCacheStats(): Promise<{ cachedModels: string[]; totalSizeBytes: number }> {\n    const loader = getModelLoader();\n    return loader.getCacheStats();\n  }\n\n  /**\n   * Format cache size for display\n   */\n  formatCacheSize(bytes: number): string {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n    return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;\n  }\n\n  /**\n   * Check if app can work offline\n   */\n  async canWorkOffline(): Promise<boolean> {\n    const status = await this.getStatus();\n    return status.modelsReady;\n  }\n\n  /**\n   * Subscribe to status changes\n   */\n  onStatusChange(callback: (status: OfflineStatus) => void): () => void {\n    this.statusListeners.add(callback);\n    // Send current status immediately if available\n    if (this.currentStatus) {\n      callback(this.currentStatus);\n    }\n    return () => this.statusListeners.delete(callback);\n  }\n\n  /**\n   * Subscribe to prefetch progress\n   */\n  onPrefetchProgress(callback: (progress: Map<string, PrefetchProgress>) => void): () => void {\n    this.prefetchListeners.add(callback);\n    return () => this.prefetchListeners.delete(callback);\n  }\n\n  /**\n   * Update status and notify listeners\n   */\n  private async updateStatus(): Promise<void> {\n    const status = await this.getStatus();\n    this.statusListeners.forEach((l) => l(status));\n  }\n\n  /**\n   * Notify prefetch listeners\n   */\n  private notifyPrefetchListeners(progress: Map<string, PrefetchProgress>): void {\n    this.prefetchListeners.forEach((l) => l(progress));\n  }\n}\n\n/**\n * Service Worker registration for offline caching of static assets\n */\nexport async function registerServiceWorker(): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('Service Worker not supported');\n    return null;\n  }\n\n  try {\n    const registration = await navigator.serviceWorker.register('/sw.js', {\n      scope: '/',\n    });\n\n    console.log('Service Worker registered:', registration.scope);\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing;\n      if (newWorker) {\n        newWorker.addEventListener('statechange', () => {\n          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n            // New version available\n            console.log('New version available. Refresh to update.');\n          }\n        });\n      }\n    });\n\n    return registration;\n  } catch (e) {\n    console.warn('Service Worker registration failed:', e);\n    return null;\n  }\n}\n\n/**\n * Check if Service Worker is active\n */\nexport function isServiceWorkerActive(): boolean {\n  return navigator.serviceWorker?.controller !== null;\n}\n\n/**\n * Request persistent storage for cache\n */\nexport async function requestPersistentStorage(): Promise<boolean> {\n  if (!navigator.storage?.persist) {\n    return false;\n  }\n\n  try {\n    const persisted = await navigator.storage.persisted();\n    if (persisted) {\n      return true;\n    }\n\n    // Request persistent storage\n    return await navigator.storage.persist();\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get storage estimate\n */\nexport async function getStorageEstimate(): Promise<{ usage: number; quota: number } | null> {\n  if (!navigator.storage?.estimate) {\n    return null;\n  }\n\n  try {\n    const estimate = await navigator.storage.estimate();\n    return {\n      usage: estimate.usage || 0,\n      quota: estimate.quota || 0,\n    };\n  } catch {\n    return null;\n  }\n}\n\n// Singleton instance\nlet offlineManagerInstance: OfflineManager | null = null;\n\n/**\n * Get global offline manager\n */\nexport function getOfflineManager(): OfflineManager {\n  if (!offlineManagerInstance) {\n    offlineManagerInstance = new OfflineManager();\n  }\n  return offlineManagerInstance;\n}\n","/**\n * Model download progress UI component.\n * Shows download progress for AI models with caching status.\n */\n\nimport type { PrefetchProgress } from '../utils/offline.ts';\nimport { getOfflineManager } from '../utils/offline.ts';\n\n/**\n * Download progress component configuration\n */\nexport interface DownloadProgressConfig {\n  showCacheSize?: boolean;\n  showModelList?: boolean;\n  compact?: boolean;\n}\n\nconst DEFAULT_CONFIG: DownloadProgressConfig = {\n  showCacheSize: true,\n  showModelList: true,\n  compact: false,\n};\n\n/**\n * Model download progress component\n */\nexport class DownloadProgress {\n  private container: HTMLElement;\n  // Configuration stored for potential future use (compact mode, etc.)\n  // @ts-expect-error Reserved for future implementation\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  private readonly config: DownloadProgressConfig;\n  private visible = false;\n  private progressMap: Map<string, PrefetchProgress> = new Map();\n  private unsubscribe: (() => void) | null = null;\n\n  constructor(parent: HTMLElement, config: Partial<DownloadProgressConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n\n    this.container = document.createElement('div');\n    this.container.className = 'download-progress hidden';\n    parent.appendChild(this.container);\n\n    this.applyStyles();\n    this.render();\n\n    // Subscribe to offline manager\n    const offline = getOfflineManager();\n    this.unsubscribe = offline.onPrefetchProgress((progress) => {\n      this.progressMap = progress;\n      this.updateProgress();\n    });\n  }\n\n  /**\n   * Show the download progress panel\n   */\n  show(): void {\n    this.container.classList.remove('hidden');\n    this.visible = true;\n    this.updateProgress();\n  }\n\n  /**\n   * Hide the download progress panel\n   */\n  hide(): void {\n    this.container.classList.add('hidden');\n    this.visible = false;\n  }\n\n  /**\n   * Check if visible\n   */\n  isVisible(): boolean {\n    return this.visible;\n  }\n\n  /**\n   * Start prefetching models\n   */\n  async startPrefetch(): Promise<void> {\n    this.show();\n\n    const offline = getOfflineManager();\n    await offline.prefetchModels((progress) => {\n      this.progressMap = progress;\n      this.updateProgress();\n    });\n\n    // Check completion\n    const allDone = Array.from(this.progressMap.values()).every(\n      (p) => p.status === 'cached' || p.status === 'error'\n    );\n\n    if (allDone) {\n      this.showCompletion();\n    }\n  }\n\n  /**\n   * Render component\n   */\n  private render(): void {\n    this.container.innerHTML = `\n      <div class=\"download-progress-header\">\n        <h3>Model Cache</h3>\n        <button class=\"close-btn\">&times;</button>\n      </div>\n      <div class=\"download-progress-content\">\n        <div class=\"cache-status\"></div>\n        <div class=\"model-list\"></div>\n        <div class=\"progress-actions\">\n          <button class=\"prefetch-btn\">Download for Offline</button>\n          <button class=\"clear-cache-btn\">Clear Cache</button>\n        </div>\n      </div>\n    `;\n\n    // Close button\n    const closeBtn = this.container.querySelector('.close-btn');\n    closeBtn?.addEventListener('click', () => this.hide());\n\n    // Prefetch button\n    const prefetchBtn = this.container.querySelector('.prefetch-btn') as HTMLButtonElement;\n    prefetchBtn?.addEventListener('click', () => this.startPrefetch());\n\n    // Clear cache button\n    const clearBtn = this.container.querySelector('.clear-cache-btn') as HTMLButtonElement;\n    clearBtn?.addEventListener('click', () => this.handleClearCache());\n\n    // Initial update\n    this.updateCacheStatus();\n  }\n\n  /**\n   * Update cache status display\n   */\n  private async updateCacheStatus(): Promise<void> {\n    const statusEl = this.container.querySelector('.cache-status');\n    if (!statusEl) return;\n\n    const offline = getOfflineManager();\n    const status = await offline.getStatus();\n    const formattedSize = offline.formatCacheSize(status.cacheSizeBytes);\n\n    statusEl.innerHTML = `\n      <div class=\"cache-info\">\n        <span class=\"status-indicator ${status.modelsReady ? 'ready' : 'not-ready'}\"></span>\n        <span class=\"status-text\">\n          ${status.modelsReady ? 'Ready for offline use' : 'Models not cached'}\n        </span>\n      </div>\n      <div class=\"cache-size\">\n        <span>Cache size: ${formattedSize}</span>\n        <span class=\"online-status ${status.isOnline ? 'online' : 'offline'}\">\n          ${status.isOnline ? 'Online' : 'Offline'}\n        </span>\n      </div>\n    `;\n  }\n\n  /**\n   * Update progress display\n   */\n  private updateProgress(): void {\n    const listEl = this.container.querySelector('.model-list');\n    if (!listEl) return;\n\n    if (this.progressMap.size === 0) {\n      this.updateCacheStatus();\n      return;\n    }\n\n    let html = '';\n    for (const [, progress] of this.progressMap) {\n      const statusClass = progress.status;\n      const progressPercent = Math.round(progress.progress * 100);\n\n      html += `\n        <div class=\"model-item ${statusClass}\">\n          <div class=\"model-info\">\n            <span class=\"model-name\">${progress.modelId}</span>\n            <span class=\"model-status\">${this.getStatusText(progress)}</span>\n          </div>\n          <div class=\"progress-bar-container\">\n            <div class=\"progress-bar\" style=\"width: ${progressPercent}%\"></div>\n          </div>\n        </div>\n      `;\n    }\n\n    listEl.innerHTML = html;\n  }\n\n  /**\n   * Get status text for a progress entry\n   */\n  private getStatusText(progress: PrefetchProgress): string {\n    switch (progress.status) {\n      case 'pending':\n        return 'Waiting...';\n      case 'downloading':\n        return `${Math.round(progress.progress * 100)}%`;\n      case 'cached':\n        return 'Cached';\n      case 'error':\n        return progress.error || 'Error';\n      default:\n        return '';\n    }\n  }\n\n  /**\n   * Show completion message\n   */\n  private showCompletion(): void {\n    const listEl = this.container.querySelector('.model-list');\n    if (!listEl) return;\n\n    const hasErrors = Array.from(this.progressMap.values()).some((p) => p.status === 'error');\n\n    if (hasErrors) {\n      listEl.innerHTML += `\n        <div class=\"completion-message error\">\n          Some models failed to download. Check connection and try again.\n        </div>\n      `;\n    } else {\n      listEl.innerHTML += `\n        <div class=\"completion-message success\">\n          All models cached. Ready for offline use!\n        </div>\n      `;\n    }\n\n    // Update cache status\n    this.updateCacheStatus();\n  }\n\n  /**\n   * Handle clear cache button\n   */\n  private async handleClearCache(): Promise<void> {\n    const clearBtn = this.container.querySelector('.clear-cache-btn') as HTMLButtonElement;\n    if (clearBtn) {\n      clearBtn.disabled = true;\n      clearBtn.textContent = 'Clearing...';\n    }\n\n    try {\n      const offline = getOfflineManager();\n      await offline.clearCache();\n      this.progressMap.clear();\n      this.updateProgress();\n      await this.updateCacheStatus();\n    } finally {\n      if (clearBtn) {\n        clearBtn.disabled = false;\n        clearBtn.textContent = 'Clear Cache';\n      }\n    }\n  }\n\n  /**\n   * Apply styles\n   */\n  private applyStyles(): void {\n    if (document.getElementById('download-progress-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'download-progress-styles';\n    style.textContent = `\n      .download-progress {\n        background: #2a2a4a;\n        border-radius: 8px;\n        margin-bottom: 20px;\n        overflow: hidden;\n      }\n      .download-progress.hidden {\n        display: none;\n      }\n      .download-progress-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 16px;\n        background: #3a3a5a;\n      }\n      .download-progress-header h3 {\n        margin: 0;\n        font-size: 14px;\n        color: #fff;\n      }\n      .download-progress-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .download-progress-header .close-btn:hover {\n        color: #fff;\n      }\n      .download-progress-content {\n        padding: 16px;\n      }\n      .cache-status {\n        margin-bottom: 12px;\n      }\n      .cache-info {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 8px;\n      }\n      .status-indicator {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: #888;\n      }\n      .status-indicator.ready {\n        background: #4a8;\n      }\n      .status-indicator.not-ready {\n        background: #a84;\n      }\n      .status-text {\n        font-size: 14px;\n        color: #ccc;\n      }\n      .cache-size {\n        display: flex;\n        justify-content: space-between;\n        font-size: 12px;\n        color: #888;\n      }\n      .online-status {\n        padding: 2px 8px;\n        border-radius: 10px;\n        font-size: 11px;\n      }\n      .online-status.online {\n        background: rgba(68, 170, 136, 0.2);\n        color: #4a8;\n      }\n      .online-status.offline {\n        background: rgba(170, 136, 68, 0.2);\n        color: #a84;\n      }\n      .model-list {\n        margin-bottom: 12px;\n      }\n      .model-item {\n        margin-bottom: 10px;\n        padding: 10px;\n        background: #1a1a2e;\n        border-radius: 6px;\n      }\n      .model-info {\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 6px;\n      }\n      .model-name {\n        font-size: 13px;\n        color: #ccc;\n        font-family: monospace;\n      }\n      .model-status {\n        font-size: 12px;\n        color: #888;\n      }\n      .model-item.cached .model-status {\n        color: #4a8;\n      }\n      .model-item.error .model-status {\n        color: #a44;\n      }\n      .progress-bar-container {\n        height: 4px;\n        background: #3a3a5a;\n        border-radius: 2px;\n        overflow: hidden;\n      }\n      .progress-bar {\n        height: 100%;\n        background: linear-gradient(90deg, #5a7aff, #7a5aff);\n        border-radius: 2px;\n        transition: width 0.3s ease;\n      }\n      .model-item.cached .progress-bar {\n        background: #4a8;\n      }\n      .model-item.error .progress-bar {\n        background: #a44;\n      }\n      .progress-actions {\n        display: flex;\n        gap: 10px;\n      }\n      .prefetch-btn, .clear-cache-btn {\n        flex: 1;\n        padding: 8px 16px;\n        border: none;\n        border-radius: 4px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n      .prefetch-btn {\n        background: #5a7aff;\n        color: white;\n      }\n      .prefetch-btn:hover:not(:disabled) {\n        background: #6a8aff;\n      }\n      .prefetch-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      .clear-cache-btn {\n        background: #3a3a5a;\n        color: #ccc;\n      }\n      .clear-cache-btn:hover:not(:disabled) {\n        background: #4a4a6a;\n      }\n      .clear-cache-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      .completion-message {\n        margin-top: 12px;\n        padding: 10px;\n        border-radius: 6px;\n        font-size: 13px;\n        text-align: center;\n      }\n      .completion-message.success {\n        background: rgba(68, 170, 136, 0.1);\n        color: #4a8;\n        border: 1px solid rgba(68, 170, 136, 0.3);\n      }\n      .completion-message.error {\n        background: rgba(170, 68, 68, 0.1);\n        color: #a44;\n        border: 1px solid rgba(170, 68, 68, 0.3);\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Destroy the component\n   */\n  destroy(): void {\n    this.unsubscribe?.();\n    this.container.remove();\n  }\n}\n\n/**\n * Create download progress container\n */\nexport function createDownloadProgressContainer(): HTMLElement {\n  const container = document.createElement('div');\n  container.id = 'downloadProgressContainer';\n  return container;\n}\n","/**\n * Comprehensive error handling system for the PBR texture generator.\n * Provides error classification, recovery suggestions, and user-friendly messages.\n */\n\n/**\n * Error codes covering all application domains\n */\nexport enum ErrorCode {\n  // General errors\n  UNKNOWN_ERROR = 'UNKNOWN_ERROR',\n  NETWORK_ERROR = 'NETWORK_ERROR',\n  TIMEOUT_ERROR = 'TIMEOUT_ERROR',\n\n  // WebGPU/WebGL errors\n  WEBGPU_NOT_SUPPORTED = 'WEBGPU_NOT_SUPPORTED',\n  WEBGL2_NOT_SUPPORTED = 'WEBGL2_NOT_SUPPORTED',\n  GPU_CONTEXT_LOST = 'GPU_CONTEXT_LOST',\n  SHADER_COMPILATION_ERROR = 'SHADER_COMPILATION_ERROR',\n\n  // Model/Inference errors\n  MODEL_NOT_FOUND = 'MODEL_NOT_FOUND',\n  MODEL_LOAD_FAILED = 'MODEL_LOAD_FAILED',\n  MODEL_CORRUPT = 'MODEL_CORRUPT',\n  INFERENCE_OOM = 'INFERENCE_OOM',\n  INFERENCE_FAILED = 'INFERENCE_FAILED',\n  WORKER_ERROR = 'WORKER_ERROR',\n  SESSION_NOT_READY = 'SESSION_NOT_READY',\n\n  // Image processing errors\n  IMAGE_LOAD_FAILED = 'IMAGE_LOAD_FAILED',\n  IMAGE_TOO_LARGE = 'IMAGE_TOO_LARGE',\n  IMAGE_INVALID_FORMAT = 'IMAGE_INVALID_FORMAT',\n  GENERATION_FAILED = 'GENERATION_FAILED',\n\n  // 3dverse errors\n  AUTH_FAILED = 'AUTH_FAILED',\n  AUTH_EXPIRED = 'AUTH_EXPIRED',\n  AUTH_INVALID_KEY = 'AUTH_INVALID_KEY',\n  UPLOAD_FAILED = 'UPLOAD_FAILED',\n  UPLOAD_QUOTA_EXCEEDED = 'UPLOAD_QUOTA_EXCEEDED',\n  MATERIAL_CREATE_FAILED = 'MATERIAL_CREATE_FAILED',\n  FOLDER_NOT_FOUND = 'FOLDER_NOT_FOUND',\n  API_ERROR = 'API_ERROR',\n\n  // Cache/Storage errors\n  CACHE_ERROR = 'CACHE_ERROR',\n  INDEXEDDB_ERROR = 'INDEXEDDB_ERROR',\n  QUOTA_EXCEEDED = 'QUOTA_EXCEEDED',\n}\n\n/**\n * Error severity levels\n */\nexport enum ErrorSeverity {\n  /** Informational, operation may still succeed */\n  INFO = 'info',\n  /** Warning, operation completed with issues */\n  WARNING = 'warning',\n  /** Error, operation failed but recoverable */\n  ERROR = 'error',\n  /** Fatal, requires page reload or major action */\n  FATAL = 'fatal',\n}\n\n/**\n * Recovery action types\n */\nexport type RecoveryAction =\n  | 'retry'\n  | 'retry-with-fallback'\n  | 'reload-page'\n  | 'clear-cache'\n  | 'reduce-quality'\n  | 'use-smaller-image'\n  | 're-authenticate'\n  | 'contact-support'\n  | 'none';\n\n/**\n * Structured application error\n */\nexport class PBRGeneratorError extends Error {\n  public readonly timestamp: number;\n\n  constructor(\n    message: string,\n    public readonly code: ErrorCode,\n    public readonly severity: ErrorSeverity = ErrorSeverity.ERROR,\n    public readonly recoverable: boolean = true,\n    public readonly recoveryAction: RecoveryAction = 'retry',\n    public readonly suggestion?: string,\n    public readonly details?: Record<string, unknown>\n  ) {\n    super(message);\n    this.name = 'PBRGeneratorError';\n    this.timestamp = Date.now();\n  }\n\n  /**\n   * Create a user-friendly error message\n   */\n  toUserMessage(): string {\n    const messages: Record<ErrorCode, string> = {\n      [ErrorCode.UNKNOWN_ERROR]: 'An unexpected error occurred.',\n      [ErrorCode.NETWORK_ERROR]: 'Network connection failed. Check your internet.',\n      [ErrorCode.TIMEOUT_ERROR]: 'Operation timed out. Try again.',\n\n      [ErrorCode.WEBGPU_NOT_SUPPORTED]: 'WebGPU is not supported. Using fallback mode.',\n      [ErrorCode.WEBGL2_NOT_SUPPORTED]: 'WebGL2 is not supported. Please use a modern browser.',\n      [ErrorCode.GPU_CONTEXT_LOST]: 'GPU context was lost. Refreshing may help.',\n      [ErrorCode.SHADER_COMPILATION_ERROR]: 'Shader compilation failed. Try reloading.',\n\n      [ErrorCode.MODEL_NOT_FOUND]: 'AI model not found. Try refreshing the page.',\n      [ErrorCode.MODEL_LOAD_FAILED]: 'Failed to load AI model. Try again.',\n      [ErrorCode.MODEL_CORRUPT]: 'Model file is corrupted. Clearing cache may help.',\n      [ErrorCode.INFERENCE_OOM]: 'Out of memory. Try a smaller image or lower quality.',\n      [ErrorCode.INFERENCE_FAILED]: 'AI inference failed. Try again or use traditional mode.',\n      [ErrorCode.WORKER_ERROR]: 'Background worker error. Reloading may help.',\n      [ErrorCode.SESSION_NOT_READY]: 'AI session not ready. Please wait.',\n\n      [ErrorCode.IMAGE_LOAD_FAILED]: 'Failed to load image. Check the file format.',\n      [ErrorCode.IMAGE_TOO_LARGE]: 'Image too large. Use an image 4096x4096 or smaller.',\n      [ErrorCode.IMAGE_INVALID_FORMAT]: 'Invalid image format. Use PNG, JPEG, or WebP.',\n      [ErrorCode.GENERATION_FAILED]: 'Failed to generate PBR maps. Try again.',\n\n      [ErrorCode.AUTH_FAILED]: '3dverse authentication failed.',\n      [ErrorCode.AUTH_EXPIRED]: 'Session expired. Please log in again.',\n      [ErrorCode.AUTH_INVALID_KEY]: 'Invalid API key. Check your credentials.',\n      [ErrorCode.UPLOAD_FAILED]: 'Upload failed. Check connection and try again.',\n      [ErrorCode.UPLOAD_QUOTA_EXCEEDED]: 'Storage quota exceeded.',\n      [ErrorCode.MATERIAL_CREATE_FAILED]: 'Failed to create material.',\n      [ErrorCode.FOLDER_NOT_FOUND]: 'Folder not found.',\n      [ErrorCode.API_ERROR]: '3dverse API error.',\n\n      [ErrorCode.CACHE_ERROR]: 'Cache error. Clearing cache may help.',\n      [ErrorCode.INDEXEDDB_ERROR]: 'Storage error. Try a different browser.',\n      [ErrorCode.QUOTA_EXCEEDED]: 'Storage quota exceeded. Clear cache.',\n    };\n\n    return messages[this.code] || this.message;\n  }\n}\n\n/**\n * Error handler with recovery support\n */\nexport class ErrorHandler {\n  private errorLog: PBRGeneratorError[] = [];\n  private maxLogSize = 100;\n  private listeners: Set<(error: PBRGeneratorError) => void> = new Set();\n\n  /**\n   * Handle an error with optional recovery attempt\n   */\n  handle(error: unknown): PBRGeneratorError {\n    const pbrError = this.normalize(error);\n    this.log(pbrError);\n    this.notify(pbrError);\n    return pbrError;\n  }\n\n  /**\n   * Normalize any error type to PBRGeneratorError\n   */\n  normalize(error: unknown): PBRGeneratorError {\n    // Already a PBRGeneratorError\n    if (error instanceof PBRGeneratorError) {\n      return error;\n    }\n\n    // Standard Error\n    if (error instanceof Error) {\n      return this.classifyError(error);\n    }\n\n    // String error\n    if (typeof error === 'string') {\n      return new PBRGeneratorError(\n        error,\n        ErrorCode.UNKNOWN_ERROR,\n        ErrorSeverity.ERROR,\n        true,\n        'retry'\n      );\n    }\n\n    // Unknown error type\n    return new PBRGeneratorError(\n      'An unknown error occurred',\n      ErrorCode.UNKNOWN_ERROR,\n      ErrorSeverity.ERROR,\n      true,\n      'retry',\n      undefined,\n      { originalError: error }\n    );\n  }\n\n  /**\n   * Classify standard Error based on message/name patterns\n   */\n  private classifyError(error: Error): PBRGeneratorError {\n    const msg = error.message.toLowerCase();\n    const name = error.name.toLowerCase();\n\n    // Network errors\n    if (name === 'typeerror' && msg.includes('fetch')) {\n      return new PBRGeneratorError(\n        error.message,\n        ErrorCode.NETWORK_ERROR,\n        ErrorSeverity.ERROR,\n        true,\n        'retry',\n        'Check your internet connection'\n      );\n    }\n\n    // Timeout\n    if (msg.includes('timeout') || name === 'timeouterror') {\n      return new PBRGeneratorError(\n        error.message,\n        ErrorCode.TIMEOUT_ERROR,\n        ErrorSeverity.ERROR,\n        true,\n        'retry'\n      );\n    }\n\n    // Out of memory\n    if (msg.includes('out of memory') || msg.includes('oom') || msg.includes('allocation')) {\n      return new PBRGeneratorError(\n        error.message,\n        ErrorCode.INFERENCE_OOM,\n        ErrorSeverity.ERROR,\n        true,\n        'reduce-quality',\n        'Try using a smaller image or lower quality setting'\n      );\n    }\n\n    // GPU context lost\n    if (msg.includes('context lost') || msg.includes('webgl')) {\n      return new PBRGeneratorError(\n        error.message,\n        ErrorCode.GPU_CONTEXT_LOST,\n        ErrorSeverity.FATAL,\n        true,\n        'reload-page'\n      );\n    }\n\n    // IndexedDB errors\n    if (msg.includes('indexeddb') || msg.includes('quota')) {\n      return new PBRGeneratorError(\n        error.message,\n        ErrorCode.INDEXEDDB_ERROR,\n        ErrorSeverity.WARNING,\n        true,\n        'clear-cache'\n      );\n    }\n\n    // Default: unknown error\n    return new PBRGeneratorError(\n      error.message,\n      ErrorCode.UNKNOWN_ERROR,\n      ErrorSeverity.ERROR,\n      true,\n      'retry',\n      undefined,\n      { stack: error.stack }\n    );\n  }\n\n  /**\n   * Log error to internal history\n   */\n  private log(error: PBRGeneratorError): void {\n    this.errorLog.push(error);\n    if (this.errorLog.length > this.maxLogSize) {\n      this.errorLog.shift();\n    }\n\n    // Console log based on severity\n    const consoleMethod = error.severity === ErrorSeverity.FATAL || error.severity === ErrorSeverity.ERROR\n      ? console.error\n      : error.severity === ErrorSeverity.WARNING\n        ? console.warn\n        : console.info;\n\n    consoleMethod(`[${error.code}]`, error.message, error.details || '');\n  }\n\n  /**\n   * Notify error listeners\n   */\n  private notify(error: PBRGeneratorError): void {\n    this.listeners.forEach((listener) => {\n      try {\n        listener(error);\n      } catch {\n        console.error('Error in error listener');\n      }\n    });\n  }\n\n  /**\n   * Subscribe to error events\n   */\n  onError(callback: (error: PBRGeneratorError) => void): () => void {\n    this.listeners.add(callback);\n    return () => this.listeners.delete(callback);\n  }\n\n  /**\n   * Get error history\n   */\n  getErrorLog(): ReadonlyArray<PBRGeneratorError> {\n    return [...this.errorLog];\n  }\n\n  /**\n   * Clear error history\n   */\n  clearLog(): void {\n    this.errorLog = [];\n  }\n}\n\n// Singleton instance\nlet handlerInstance: ErrorHandler | null = null;\n\n/**\n * Get the global error handler\n */\nexport function getErrorHandler(): ErrorHandler {\n  if (!handlerInstance) {\n    handlerInstance = new ErrorHandler();\n  }\n  return handlerInstance;\n}\n\n/**\n * Utility function for retry with exponential backoff\n */\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  options: {\n    maxRetries?: number;\n    initialDelayMs?: number;\n    maxDelayMs?: number;\n    backoffMultiplier?: number;\n    shouldRetry?: (error: unknown, attempt: number) => boolean;\n    onRetry?: (error: unknown, attempt: number, delayMs: number) => void;\n  } = {}\n): Promise<T> {\n  const {\n    maxRetries = 3,\n    initialDelayMs = 1000,\n    maxDelayMs = 30000,\n    backoffMultiplier = 2,\n    shouldRetry = () => true,\n    onRetry,\n  } = options;\n\n  let lastError: unknown;\n\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (e) {\n      lastError = e;\n\n      if (attempt >= maxRetries || !shouldRetry(e, attempt)) {\n        throw e;\n      }\n\n      const delay = Math.min(initialDelayMs * Math.pow(backoffMultiplier, attempt), maxDelayMs);\n      onRetry?.(e, attempt, delay);\n      await sleep(delay);\n    }\n  }\n\n  throw lastError;\n}\n\n/**\n * Simple sleep utility\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Wrap a function with error handling\n */\nexport function withErrorHandling<T extends unknown[], R>(\n  fn: (...args: T) => Promise<R>,\n  options: {\n    fallback?: R;\n    rethrow?: boolean;\n    onError?: (error: PBRGeneratorError) => void;\n  } = {}\n): (...args: T) => Promise<R> {\n  return async (...args: T): Promise<R> => {\n    try {\n      return await fn(...args);\n    } catch (e) {\n      const handler = getErrorHandler();\n      const pbrError = handler.handle(e);\n      options.onError?.(pbrError);\n\n      if (options.rethrow !== false) {\n        throw pbrError;\n      }\n\n      return options.fallback as R;\n    }\n  };\n}\n","/**\n * Error boundary UI component for displaying and recovering from errors.\n * Provides user-friendly error messages with recovery actions.\n */\n\nimport {\n  PBRGeneratorError,\n  ErrorSeverity,\n  type RecoveryAction,\n  getErrorHandler,\n} from '../utils/error-handler.ts';\n\n/**\n * Error display configuration\n */\nexport interface ErrorDisplayConfig {\n  position?: 'top' | 'bottom' | 'inline';\n  autoDismissMs?: number;\n  maxVisible?: number;\n}\n\nconst DEFAULT_CONFIG: ErrorDisplayConfig = {\n  position: 'top',\n  autoDismissMs: 5000,\n  maxVisible: 3,\n};\n\n/**\n * Displayed error entry\n */\ninterface ErrorEntry {\n  id: number;\n  error: PBRGeneratorError;\n  element: HTMLElement;\n  dismissTimeout?: ReturnType<typeof setTimeout>;\n}\n\n/**\n * Error boundary component\n */\nexport class ErrorBoundary {\n  private container: HTMLElement;\n  private config: ErrorDisplayConfig;\n  private errors: ErrorEntry[] = [];\n  private nextId = 1;\n  private unsubscribe: (() => void) | null = null;\n\n  constructor(parent: HTMLElement, config: Partial<ErrorDisplayConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n\n    this.container = document.createElement('div');\n    this.container.className = `error-boundary error-boundary-${this.config.position}`;\n    parent.appendChild(this.container);\n\n    this.applyStyles();\n\n    // Subscribe to global error handler\n    const handler = getErrorHandler();\n    this.unsubscribe = handler.onError((error) => this.showError(error));\n  }\n\n  /**\n   * Display an error\n   */\n  showError(error: PBRGeneratorError): void {\n    // Enforce max visible\n    while (this.errors.length >= (this.config.maxVisible || 3)) {\n      const oldest = this.errors.shift();\n      if (oldest) {\n        this.dismissError(oldest);\n      }\n    }\n\n    const id = this.nextId++;\n    const element = this.createErrorElement(id, error);\n    this.container.appendChild(element);\n\n    // Animate in\n    requestAnimationFrame(() => {\n      element.classList.add('visible');\n    });\n\n    const entry: ErrorEntry = { id, error, element };\n\n    // Auto-dismiss for non-fatal errors\n    if (\n      error.severity !== ErrorSeverity.FATAL &&\n      this.config.autoDismissMs &&\n      this.config.autoDismissMs > 0\n    ) {\n      entry.dismissTimeout = setTimeout(() => {\n        this.dismiss(id);\n      }, this.config.autoDismissMs);\n    }\n\n    this.errors.push(entry);\n  }\n\n  /**\n   * Dismiss an error by ID\n   */\n  dismiss(id: number): void {\n    const index = this.errors.findIndex((e) => e.id === id);\n    if (index === -1) return;\n\n    const entry = this.errors[index];\n    this.dismissError(entry);\n    this.errors.splice(index, 1);\n  }\n\n  /**\n   * Clear all errors\n   */\n  clearAll(): void {\n    for (const entry of this.errors) {\n      this.dismissError(entry);\n    }\n    this.errors = [];\n  }\n\n  /**\n   * Create error element\n   */\n  private createErrorElement(id: number, error: PBRGeneratorError): HTMLElement {\n    const el = document.createElement('div');\n    el.className = `error-item error-${error.severity}`;\n    el.dataset.errorId = String(id);\n\n    const icon = this.getSeverityIcon(error.severity);\n    const actionButton = this.createActionButton(id, error.recoveryAction, error.recoverable);\n\n    el.innerHTML = `\n      <div class=\"error-icon\">${icon}</div>\n      <div class=\"error-content\">\n        <div class=\"error-message\">${error.toUserMessage()}</div>\n        ${error.suggestion ? `<div class=\"error-suggestion\">${error.suggestion}</div>` : ''}\n      </div>\n      <div class=\"error-actions\">\n        ${actionButton}\n        <button class=\"dismiss-btn\" title=\"Dismiss\">&times;</button>\n      </div>\n    `;\n\n    // Dismiss button\n    const dismissBtn = el.querySelector('.dismiss-btn');\n    dismissBtn?.addEventListener('click', () => this.dismiss(id));\n\n    // Recovery action button\n    const recoveryBtn = el.querySelector('.recovery-btn');\n    recoveryBtn?.addEventListener('click', () => this.executeRecovery(id, error.recoveryAction));\n\n    return el;\n  }\n\n  /**\n   * Get icon for severity\n   */\n  private getSeverityIcon(severity: ErrorSeverity): string {\n    switch (severity) {\n      case ErrorSeverity.INFO:\n        return '<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"/><path d=\"M12 16v-4M12 8h.01\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>';\n      case ErrorSeverity.WARNING:\n        return '<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><path d=\"M12 2L2 22h20L12 2z\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"/><path d=\"M12 9v4M12 17h.01\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>';\n      case ErrorSeverity.ERROR:\n      case ErrorSeverity.FATAL:\n        return '<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"/><path d=\"M15 9l-6 6M9 9l6 6\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>';\n      default:\n        return '';\n    }\n  }\n\n  /**\n   * Create action button based on recovery type\n   */\n  private createActionButton(\n    _id: number,\n    action: RecoveryAction,\n    recoverable: boolean\n  ): string {\n    if (!recoverable || action === 'none') return '';\n\n    const labels: Record<RecoveryAction, string> = {\n      'retry': 'Retry',\n      'retry-with-fallback': 'Try Fallback',\n      'reload-page': 'Reload Page',\n      'clear-cache': 'Clear Cache',\n      'reduce-quality': 'Lower Quality',\n      'use-smaller-image': 'Use Smaller',\n      're-authenticate': 'Log In Again',\n      'contact-support': 'Get Help',\n      'none': '',\n    };\n\n    const label = labels[action] || 'Retry';\n    return `<button class=\"recovery-btn\">${label}</button>`;\n  }\n\n  /**\n   * Execute recovery action\n   */\n  private executeRecovery(id: number, action: RecoveryAction): void {\n    switch (action) {\n      case 'reload-page':\n        window.location.reload();\n        break;\n      case 'clear-cache':\n        this.clearCacheAndRetry();\n        break;\n      case 're-authenticate':\n        // Dispatch custom event for auth handling\n        window.dispatchEvent(new CustomEvent('pbr-reauthenticate'));\n        break;\n      default:\n        // Dispatch retry event with error ID\n        window.dispatchEvent(new CustomEvent('pbr-error-retry', { detail: { id } }));\n        break;\n    }\n\n    this.dismiss(id);\n  }\n\n  /**\n   * Clear cache and retry\n   */\n  private async clearCacheAndRetry(): Promise<void> {\n    try {\n      // Clear IndexedDB model cache\n      const { getModelCache } = await import('../inference/model-cache.ts');\n      const cache = getModelCache();\n      await cache.clearAll();\n\n      // Dispatch retry event\n      window.dispatchEvent(new CustomEvent('pbr-error-retry'));\n    } catch (e) {\n      console.error('Failed to clear cache:', e);\n    }\n  }\n\n  /**\n   * Dismiss error entry\n   */\n  private dismissError(entry: ErrorEntry): void {\n    if (entry.dismissTimeout) {\n      clearTimeout(entry.dismissTimeout);\n    }\n\n    entry.element.classList.remove('visible');\n    entry.element.classList.add('dismissing');\n\n    setTimeout(() => {\n      entry.element.remove();\n    }, 300);\n  }\n\n  /**\n   * Apply styles\n   */\n  private applyStyles(): void {\n    if (document.getElementById('error-boundary-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'error-boundary-styles';\n    style.textContent = `\n      .error-boundary {\n        position: fixed;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 9999;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        max-width: 500px;\n        width: calc(100% - 40px);\n        pointer-events: none;\n      }\n      .error-boundary-top {\n        top: 20px;\n      }\n      .error-boundary-bottom {\n        bottom: 20px;\n      }\n      .error-boundary-inline {\n        position: relative;\n        transform: none;\n        left: auto;\n      }\n      .error-item {\n        display: flex;\n        align-items: flex-start;\n        gap: 12px;\n        padding: 12px 16px;\n        background: #2a2a4a;\n        border-radius: 8px;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);\n        opacity: 0;\n        transform: translateY(-20px);\n        transition: opacity 0.3s, transform 0.3s;\n        pointer-events: auto;\n      }\n      .error-item.visible {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      .error-item.dismissing {\n        opacity: 0;\n        transform: translateY(-20px);\n      }\n      .error-info {\n        border-left: 3px solid #5a7aff;\n      }\n      .error-warning {\n        border-left: 3px solid #ff9a5a;\n      }\n      .error-error {\n        border-left: 3px solid #ff5a5a;\n      }\n      .error-fatal {\n        border-left: 3px solid #ff2a2a;\n        background: #3a2a2a;\n      }\n      .error-icon {\n        flex-shrink: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      .error-info .error-icon {\n        color: #5a7aff;\n      }\n      .error-warning .error-icon {\n        color: #ff9a5a;\n      }\n      .error-error .error-icon,\n      .error-fatal .error-icon {\n        color: #ff5a5a;\n      }\n      .error-content {\n        flex: 1;\n        min-width: 0;\n      }\n      .error-message {\n        font-size: 14px;\n        color: #eee;\n        line-height: 1.4;\n      }\n      .error-suggestion {\n        margin-top: 4px;\n        font-size: 12px;\n        color: #888;\n      }\n      .error-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        flex-shrink: 0;\n      }\n      .recovery-btn {\n        padding: 4px 10px;\n        background: #5a7aff;\n        border: none;\n        border-radius: 4px;\n        color: white;\n        font-size: 12px;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .recovery-btn:hover {\n        background: #6a8aff;\n      }\n      .dismiss-btn {\n        padding: 2px 6px;\n        background: transparent;\n        border: none;\n        color: #666;\n        font-size: 18px;\n        cursor: pointer;\n        line-height: 1;\n      }\n      .dismiss-btn:hover {\n        color: #aaa;\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Destroy the component\n   */\n  destroy(): void {\n    this.unsubscribe?.();\n    this.clearAll();\n    this.container.remove();\n  }\n}\n\n/**\n * Create error boundary container\n */\nexport function createErrorBoundaryContainer(): HTMLElement {\n  const container = document.createElement('div');\n  container.id = 'errorBoundaryContainer';\n  return container;\n}\n\n// Singleton instance\nlet boundaryInstance: ErrorBoundary | null = null;\n\n/**\n * Get or create global error boundary\n */\nexport function getErrorBoundary(): ErrorBoundary {\n  if (!boundaryInstance) {\n    boundaryInstance = new ErrorBoundary(document.body);\n  }\n  return boundaryInstance;\n}\n","/**\n * Batch processing UI component for processing multiple textures.\n * Supports queuing, progress tracking, and bulk export.\n */\n\nimport type { ExtendedPBRMaps } from '../generators/index.ts';\n\n/**\n * Batch item status\n */\nexport type BatchItemStatus = 'pending' | 'processing' | 'complete' | 'error';\n\n/**\n * Batch item definition\n */\nexport interface BatchItem {\n  id: number;\n  file: File;\n  status: BatchItemStatus;\n  progress: number;\n  error?: string;\n  input?: ImageData;\n  maps?: ExtendedPBRMaps;\n}\n\n/**\n * Batch processing result\n */\nexport interface BatchResult {\n  totalItems: number;\n  completed: number;\n  failed: number;\n  items: BatchItem[];\n}\n\n/**\n * Batch processor callbacks\n */\nexport interface BatchProcessorCallbacks {\n  onProcess: (file: File) => Promise<{ input: ImageData; maps: ExtendedPBRMaps }>;\n  onExport: (item: BatchItem, maps: string[]) => Promise<void>;\n  onComplete: (result: BatchResult) => void;\n}\n\n/**\n * Batch processor component\n */\nexport class BatchProcessor {\n  private container: HTMLElement;\n  private items: BatchItem[] = [];\n  private nextId = 1;\n  private processing = false;\n  private callbacks: BatchProcessorCallbacks;\n  private visible = false;\n\n  constructor(parent: HTMLElement, callbacks: BatchProcessorCallbacks) {\n    this.callbacks = callbacks;\n\n    this.container = document.createElement('div');\n    this.container.className = 'batch-processor hidden';\n    parent.appendChild(this.container);\n\n    this.applyStyles();\n    this.render();\n  }\n\n  /**\n   * Show the batch processor\n   */\n  show(): void {\n    this.container.classList.remove('hidden');\n    this.visible = true;\n  }\n\n  /**\n   * Hide the batch processor\n   */\n  hide(): void {\n    this.container.classList.add('hidden');\n    this.visible = false;\n  }\n\n  /**\n   * Toggle visibility\n   */\n  toggle(): void {\n    if (this.visible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n\n  /**\n   * Check if visible\n   */\n  isVisible(): boolean {\n    return this.visible;\n  }\n\n  /**\n   * Add files to the batch queue\n   */\n  addFiles(files: FileList | File[]): void {\n    for (const file of files) {\n      if (!file.type.startsWith('image/')) continue;\n\n      this.items.push({\n        id: this.nextId++,\n        file,\n        status: 'pending',\n        progress: 0,\n      });\n    }\n\n    this.updateItemList();\n    this.updateStats();\n    this.updateButtons();\n  }\n\n  /**\n   * Remove an item from the queue\n   */\n  removeItem(id: number): void {\n    const index = this.items.findIndex((i) => i.id === id);\n    if (index !== -1 && this.items[index].status !== 'processing') {\n      this.items.splice(index, 1);\n      this.updateItemList();\n      this.updateStats();\n      this.updateButtons();\n    }\n  }\n\n  /**\n   * Clear all items\n   */\n  clearAll(): void {\n    if (this.processing) return;\n    this.items = [];\n    this.updateItemList();\n    this.updateStats();\n    this.updateButtons();\n  }\n\n  /**\n   * Start batch processing\n   */\n  async startProcessing(): Promise<void> {\n    if (this.processing) return;\n    if (this.items.length === 0) return;\n\n    this.processing = true;\n    this.updateButtons();\n\n    for (const item of this.items) {\n      if (item.status === 'complete') continue;\n\n      item.status = 'processing';\n      item.progress = 0;\n      this.updateItem(item.id);\n\n      try {\n        const result = await this.callbacks.onProcess(item.file);\n        item.input = result.input;\n        item.maps = result.maps;\n        item.status = 'complete';\n        item.progress = 1;\n      } catch (e) {\n        item.status = 'error';\n        item.error = e instanceof Error ? e.message : 'Unknown error';\n      }\n\n      this.updateItem(item.id);\n      this.updateStats();\n    }\n\n    this.processing = false;\n    this.updateButtons();\n\n    // Notify completion\n    const result: BatchResult = {\n      totalItems: this.items.length,\n      completed: this.items.filter((i) => i.status === 'complete').length,\n      failed: this.items.filter((i) => i.status === 'error').length,\n      items: this.items,\n    };\n    this.callbacks.onComplete(result);\n  }\n\n  /**\n   * Export all completed items\n   */\n  async exportAll(maps: string[] = ['basecolor', 'normal', 'roughness', 'metallic']): Promise<void> {\n    const completed = this.items.filter((i) => i.status === 'complete');\n    for (const item of completed) {\n      await this.callbacks.onExport(item, maps);\n    }\n  }\n\n  /**\n   * Check if currently processing\n   */\n  isProcessing(): boolean {\n    return this.processing;\n  }\n\n  /**\n   * Get batch statistics\n   */\n  getStats(): { total: number; pending: number; complete: number; error: number } {\n    return {\n      total: this.items.length,\n      pending: this.items.filter((i) => i.status === 'pending').length,\n      complete: this.items.filter((i) => i.status === 'complete').length,\n      error: this.items.filter((i) => i.status === 'error').length,\n    };\n  }\n\n  /**\n   * Render the component\n   */\n  private render(): void {\n    this.container.innerHTML = `\n      <div class=\"batch-header\">\n        <h3>Batch Processing</h3>\n        <button class=\"close-btn\">&times;</button>\n      </div>\n      <div class=\"batch-content\">\n        <div class=\"batch-drop-zone\">\n          <p>Drop multiple images here</p>\n          <p class=\"hint\">or click to select files</p>\n          <input type=\"file\" multiple accept=\"image/png,image/jpeg,image/webp\" class=\"batch-file-input\">\n        </div>\n        <div class=\"batch-stats\">\n          <span class=\"stat-item\">Total: <span class=\"stat-total\">0</span></span>\n          <span class=\"stat-item\">Pending: <span class=\"stat-pending\">0</span></span>\n          <span class=\"stat-item\">Complete: <span class=\"stat-complete\">0</span></span>\n          <span class=\"stat-item\">Error: <span class=\"stat-error\">0</span></span>\n        </div>\n        <div class=\"batch-item-list\"></div>\n        <div class=\"batch-actions\">\n          <button class=\"start-btn\" disabled>Start Processing</button>\n          <button class=\"export-btn\" disabled>Export All</button>\n          <button class=\"clear-btn\" disabled>Clear</button>\n        </div>\n      </div>\n    `;\n\n    // Event handlers\n    const closeBtn = this.container.querySelector('.close-btn');\n    closeBtn?.addEventListener('click', () => this.hide());\n\n    const dropZone = this.container.querySelector('.batch-drop-zone') as HTMLElement;\n    const fileInput = this.container.querySelector('.batch-file-input') as HTMLInputElement;\n\n    dropZone.addEventListener('click', () => fileInput.click());\n    dropZone.addEventListener('dragover', (e) => {\n      e.preventDefault();\n      dropZone.classList.add('dragover');\n    });\n    dropZone.addEventListener('dragleave', () => {\n      dropZone.classList.remove('dragover');\n    });\n    dropZone.addEventListener('drop', (e) => {\n      e.preventDefault();\n      dropZone.classList.remove('dragover');\n      if (e.dataTransfer?.files) {\n        this.addFiles(e.dataTransfer.files);\n      }\n    });\n\n    fileInput.addEventListener('change', () => {\n      if (fileInput.files) {\n        this.addFiles(fileInput.files);\n        fileInput.value = '';\n      }\n    });\n\n    const startBtn = this.container.querySelector('.start-btn');\n    startBtn?.addEventListener('click', () => this.startProcessing());\n\n    const exportBtn = this.container.querySelector('.export-btn');\n    exportBtn?.addEventListener('click', () => this.exportAll());\n\n    const clearBtn = this.container.querySelector('.clear-btn');\n    clearBtn?.addEventListener('click', () => this.clearAll());\n  }\n\n  /**\n   * Update item list display\n   */\n  private updateItemList(): void {\n    const list = this.container.querySelector('.batch-item-list');\n    if (!list) return;\n\n    if (this.items.length === 0) {\n      list.innerHTML = '<p class=\"no-items\">No items in queue</p>';\n      return;\n    }\n\n    list.innerHTML = this.items.map((item) => `\n      <div class=\"batch-item batch-item-${item.status}\" data-id=\"${item.id}\">\n        <div class=\"item-info\">\n          <span class=\"item-name\">${this.truncateFilename(item.file.name)}</span>\n          <span class=\"item-size\">${this.formatSize(item.file.size)}</span>\n        </div>\n        <div class=\"item-status\">\n          ${this.getStatusIndicator(item)}\n        </div>\n        <button class=\"remove-btn\" title=\"Remove\" ${item.status === 'processing' ? 'disabled' : ''}>\n          &times;\n        </button>\n      </div>\n    `).join('');\n\n    // Add remove handlers\n    const removeButtons = list.querySelectorAll('.remove-btn');\n    removeButtons.forEach((btn) => {\n      btn.addEventListener('click', (e) => {\n        const parent = (e.target as HTMLElement).closest('.batch-item');\n        const id = parseInt(parent?.getAttribute('data-id') || '0', 10);\n        if (id) this.removeItem(id);\n      });\n    });\n  }\n\n  /**\n   * Update a single item in the list\n   */\n  private updateItem(id: number): void {\n    const item = this.items.find((i) => i.id === id);\n    if (!item) return;\n\n    const el = this.container.querySelector(`.batch-item[data-id=\"${id}\"]`);\n    if (!el) return;\n\n    el.className = `batch-item batch-item-${item.status}`;\n    const statusEl = el.querySelector('.item-status');\n    if (statusEl) {\n      statusEl.innerHTML = this.getStatusIndicator(item);\n    }\n  }\n\n  /**\n   * Get status indicator HTML\n   */\n  private getStatusIndicator(item: BatchItem): string {\n    switch (item.status) {\n      case 'pending':\n        return '<span class=\"status-badge pending\">Pending</span>';\n      case 'processing':\n        return `<span class=\"status-badge processing\">Processing...</span>`;\n      case 'complete':\n        return '<span class=\"status-badge complete\">Done</span>';\n      case 'error':\n        return `<span class=\"status-badge error\" title=\"${item.error || ''}\">Error</span>`;\n      default:\n        return '';\n    }\n  }\n\n  /**\n   * Update statistics display\n   */\n  private updateStats(): void {\n    const stats = this.getStats();\n    const totalEl = this.container.querySelector('.stat-total');\n    const pendingEl = this.container.querySelector('.stat-pending');\n    const completeEl = this.container.querySelector('.stat-complete');\n    const errorEl = this.container.querySelector('.stat-error');\n\n    if (totalEl) totalEl.textContent = String(stats.total);\n    if (pendingEl) pendingEl.textContent = String(stats.pending);\n    if (completeEl) completeEl.textContent = String(stats.complete);\n    if (errorEl) errorEl.textContent = String(stats.error);\n  }\n\n  /**\n   * Update button states\n   */\n  private updateButtons(): void {\n    const startBtn = this.container.querySelector('.start-btn') as HTMLButtonElement;\n    const exportBtn = this.container.querySelector('.export-btn') as HTMLButtonElement;\n    const clearBtn = this.container.querySelector('.clear-btn') as HTMLButtonElement;\n\n    const hasPending = this.items.some((i) => i.status === 'pending' || i.status === 'error');\n    const hasComplete = this.items.some((i) => i.status === 'complete');\n\n    if (startBtn) {\n      startBtn.disabled = this.processing || !hasPending;\n      startBtn.textContent = this.processing ? 'Processing...' : 'Start Processing';\n    }\n    if (exportBtn) {\n      exportBtn.disabled = this.processing || !hasComplete;\n    }\n    if (clearBtn) {\n      clearBtn.disabled = this.processing || this.items.length === 0;\n    }\n  }\n\n  /**\n   * Truncate filename for display\n   */\n  private truncateFilename(name: string, maxLen: number = 30): string {\n    if (name.length <= maxLen) return name;\n    const ext = name.split('.').pop() || '';\n    const base = name.slice(0, -(ext.length + 1));\n    const truncated = base.slice(0, maxLen - ext.length - 4) + '...';\n    return `${truncated}.${ext}`;\n  }\n\n  /**\n   * Format file size\n   */\n  private formatSize(bytes: number): string {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  }\n\n  /**\n   * Apply styles\n   */\n  private applyStyles(): void {\n    if (document.getElementById('batch-processor-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'batch-processor-styles';\n    style.textContent = `\n      .batch-processor {\n        background: #2a2a4a;\n        border-radius: 8px;\n        margin-bottom: 20px;\n        overflow: hidden;\n      }\n      .batch-processor.hidden {\n        display: none;\n      }\n      .batch-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 16px;\n        background: #3a3a5a;\n      }\n      .batch-header h3 {\n        margin: 0;\n        font-size: 14px;\n        color: #fff;\n      }\n      .batch-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .batch-header .close-btn:hover {\n        color: #fff;\n      }\n      .batch-content {\n        padding: 16px;\n      }\n      .batch-drop-zone {\n        border: 2px dashed #4a4a6a;\n        border-radius: 8px;\n        padding: 30px;\n        text-align: center;\n        cursor: pointer;\n        transition: border-color 0.2s, background 0.2s;\n        margin-bottom: 16px;\n      }\n      .batch-drop-zone:hover, .batch-drop-zone.dragover {\n        border-color: #7878ff;\n        background: rgba(120, 120, 255, 0.05);\n      }\n      .batch-drop-zone p {\n        margin: 0;\n        color: #888;\n      }\n      .batch-drop-zone .hint {\n        font-size: 12px;\n        margin-top: 8px;\n      }\n      .batch-file-input {\n        display: none;\n      }\n      .batch-stats {\n        display: flex;\n        gap: 16px;\n        padding: 10px 0;\n        border-bottom: 1px solid #3a3a5a;\n        margin-bottom: 12px;\n        font-size: 13px;\n      }\n      .stat-item {\n        color: #888;\n      }\n      .stat-total, .stat-pending, .stat-complete, .stat-error {\n        color: #fff;\n        font-weight: 500;\n      }\n      .stat-complete {\n        color: #4a8;\n      }\n      .stat-error {\n        color: #a44;\n      }\n      .batch-item-list {\n        max-height: 300px;\n        overflow-y: auto;\n        margin-bottom: 16px;\n      }\n      .no-items {\n        text-align: center;\n        color: #666;\n        padding: 20px;\n      }\n      .batch-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px;\n        background: #1a1a2e;\n        border-radius: 6px;\n        margin-bottom: 8px;\n      }\n      .batch-item:last-child {\n        margin-bottom: 0;\n      }\n      .item-info {\n        flex: 1;\n        min-width: 0;\n      }\n      .item-name {\n        display: block;\n        font-size: 13px;\n        color: #ccc;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n      .item-size {\n        font-size: 11px;\n        color: #666;\n      }\n      .status-badge {\n        padding: 3px 8px;\n        border-radius: 10px;\n        font-size: 11px;\n        white-space: nowrap;\n      }\n      .status-badge.pending {\n        background: #3a3a5a;\n        color: #888;\n      }\n      .status-badge.processing {\n        background: rgba(90, 122, 255, 0.2);\n        color: #5a7aff;\n      }\n      .status-badge.complete {\n        background: rgba(68, 170, 136, 0.2);\n        color: #4a8;\n      }\n      .status-badge.error {\n        background: rgba(170, 68, 68, 0.2);\n        color: #a44;\n      }\n      .batch-item .remove-btn {\n        background: none;\n        border: none;\n        color: #666;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px;\n        line-height: 1;\n      }\n      .batch-item .remove-btn:hover:not(:disabled) {\n        color: #a44;\n      }\n      .batch-item .remove-btn:disabled {\n        cursor: not-allowed;\n        opacity: 0.3;\n      }\n      .batch-actions {\n        display: flex;\n        gap: 10px;\n      }\n      .batch-actions button {\n        flex: 1;\n        padding: 10px;\n        border: none;\n        border-radius: 4px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n      .start-btn {\n        background: #5a7aff;\n        color: white;\n      }\n      .start-btn:hover:not(:disabled) {\n        background: #6a8aff;\n      }\n      .export-btn {\n        background: #5a8a5a;\n        color: white;\n      }\n      .export-btn:hover:not(:disabled) {\n        background: #6a9a6a;\n      }\n      .clear-btn {\n        background: #3a3a5a;\n        color: #ccc;\n      }\n      .clear-btn:hover:not(:disabled) {\n        background: #4a4a6a;\n      }\n      .batch-actions button:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Destroy the component\n   */\n  destroy(): void {\n    this.container.remove();\n  }\n}\n\n/**\n * Create batch processor container\n */\nexport function createBatchProcessorContainer(): HTMLElement {\n  const container = document.createElement('div');\n  container.id = 'batchProcessorContainer';\n  return container;\n}\n","/**\n * PBR Material Preview renderer.\n * Renders a 3D sphere/cube/plane with PBR materials using WebGL2.\n */\n\nimport { PBR_VERTEX_SHADER } from './shaders/pbr.vert.ts';\nimport { PBR_FRAGMENT_SHADER } from './shaders/pbr.frag.ts';\nimport { createSphere, createCube, createPlane, type Geometry } from './geometry.ts';\nimport type { ExtendedPBRMaps } from '../generators/unified.ts';\n\n/**\n * Preview geometry type\n */\nexport type PreviewGeometryType = 'sphere' | 'cube' | 'plane';\n\n/**\n * Preview configuration\n */\nexport interface PreviewConfig {\n  /** Geometry to use for preview */\n  geometry: PreviewGeometryType;\n  /** Texture tiling */\n  tiling: [number, number];\n  /** Texture offset */\n  offset: [number, number];\n  /** Auto-rotate */\n  autoRotate: boolean;\n  /** Rotation speed (radians per second) */\n  rotationSpeed: number;\n  /** Light direction */\n  lightDirection: [number, number, number];\n  /** Light color */\n  lightColor: [number, number, number];\n  /** Light intensity */\n  lightIntensity: number;\n  /** Ambient color */\n  ambientColor: [number, number, number];\n  /** Ambient intensity */\n  ambientIntensity: number;\n}\n\n/**\n * Default preview configuration\n */\nexport const DEFAULT_PREVIEW_CONFIG: PreviewConfig = {\n  geometry: 'sphere',\n  tiling: [1, 1],\n  offset: [0, 0],\n  autoRotate: true,\n  rotationSpeed: 0.5,\n  lightDirection: [1, 1, 1],\n  lightColor: [1, 1, 1],\n  lightIntensity: 2.0,\n  ambientColor: [0.3, 0.4, 0.5],\n  ambientIntensity: 0.5,\n};\n\n/**\n * Shader uniform locations cache\n */\ninterface UniformLocations {\n  modelMatrix: WebGLUniformLocation | null;\n  viewMatrix: WebGLUniformLocation | null;\n  projectionMatrix: WebGLUniformLocation | null;\n  normalMatrix: WebGLUniformLocation | null;\n  cameraPosition: WebGLUniformLocation | null;\n  basecolorMap: WebGLUniformLocation | null;\n  normalMap: WebGLUniformLocation | null;\n  roughnessMap: WebGLUniformLocation | null;\n  metallicMap: WebGLUniformLocation | null;\n  useBasecolorMap: WebGLUniformLocation | null;\n  useNormalMap: WebGLUniformLocation | null;\n  useRoughnessMap: WebGLUniformLocation | null;\n  useMetallicMap: WebGLUniformLocation | null;\n  baseColor: WebGLUniformLocation | null;\n  roughness: WebGLUniformLocation | null;\n  metallic: WebGLUniformLocation | null;\n  lightDirection: WebGLUniformLocation | null;\n  lightColor: WebGLUniformLocation | null;\n  lightIntensity: WebGLUniformLocation | null;\n  ambientColor: WebGLUniformLocation | null;\n  ambientIntensity: WebGLUniformLocation | null;\n  textureTiling: WebGLUniformLocation | null;\n  textureOffset: WebGLUniformLocation | null;\n}\n\n/**\n * PBR Material Preview class\n */\nexport class PBRPreview {\n  private canvas: HTMLCanvasElement;\n  private gl: WebGL2RenderingContext;\n  private program: WebGLProgram | null = null;\n  private uniforms: UniformLocations | null = null;\n  private vao: WebGLVertexArrayObject | null = null;\n  private geometry: Geometry | null = null;\n  private geometryType: PreviewGeometryType = 'sphere';\n\n  // Textures\n  private basecolorTexture: WebGLTexture | null = null;\n  private normalTexture: WebGLTexture | null = null;\n  private roughnessTexture: WebGLTexture | null = null;\n  private metallicTexture: WebGLTexture | null = null;\n\n  // Configuration\n  private config: PreviewConfig;\n\n  // Animation state\n  private rotation: number = 0;\n  private animationId: number | null = null;\n  private lastFrameTime: number = 0;\n\n  // Camera state\n  private cameraDistance: number = 3;\n  private cameraRotationX: number = 0.3;\n  private cameraRotationY: number = 0;\n  private isDragging: boolean = false;\n  private lastMouseX: number = 0;\n  private lastMouseY: number = 0;\n\n  constructor(canvas: HTMLCanvasElement, config: Partial<PreviewConfig> = {}) {\n    this.canvas = canvas;\n    this.config = { ...DEFAULT_PREVIEW_CONFIG, ...config };\n\n    const gl = canvas.getContext('webgl2', {\n      antialias: true,\n      alpha: false,\n      premultipliedAlpha: false,\n    });\n\n    if (!gl) {\n      throw new Error('WebGL2 not supported');\n    }\n\n    this.gl = gl;\n\n    this.initializeShaders();\n    this.initializeGeometry();\n    this.setupInteraction();\n\n    // Start render loop\n    this.startRenderLoop();\n  }\n\n  /**\n   * Initialize shaders\n   */\n  private initializeShaders(): void {\n    const gl = this.gl;\n\n    // Compile shaders\n    const vertShader = this.compileShader(gl.VERTEX_SHADER, PBR_VERTEX_SHADER);\n    const fragShader = this.compileShader(gl.FRAGMENT_SHADER, PBR_FRAGMENT_SHADER);\n\n    // Create program\n    const program = gl.createProgram()!;\n    gl.attachShader(program, vertShader);\n    gl.attachShader(program, fragShader);\n    gl.linkProgram(program);\n\n    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n      throw new Error(`Shader program link failed: ${gl.getProgramInfoLog(program)}`);\n    }\n\n    gl.deleteShader(vertShader);\n    gl.deleteShader(fragShader);\n\n    this.program = program;\n\n    // Cache uniform locations\n    this.uniforms = {\n      modelMatrix: gl.getUniformLocation(program, 'u_modelMatrix'),\n      viewMatrix: gl.getUniformLocation(program, 'u_viewMatrix'),\n      projectionMatrix: gl.getUniformLocation(program, 'u_projectionMatrix'),\n      normalMatrix: gl.getUniformLocation(program, 'u_normalMatrix'),\n      cameraPosition: gl.getUniformLocation(program, 'u_cameraPosition'),\n      basecolorMap: gl.getUniformLocation(program, 'u_basecolorMap'),\n      normalMap: gl.getUniformLocation(program, 'u_normalMap'),\n      roughnessMap: gl.getUniformLocation(program, 'u_roughnessMap'),\n      metallicMap: gl.getUniformLocation(program, 'u_metallicMap'),\n      useBasecolorMap: gl.getUniformLocation(program, 'u_useBasecolorMap'),\n      useNormalMap: gl.getUniformLocation(program, 'u_useNormalMap'),\n      useRoughnessMap: gl.getUniformLocation(program, 'u_useRoughnessMap'),\n      useMetallicMap: gl.getUniformLocation(program, 'u_useMetallicMap'),\n      baseColor: gl.getUniformLocation(program, 'u_baseColor'),\n      roughness: gl.getUniformLocation(program, 'u_roughness'),\n      metallic: gl.getUniformLocation(program, 'u_metallic'),\n      lightDirection: gl.getUniformLocation(program, 'u_lightDirection'),\n      lightColor: gl.getUniformLocation(program, 'u_lightColor'),\n      lightIntensity: gl.getUniformLocation(program, 'u_lightIntensity'),\n      ambientColor: gl.getUniformLocation(program, 'u_ambientColor'),\n      ambientIntensity: gl.getUniformLocation(program, 'u_ambientIntensity'),\n      textureTiling: gl.getUniformLocation(program, 'u_textureTiling'),\n      textureOffset: gl.getUniformLocation(program, 'u_textureOffset'),\n    };\n  }\n\n  /**\n   * Compile a shader\n   */\n  private compileShader(type: number, source: string): WebGLShader {\n    const gl = this.gl;\n    const shader = gl.createShader(type)!;\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n      const log = gl.getShaderInfoLog(shader);\n      gl.deleteShader(shader);\n      throw new Error(`Shader compilation failed: ${log}`);\n    }\n\n    return shader;\n  }\n\n  /**\n   * Initialize geometry\n   */\n  private initializeGeometry(): void {\n    this.setGeometry(this.config.geometry);\n  }\n\n  /**\n   * Create VAO for geometry\n   */\n  private createVAO(geom: Geometry): WebGLVertexArrayObject {\n    const gl = this.gl;\n    const vao = gl.createVertexArray()!;\n    gl.bindVertexArray(vao);\n\n    // Position buffer (location 0)\n    const posBuffer = gl.createBuffer()!;\n    gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, geom.positions, gl.STATIC_DRAW);\n    gl.enableVertexAttribArray(0);\n    gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);\n\n    // Normal buffer (location 1)\n    const normBuffer = gl.createBuffer()!;\n    gl.bindBuffer(gl.ARRAY_BUFFER, normBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, geom.normals, gl.STATIC_DRAW);\n    gl.enableVertexAttribArray(1);\n    gl.vertexAttribPointer(1, 3, gl.FLOAT, false, 0, 0);\n\n    // Texcoord buffer (location 2)\n    const texBuffer = gl.createBuffer()!;\n    gl.bindBuffer(gl.ARRAY_BUFFER, texBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, geom.texcoords, gl.STATIC_DRAW);\n    gl.enableVertexAttribArray(2);\n    gl.vertexAttribPointer(2, 2, gl.FLOAT, false, 0, 0);\n\n    // Tangent buffer (location 3)\n    const tanBuffer = gl.createBuffer()!;\n    gl.bindBuffer(gl.ARRAY_BUFFER, tanBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, geom.tangents, gl.STATIC_DRAW);\n    gl.enableVertexAttribArray(3);\n    gl.vertexAttribPointer(3, 4, gl.FLOAT, false, 0, 0);\n\n    // Index buffer\n    const indexBuffer = gl.createBuffer()!;\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, geom.indices, gl.STATIC_DRAW);\n\n    gl.bindVertexArray(null);\n    return vao;\n  }\n\n  /**\n   * Setup mouse interaction for camera control\n   */\n  private setupInteraction(): void {\n    this.canvas.addEventListener('mousedown', (e) => {\n      this.isDragging = true;\n      this.lastMouseX = e.clientX;\n      this.lastMouseY = e.clientY;\n    });\n\n    this.canvas.addEventListener('mousemove', (e) => {\n      if (!this.isDragging) return;\n\n      const dx = e.clientX - this.lastMouseX;\n      const dy = e.clientY - this.lastMouseY;\n\n      this.cameraRotationY += dx * 0.01;\n      this.cameraRotationX += dy * 0.01;\n      this.cameraRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, this.cameraRotationX));\n\n      this.lastMouseX = e.clientX;\n      this.lastMouseY = e.clientY;\n    });\n\n    this.canvas.addEventListener('mouseup', () => {\n      this.isDragging = false;\n    });\n\n    this.canvas.addEventListener('mouseleave', () => {\n      this.isDragging = false;\n    });\n\n    this.canvas.addEventListener('wheel', (e) => {\n      e.preventDefault();\n      this.cameraDistance += e.deltaY * 0.01;\n      this.cameraDistance = Math.max(1.5, Math.min(10, this.cameraDistance));\n    });\n  }\n\n  /**\n   * Set geometry type\n   */\n  setGeometry(type: PreviewGeometryType): void {\n    this.geometryType = type;\n\n    switch (type) {\n      case 'sphere':\n        this.geometry = createSphere(1, 64, 32);\n        break;\n      case 'cube':\n        this.geometry = createCube(1.5);\n        break;\n      case 'plane':\n        this.geometry = createPlane(2, 2, 1, 1);\n        break;\n    }\n\n    if (this.vao) {\n      this.gl.deleteVertexArray(this.vao);\n    }\n    this.vao = this.createVAO(this.geometry);\n  }\n\n  /**\n   * Set PBR textures from generated maps\n   */\n  setMaps(maps: ExtendedPBRMaps): void {\n    const gl = this.gl;\n\n    // Delete old textures to prevent memory leak\n    if (this.basecolorTexture) gl.deleteTexture(this.basecolorTexture);\n    if (this.normalTexture) gl.deleteTexture(this.normalTexture);\n    if (this.roughnessTexture) gl.deleteTexture(this.roughnessTexture);\n    if (this.metallicTexture) gl.deleteTexture(this.metallicTexture);\n\n    this.basecolorTexture = this.createTextureFromImageData(maps.basecolor);\n    this.normalTexture = this.createTextureFromImageData(maps.normal);\n    this.roughnessTexture = this.createTextureFromImageData(maps.roughness);\n    this.metallicTexture = this.createTextureFromImageData(maps.metallic);\n  }\n\n  /**\n   * Create texture from ImageData\n   */\n  private createTextureFromImageData(imageData: ImageData): WebGLTexture {\n    const gl = this.gl;\n    const texture = gl.createTexture()!;\n\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(\n      gl.TEXTURE_2D,\n      0,\n      gl.RGBA8,\n      imageData.width,\n      imageData.height,\n      0,\n      gl.RGBA,\n      gl.UNSIGNED_BYTE,\n      imageData.data\n    );\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n    gl.generateMipmap(gl.TEXTURE_2D);\n\n    return texture;\n  }\n\n  /**\n   * Update configuration\n   */\n  setConfig(config: Partial<PreviewConfig>): void {\n    this.config = { ...this.config, ...config };\n\n    if (config.geometry && config.geometry !== this.geometryType) {\n      this.setGeometry(config.geometry);\n    }\n  }\n\n  /**\n   * Start the render loop\n   */\n  private startRenderLoop(): void {\n    const render = (time: number) => {\n      const dt = (time - this.lastFrameTime) / 1000;\n      this.lastFrameTime = time;\n\n      if (this.config.autoRotate && !this.isDragging) {\n        this.rotation += this.config.rotationSpeed * dt;\n      }\n\n      this.render();\n      this.animationId = requestAnimationFrame(render);\n    };\n\n    this.animationId = requestAnimationFrame(render);\n  }\n\n  /**\n   * Render a frame\n   */\n  private render(): void {\n    const gl = this.gl;\n    const canvas = this.canvas;\n\n    // Resize if needed\n    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {\n      canvas.width = canvas.clientWidth;\n      canvas.height = canvas.clientHeight;\n    }\n\n    gl.viewport(0, 0, canvas.width, canvas.height);\n    gl.clearColor(0.1, 0.1, 0.15, 1.0);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    gl.enable(gl.DEPTH_TEST);\n    gl.enable(gl.CULL_FACE);\n\n    if (!this.program || !this.vao || !this.geometry || !this.uniforms) return;\n\n    gl.useProgram(this.program);\n    gl.bindVertexArray(this.vao);\n\n    // Calculate matrices\n    const aspect = canvas.width / canvas.height;\n    const projMatrix = this.perspectiveMatrix(Math.PI / 4, aspect, 0.1, 100);\n\n    // Camera position\n    const camX = this.cameraDistance * Math.sin(this.cameraRotationY) * Math.cos(this.cameraRotationX);\n    const camY = this.cameraDistance * Math.sin(this.cameraRotationX);\n    const camZ = this.cameraDistance * Math.cos(this.cameraRotationY) * Math.cos(this.cameraRotationX);\n    const viewMatrix = this.lookAtMatrix([camX, camY, camZ], [0, 0, 0], [0, 1, 0]);\n\n    // Model matrix (rotation)\n    const modelMatrix = this.rotationMatrix(this.rotation, [0, 1, 0]);\n\n    // Normal matrix (inverse transpose of model-view)\n    const normalMatrix = this.normalMatrixFromModel(modelMatrix);\n\n    // Set uniforms\n    gl.uniformMatrix4fv(this.uniforms.projectionMatrix, false, projMatrix);\n    gl.uniformMatrix4fv(this.uniforms.viewMatrix, false, viewMatrix);\n    gl.uniformMatrix4fv(this.uniforms.modelMatrix, false, modelMatrix);\n    gl.uniformMatrix3fv(this.uniforms.normalMatrix, false, normalMatrix);\n    gl.uniform3f(this.uniforms.cameraPosition, camX, camY, camZ);\n\n    // Lighting\n    gl.uniform3fv(this.uniforms.lightDirection, this.config.lightDirection);\n    gl.uniform3fv(this.uniforms.lightColor, this.config.lightColor);\n    gl.uniform1f(this.uniforms.lightIntensity, this.config.lightIntensity);\n    gl.uniform3fv(this.uniforms.ambientColor, this.config.ambientColor);\n    gl.uniform1f(this.uniforms.ambientIntensity, this.config.ambientIntensity);\n\n    // Texture settings\n    gl.uniform2fv(this.uniforms.textureTiling, this.config.tiling);\n    gl.uniform2fv(this.uniforms.textureOffset, this.config.offset);\n\n    // Bind textures\n    this.bindTexture(0, this.basecolorTexture, this.uniforms.basecolorMap!, this.uniforms.useBasecolorMap!);\n    this.bindTexture(1, this.normalTexture, this.uniforms.normalMap!, this.uniforms.useNormalMap!);\n    this.bindTexture(2, this.roughnessTexture, this.uniforms.roughnessMap!, this.uniforms.useRoughnessMap!);\n    this.bindTexture(3, this.metallicTexture, this.uniforms.metallicMap!, this.uniforms.useMetallicMap!);\n\n    // Fallback values\n    gl.uniform3f(this.uniforms.baseColor, 0.8, 0.8, 0.8);\n    gl.uniform1f(this.uniforms.roughness, 0.5);\n    gl.uniform1f(this.uniforms.metallic, 0.0);\n\n    // Draw\n    gl.drawElements(gl.TRIANGLES, this.geometry.indexCount, gl.UNSIGNED_SHORT, 0);\n\n    gl.bindVertexArray(null);\n  }\n\n  /**\n   * Bind texture to unit\n   */\n  private bindTexture(\n    unit: number,\n    texture: WebGLTexture | null,\n    samplerLocation: WebGLUniformLocation,\n    useLocation: WebGLUniformLocation\n  ): void {\n    const gl = this.gl;\n    gl.activeTexture(gl.TEXTURE0 + unit);\n\n    if (texture) {\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      gl.uniform1i(samplerLocation, unit);\n      gl.uniform1i(useLocation, 1);\n    } else {\n      gl.bindTexture(gl.TEXTURE_2D, null);\n      gl.uniform1i(useLocation, 0);\n    }\n  }\n\n  // Matrix utilities\n\n  private perspectiveMatrix(fov: number, aspect: number, near: number, far: number): Float32Array {\n    const f = 1 / Math.tan(fov / 2);\n    const nf = 1 / (near - far);\n    return new Float32Array([\n      f / aspect, 0, 0, 0,\n      0, f, 0, 0,\n      0, 0, (far + near) * nf, -1,\n      0, 0, 2 * far * near * nf, 0,\n    ]);\n  }\n\n  private lookAtMatrix(eye: number[], target: number[], up: number[]): Float32Array {\n    const zAxis = this.normalize([\n      eye[0] - target[0],\n      eye[1] - target[1],\n      eye[2] - target[2],\n    ]);\n    const xAxis = this.normalize(this.cross(up, zAxis));\n    const yAxis = this.cross(zAxis, xAxis);\n\n    return new Float32Array([\n      xAxis[0], yAxis[0], zAxis[0], 0,\n      xAxis[1], yAxis[1], zAxis[1], 0,\n      xAxis[2], yAxis[2], zAxis[2], 0,\n      -this.dot(xAxis, eye), -this.dot(yAxis, eye), -this.dot(zAxis, eye), 1,\n    ]);\n  }\n\n  private rotationMatrix(angle: number, axis: number[]): Float32Array {\n    const [x, y, z] = this.normalize(axis);\n    const c = Math.cos(angle);\n    const s = Math.sin(angle);\n    const t = 1 - c;\n\n    return new Float32Array([\n      t * x * x + c, t * x * y + s * z, t * x * z - s * y, 0,\n      t * x * y - s * z, t * y * y + c, t * y * z + s * x, 0,\n      t * x * z + s * y, t * y * z - s * x, t * z * z + c, 0,\n      0, 0, 0, 1,\n    ]);\n  }\n\n  private normalMatrixFromModel(model: Float32Array): Float32Array {\n    // For uniform scale, normal matrix is just upper-left 3x3\n    return new Float32Array([\n      model[0], model[1], model[2],\n      model[4], model[5], model[6],\n      model[8], model[9], model[10],\n    ]);\n  }\n\n  private normalize(v: number[]): number[] {\n    const len = Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2]);\n    return len > 0 ? [v[0] / len, v[1] / len, v[2] / len] : [0, 0, 0];\n  }\n\n  private cross(a: number[], b: number[]): number[] {\n    return [\n      a[1] * b[2] - a[2] * b[1],\n      a[2] * b[0] - a[0] * b[2],\n      a[0] * b[1] - a[1] * b[0],\n    ];\n  }\n\n  private dot(a: number[], b: number[]): number {\n    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2];\n  }\n\n  /**\n   * Dispose resources\n   */\n  dispose(): void {\n    if (this.animationId) {\n      cancelAnimationFrame(this.animationId);\n    }\n\n    const gl = this.gl;\n\n    if (this.program) gl.deleteProgram(this.program);\n    if (this.vao) gl.deleteVertexArray(this.vao);\n    if (this.basecolorTexture) gl.deleteTexture(this.basecolorTexture);\n    if (this.normalTexture) gl.deleteTexture(this.normalTexture);\n    if (this.roughnessTexture) gl.deleteTexture(this.roughnessTexture);\n    if (this.metallicTexture) gl.deleteTexture(this.metallicTexture);\n  }\n}\n","/**\n * PBR Preview vertex shader.\n * Supports both sphere and plane geometry for material preview.\n */\n\nexport const PBR_VERTEX_SHADER = `#version 300 es\nprecision highp float;\n\n// Attributes\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texcoord;\nin vec4 a_tangent;\n\n// Uniforms\nuniform mat4 u_modelMatrix;\nuniform mat4 u_viewMatrix;\nuniform mat4 u_projectionMatrix;\nuniform mat3 u_normalMatrix;\n\n// Varyings\nout vec3 v_worldPosition;\nout vec3 v_worldNormal;\nout vec2 v_texcoord;\nout mat3 v_TBN;\n\nvoid main() {\n  // World space position\n  vec4 worldPos = u_modelMatrix * vec4(a_position, 1.0);\n  v_worldPosition = worldPos.xyz;\n\n  // World space normal\n  v_worldNormal = normalize(u_normalMatrix * a_normal);\n\n  // Texture coordinates\n  v_texcoord = a_texcoord;\n\n  // TBN matrix for normal mapping\n  vec3 T = normalize(u_normalMatrix * a_tangent.xyz);\n  vec3 N = v_worldNormal;\n  // Re-orthogonalize T with respect to N\n  T = normalize(T - dot(T, N) * N);\n  vec3 B = cross(N, T) * a_tangent.w;\n  v_TBN = mat3(T, B, N);\n\n  gl_Position = u_projectionMatrix * u_viewMatrix * worldPos;\n}\n`;\n","/**\n * PBR Preview fragment shader.\n * Implements Cook-Torrance BRDF with GGX distribution.\n */\n\nexport const PBR_FRAGMENT_SHADER = `#version 300 es\nprecision highp float;\n\n// Constants\nconst float PI = 3.14159265359;\nconst float EPSILON = 0.0001;\n\n// PBR Textures\nuniform sampler2D u_basecolorMap;\nuniform sampler2D u_normalMap;\nuniform sampler2D u_roughnessMap;\nuniform sampler2D u_metallicMap;\n\n// Texture enable flags\nuniform bool u_useBasecolorMap;\nuniform bool u_useNormalMap;\nuniform bool u_useRoughnessMap;\nuniform bool u_useMetallicMap;\n\n// Material fallback values\nuniform vec3 u_baseColor;\nuniform float u_roughness;\nuniform float u_metallic;\n\n// Environment\nuniform vec3 u_lightDirection;\nuniform vec3 u_lightColor;\nuniform float u_lightIntensity;\nuniform vec3 u_ambientColor;\nuniform float u_ambientIntensity;\n\n// Camera\nuniform vec3 u_cameraPosition;\n\n// Texture tiling\nuniform vec2 u_textureTiling;\nuniform vec2 u_textureOffset;\n\n// Varyings\nin vec3 v_worldPosition;\nin vec3 v_worldNormal;\nin vec2 v_texcoord;\nin mat3 v_TBN;\n\n// Output\nout vec4 fragColor;\n\n// Normal Distribution Function (GGX/Trowbridge-Reitz)\nfloat distributionGGX(vec3 N, vec3 H, float roughness) {\n  float a = roughness * roughness;\n  float a2 = a * a;\n  float NdotH = max(dot(N, H), 0.0);\n  float NdotH2 = NdotH * NdotH;\n\n  float num = a2;\n  float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n  denom = PI * denom * denom;\n\n  return num / max(denom, EPSILON);\n}\n\n// Geometry Function (Schlick-GGX)\nfloat geometrySchlickGGX(float NdotV, float roughness) {\n  float r = roughness + 1.0;\n  float k = (r * r) / 8.0;\n\n  float num = NdotV;\n  float denom = NdotV * (1.0 - k) + k;\n\n  return num / max(denom, EPSILON);\n}\n\n// Geometry Function (Smith)\nfloat geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {\n  float NdotV = max(dot(N, V), 0.0);\n  float NdotL = max(dot(N, L), 0.0);\n  float ggx2 = geometrySchlickGGX(NdotV, roughness);\n  float ggx1 = geometrySchlickGGX(NdotL, roughness);\n\n  return ggx1 * ggx2;\n}\n\n// Fresnel (Schlick approximation)\nvec3 fresnelSchlick(float cosTheta, vec3 F0) {\n  return F0 + (1.0 - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);\n}\n\n// Fresnel with roughness for ambient\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n  return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);\n}\n\nvoid main() {\n  // Calculate tiled texture coordinates\n  vec2 uv = v_texcoord * u_textureTiling + u_textureOffset;\n\n  // Sample textures or use fallback values\n  vec3 albedo = u_useBasecolorMap ? texture(u_basecolorMap, uv).rgb : u_baseColor;\n  float roughness = u_useRoughnessMap ? texture(u_roughnessMap, uv).r : u_roughness;\n  float metallic = u_useMetallicMap ? texture(u_metallicMap, uv).r : u_metallic;\n\n  // Clamp roughness to avoid division issues\n  roughness = clamp(roughness, 0.04, 1.0);\n\n  // Get normal from map or geometry\n  vec3 N;\n  if (u_useNormalMap) {\n    vec3 tangentNormal = texture(u_normalMap, uv).rgb * 2.0 - 1.0;\n    N = normalize(v_TBN * tangentNormal);\n  } else {\n    N = normalize(v_worldNormal);\n  }\n\n  // View direction\n  vec3 V = normalize(u_cameraPosition - v_worldPosition);\n\n  // Light direction (directional light)\n  vec3 L = normalize(-u_lightDirection);\n\n  // Half vector\n  vec3 H = normalize(V + L);\n\n  // Calculate reflectance at normal incidence\n  // Dielectric: 0.04, Metal: albedo\n  vec3 F0 = vec3(0.04);\n  F0 = mix(F0, albedo, metallic);\n\n  // Cook-Torrance BRDF\n  float NDF = distributionGGX(N, H, roughness);\n  float G = geometrySmith(N, V, L, roughness);\n  vec3 F = fresnelSchlick(max(dot(H, V), 0.0), F0);\n\n  // Specular and diffuse components\n  vec3 kS = F;\n  vec3 kD = vec3(1.0) - kS;\n  kD *= 1.0 - metallic; // Metals have no diffuse\n\n  // Specular BRDF\n  vec3 numerator = NDF * G * F;\n  float denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, L), 0.0) + EPSILON;\n  vec3 specular = numerator / denominator;\n\n  // Direct lighting\n  float NdotL = max(dot(N, L), 0.0);\n  vec3 Lo = (kD * albedo / PI + specular) * u_lightColor * u_lightIntensity * NdotL;\n\n  // Ambient (simplified IBL approximation)\n  vec3 kSAmbient = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n  vec3 kDAmbient = 1.0 - kSAmbient;\n  kDAmbient *= 1.0 - metallic;\n\n  vec3 diffuseAmbient = kDAmbient * albedo * u_ambientColor * u_ambientIntensity;\n\n  // Simple ambient specular (reflection approximation)\n  vec3 R = reflect(-V, N);\n  float reflectionMix = 1.0 - roughness;\n  vec3 specularAmbient = kSAmbient * u_ambientColor * u_ambientIntensity * reflectionMix * 0.5;\n\n  vec3 ambient = diffuseAmbient + specularAmbient;\n\n  // Final color\n  vec3 color = ambient + Lo;\n\n  // HDR tonemapping (Reinhard)\n  color = color / (color + vec3(1.0));\n\n  // Gamma correction\n  color = pow(color, vec3(1.0 / 2.2));\n\n  fragColor = vec4(color, 1.0);\n}\n`;\n","/**\n * Geometry generation for PBR preview.\n * Creates sphere and plane meshes with positions, normals, tangents, and UVs.\n */\n\nexport interface Geometry {\n  positions: Float32Array;\n  normals: Float32Array;\n  texcoords: Float32Array;\n  tangents: Float32Array;\n  indices: Uint16Array;\n  vertexCount: number;\n  indexCount: number;\n}\n\n/**\n * Generate a UV sphere mesh.\n */\nexport function createSphere(radius: number = 1, segments: number = 32, rings: number = 16): Geometry {\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const texcoords: number[] = [];\n  const tangents: number[] = [];\n  const indices: number[] = [];\n\n  // Generate vertices\n  for (let y = 0; y <= rings; y++) {\n    const v = y / rings;\n    const theta = v * Math.PI;\n    const sinTheta = Math.sin(theta);\n    const cosTheta = Math.cos(theta);\n\n    for (let x = 0; x <= segments; x++) {\n      const u = x / segments;\n      const phi = u * Math.PI * 2;\n      const sinPhi = Math.sin(phi);\n      const cosPhi = Math.cos(phi);\n\n      // Position\n      const px = radius * sinTheta * cosPhi;\n      const py = radius * cosTheta;\n      const pz = radius * sinTheta * sinPhi;\n      positions.push(px, py, pz);\n\n      // Normal (same as normalized position for sphere)\n      normals.push(sinTheta * cosPhi, cosTheta, sinTheta * sinPhi);\n\n      // Texture coordinates\n      texcoords.push(u, 1 - v);\n\n      // Tangent (along phi direction)\n      const tx = -sinPhi;\n      const ty = 0;\n      const tz = cosPhi;\n      tangents.push(tx, ty, tz, 1); // w = 1 for handedness\n    }\n  }\n\n  // Generate indices (counter-clockwise winding for front faces)\n  for (let y = 0; y < rings; y++) {\n    for (let x = 0; x < segments; x++) {\n      const a = y * (segments + 1) + x;\n      const b = a + 1;\n      const c = a + segments + 1;\n      const d = c + 1;\n\n      // Two triangles per quad (CCW winding)\n      indices.push(a, b, c);\n      indices.push(b, d, c);\n    }\n  }\n\n  return {\n    positions: new Float32Array(positions),\n    normals: new Float32Array(normals),\n    texcoords: new Float32Array(texcoords),\n    tangents: new Float32Array(tangents),\n    indices: new Uint16Array(indices),\n    vertexCount: positions.length / 3,\n    indexCount: indices.length,\n  };\n}\n\n/**\n * Generate a plane mesh.\n */\nexport function createPlane(width: number = 2, height: number = 2, subdivisionsX: number = 1, subdivisionsY: number = 1): Geometry {\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const texcoords: number[] = [];\n  const tangents: number[] = [];\n  const indices: number[] = [];\n\n  const halfWidth = width / 2;\n  const halfHeight = height / 2;\n\n  // Generate vertices\n  for (let y = 0; y <= subdivisionsY; y++) {\n    const v = y / subdivisionsY;\n    const py = -halfHeight + v * height;\n\n    for (let x = 0; x <= subdivisionsX; x++) {\n      const u = x / subdivisionsX;\n      const px = -halfWidth + u * width;\n\n      positions.push(px, 0, py);\n      normals.push(0, 1, 0);\n      texcoords.push(u, v);\n      tangents.push(1, 0, 0, 1);\n    }\n  }\n\n  // Generate indices (counter-clockwise winding for front faces)\n  for (let y = 0; y < subdivisionsY; y++) {\n    for (let x = 0; x < subdivisionsX; x++) {\n      const a = y * (subdivisionsX + 1) + x;\n      const b = a + 1;\n      const c = a + subdivisionsX + 1;\n      const d = c + 1;\n\n      // CCW winding when viewed from +Y\n      indices.push(a, b, c);\n      indices.push(b, d, c);\n    }\n  }\n\n  return {\n    positions: new Float32Array(positions),\n    normals: new Float32Array(normals),\n    texcoords: new Float32Array(texcoords),\n    tangents: new Float32Array(tangents),\n    indices: new Uint16Array(indices),\n    vertexCount: positions.length / 3,\n    indexCount: indices.length,\n  };\n}\n\n/**\n * Generate a cube mesh.\n */\nexport function createCube(size: number = 1): Geometry {\n  const s = size / 2;\n\n  // Each face has 4 unique vertices (for correct normals)\n  const positions = new Float32Array([\n    // Front face\n    -s, -s,  s,  s, -s,  s,  s,  s,  s, -s,  s,  s,\n    // Back face\n     s, -s, -s, -s, -s, -s, -s,  s, -s,  s,  s, -s,\n    // Top face\n    -s,  s,  s,  s,  s,  s,  s,  s, -s, -s,  s, -s,\n    // Bottom face\n    -s, -s, -s,  s, -s, -s,  s, -s,  s, -s, -s,  s,\n    // Right face\n     s, -s,  s,  s, -s, -s,  s,  s, -s,  s,  s,  s,\n    // Left face\n    -s, -s, -s, -s, -s,  s, -s,  s,  s, -s,  s, -s,\n  ]);\n\n  const normals = new Float32Array([\n    // Front\n    0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,\n    // Back\n    0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1,\n    // Top\n    0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0,\n    // Bottom\n    0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0,\n    // Right\n    1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0,\n    // Left\n    -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0,\n  ]);\n\n  const texcoords = new Float32Array([\n    // Front\n    0, 0, 1, 0, 1, 1, 0, 1,\n    // Back\n    0, 0, 1, 0, 1, 1, 0, 1,\n    // Top\n    0, 0, 1, 0, 1, 1, 0, 1,\n    // Bottom\n    0, 0, 1, 0, 1, 1, 0, 1,\n    // Right\n    0, 0, 1, 0, 1, 1, 0, 1,\n    // Left\n    0, 0, 1, 0, 1, 1, 0, 1,\n  ]);\n\n  const tangents = new Float32Array([\n    // Front (tangent = +X)\n    1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1,\n    // Back (tangent = -X)\n    -1, 0, 0, 1, -1, 0, 0, 1, -1, 0, 0, 1, -1, 0, 0, 1,\n    // Top (tangent = +X)\n    1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1,\n    // Bottom (tangent = +X)\n    1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1,\n    // Right (tangent = -Z)\n    0, 0, -1, 1, 0, 0, -1, 1, 0, 0, -1, 1, 0, 0, -1, 1,\n    // Left (tangent = +Z)\n    0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1,\n  ]);\n\n  const indices = new Uint16Array([\n    0, 1, 2, 0, 2, 3,       // Front\n    4, 5, 6, 4, 6, 7,       // Back\n    8, 9, 10, 8, 10, 11,    // Top\n    12, 13, 14, 12, 14, 15, // Bottom\n    16, 17, 18, 16, 18, 19, // Right\n    20, 21, 22, 20, 22, 23, // Left\n  ]);\n\n  return {\n    positions,\n    normals,\n    texcoords,\n    tangents,\n    indices,\n    vertexCount: 24,\n    indexCount: 36,\n  };\n}\n","/**\n * Performance monitoring and optimization utilities.\n * Provides profiling, texture pooling, and memory management.\n */\n\n/**\n * Performance metric entry\n */\nexport interface PerformanceMetric {\n  name: string;\n  startTime: number;\n  endTime: number;\n  duration: number;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * Performance statistics\n */\nexport interface PerformanceStats {\n  count: number;\n  totalMs: number;\n  minMs: number;\n  maxMs: number;\n  avgMs: number;\n  lastMs: number;\n}\n\n/**\n * Performance profiler for tracking operation timings\n */\nexport class PerformanceProfiler {\n  private metrics: Map<string, PerformanceMetric[]> = new Map();\n  private activeTimers: Map<string, number> = new Map();\n  private maxHistoryPerMetric = 100;\n  private enabled = true;\n\n  /**\n   * Enable or disable profiling\n   */\n  setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n  }\n\n  /**\n   * Start timing an operation\n   */\n  start(name: string): void {\n    if (!this.enabled) return;\n    this.activeTimers.set(name, performance.now());\n  }\n\n  /**\n   * End timing an operation\n   */\n  end(name: string, metadata?: Record<string, unknown>): number {\n    if (!this.enabled) return 0;\n\n    const startTime = this.activeTimers.get(name);\n    if (startTime === undefined) {\n      console.warn(`No timer started for: ${name}`);\n      return 0;\n    }\n\n    const endTime = performance.now();\n    const duration = endTime - startTime;\n\n    this.activeTimers.delete(name);\n    this.record(name, startTime, endTime, duration, metadata);\n\n    return duration;\n  }\n\n  /**\n   * Time a synchronous function\n   */\n  time<T>(name: string, fn: () => T, metadata?: Record<string, unknown>): T {\n    if (!this.enabled) return fn();\n\n    this.start(name);\n    try {\n      const result = fn();\n      this.end(name, metadata);\n      return result;\n    } catch (e) {\n      this.end(name, { ...metadata, error: true });\n      throw e;\n    }\n  }\n\n  /**\n   * Time an async function\n   */\n  async timeAsync<T>(name: string, fn: () => Promise<T>, metadata?: Record<string, unknown>): Promise<T> {\n    if (!this.enabled) return fn();\n\n    this.start(name);\n    try {\n      const result = await fn();\n      this.end(name, metadata);\n      return result;\n    } catch (e) {\n      this.end(name, { ...metadata, error: true });\n      throw e;\n    }\n  }\n\n  /**\n   * Record a metric\n   */\n  private record(\n    name: string,\n    startTime: number,\n    endTime: number,\n    duration: number,\n    metadata?: Record<string, unknown>\n  ): void {\n    if (!this.metrics.has(name)) {\n      this.metrics.set(name, []);\n    }\n\n    const history = this.metrics.get(name)!;\n    history.push({ name, startTime, endTime, duration, metadata });\n\n    // Trim history\n    while (history.length > this.maxHistoryPerMetric) {\n      history.shift();\n    }\n  }\n\n  /**\n   * Get statistics for a metric\n   */\n  getStats(name: string): PerformanceStats | null {\n    const history = this.metrics.get(name);\n    if (!history || history.length === 0) return null;\n\n    const durations = history.map((m) => m.duration);\n    const sum = durations.reduce((a, b) => a + b, 0);\n\n    return {\n      count: durations.length,\n      totalMs: sum,\n      minMs: Math.min(...durations),\n      maxMs: Math.max(...durations),\n      avgMs: sum / durations.length,\n      lastMs: durations[durations.length - 1],\n    };\n  }\n\n  /**\n   * Get all metric names\n   */\n  getMetricNames(): string[] {\n    return Array.from(this.metrics.keys());\n  }\n\n  /**\n   * Get all stats\n   */\n  getAllStats(): Map<string, PerformanceStats> {\n    const result = new Map<string, PerformanceStats>();\n    for (const name of this.metrics.keys()) {\n      const stats = this.getStats(name);\n      if (stats) {\n        result.set(name, stats);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Log performance summary to console\n   */\n  logSummary(): void {\n    console.group('Performance Summary');\n    for (const [name, stats] of this.getAllStats()) {\n      console.log(\n        `${name}: avg=${stats.avgMs.toFixed(1)}ms, ` +\n        `min=${stats.minMs.toFixed(1)}ms, max=${stats.maxMs.toFixed(1)}ms, ` +\n        `count=${stats.count}`\n      );\n    }\n    console.groupEnd();\n  }\n\n  /**\n   * Clear all metrics\n   */\n  clear(): void {\n    this.metrics.clear();\n    this.activeTimers.clear();\n  }\n\n  /**\n   * Export metrics as JSON\n   */\n  export(): object {\n    const data: Record<string, { history: PerformanceMetric[]; stats: PerformanceStats | null }> = {};\n    for (const [name, history] of this.metrics) {\n      data[name] = {\n        history,\n        stats: this.getStats(name),\n      };\n    }\n    return {\n      exportedAt: Date.now(),\n      metrics: data,\n    };\n  }\n}\n\n/**\n * WebGL texture pool for reducing GC pressure\n */\nexport class TexturePool {\n  private pool: Map<string, WebGLTexture[]> = new Map();\n  private gl: WebGL2RenderingContext;\n  private maxPoolSize = 10;\n\n  constructor(gl: WebGL2RenderingContext) {\n    this.gl = gl;\n  }\n\n  /**\n   * Create pool key from dimensions\n   */\n  private getKey(width: number, height: number): string {\n    return `${width}x${height}`;\n  }\n\n  /**\n   * Acquire a texture from the pool or create new\n   */\n  acquire(width: number, height: number): WebGLTexture {\n    const key = this.getKey(width, height);\n    const available = this.pool.get(key);\n\n    if (available && available.length > 0) {\n      return available.pop()!;\n    }\n\n    // Create new texture\n    const texture = this.gl.createTexture();\n    if (!texture) {\n      throw new Error('Failed to create WebGL texture');\n    }\n\n    // Initialize texture\n    this.gl.bindTexture(this.gl.TEXTURE_2D, texture);\n    this.gl.texImage2D(\n      this.gl.TEXTURE_2D,\n      0,\n      this.gl.RGBA,\n      width,\n      height,\n      0,\n      this.gl.RGBA,\n      this.gl.UNSIGNED_BYTE,\n      null\n    );\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);\n    this.gl.bindTexture(this.gl.TEXTURE_2D, null);\n\n    return texture;\n  }\n\n  /**\n   * Release a texture back to the pool\n   */\n  release(texture: WebGLTexture, width: number, height: number): void {\n    const key = this.getKey(width, height);\n    let pool = this.pool.get(key);\n\n    if (!pool) {\n      pool = [];\n      this.pool.set(key, pool);\n    }\n\n    // Don't exceed max pool size\n    if (pool.length >= this.maxPoolSize) {\n      this.gl.deleteTexture(texture);\n      return;\n    }\n\n    pool.push(texture);\n  }\n\n  /**\n   * Get pool statistics\n   */\n  getStats(): { key: string; count: number }[] {\n    const stats: { key: string; count: number }[] = [];\n    for (const [key, textures] of this.pool) {\n      stats.push({ key, count: textures.length });\n    }\n    return stats;\n  }\n\n  /**\n   * Clear all pooled textures\n   */\n  clear(): void {\n    for (const textures of this.pool.values()) {\n      for (const texture of textures) {\n        this.gl.deleteTexture(texture);\n      }\n    }\n    this.pool.clear();\n  }\n\n  /**\n   * Set max pool size per dimension\n   */\n  setMaxPoolSize(size: number): void {\n    this.maxPoolSize = Math.max(1, size);\n  }\n}\n\n/**\n * Memory usage tracker\n */\nexport class MemoryTracker {\n  private snapshots: { timestamp: number; usedJSHeapSize?: number; totalJSHeapSize?: number }[] = [];\n  private maxSnapshots = 60;\n\n  /**\n   * Take a memory snapshot (if available)\n   */\n  snapshot(): void {\n    const perf = performance as Performance & {\n      memory?: {\n        usedJSHeapSize: number;\n        totalJSHeapSize: number;\n      };\n    };\n\n    if (perf.memory) {\n      this.snapshots.push({\n        timestamp: Date.now(),\n        usedJSHeapSize: perf.memory.usedJSHeapSize,\n        totalJSHeapSize: perf.memory.totalJSHeapSize,\n      });\n\n      while (this.snapshots.length > this.maxSnapshots) {\n        this.snapshots.shift();\n      }\n    }\n  }\n\n  /**\n   * Get current memory usage\n   */\n  getCurrentUsage(): { usedMB: number; totalMB: number } | null {\n    const perf = performance as Performance & {\n      memory?: {\n        usedJSHeapSize: number;\n        totalJSHeapSize: number;\n      };\n    };\n\n    if (!perf.memory) return null;\n\n    return {\n      usedMB: perf.memory.usedJSHeapSize / (1024 * 1024),\n      totalMB: perf.memory.totalJSHeapSize / (1024 * 1024),\n    };\n  }\n\n  /**\n   * Check if memory is getting low\n   */\n  isMemoryLow(thresholdPercent: number = 80): boolean {\n    const usage = this.getCurrentUsage();\n    if (!usage) return false;\n    return (usage.usedMB / usage.totalMB) * 100 > thresholdPercent;\n  }\n\n  /**\n   * Get memory trend (positive = increasing)\n   */\n  getMemoryTrend(): number | null {\n    if (this.snapshots.length < 2) return null;\n\n    const recent = this.snapshots.slice(-10);\n    if (recent.length < 2) return null;\n\n    const first = recent[0].usedJSHeapSize;\n    const last = recent[recent.length - 1].usedJSHeapSize;\n\n    if (first === undefined || last === undefined) return null;\n\n    return last - first;\n  }\n\n  /**\n   * Clear snapshots\n   */\n  clear(): void {\n    this.snapshots = [];\n  }\n}\n\n/**\n * Frame rate monitor\n */\nexport class FPSMonitor {\n  private frameTimes: number[] = [];\n  private lastFrameTime = 0;\n  private maxFrames = 60;\n  private animationId: number | null = null;\n  private listeners: Set<(fps: number) => void> = new Set();\n\n  /**\n   * Start monitoring\n   */\n  start(): void {\n    if (this.animationId !== null) return;\n\n    const tick = (timestamp: number) => {\n      if (this.lastFrameTime > 0) {\n        const delta = timestamp - this.lastFrameTime;\n        this.frameTimes.push(delta);\n\n        while (this.frameTimes.length > this.maxFrames) {\n          this.frameTimes.shift();\n        }\n\n        // Notify listeners every 10 frames\n        if (this.frameTimes.length % 10 === 0) {\n          const fps = this.getCurrentFPS();\n          this.listeners.forEach((l) => l(fps));\n        }\n      }\n\n      this.lastFrameTime = timestamp;\n      this.animationId = requestAnimationFrame(tick);\n    };\n\n    this.animationId = requestAnimationFrame(tick);\n  }\n\n  /**\n   * Stop monitoring\n   */\n  stop(): void {\n    if (this.animationId !== null) {\n      cancelAnimationFrame(this.animationId);\n      this.animationId = null;\n    }\n  }\n\n  /**\n   * Get current FPS\n   */\n  getCurrentFPS(): number {\n    if (this.frameTimes.length === 0) return 0;\n\n    const avgFrameTime = this.frameTimes.reduce((a, b) => a + b, 0) / this.frameTimes.length;\n    return 1000 / avgFrameTime;\n  }\n\n  /**\n   * Subscribe to FPS updates\n   */\n  onFPS(callback: (fps: number) => void): () => void {\n    this.listeners.add(callback);\n    return () => this.listeners.delete(callback);\n  }\n\n  /**\n   * Clear measurements\n   */\n  clear(): void {\n    this.frameTimes = [];\n    this.lastFrameTime = 0;\n  }\n}\n\n// Singleton instances\nlet profilerInstance: PerformanceProfiler | null = null;\nlet memoryTrackerInstance: MemoryTracker | null = null;\nlet fpsMonitorInstance: FPSMonitor | null = null;\n\n/**\n * Get global performance profiler\n */\nexport function getProfiler(): PerformanceProfiler {\n  if (!profilerInstance) {\n    profilerInstance = new PerformanceProfiler();\n  }\n  return profilerInstance;\n}\n\n/**\n * Get global memory tracker\n */\nexport function getMemoryTracker(): MemoryTracker {\n  if (!memoryTrackerInstance) {\n    memoryTrackerInstance = new MemoryTracker();\n  }\n  return memoryTrackerInstance;\n}\n\n/**\n * Get global FPS monitor\n */\nexport function getFPSMonitor(): FPSMonitor {\n  if (!fpsMonitorInstance) {\n    fpsMonitorInstance = new FPSMonitor();\n  }\n  return fpsMonitorInstance;\n}\n\n/**\n * Debounce function for rate-limiting\n */\nexport function debounce<T extends (...args: unknown[]) => void>(\n  fn: T,\n  delayMs: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n  return (...args: Parameters<T>) => {\n    if (timeoutId !== null) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn(...args);\n      timeoutId = null;\n    }, delayMs);\n  };\n}\n\n/**\n * Throttle function for rate-limiting\n */\nexport function throttle<T extends (...args: unknown[]) => void>(\n  fn: T,\n  limitMs: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n  return (...args: Parameters<T>) => {\n    const now = Date.now();\n    const timeSinceLastCall = now - lastCall;\n\n    if (timeSinceLastCall >= limitMs) {\n      lastCall = now;\n      fn(...args);\n    } else if (!timeoutId) {\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        fn(...args);\n        timeoutId = null;\n      }, limitMs - timeSinceLastCall);\n    }\n  };\n}\n","/**\n * PBR Texture Generator - Main Entry Point\n *\n * Phase 6: Production Polish\n * - Comprehensive error handling and recovery\n * - Performance profiling and optimization\n * - Model download progress UI\n * - Offline mode (cached models, local export)\n * - Keyboard shortcuts\n * - Batch processing mode\n */\n\nimport {\n  DEFAULT_PARAMS,\n  type PBRGeneratorParams,\n  UnifiedPBRGenerator,\n  DEFAULT_UNIFIED_CONFIG,\n  type UnifiedPBRConfig,\n  type ExtendedPBRMaps,\n} from './generators/index.ts';\nimport { TraditionalPBRGenerator } from './generators/traditional/index.ts';\nimport {\n  getDeepBumpGenerator,\n  isDeepBumpAvailable,\n  getPerformanceInfo,\n  QUALITY_PRESETS,\n  type QualityPreset,\n} from './generators/ai/index.ts';\nimport { loadImageFile, loadImageFromClipboard } from './utils/image-loader.ts';\nimport { downloadImageData, renderToCanvas } from './utils/export.ts';\nimport {\n  detectCapabilities,\n  selectBackend,\n  getBackendDisplayName,\n  type BackendCapabilities,\n  type InferenceBackend,\n} from './inference/index.ts';\nimport {\n  ProgressBar,\n  createProgressCallback,\n  ChannelControls,\n  createChannelControlsContainer,\n  PreviewControls,\n  LoginPanel,\n  FolderPicker,\n  UploadStatus,\n  // Phase 6: New UI components\n  getKeyboardShortcuts,\n  getShortcutsHelpDialog,\n  DownloadProgress,\n  getErrorBoundary,\n  BatchProcessor,\n  type BatchItem,\n} from './ui/index.ts';\nimport {\n  PBRPreview,\n  DEFAULT_PREVIEW_CONFIG,\n} from './preview/index.ts';\nimport {\n  getAuth,\n  uploadAndCreateMaterial,\n  ThreeDverseError,\n  type ThreeDverseFolder,\n} from './threedverse/index.ts';\n// Phase 6: Error handling and utilities\nimport {\n  getErrorHandler,\n  getProfiler,\n  getOfflineManager,\n} from './utils/index.ts';\n\n// DOM Elements\nconst capabilitiesEl = document.getElementById('capabilities') as HTMLDivElement;\nconst dropZone = document.getElementById('dropZone') as HTMLDivElement;\nconst fileInput = document.getElementById('fileInput') as HTMLInputElement;\nconst controls = document.getElementById('controls') as HTMLDivElement;\nconst previewGrid = document.getElementById('previewGrid') as HTMLDivElement;\nconst status = document.getElementById('status') as HTMLDivElement;\nconst preview3DSection = document.getElementById('preview3DSection') as HTMLDivElement;\nconst previewCanvas = document.getElementById('previewCanvas') as HTMLCanvasElement;\nconst previewControlsContainer = document.getElementById('previewControlsContainer') as HTMLDivElement;\n\n// Canvases\nconst inputCanvas = document.getElementById('inputCanvas') as HTMLCanvasElement;\nconst basecolorCanvas = document.getElementById('basecolorCanvas') as HTMLCanvasElement;\nconst normalCanvas = document.getElementById('normalCanvas') as HTMLCanvasElement;\nconst roughnessCanvas = document.getElementById('roughnessCanvas') as HTMLCanvasElement;\nconst metallicCanvas = document.getElementById('metallicCanvas') as HTMLCanvasElement;\nconst heightCanvas = document.getElementById('heightCanvas') as HTMLCanvasElement;\nconst heightPreviewItem = document.getElementById('heightPreviewItem') as HTMLDivElement;\n\n// Control inputs\nconst shadowReductionInput = document.getElementById('shadowReduction') as HTMLInputElement;\nconst highlightReductionInput = document.getElementById('highlightReduction') as HTMLInputElement;\nconst normalStrengthInput = document.getElementById('normalStrength') as HTMLInputElement;\nconst roughnessScaleInput = document.getElementById('roughnessScale') as HTMLInputElement;\nconst roughnessOffsetInput = document.getElementById('roughnessOffset') as HTMLInputElement;\nconst metallicThresholdInput = document.getElementById('metallicThreshold') as HTMLInputElement;\n\n// Value displays\nconst shadowReductionValue = document.getElementById('shadowReductionValue') as HTMLSpanElement;\nconst highlightReductionValue = document.getElementById('highlightReductionValue') as HTMLSpanElement;\nconst normalStrengthValue = document.getElementById('normalStrengthValue') as HTMLSpanElement;\nconst roughnessScaleValue = document.getElementById('roughnessScaleValue') as HTMLSpanElement;\nconst roughnessOffsetValue = document.getElementById('roughnessOffsetValue') as HTMLSpanElement;\nconst metallicThresholdValue = document.getElementById('metallicThresholdValue') as HTMLSpanElement;\n\n// Export buttons\nconst exportInput = document.getElementById('exportInput') as HTMLButtonElement;\nconst exportBasecolor = document.getElementById('exportBasecolor') as HTMLButtonElement;\nconst exportNormal = document.getElementById('exportNormal') as HTMLButtonElement;\nconst exportRoughness = document.getElementById('exportRoughness') as HTMLButtonElement;\nconst exportMetallic = document.getElementById('exportMetallic') as HTMLButtonElement;\nconst exportHeight = document.getElementById('exportHeight') as HTMLButtonElement;\n\n// State\nlet traditionalGenerator: TraditionalPBRGenerator | null = null;\nlet unifiedGenerator: UnifiedPBRGenerator | null = null;\nlet currentInput: ImageData | null = null;\nlet currentMaps: ExtendedPBRMaps | null = null;\nlet currentAINormal: ImageData | null = null;\nlet currentFilename = 'texture';\nlet capabilities: BackendCapabilities | null = null;\nlet selectedBackend: InferenceBackend | null = null;\nlet aiAvailable = false;\nlet useAINormal = false;\nlet currentQualityPreset: QualityPreset = QUALITY_PRESETS.quality;\n\nconst params: PBRGeneratorParams = { ...DEFAULT_PARAMS };\nlet unifiedConfig: UnifiedPBRConfig = { ...DEFAULT_UNIFIED_CONFIG };\n\n// UI Components\nlet progressBar: ProgressBar | null = null;\nlet channelControls: ChannelControls | null = null;\nlet previewControls: PreviewControls | null = null;\nlet pbrPreview: PBRPreview | null = null;\n\n// 3dverse UI Components\nlet loginPanel: LoginPanel | null = null;\nlet folderPicker: FolderPicker | null = null;\nlet uploadStatus: UploadStatus | null = null;\nlet selectedFolder: ThreeDverseFolder | null = null;\n\n/**\n * Initialize backend capabilities detection\n */\nasync function initCapabilities(): Promise<void> {\n  capabilitiesEl.textContent = 'Detecting capabilities...';\n\n  try {\n    capabilities = await detectCapabilities();\n    selectedBackend = selectBackend(capabilities);\n\n    // Check AI availability\n    aiAvailable = await isDeepBumpAvailable();\n    const perfInfo = await getPerformanceInfo();\n\n    displayCapabilities(capabilities, selectedBackend, perfInfo);\n\n    // Setup unified generator\n    unifiedGenerator = new UnifiedPBRGenerator(unifiedConfig);\n    await unifiedGenerator.initialize();\n\n    // Setup AI controls if available\n    setupAIControls();\n\n    // Setup channel controls\n    setupChannelControls();\n\n    // Setup 3D preview\n    setup3DPreview();\n\n    // Setup 3dverse integration\n    setup3dverseIntegration();\n  } catch (err) {\n    console.error('Capability detection failed:', err);\n    capabilitiesEl.textContent = 'Capability detection failed';\n  }\n}\n\n/**\n * Display detected capabilities in the UI\n */\nfunction displayCapabilities(\n  caps: BackendCapabilities,\n  backend: InferenceBackend | null,\n  perfInfo: { backend: string; model: string; expectedTime: string } | null\n): void {\n  const features: string[] = [];\n\n  // WebGPU\n  features.push(\n    `<span class=\"feature ${caps.webgpu ? 'active' : 'inactive'}\">` +\n    `WebGPU${caps.webgpuFP16 ? ' FP16' : ''}</span>`\n  );\n\n  // WebNN\n  features.push(\n    `<span class=\"feature ${caps.webnn ? 'active' : 'inactive'}\">WebNN</span>`\n  );\n\n  // WASM\n  const wasmFeatures: string[] = [];\n  if (caps.wasmSimd) wasmFeatures.push('SIMD');\n  if (caps.wasmThreads) wasmFeatures.push('Threads');\n  features.push(\n    `<span class=\"feature ${caps.wasm ? 'active' : 'inactive'}\">` +\n    `WASM${wasmFeatures.length ? ` (${wasmFeatures.join(', ')})` : ''}</span>`\n  );\n\n  // WebGL2\n  features.push(\n    `<span class=\"feature ${caps.webgl2 ? 'active' : 'inactive'}\">WebGL2</span>`\n  );\n\n  // AI status\n  const aiStatus = aiAvailable\n    ? `<span class=\"feature active\">AI Ready</span>`\n    : `<span class=\"feature inactive\">AI Unavailable</span>`;\n\n  const backendName = backend ? getBackendDisplayName(backend) : 'None';\n  const expectedTime = perfInfo ? ` (~${perfInfo.expectedTime})` : '';\n\n  capabilitiesEl.innerHTML =\n    `AI Backend: <span class=\"backend\">${backendName}</span>${expectedTime} | ` +\n    `${features.join(' ')} | ${aiStatus} | ~${caps.estimatedMemoryMB}MB available`;\n}\n\n/**\n * Setup channel-specific controls\n */\nfunction setupChannelControls(): void {\n  const container = createChannelControlsContainer();\n  // Insert before the parameter controls\n  controls.parentNode?.insertBefore(container, controls);\n\n  channelControls = new ChannelControls(container, unifiedConfig, aiAvailable);\n  channelControls.onChange((event) => {\n    unifiedConfig = { ...unifiedConfig, ...event.config };\n    if (unifiedGenerator) {\n      unifiedGenerator.setConfig(unifiedConfig);\n    }\n\n    // Show/hide height preview based on config\n    if (event.config.heightMethod !== undefined) {\n      if (event.config.heightMethod !== 'none') {\n        heightPreviewItem.classList.remove('hidden');\n      } else {\n        heightPreviewItem.classList.add('hidden');\n      }\n    }\n\n    // If normal method changed to AI, generate AI normal map\n    if (event.config.normalMethod === 'ai' && currentInput) {\n      generateAINormalMap();\n    } else if (event.config.normalMethod === 'traditional' && currentInput) {\n      // Switch back to traditional\n      useAINormal = false;\n      updateNormalDisplay();\n    } else if (currentInput) {\n      // Re-process for other changes (height method)\n      processImageUnified();\n    }\n  });\n}\n\n/**\n * Setup 3D material preview\n */\nfunction setup3DPreview(): void {\n  // Setup preview controls\n  previewControls = new PreviewControls(previewControlsContainer, DEFAULT_PREVIEW_CONFIG);\n  previewControls.onChange((event) => {\n    if (pbrPreview) {\n      pbrPreview.setConfig(event.config);\n    }\n  });\n\n  // Create PBR preview (but don't show until we have textures)\n  try {\n    pbrPreview = new PBRPreview(previewCanvas);\n  } catch (err) {\n    console.warn('Failed to initialize 3D preview:', err);\n    preview3DSection.innerHTML = '<p style=\"padding: 20px; color: #888;\">3D preview not available</p>';\n  }\n}\n\n/**\n * Setup AI-specific controls (progress bar only)\n * Note: Method selection is handled by ChannelControls\n */\nfunction setupAIControls(): void {\n  // Create progress bar container (hidden initially)\n  const progressContainer = document.createElement('div');\n  progressContainer.id = 'aiProgressContainer';\n  progressContainer.style.marginBottom = '20px';\n  previewGrid.parentNode?.insertBefore(progressContainer, previewGrid);\n  progressBar = new ProgressBar(progressContainer);\n}\n\n/**\n * Setup 3dverse integration UI\n */\nfunction setup3dverseIntegration(): void {\n  // Find or create the 3dverse section\n  let threeDverseSection = document.getElementById('threedverseSection');\n  if (!threeDverseSection) {\n    threeDverseSection = document.createElement('div');\n    threeDverseSection.id = 'threedverseSection';\n    threeDverseSection.className = 'threedverse-section';\n    // Insert after preview grid\n    previewGrid.parentNode?.insertBefore(threeDverseSection, previewGrid.nextSibling);\n  }\n\n  threeDverseSection.innerHTML = `\n    <h2 class=\"section-title\">3dverse Integration</h2>\n    <div id=\"loginPanelContainer\"></div>\n    <div id=\"uploadSection\" class=\"hidden\">\n      <div id=\"folderPickerContainer\"></div>\n      <div class=\"upload-actions\">\n        <input type=\"text\" id=\"materialNameInput\" placeholder=\"Material name\" class=\"material-name-input\" />\n        <label class=\"subfolder-checkbox\">\n          <input type=\"checkbox\" id=\"createSubfolderCheckbox\" checked />\n          Create subfolder\n        </label>\n        <button id=\"uploadTo3dverseBtn\" class=\"upload-btn\" disabled>Upload to 3dverse</button>\n      </div>\n      <div id=\"uploadStatusContainer\"></div>\n    </div>\n  `;\n\n  // Apply section styles\n  applyThreeDverseSectionStyles();\n\n  // Create login panel\n  const loginContainer = document.getElementById('loginPanelContainer')!;\n  loginPanel = new LoginPanel(loginContainer);\n  loginPanel.onLogin((event) => {\n    if (event.success) {\n      // Show upload section\n      document.getElementById('uploadSection')?.classList.remove('hidden');\n      // Refresh folder picker\n      folderPicker?.refresh();\n      updateUploadButtonState();\n    } else {\n      // Hide upload section\n      document.getElementById('uploadSection')?.classList.add('hidden');\n    }\n  });\n\n  // Create folder picker\n  const folderContainer = document.getElementById('folderPickerContainer')!;\n  folderPicker = new FolderPicker(folderContainer);\n  folderPicker.onSelect((event) => {\n    selectedFolder = event.folder;\n    updateUploadButtonState();\n  });\n\n  // Create upload status\n  const statusContainer = document.getElementById('uploadStatusContainer')!;\n  uploadStatus = new UploadStatus(statusContainer);\n\n  // Setup upload button\n  const uploadBtn = document.getElementById('uploadTo3dverseBtn') as HTMLButtonElement;\n  const materialNameInput = document.getElementById('materialNameInput') as HTMLInputElement;\n\n  // Update button state when material name changes\n  materialNameInput.addEventListener('input', updateUploadButtonState);\n\n  // Upload click handler\n  uploadBtn.addEventListener('click', handleUploadTo3dverse);\n\n  // Check if already authenticated\n  const auth = getAuth();\n  if (auth.isAuthenticated()) {\n    document.getElementById('uploadSection')?.classList.remove('hidden');\n  }\n}\n\n/**\n * Apply styles for 3dverse section\n */\nfunction applyThreeDverseSectionStyles(): void {\n  if (!document.getElementById('threedverse-section-styles')) {\n    const style = document.createElement('style');\n    style.id = 'threedverse-section-styles';\n    style.textContent = `\n      .threedverse-section {\n        margin-top: 30px;\n        padding-top: 20px;\n        border-top: 1px solid #3a3a5a;\n      }\n      .threedverse-section .section-title {\n        font-size: 16px;\n        margin-bottom: 15px;\n        color: #fff;\n      }\n      .upload-actions {\n        display: flex;\n        gap: 10px;\n        margin-bottom: 15px;\n      }\n      .material-name-input {\n        flex: 1;\n        padding: 8px 12px;\n        border: 1px solid #4a4a6a;\n        border-radius: 4px;\n        background: #1a1a2e;\n        color: #fff;\n        font-size: 14px;\n      }\n      .material-name-input:focus {\n        outline: none;\n        border-color: #7878ff;\n      }\n      .upload-btn {\n        padding: 8px 20px;\n        background: #5a8a5a;\n        border: none;\n        border-radius: 4px;\n        color: white;\n        font-size: 14px;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .upload-btn:hover:not(:disabled) {\n        background: #6a9a6a;\n      }\n      .upload-btn:disabled {\n        background: #3a5a3a;\n        cursor: not-allowed;\n        opacity: 0.6;\n      }\n      .subfolder-checkbox {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        font-size: 12px;\n        color: #aaa;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .subfolder-checkbox input {\n        cursor: pointer;\n      }\n    `;\n    document.head.appendChild(style);\n  }\n}\n\n/**\n * Update upload button enabled state\n */\nfunction updateUploadButtonState(): void {\n  const uploadBtn = document.getElementById('uploadTo3dverseBtn') as HTMLButtonElement;\n  const materialNameInput = document.getElementById('materialNameInput') as HTMLInputElement;\n\n  const auth = getAuth();\n  const hasAuth = auth.isAuthenticated();\n  const hasFolder = selectedFolder !== null;\n  const hasMaps = currentMaps !== null;\n  const hasName = materialNameInput.value.trim().length > 0;\n\n  uploadBtn.disabled = !(hasAuth && hasFolder && hasMaps && hasName);\n\n  // Update placeholder with default name\n  if (currentFilename && !materialNameInput.value) {\n    materialNameInput.placeholder = `Material name (e.g., ${currentFilename})`;\n  }\n}\n\n/**\n * Handle upload to 3dverse\n */\nasync function handleUploadTo3dverse(): Promise<void> {\n  if (!currentMaps || !selectedFolder) {\n    setStatus('No maps or folder selected');\n    return;\n  }\n\n  const materialNameInput = document.getElementById('materialNameInput') as HTMLInputElement;\n  const createSubfolderCheckbox = document.getElementById('createSubfolderCheckbox') as HTMLInputElement;\n  const materialName = materialNameInput.value.trim() || currentFilename;\n\n  // Disable button during upload\n  const uploadBtn = document.getElementById('uploadTo3dverseBtn') as HTMLButtonElement;\n  uploadBtn.disabled = true;\n\n  try {\n    // Determine target folder\n    let targetFolderUuid = selectedFolder.uuid;\n\n    // Create subfolder if checkbox is checked\n    if (createSubfolderCheckbox?.checked && materialName) {\n      setStatus(`Creating subfolder \"${materialName}\"...`);\n      const { getFolderBrowser } = await import('./threedverse/index.ts');\n      const folderBrowser = getFolderBrowser();\n      try {\n        const subfolder = await folderBrowser.createFolder(materialName, selectedFolder.uuid);\n        targetFolderUuid = subfolder.uuid;\n        setStatus(`Subfolder created, uploading...`);\n      } catch (err) {\n        console.warn('Could not create subfolder, using parent folder:', err);\n        // Continue with parent folder if subfolder creation fails\n      }\n    }\n\n    setStatus('Uploading to 3dverse...');\n\n    // Create maps with AI normal if selected\n    const mapsToUpload: ExtendedPBRMaps = {\n      ...currentMaps,\n      normal: useAINormal && currentAINormal ? currentAINormal : currentMaps.normal,\n    };\n\n    // Determine which channels will be uploaded\n    const activeChannels = ['basecolor', 'normal', 'roughness', 'metallic'];\n    if (mapsToUpload.height) {\n      activeChannels.push('height');\n    }\n\n    // Start upload status with active channels\n    uploadStatus?.start(activeChannels);\n\n    const result = await uploadAndCreateMaterial(\n      mapsToUpload,\n      targetFolderUuid,\n      materialName,\n      (event) => {\n        uploadStatus?.updateProgress(event);\n        setStatus(event.status);\n      }\n    );\n\n    // Show completion\n    uploadStatus?.complete(result.textures, result.material);\n    setStatus(`Material \"${result.material.name}\" created successfully!`);\n\n  } catch (err) {\n    const message = err instanceof ThreeDverseError\n      ? err.message\n      : (err instanceof Error ? err.message : 'Upload failed');\n    uploadStatus?.error(message);\n    setStatus(`Upload error: ${message}`);\n  } finally {\n    // Re-enable button\n    updateUploadButtonState();\n  }\n}\n\n/**\n * Initialize the traditional PBR generator\n */\nfunction initTraditionalGenerator(): TraditionalPBRGenerator {\n  if (!traditionalGenerator) {\n    traditionalGenerator = new TraditionalPBRGenerator();\n  }\n  return traditionalGenerator;\n}\n\n/**\n * Process the input image using traditional generator (fast)\n */\nfunction processImageTraditional(): void {\n  if (!currentInput) return;\n\n  const startTime = performance.now();\n  setStatus('Generating PBR maps (traditional)...');\n\n  try {\n    const gen = initTraditionalGenerator();\n    const maps = gen.generate(currentInput, params);\n\n    // Convert to extended maps (no height)\n    currentMaps = {\n      ...maps,\n      height: null,\n    };\n\n    // Render to canvases\n    renderToCanvas(currentInput, inputCanvas);\n    renderToCanvas(currentMaps.basecolor, basecolorCanvas);\n    renderToCanvas(currentMaps.roughness, roughnessCanvas);\n    renderToCanvas(currentMaps.metallic, metallicCanvas);\n\n    // For normal map, show AI version if available and selected\n    updateNormalDisplay();\n\n    // Update 3D preview\n    update3DPreview();\n\n    // Update upload button state\n    updateUploadButtonState();\n\n    const elapsed = (performance.now() - startTime).toFixed(1);\n    setStatus(`Generated in ${elapsed}ms (${currentInput.width}x${currentInput.height})`);\n  } catch (err) {\n    console.error('Generation failed:', err);\n    setStatus(`Error: ${err instanceof Error ? err.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Process the input image using unified generator (supports AI)\n */\nasync function processImageUnified(): Promise<void> {\n  if (!currentInput || !unifiedGenerator) return;\n\n  const startTime = performance.now();\n  setStatus('Generating PBR maps...');\n\n  // Show progress if AI is being used (only normal map supports AI)\n  const usingAI = unifiedConfig.normalMethod === 'ai';\n\n  if (usingAI) {\n    progressBar?.show();\n  }\n\n  try {\n    currentMaps = await unifiedGenerator.generate(\n      currentInput,\n      params,\n      (_channel, progress, statusMsg) => {\n        if (usingAI) {\n          progressBar?.update(statusMsg, progress);\n        }\n        setStatus(statusMsg);\n      }\n    );\n\n    // Render to canvases\n    renderToCanvas(currentInput, inputCanvas);\n    renderToCanvas(currentMaps.basecolor, basecolorCanvas);\n    renderToCanvas(currentMaps.normal, normalCanvas);\n    renderToCanvas(currentMaps.roughness, roughnessCanvas);\n    renderToCanvas(currentMaps.metallic, metallicCanvas);\n\n    // Render height if available\n    if (currentMaps.height) {\n      renderToCanvas(currentMaps.height, heightCanvas);\n      heightPreviewItem.classList.remove('hidden');\n    } else {\n      heightPreviewItem.classList.add('hidden');\n    }\n\n    // Update 3D preview\n    update3DPreview();\n\n    // Update upload button state\n    updateUploadButtonState();\n\n    if (usingAI) {\n      progressBar?.complete();\n    }\n\n    const elapsed = (performance.now() - startTime).toFixed(1);\n    setStatus(`Generated in ${elapsed}ms (${currentInput.width}x${currentInput.height})`);\n  } catch (err) {\n    console.error('Generation failed:', err);\n    if (usingAI) {\n      progressBar?.error(err instanceof Error ? err.message : 'Unknown error');\n    }\n    setStatus(`Error: ${err instanceof Error ? err.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Update normal map display based on current mode\n */\nfunction updateNormalDisplay(): void {\n  if (!currentMaps) return;\n\n  // Show AI normal if available and selected, otherwise traditional\n  if (useAINormal && currentAINormal) {\n    renderToCanvas(currentAINormal, normalCanvas);\n  } else {\n    renderToCanvas(currentMaps.normal, normalCanvas);\n  }\n\n  // Update 3D preview\n  update3DPreview();\n}\n\n/**\n * Update 3D material preview\n */\nfunction update3DPreview(): void {\n  if (!pbrPreview || !currentMaps) return;\n\n  // Create maps for preview, using AI normal if selected\n  const previewMaps: ExtendedPBRMaps = {\n    ...currentMaps,\n    normal: useAINormal && currentAINormal ? currentAINormal : currentMaps.normal,\n  };\n\n  pbrPreview.setMaps(previewMaps);\n}\n\n/**\n * Generate AI normal map using DeepBump\n */\nasync function generateAINormalMap(): Promise<void> {\n  if (!currentInput) {\n    setStatus('Load an image first');\n    return;\n  }\n\n  // Show progress bar\n  progressBar?.show();\n\n  try {\n    setStatus('Initializing AI model...');\n\n    const deepbump = getDeepBumpGenerator();\n    await deepbump.initialize();\n\n    setStatus('Running AI inference...');\n\n    currentAINormal = await deepbump.generateNormalMap(\n      currentInput,\n      currentQualityPreset,\n      createProgressCallback(progressBar!)\n    );\n\n    // Mark complete\n    progressBar?.complete();\n\n    // Switch to AI mode and update display\n    useAINormal = true;\n    updateNormalDisplay();\n    setStatus('AI normal map generated successfully');\n  } catch (err) {\n    console.error('AI generation failed:', err);\n    progressBar?.error(err instanceof Error ? err.message : 'Unknown error');\n    setStatus(`AI Error: ${err instanceof Error ? err.message : 'Unknown error'}`);\n\n    // Keep showing traditional\n    useAINormal = false;\n    updateNormalDisplay();\n  }\n}\n\n/**\n * Handle file selection\n */\nasync function handleFile(file: File): Promise<void> {\n  setStatus('Loading image...');\n\n  try {\n    currentInput = await loadImageFile(file);\n    currentFilename = file.name.replace(/\\.[^.]+$/, '');\n\n    // Reset AI normal when loading new image\n    currentAINormal = null;\n    useAINormal = false;\n\n    // Show UI\n    controls.classList.remove('hidden');\n    previewGrid.classList.remove('hidden');\n    preview3DSection.classList.remove('hidden');\n\n    // Show channel controls\n    const channelControlsEl = document.getElementById('channelControls');\n    channelControlsEl?.classList.remove('hidden');\n\n    // Update material name placeholder\n    const materialNameInput = document.getElementById('materialNameInput') as HTMLInputElement;\n    if (materialNameInput) {\n      materialNameInput.placeholder = `Material name (e.g., ${currentFilename})`;\n    }\n\n    // Use traditional for fast initial preview\n    processImageTraditional();\n  } catch (err) {\n    console.error('Failed to load image:', err);\n    setStatus(`Error: ${err instanceof Error ? err.message : 'Failed to load image'}`);\n  }\n}\n\n/**\n * Update status message\n */\nfunction setStatus(message: string): void {\n  status.textContent = message;\n}\n\n/**\n * Update parameter value display\n */\nfunction updateValueDisplay(input: HTMLInputElement, display: HTMLSpanElement): void {\n  display.textContent = input.value;\n}\n\n// File input handling\ndropZone.addEventListener('click', () => fileInput.click());\n\nfileInput.addEventListener('change', () => {\n  const file = fileInput.files?.[0];\n  if (file) {\n    handleFile(file);\n  }\n});\n\n// Drag and drop\ndropZone.addEventListener('dragover', (e) => {\n  e.preventDefault();\n  dropZone.classList.add('dragover');\n});\n\ndropZone.addEventListener('dragleave', () => {\n  dropZone.classList.remove('dragover');\n});\n\ndropZone.addEventListener('drop', (e) => {\n  e.preventDefault();\n  dropZone.classList.remove('dragover');\n\n  const file = e.dataTransfer?.files[0];\n  if (file) {\n    handleFile(file);\n  }\n});\n\n// Clipboard paste\ndocument.addEventListener('paste', async (e) => {\n  const imageData = await loadImageFromClipboard(e);\n  if (imageData) {\n    currentInput = imageData;\n    currentFilename = 'pasted';\n    currentAINormal = null;\n    useAINormal = false;\n    controls.classList.remove('hidden');\n    previewGrid.classList.remove('hidden');\n    preview3DSection.classList.remove('hidden');\n    document.getElementById('channelControls')?.classList.remove('hidden');\n    processImageTraditional();\n  }\n});\n\n// Parameter controls\nshadowReductionInput.addEventListener('input', () => {\n  params.shadowReduction = parseFloat(shadowReductionInput.value);\n  updateValueDisplay(shadowReductionInput, shadowReductionValue);\n  processImageTraditional();\n});\n\nhighlightReductionInput.addEventListener('input', () => {\n  params.highlightReduction = parseFloat(highlightReductionInput.value);\n  updateValueDisplay(highlightReductionInput, highlightReductionValue);\n  processImageTraditional();\n});\n\nnormalStrengthInput.addEventListener('input', () => {\n  params.normalStrength = parseFloat(normalStrengthInput.value);\n  updateValueDisplay(normalStrengthInput, normalStrengthValue);\n  processImageTraditional();\n});\n\nroughnessScaleInput.addEventListener('input', () => {\n  params.roughnessScale = parseFloat(roughnessScaleInput.value);\n  updateValueDisplay(roughnessScaleInput, roughnessScaleValue);\n  processImageTraditional();\n});\n\nroughnessOffsetInput.addEventListener('input', () => {\n  params.roughnessOffset = parseFloat(roughnessOffsetInput.value);\n  updateValueDisplay(roughnessOffsetInput, roughnessOffsetValue);\n  processImageTraditional();\n});\n\nmetallicThresholdInput.addEventListener('input', () => {\n  params.metallicThreshold = parseFloat(metallicThresholdInput.value);\n  updateValueDisplay(metallicThresholdInput, metallicThresholdValue);\n  processImageTraditional();\n});\n\n// Export buttons\nexportInput.addEventListener('click', async () => {\n  if (currentInput) {\n    await downloadImageData(currentInput, `${currentFilename}_input.png`);\n  }\n});\n\nexportBasecolor.addEventListener('click', async () => {\n  if (currentMaps) {\n    await downloadImageData(currentMaps.basecolor, `${currentFilename}_basecolor.png`);\n  }\n});\n\nexportNormal.addEventListener('click', async () => {\n  // Export AI normal if available and selected, otherwise traditional\n  const normalToExport = useAINormal && currentAINormal ? currentAINormal : currentMaps?.normal;\n  if (normalToExport) {\n    const suffix = useAINormal && currentAINormal ? '_normal_ai' : '_normal';\n    await downloadImageData(normalToExport, `${currentFilename}${suffix}.png`);\n  }\n});\n\nexportRoughness.addEventListener('click', async () => {\n  if (currentMaps) {\n    await downloadImageData(currentMaps.roughness, `${currentFilename}_roughness.png`);\n  }\n});\n\nexportMetallic.addEventListener('click', async () => {\n  if (currentMaps) {\n    await downloadImageData(currentMaps.metallic, `${currentFilename}_metallic.png`);\n  }\n});\n\nexportHeight.addEventListener('click', async () => {\n  if (currentMaps?.height) {\n    await downloadImageData(currentMaps.height, `${currentFilename}_height.png`);\n  }\n});\n\n// Initialize value displays\nupdateValueDisplay(shadowReductionInput, shadowReductionValue);\nupdateValueDisplay(highlightReductionInput, highlightReductionValue);\nupdateValueDisplay(normalStrengthInput, normalStrengthValue);\nupdateValueDisplay(roughnessScaleInput, roughnessScaleValue);\nupdateValueDisplay(roughnessOffsetInput, roughnessOffsetValue);\nupdateValueDisplay(metallicThresholdInput, metallicThresholdValue);\n\n// ============================================================================\n// Phase 6: Production Polish - Initialization\n// ============================================================================\n\n// Global error boundary for catching unhandled errors\n// Note: errorBoundary automatically subscribes to error handler\ngetErrorBoundary();\nconst errorHandler = getErrorHandler();\n\n// Performance profiler\nconst profiler = getProfiler();\n\n// Offline manager\nconst offlineManager = getOfflineManager();\n\n// Keyboard shortcuts\nconst keyboardShortcuts = getKeyboardShortcuts();\nconst shortcutsHelp = getShortcutsHelpDialog();\n\n// Batch processor\nlet batchProcessor: BatchProcessor | null = null;\n\n/**\n * Initialize Phase 6 features\n */\nfunction initPhase6Features(): void {\n  // Setup keyboard shortcuts\n  setupKeyboardShortcuts();\n\n  // Setup model download progress\n  setupDownloadProgress();\n\n  // Setup batch processor\n  setupBatchProcessor();\n\n  // Check offline status\n  checkOfflineStatus();\n\n  // Setup global error recovery handlers\n  setupErrorRecoveryHandlers();\n\n  console.log('[PBR Generator] Phase 6 features initialized');\n}\n\n/**\n * Setup keyboard shortcuts\n */\nfunction setupKeyboardShortcuts(): void {\n  keyboardShortcuts.onAll({\n    'open-file': () => fileInput.click(),\n    'export-all': () => exportAllMaps(),\n    'export-basecolor': () => exportBasecolor.click(),\n    'export-normal': () => exportNormal.click(),\n    'export-roughness': () => exportRoughness.click(),\n    'export-metallic': () => exportMetallic.click(),\n    'export-height': () => exportHeight.click(),\n    'toggle-ai': () => toggleAIMode(),\n    'toggle-preview': () => toggle3DPreview(),\n    'regenerate': () => regenerateMaps(),\n    'upload-3dverse': () => handleUploadTo3dverse(),\n    'toggle-help': () => shortcutsHelp.toggle(keyboardShortcuts.getShortcuts()),\n    'increase-quality': () => cycleQuality(1),\n    'decrease-quality': () => cycleQuality(-1),\n  });\n\n  keyboardShortcuts.start();\n}\n\n/**\n * Export all maps\n */\nasync function exportAllMaps(): Promise<void> {\n  if (!currentMaps) {\n    setStatus('No maps to export');\n    return;\n  }\n\n  profiler.start('export-all');\n  setStatus('Exporting all maps...');\n\n  try {\n    await downloadImageData(currentMaps.basecolor, `${currentFilename}_basecolor.png`);\n    const normalToExport = useAINormal && currentAINormal ? currentAINormal : currentMaps.normal;\n    await downloadImageData(normalToExport, `${currentFilename}_normal.png`);\n    await downloadImageData(currentMaps.roughness, `${currentFilename}_roughness.png`);\n    await downloadImageData(currentMaps.metallic, `${currentFilename}_metallic.png`);\n    if (currentMaps.height) {\n      await downloadImageData(currentMaps.height, `${currentFilename}_height.png`);\n    }\n    setStatus('All maps exported');\n  } catch (e) {\n    errorHandler.handle(e);\n    setStatus('Export failed');\n  }\n\n  profiler.end('export-all');\n}\n\n/**\n * Toggle AI normal map mode\n */\nfunction toggleAIMode(): void {\n  if (!aiAvailable) {\n    setStatus('AI not available');\n    return;\n  }\n\n  if (unifiedConfig.normalMethod === 'ai') {\n    unifiedConfig.normalMethod = 'traditional';\n    useAINormal = false;\n    updateNormalDisplay();\n    setStatus('Switched to traditional normal generation');\n  } else {\n    unifiedConfig.normalMethod = 'ai';\n    if (currentInput) {\n      generateAINormalMap();\n    }\n    setStatus('Switched to AI normal generation');\n  }\n\n  // Update channel controls if available\n  if (channelControls) {\n    channelControls.setConfig(unifiedConfig);\n  }\n}\n\n/**\n * Toggle 3D preview visibility\n */\nfunction toggle3DPreview(): void {\n  if (preview3DSection.classList.contains('hidden')) {\n    preview3DSection.classList.remove('hidden');\n    setStatus('3D preview shown');\n  } else {\n    preview3DSection.classList.add('hidden');\n    setStatus('3D preview hidden');\n  }\n}\n\n/**\n * Regenerate maps with current settings\n */\nfunction regenerateMaps(): void {\n  if (!currentInput) {\n    setStatus('No input image');\n    return;\n  }\n\n  if (unifiedConfig.normalMethod === 'ai') {\n    processImageUnified();\n  } else {\n    processImageTraditional();\n  }\n}\n\n/**\n * Cycle through quality presets\n */\nfunction cycleQuality(direction: number): void {\n  const presetKeys = Object.keys(QUALITY_PRESETS) as (keyof typeof QUALITY_PRESETS)[];\n  const currentIndex = presetKeys.findIndex((k) => QUALITY_PRESETS[k] === currentQualityPreset);\n  const newIndex = Math.max(0, Math.min(presetKeys.length - 1, currentIndex + direction));\n  currentQualityPreset = QUALITY_PRESETS[presetKeys[newIndex]];\n  setStatus(`Quality: ${currentQualityPreset.name}`);\n}\n\n/**\n * Setup model download progress\n */\nfunction setupDownloadProgress(): void {\n  // Create container after capabilities section\n  const container = document.createElement('div');\n  container.id = 'downloadProgressContainer';\n  capabilitiesEl.parentNode?.insertBefore(container, capabilitiesEl.nextSibling);\n\n  // Store reference for potential future use (e.g., programmatic show/hide)\n  new DownloadProgress(container, {\n    showCacheSize: true,\n    showModelList: true,\n  });\n}\n\n/**\n * Setup batch processor\n */\nfunction setupBatchProcessor(): void {\n  // Create batch processor container\n  const container = document.createElement('div');\n  container.id = 'batchProcessorContainer';\n  dropZone.parentNode?.insertBefore(container, dropZone.nextSibling);\n\n  batchProcessor = new BatchProcessor(container, {\n    onProcess: async (file: File) => {\n      const input = await loadImageFile(file);\n      const gen = initTraditionalGenerator();\n      const maps = gen.generate(input, params);\n      return {\n        input,\n        maps: { ...maps, height: null },\n      };\n    },\n    onExport: async (item: BatchItem, channels: string[]) => {\n      const baseName = item.file.name.replace(/\\.[^.]+$/, '');\n      if (item.maps) {\n        for (const channel of channels) {\n          const map = item.maps[channel as keyof ExtendedPBRMaps];\n          if (map) {\n            await downloadImageData(map, `${baseName}_${channel}.png`);\n          }\n        }\n      }\n    },\n    onComplete: (result) => {\n      setStatus(`Batch complete: ${result.completed}/${result.totalItems} successful`);\n    },\n  });\n\n  // Add batch mode toggle button\n  addBatchModeButton();\n}\n\n/**\n * Add batch mode toggle button\n */\nfunction addBatchModeButton(): void {\n  const batchBtn = document.createElement('button');\n  batchBtn.className = 'batch-toggle-btn';\n  batchBtn.textContent = 'Batch Mode';\n  batchBtn.style.cssText = `\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    padding: 6px 12px;\n    background: #3a3a5a;\n    border: none;\n    border-radius: 4px;\n    color: #ccc;\n    font-size: 12px;\n    cursor: pointer;\n  `;\n  batchBtn.addEventListener('click', () => {\n    batchProcessor?.toggle();\n  });\n  dropZone.style.position = 'relative';\n  dropZone.appendChild(batchBtn);\n}\n\n/**\n * Check offline status and update UI\n */\nasync function checkOfflineStatus(): Promise<void> {\n  const status = await offlineManager.getStatus();\n  if (!status.isOnline) {\n    console.log('[PBR Generator] Running in offline mode');\n    if (!status.modelsReady) {\n      console.warn('[PBR Generator] AI models not cached for offline use');\n    }\n  }\n\n  // Subscribe to status changes\n  offlineManager.onStatusChange((newStatus) => {\n    if (!newStatus.isOnline && !newStatus.modelsReady) {\n      setStatus('Offline - AI features unavailable (models not cached)');\n    }\n  });\n}\n\n/**\n * Setup global error recovery handlers\n */\nfunction setupErrorRecoveryHandlers(): void {\n  // Listen for retry requests\n  window.addEventListener('pbr-error-retry', () => {\n    if (currentInput) {\n      regenerateMaps();\n    }\n  });\n\n  // Listen for re-auth requests\n  window.addEventListener('pbr-reauthenticate', () => {\n    const auth = getAuth();\n    auth.logout();\n    loginPanel?.refresh();\n  });\n\n  // Handle unhandled promise rejections\n  window.addEventListener('unhandledrejection', (event) => {\n    console.error('Unhandled rejection:', event.reason);\n    errorHandler.handle(event.reason);\n    event.preventDefault();\n  });\n\n  // Handle general errors\n  window.addEventListener('error', (event) => {\n    console.error('Global error:', event.error);\n    errorHandler.handle(event.error);\n  });\n}\n\n// Initialize capabilities detection and Phase 6 features\ninitCapabilities();\ninitPhase6Features();\n"],"file":"assets/index-DSBAvkOw.js"}