!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const e={},t=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const t=document.querySelector("meta[property=csp-nonce]"),r=t?.nonce||t?.getAttribute("nonce");a=Promise.allSettled(n.map(t=>{if((t=function(e){return"/shader-fn-dep-analyzer/texturegenerator/"+e}(t))in e)return;e[t]=!0;const n=t.endsWith(".css"),a=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${t}"]${a}`))return;const s=document.createElement("link");return s.rel=n?"stylesheet":"modulepreload",n||(s.as="script"),s.crossOrigin="",s.href=t,r&&s.setAttribute("nonce",r),document.head.appendChild(s),n?new Promise((e,n)=>{s.addEventListener("load",e),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(e=>{for(const t of e||[])"rejected"===t.status&&s(t.reason);return t().catch(s)})};class n{gl;canvas;textures=[];framebuffers=[];programs=[];constructor(e={}){this.canvas=document.createElement("canvas");const t=this.canvas.getContext("webgl2",{antialias:e.antialias??!1,preserveDrawingBuffer:e.preserveDrawingBuffer??!0,premultipliedAlpha:!1,alpha:!0});if(!t)throw new Error("WebGL2 not supported");this.gl=t;t.getExtension("EXT_color_buffer_float")||console.warn("EXT_color_buffer_float not available, some features may be limited")}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t)}createTextureFromImageData(e){const t=this.gl,n=t.createTexture();if(!n)throw new Error("Failed to create texture");return t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,e.width,e.height,0,t.RGBA,t.UNSIGNED_BYTE,e.data),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.textures.push(n),n}createRenderTarget(e,t){const n=this.gl,r=n.createTexture();if(!r)throw new Error("Failed to create render target");return n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA8,e,t,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),this.textures.push(r),r}createFramebuffer(e){const t=this.gl,n=t.createFramebuffer();if(!n)throw new Error("Failed to create framebuffer");t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0);const r=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r!==t.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer incomplete: ${r}`);return t.bindFramebuffer(t.FRAMEBUFFER,null),this.framebuffers.push(n),n}readPixels(e,t,n){const r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,e);const a=new Uint8ClampedArray(t*n*4);return r.readPixels(0,0,t,n,r.RGBA,r.UNSIGNED_BYTE,a),r.bindFramebuffer(r.FRAMEBUFFER,null),new ImageData(a,t,n)}registerProgram(e){this.programs.push(e)}clearTemporaryResources(){const e=this.gl;for(const t of this.textures)e.deleteTexture(t);for(const t of this.framebuffers)e.deleteFramebuffer(t);this.textures=[],this.framebuffers=[]}dispose(){const e=this.gl;for(const t of this.textures)e.deleteTexture(t);for(const t of this.framebuffers)e.deleteFramebuffer(t);for(const t of this.programs)e.deleteProgram(t);this.textures=[],this.framebuffers=[],this.programs=[]}}function r(e,t,n){const r=e.createShader(t);if(!r)throw new Error("Failed to create shader");if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(r);throw e.deleteShader(r),new Error(`Shader compilation failed: ${t}`)}return r}function a(e,t,n){const a=r(e,e.VERTEX_SHADER,t),s=r(e,e.FRAGMENT_SHADER,n),o=e.createProgram();if(!o)throw new Error("Failed to create program");if(e.attachShader(o,a),e.attachShader(o,s),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS)){const t=e.getProgramInfoLog(o);throw e.deleteProgram(o),e.deleteShader(a),e.deleteShader(s),new Error(`Program linking failed: ${t}`)}e.deleteShader(a),e.deleteShader(s);const i=new Map,l=e.getProgramParameter(o,e.ACTIVE_ATTRIBUTES);for(let r=0;r<l;r++){const t=e.getActiveAttrib(o,r);t&&i.set(t.name,e.getAttribLocation(o,t.name))}const c=new Map,d=e.getProgramParameter(o,e.ACTIVE_UNIFORMS);for(let r=0;r<d;r++){const t=e.getActiveUniform(o,r);if(t){const n=e.getUniformLocation(o,t.name);n&&c.set(t.name,n)}}return{program:o,attributes:i,uniforms:c}}const s="#version 300 es\nprecision highp float;\n\nin vec2 a_position;\nout vec2 v_uv;\n\nvoid main() {\n  v_uv = a_position * 0.5 + 0.5;\n  gl_Position = vec4(a_position, 0.0, 1.0);\n}\n";const o="\n// Luminance calculation using Rec. 709 coefficients\nfloat luminance(vec3 color) {\n  return dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\n\n// Saturation: difference between max and min channel\nfloat saturation(vec3 color) {\n  float maxC = max(max(color.r, color.g), color.b);\n  float minC = min(min(color.r, color.g), color.b);\n  return maxC - minC;\n}\n\n// Convert RGB to HSL\nvec3 rgb2hsl(vec3 color) {\n  float maxC = max(max(color.r, color.g), color.b);\n  float minC = min(min(color.r, color.g), color.b);\n  float l = (maxC + minC) * 0.5;\n\n  if (maxC == minC) {\n    return vec3(0.0, 0.0, l);\n  }\n\n  float d = maxC - minC;\n  float s = l > 0.5 ? d / (2.0 - maxC - minC) : d / (maxC + minC);\n\n  float h;\n  if (maxC == color.r) {\n    h = (color.g - color.b) / d + (color.g < color.b ? 6.0 : 0.0);\n  } else if (maxC == color.g) {\n    h = (color.b - color.r) / d + 2.0;\n  } else {\n    h = (color.r - color.g) / d + 4.0;\n  }\n  h /= 6.0;\n\n  return vec3(h, s, l);\n}\n",i=`#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_strength;\nuniform vec2 u_texelSize;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${o}\n\nvoid main() {\n  // Sample 3x3 neighborhood using luminance as height\n  float tl = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, -u_texelSize.y)).rgb);\n  float t  = luminance(texture(u_texture, v_uv + vec2(0.0, -u_texelSize.y)).rgb);\n  float tr = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, -u_texelSize.y)).rgb);\n  float l  = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, 0.0)).rgb);\n  float r  = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, 0.0)).rgb);\n  float bl = luminance(texture(u_texture, v_uv + vec2(-u_texelSize.x, u_texelSize.y)).rgb);\n  float b  = luminance(texture(u_texture, v_uv + vec2(0.0, u_texelSize.y)).rgb);\n  float br = luminance(texture(u_texture, v_uv + vec2(u_texelSize.x, u_texelSize.y)).rgb);\n\n  // Sobel operator\n  float dX = (tr + 2.0 * r + br) - (tl + 2.0 * l + bl);\n  float dY = (bl + 2.0 * b + br) - (tl + 2.0 * t + tr);\n\n  // Construct and normalize the normal vector\n  vec3 normal = normalize(vec3(dX * u_strength, dY * u_strength, 1.0));\n\n  // Pack from [-1,1] to [0,1] for storage\n  normal = normal * 0.5 + 0.5;\n\n  fragColor = vec4(normal, 1.0);\n}\n`,l=`#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_scale;\nuniform float u_offset;\nuniform vec2 u_texelSize;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${o}\n\nvoid main() {\n  // Sample 3x3 neighborhood\n  float samples[9];\n  int idx = 0;\n  for (int y = -1; y <= 1; y++) {\n    for (int x = -1; x <= 1; x++) {\n      vec2 offset = vec2(float(x), float(y)) * u_texelSize;\n      samples[idx] = luminance(texture(u_texture, v_uv + offset).rgb);\n      idx++;\n    }\n  }\n\n  // Calculate mean\n  float mean = 0.0;\n  for (int i = 0; i < 9; i++) {\n    mean += samples[i];\n  }\n  mean /= 9.0;\n\n  // Calculate variance\n  float variance = 0.0;\n  for (int i = 0; i < 9; i++) {\n    float diff = samples[i] - mean;\n    variance += diff * diff;\n  }\n  variance /= 9.0;\n\n  // Map variance to roughness\n  // High variance = high local detail = rough surface\n  // Low variance = flat area = could be smooth or rough depending on luminance\n  float roughness = sqrt(variance) * 4.0; // Scale variance to useful range\n\n  // Dark areas tend to be rougher (absorption)\n  // Light areas with low variance tend to be smooth (reflection)\n  float lumFactor = 1.0 - mean * 0.3;\n\n  roughness = roughness * lumFactor;\n\n  // Apply user controls\n  roughness = roughness * u_scale + u_offset;\n  roughness = clamp(roughness, 0.0, 1.0);\n\n  // Invert so that smooth areas are dark, rough areas are bright\n  // This matches common PBR conventions where white = rough\n  roughness = 0.5 + roughness * 0.5;\n\n  fragColor = vec4(vec3(roughness), 1.0);\n}\n`,c=`#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n${o}\n\n// Check if color is in metallic range (gold, copper, silver, etc.)\nfloat metallicColorScore(vec3 color) {\n  vec3 hsl = rgb2hsl(color);\n  float h = hsl.x;\n  float s = hsl.y;\n  float l = hsl.z;\n\n  float score = 0.0;\n\n  // Gold range: hue 30-60 degrees (0.08-0.17 normalized)\n  if (h > 0.08 && h < 0.17 && s > 0.3 && l > 0.4) {\n    score = max(score, 0.7);\n  }\n\n  // Copper range: hue 10-30 degrees (0.03-0.08 normalized)\n  if (h > 0.03 && h < 0.08 && s > 0.4 && l > 0.3) {\n    score = max(score, 0.6);\n  }\n\n  // Silver/chrome: very low saturation, high luminance\n  if (s < 0.15 && l > 0.6) {\n    score = max(score, 0.5);\n  }\n\n  return score;\n}\n\nvoid main() {\n  vec3 color = texture(u_texture, v_uv).rgb;\n  float lum = luminance(color);\n  float sat = saturation(color);\n\n  // Base metallic estimation\n  // High luminance + moderate saturation suggests metal\n  // Low saturation + high luminance could be chrome/silver\n  float metallic = 0.0;\n\n  // Check for metallic color ranges\n  metallic = metallicColorScore(color);\n\n  // Boost for high luminance areas with some color\n  if (lum > 0.5 && sat > 0.1 && sat < 0.6) {\n    metallic = max(metallic, lum * 0.4);\n  }\n\n  // Very bright, low saturation = potential chrome/silver\n  if (lum > 0.7 && sat < 0.2) {\n    metallic = max(metallic, 0.3);\n  }\n\n  // Apply threshold - creates more binary output\n  // Values below threshold become 0, above become scaled\n  metallic = smoothstep(u_threshold - 0.2, u_threshold + 0.2, metallic);\n\n  fragColor = vec4(vec3(metallic), 1.0);\n}\n`;class d{ctx;vao;normalProgram;roughnessProgram;metallicProgram;basecolorProgram;constructor(){this.ctx=new n;const e=this.ctx.gl;this.vao=function(e){const t=e.createVertexArray();if(!t)throw new Error("Failed to create VAO");const n=e.createBuffer();if(!n)throw new Error("Failed to create buffer");const r=new Float32Array([-1,-1,1,-1,-1,1,1,1]);return e.bindVertexArray(t),e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),t}(e),this.normalProgram=a(e,s,i),this.roughnessProgram=a(e,s,l),this.metallicProgram=a(e,s,c),this.basecolorProgram=a(e,s,"#version 300 es\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform vec2 u_texelSize;\nuniform float u_shadowReduction;   // 0.0 = none, 1.0 = full\nuniform float u_highlightReduction; // 0.0 = none, 1.0 = full\n\nin vec2 v_uv;\nout vec4 fragColor;\n\nvoid main() {\n  vec3 color = texture(u_texture, v_uv).rgb;\n  float lum = dot(color, vec3(0.299, 0.587, 0.114));\n\n  // Target: mid-gray (0.5)\n  vec3 midGray = vec3(0.5);\n\n  // Shadow reduction: blend dark pixels toward mid-gray\n  float shadowBlend = 0.0;\n  if (lum < 0.5) {\n    float darkness = 1.0 - lum * 2.0; // 1.0 at black, 0.0 at mid-gray\n    shadowBlend = darkness * u_shadowReduction;\n  }\n\n  // Highlight reduction: blend bright pixels toward mid-gray\n  float highlightBlend = 0.0;\n  if (lum > 0.5) {\n    float brightness = (lum - 0.5) * 2.0; // 0.0 at mid-gray, 1.0 at white\n    highlightBlend = brightness * u_highlightReduction;\n  }\n\n  // Simple additive adjustment (no division)\n  vec3 result = color;\n  result += (midGray - color) * shadowBlend;\n  result += (midGray - result) * highlightBlend;\n\n  fragColor = vec4(clamp(result, 0.0, 1.0), 1.0);\n}\n"),this.ctx.registerProgram(this.normalProgram.program),this.ctx.registerProgram(this.roughnessProgram.program),this.ctx.registerProgram(this.metallicProgram.program),this.ctx.registerProgram(this.basecolorProgram.program)}generate(e,t){const{width:n,height:r}=e;this.ctx.clearTemporaryResources(),this.ctx.resize(n,r);const a=this.ctx.createTextureFromImageData(e),s=[1/n,1/r];return{basecolor:this.renderPass(this.basecolorProgram,a,{u_texelSize:s,u_shadowReduction:t.shadowReduction,u_highlightReduction:t.highlightReduction},n,r),normal:this.renderPass(this.normalProgram,a,{u_strength:t.normalStrength,u_texelSize:s},n,r),roughness:this.renderPass(this.roughnessProgram,a,{u_scale:t.roughnessScale,u_offset:t.roughnessOffset,u_texelSize:s},n,r),metallic:this.renderPass(this.metallicProgram,a,{u_threshold:t.metallicThreshold},n,r)}}renderPass(e,t,n,r,a){const s=this.ctx.gl,o=this.ctx.createRenderTarget(r,a),i=this.ctx.createFramebuffer(o);s.useProgram(e.program);const l=e.uniforms.get("u_texture");l&&s.uniform1i(l,0),function(e,t,n,r,a,s){e.bindFramebuffer(e.FRAMEBUFFER,s),e.useProgram(t.program),e.bindVertexArray(n);for(const{unit:o,texture:i}of a)e.activeTexture(e.TEXTURE0+o),e.bindTexture(e.TEXTURE_2D,i);for(const[o,i]of Object.entries(r)){const n=t.uniforms.get(o);n&&(Array.isArray(i)?2===i.length?e.uniform2fv(n,i):3===i.length?e.uniform3fv(n,i):4===i.length&&e.uniform4fv(n,i):e.uniform1f(n,i))}e.drawArrays(e.TRIANGLE_STRIP,0,4),e.bindVertexArray(null)}(s,e,this.vao,n,[{unit:0,texture:t}],i);const c=this.ctx.readPixels(i,r,a);return this.flipImageDataY(c)}flipImageDataY(e){const{data:t,width:n,height:r}=e,a=new Uint8ClampedArray(t.length),s=4*n;for(let o=0;o<r;o++){const e=o*s,n=(r-1-o)*s;a.set(t.subarray(e,e+s),n)}return new ImageData(a,n,r)}dispose(){this.ctx.dispose()}}const h=new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]);async function u(){const e={webgpu:!1,webgpuAdapter:null,webgpuFP16:!1,webnn:!1,wasm:"undefined"!=typeof WebAssembly,wasmSimd:!1,wasmThreads:!1,estimatedMemoryMB:2048,webgl2:!1},[t,n,r,a,s]=await Promise.allSettled([p(),m(),g(),f(),b()]);return"fulfilled"===t.status&&t.value&&(e.webgpu=!0,e.webgpuAdapter=t.value.adapter,e.webgpuFP16=t.value.fp16),"fulfilled"===n.status&&(e.wasmSimd=n.value),"fulfilled"===r.status&&(e.wasmThreads=r.value),"fulfilled"===a.status&&(e.webgl2=a.value),"fulfilled"===s.status&&(e.estimatedMemoryMB=s.value),e.webnn="ml"in navigator||"MLContext"in globalThis,e}async function p(){if(!("gpu"in navigator))return null;try{const e=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!e)return null;const t=e.features.has("shader-f16");return{adapter:e,fp16:t}}catch{return null}}async function m(){try{return WebAssembly.validate(h)}catch{return!1}}async function g(){try{if("undefined"==typeof SharedArrayBuffer)return!1;return 1===new SharedArrayBuffer(1).byteLength}catch{return!1}}async function f(){try{const e=document.createElement("canvas");return null!==e.getContext("webgl2")}catch{return!1}}async function b(){let e=2048;const t=navigator.deviceMemory;"number"==typeof t&&t>0&&(e=1024*t*.5);const n=performance.memory;if(n&&"number"==typeof n.jsHeapSizeLimit){const t=n.jsHeapSizeLimit/1048576;e=Math.min(e,.8*t)}return e=Math.max(512,Math.min(e,16384)),Math.round(e)}const y=["webgpu-fp16","webgpu-fp32","webnn","wasm"];function x(e,t){const n=function(e){const t=[];for(const n of y)v(e,n)&&t.push(n);return t}(e);return 0===n.length?null:n[0]}function v(e,t){switch(t){case"webgpu-fp16":return e.webgpu&&e.webgpuFP16;case"webgpu-fp32":return e.webgpu;case"webnn":return e.webnn;case"wasm":return e.wasm&&e.wasmSimd;default:return!1}}function E(e,t){const n=function(e){switch(e){case"webgpu-fp16":case"webnn":return"fp16";case"webgpu-fp32":default:return"fp32";case"wasm":return"int8"}}(t),r=e.find(e=>e.quantization===n&&e.backends.includes(t));if(r)return r;const a=e.filter(e=>e.backends.includes(t));return a.length>0?a[0]:null}var w=(e=>(e.BACKEND_NOT_SUPPORTED="BACKEND_NOT_SUPPORTED",e.MODEL_NOT_FOUND="MODEL_NOT_FOUND",e.MODEL_LOAD_FAILED="MODEL_LOAD_FAILED",e.INFERENCE_FAILED="INFERENCE_FAILED",e.OUT_OF_MEMORY="OUT_OF_MEMORY",e.WORKER_ERROR="WORKER_ERROR",e.SESSION_NOT_READY="SESSION_NOT_READY",e.CACHE_ERROR="CACHE_ERROR",e))(w||{});class _ extends Error{constructor(e,t,n=!1,r){super(e),this.code=t,this.recoverable=n,this.suggestion=r,this.name="InferenceError"}}const T="models",A="metadata",C="1.0.0";class S{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((e,t)=>{const n=indexedDB.open("pbr-texture-gen-models",1);n.onerror=()=>{t(new _("Failed to open model cache database",w.CACHE_ERROR,!0,"Model caching disabled, models will be re-downloaded each session"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(T)||t.createObjectStore(T),t.objectStoreNames.contains(A)||t.createObjectStore(A)}})),this.initPromise}async isCached(e){if(await this.init(),!this.db)return!1;try{const t=await this.getMetadata(e);return!!t&&(t.cacheVersion===C||(await this.delete(e),!1))}catch{return!1}}async get(e){return await this.init(),this.db?new Promise((t,n)=>{const r=this.db.transaction(T,"readonly").objectStore(T).get(e);r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result||null)}):null}async getExternalData(e){return this.get(`${e}_external`)}async put(e,t,n){if(await this.init(),!this.db)return;await new Promise((n,r)=>{const a=this.db.transaction(T,"readwrite").objectStore(T).put(t,e);a.onerror=()=>r(a.error),a.onsuccess=()=>n()});const r={modelId:e,cachedAt:Date.now(),sizeBytes:n.sizeBytes,cacheVersion:C};await this.putMetadata(e,r)}async putExternalData(e,t){await this.init(),this.db&&await new Promise((n,r)=>{const a=this.db.transaction(T,"readwrite").objectStore(T).put(t,`${e}_external`);a.onerror=()=>r(a.error),a.onsuccess=()=>n()})}async delete(e){await this.init(),this.db&&(await new Promise((t,n)=>{const r=this.db.transaction(T,"readwrite").objectStore(T).delete(e);r.onerror=()=>n(r.error),r.onsuccess=()=>t()}),await new Promise(t=>{const n=this.db.transaction(T,"readwrite").objectStore(T).delete(`${e}_external`);n.onsuccess=()=>t(),n.onerror=()=>t()}),await this.deleteMetadata(e))}async listCached(){return await this.init(),this.db?new Promise((e,t)=>{const n=this.db.transaction(A,"readonly").objectStore(A).getAllKeys();n.onerror=()=>t(n.error),n.onsuccess=()=>{const t=n.result;e(t)}}):[]}async getCacheSize(){if(await this.init(),!this.db)return 0;const e=await this.listCached();let t=0;for(const n of e){const e=await this.getMetadata(n);e&&(t+=e.sizeBytes)}return t}async clearAll(){await this.init(),this.db&&await new Promise((e,t)=>{const n=this.db.transaction([T,A],"readwrite");n.objectStore(T).clear(),n.objectStore(A).clear(),n.oncomplete=()=>e(),n.onerror=()=>t(n.error)})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}async getMetadata(e){return new Promise((t,n)=>{const r=this.db.transaction(A,"readonly").objectStore(A).get(e);r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result||null)})}async putMetadata(e,t){return new Promise((n,r)=>{const a=this.db.transaction(A,"readwrite").objectStore(A).put(t,e);a.onerror=()=>r(a.error),a.onsuccess=()=>n()})}async deleteMetadata(e){return new Promise((t,n)=>{const r=this.db.transaction(A,"readwrite").objectStore(A).delete(e);r.onerror=()=>n(r.error),r.onsuccess=()=>t()})}}let k=null;function R(){return k||(k=new S),k}const M=Object.freeze(Object.defineProperty({__proto__:null,ModelCache:S,getModelCache:R},Symbol.toStringTag,{value:"Module"})),I="/models";class L{manifestPromise=null;async loadManifest(){return this.manifestPromise||(this.manifestPromise=this.fetchManifest()),this.manifestPromise}async getModel(e){return(await this.loadManifest()).models.find(t=>t.id===e)||null}async getAvailableModels(){return(await this.loadManifest()).models}async loadModelData(e,t){const n=R();if(await n.isCached(e.id)){const r=await n.get(e.id);if(r)return t?.({modelId:e.id,loadedBytes:e.sizeBytes,totalBytes:e.sizeBytes,progress:1}),r}const r=await this.downloadModel(e,t);try{await n.put(e.id,r,e)}catch(a){console.warn("Failed to cache model:",a)}return r}async loadExternalData(e,t){if(!e.externalDataPath)return null;const n=R();if(await n.isCached(e.id)){const t=await n.getExternalData(e.id);if(t)return t}const r=`${I}/${e.externalDataPath}`,a=await this.downloadWithProgress(r,e.id,t);try{await n.putExternalData(e.id,a)}catch(s){console.warn("Failed to cache external data:",s)}return a}getModelUrl(e){return`${I}/${e.path}`}getExternalDataUrl(e){return e.externalDataPath?`${I}/${e.externalDataPath}`:null}async preloadModels(e,t){for(const n of e){const e=await this.getModel(n);e&&(await this.loadModelData(e,e=>{t?.(n,e.progress)}),e.externalDataPath&&await this.loadExternalData(e))}}async clearCache(){const e=R();await e.clearAll()}async getCacheStats(){const e=R();return{cachedModels:await e.listCached(),totalSizeBytes:await e.getCacheSize()}}async fetchManifest(){try{const e=await fetch(`${I}/manifest.json`);if(!e.ok)throw new Error(`HTTP ${e.status}`);return await e.json()}catch(e){return console.warn("Model manifest not found, using empty manifest"),{version:"1.0.0",models:[]}}}async downloadModel(e,t){const n=`${I}/${e.path}`;return this.downloadWithProgress(n,e.id,t)}async downloadWithProgress(e,t,n){try{const r=await fetch(e);if(!r.ok)throw new _(`Failed to download model: HTTP ${r.status}`,w.MODEL_NOT_FOUND,!1);const a=r.headers.get("content-length");if(!a||!r.body){const e=await r.arrayBuffer();return n?.({modelId:t,loadedBytes:e.byteLength,totalBytes:e.byteLength,progress:1}),e}const s=parseInt(a,10),o=r.body.getReader(),i=[];let l=0;for(;;){const{done:e,value:r}=await o.read();if(e)break;i.push(r),l+=r.length,n?.({modelId:t,loadedBytes:l,totalBytes:s,progress:l/s})}const c=new Uint8Array(l);let d=0;for(const e of i)c.set(e,d),d+=e.length;return c.buffer}catch(r){if(r instanceof _)throw r;throw new _(`Failed to download model: ${r instanceof Error?r.message:"Unknown error"}`,w.MODEL_LOAD_FAILED,!0,"Check network connection and try again")}}}let P=null;function F(){return P||(P=new L),P}class D{worker=null;state="uninitialized";pendingRequests=new Map;nextRequestId=1;initPromise=null;currentModel=null;currentBackend=null;getState(){return this.state}getCurrentModel(){return this.currentModel}getCurrentBackend(){return this.currentBackend}async initialize(e,t){if(!("ready"===this.state&&this.currentModel?.id===e.id&&this.currentBackend===t||this.initPromise&&(await this.initPromise,this.currentModel?.id===e.id&&this.currentBackend===t)))return this.initPromise=this.doInitialize(e,t),this.initPromise}async infer(e,t){if("ready"!==this.state)throw new _("Session not ready for inference",w.SESSION_NOT_READY,!0,"Initialize the session first");if(!this.worker)throw new _("Worker not initialized",w.WORKER_ERROR,!0);this.state="busy";const n=this.nextRequestId++,{width:r,height:a,data:s}=e,o=s.buffer.slice(0);return new Promise((e,s)=>{this.pendingRequests.set(n,{resolve:e,reject:s,onProgress:t}),this.worker.postMessage({type:"infer",id:n,payload:{imageData:o,width:r,height:a}},[o])})}isReady(){return"ready"===this.state}dispose(){this.worker&&(this.worker.postMessage({type:"dispose"}),this.worker.terminate(),this.worker=null);for(const[,e]of this.pendingRequests)e.reject(new _("Session disposed",w.SESSION_NOT_READY,!1));this.pendingRequests.clear(),this.state="disposed",this.currentModel=null,this.currentBackend=null,this.initPromise=null}async doInitialize(e,t){this.worker&&this.dispose(),this.state="loading";try{this.worker=new Worker(new URL("/shader-fn-dep-analyzer/texturegenerator/assets/inference-worker-Dhrl059K.js",import.meta.url),{type:"module"}),this.worker.onmessage=this.handleMessage.bind(this),this.worker.onerror=this.handleError.bind(this);const n=F(),r=n.getModelUrl(e),a=n.getExternalDataUrl(e);await new Promise((e,n)=>{const s=setTimeout(()=>{n(new _("Timeout waiting for worker initialization",w.MODEL_LOAD_FAILED,!0))},6e4);this.worker.onmessage=t=>{const r=t.data;if("ready"===r.type)clearTimeout(s),e();else if("error"===r.type){clearTimeout(s);const e=r;n(new _(e.payload.message,e.payload.code,!0))}},this.worker.postMessage({type:"init",payload:{modelUrl:r,externalDataUrl:a,backend:t}})}),this.worker.onmessage=this.handleMessage.bind(this),this.state="ready",this.currentModel=e,this.currentBackend=t}catch(n){throw this.state="error",this.initPromise=null,n}}handleMessage(e){const t=e.data;switch(t.type){case"result":this.handleResult(t);break;case"progress":this.handleProgress(t);break;case"error":this.handleWorkerError(t)}}handleResult(e){const t=this.pendingRequests.get(e.id);if(!t)return;this.pendingRequests.delete(e.id),this.state="ready";const{outputData:n,width:r,height:a}=e.payload,s=new ImageData(new Uint8ClampedArray(n),r,a);t.resolve(s)}handleProgress(e){const t=this.pendingRequests.get(e.id);t&&t.onProgress&&t.onProgress(e.payload.stage,e.payload.progress)}handleWorkerError(e){const t=e.id?this.pendingRequests.get(e.id):null;t?(this.pendingRequests.delete(e.id),this.state="ready",t.reject(new _(e.payload.message,e.payload.code,!0))):(console.error("Worker error:",e.payload),this.state="error")}handleError(e){console.error("Worker error event:",e),this.state="error";for(const[,t]of this.pendingRequests)t.reject(new _(e.message||"Worker error",w.WORKER_ERROR,!0));this.pendingRequests.clear()}}let N=null;function O(){return N||(N=new D),N}function U(e,t,n){const{width:r,height:a}=e;if(r===t&&a===n)return e;const s=new OffscreenCanvas(r,a);s.getContext("2d").putImageData(e,0,0);const o=new OffscreenCanvas(t,n).getContext("2d");return o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(s,0,0,t,n),o.getImageData(0,0,t,n)}function B(e,t,n){const{width:r,height:a}=e;if(r===t&&a===n)return e;const s=Math.floor((r-t)/2),o=Math.floor((a-n)/2),i=new OffscreenCanvas(r,a).getContext("2d");return i.putImageData(e,0,0),i.getImageData(s,o,t,n)}const $="deepbump",z={fast:{name:"Fast Preview",resolution:256,useAI:!1,upscale:!0,expectedTime:"<100ms (Traditional)"},balanced:{name:"Balanced (AI)",resolution:256,useAI:!0,upscale:!0,expectedTime:"2-10s (WASM)"},quality:{name:"High Quality (AI)",resolution:256,useAI:!0,upscale:!0,expectedTime:"2-10s (WASM)"}};class G{capabilities=null;selectedBackend=null;selectedModel=null;state="uninitialized";initPromise=null;lastError=null;getState(){return this.state}getLastError(){return this.lastError}getBackend(){return this.selectedBackend}getModel(){return this.selectedModel}isAvailable(){return"ready"===this.state}async initialize(){if("ready"!==this.state)return this.initPromise||(this.initPromise=this.doInitialize()),this.initPromise}async generateNormalMap(e,t=z.balanced,n){if("ready"!==this.state&&await this.initialize(),"ready"!==this.state)throw new _("DeepBump generator not ready",w.SESSION_NOT_READY,!0,this.lastError?.message);this.state="busy";const r=e.width,a=e.height;try{n?.("preprocessing",.05);let s=e;const o=e.width!==e.height;o&&(s=function(e){const{width:t,height:n}=e;if(t===n)return e;const r=Math.max(t,n),a=new OffscreenCanvas(r,r).getContext("2d"),s=new OffscreenCanvas(t,n);s.getContext("2d").putImageData(e,0,0);const o=Math.floor((r-t)/2),i=Math.floor((r-n)/2);return a.drawImage(s,o,i),o>0&&(a.save(),a.scale(-1,1),a.drawImage(s,0,0,1,n,-o,i,o,n),a.restore(),a.save(),a.translate(r,0),a.scale(-1,1),a.drawImage(s,t-1,0,1,n,0,i,o,n),a.restore()),i>0&&(a.save(),a.scale(1,-1),a.drawImage(s,0,0,t,1,o,-i,t,i),a.restore(),a.save(),a.translate(0,r),a.scale(1,-1),a.drawImage(s,0,n-1,t,1,o,0,t,i),a.restore()),a.getImageData(0,0,r,r)}(s));const i=t.resolution;s.width===i&&s.height===i||(s=U(s,i,i)),n?.("preprocessing",.1);const l=O(),c=await l.infer(s,(e,t)=>{const r=.1+.8*t;n?.(e,r)});n?.("postprocessing",.9);let d=c;if(!t.upscale||c.width===r&&c.height===a)o&&(d=B(d,r,a));else if(o){const e=Math.max(r,a);d=U(d,e,e),d=B(d,r,a)}else d=U(d,r,a);return n?.("complete",1),this.state="ready",d}catch(s){throw this.state="ready",s}}dispose(){O().dispose(),this.state="uninitialized",this.initPromise=null,this.selectedModel=null,this.selectedBackend=null}async doInitialize(){this.state="initializing",this.lastError=null;try{this.capabilities=await u();const e=F(),t=(await e.getAvailableModels()).filter(e=>e.id.startsWith($));if(0===t.length)throw new _("No DeepBump models found in manifest",w.MODEL_NOT_FOUND,!1,"Ensure model files are present in /public/models/");if(this.selectedBackend=x(this.capabilities),!this.selectedBackend)throw new _("No compatible inference backend available",w.BACKEND_NOT_SUPPORTED,!1,"WebGPU or WASM with SIMD required");if(this.selectedModel=E(t,this.selectedBackend),!this.selectedModel)throw new _(`No DeepBump model compatible with ${this.selectedBackend}`,w.MODEL_NOT_FOUND,!1);const n=O();await n.initialize(this.selectedModel,this.selectedBackend),this.state="ready"}catch(e){throw this.state="error",this.lastError=e instanceof Error?e:new Error(String(e)),this.initPromise=null,e}}}let H=null;function q(){return H||(H=new G),H}async function j(){try{const e=x(await u());if(!e)return!1;const t=F(),n=(await t.getAvailableModels()).filter(e=>e.id.startsWith($));if(0===n.length)return!1;return null!==E(n,e)}catch{return!1}}const W={normalMethod:"traditional",heightMethod:"none",aiQualityPreset:z.quality};class X{traditionalGen=null;config;aiAvailable=!1;constructor(e={}){this.config={...W,...e}}async initialize(){this.aiAvailable=await j(),this.aiAvailable||"ai"!==this.config.normalMethod||(console.warn("AI not available for normal maps, falling back to traditional"),this.config.normalMethod="traditional")}setConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}isAIAvailable(){return this.aiAvailable}async generate(e,t,n){this.traditionalGen||(this.traditionalGen=new d),n?.("basecolor",0,"Processing basecolor...");const r=this.traditionalGen.generate(e,t);let a;if(n?.("basecolor",1,"Basecolor complete"),n?.("normal",0,"Generating normal map..."),"ai"===this.config.normalMethod&&this.aiAvailable)try{const t=q();await t.initialize(),a=await t.generateNormalMap(e,this.config.aiQualityPreset,(e,t)=>{n?.("normal",t,`Normal map: ${e}`)})}catch(l){console.warn("AI normal generation failed, falling back to traditional:",l),a=r.normal}else a=r.normal;n?.("normal",1,"Normal map complete"),n?.("roughness",0,"Generating roughness map...");const s=r.roughness;n?.("roughness",1,"Roughness map complete"),n?.("metallic",0,"Generating metallic map...");const o=r.metallic;n?.("metallic",1,"Metallic map complete"),n?.("height",0,"Generating height map...");let i=null;return"integrated"===this.config.heightMethod?i=this.integrateHeightFromNormal(a):"sobel"===this.config.heightMethod&&(i=this.generateSobelHeight(e)),n?.("height",1,"Height map complete"),{basecolor:r.basecolor,normal:a,roughness:s,metallic:o,height:i}}integrateHeightFromNormal(e){const{width:t,height:n,data:r}=e,a=new Uint8ClampedArray(t*n*4),s=new Float32Array(t*n),o=new Float32Array(t*n);for(let h=0;h<t*n;h++){const e=4*h,t=r[e]/255*2-1,n=r[e+1]/255*2-1,a=r[e+2]/255*2-1,i=0!==a?1/a:0;s[h]=-t*i,o[h]=-n*i}const i=new Float32Array(t*n);for(let h=0;h<50;h++)for(let e=1;e<n-1;e++)for(let n=1;n<t-1;n++){const r=e*t+n,a=(i[r-1]+i[r+1]+i[r-t]+i[r+t])/4,l=(s[r-1]-s[r+1]+o[r-t]-o[r+t])/4;i[r]=a+l}let l=1/0,c=-1/0;for(let h=0;h<i.length;h++)l=Math.min(l,i[h]),c=Math.max(c,i[h]);const d=c-l||1;for(let h=0;h<t*n;h++){const e=(i[h]-l)/d,t=Math.round(255*e),n=4*h;a[n]=t,a[n+1]=t,a[n+2]=t,a[n+3]=255}return new ImageData(a,t,n)}generateSobelHeight(e){const{width:t,height:n,data:r}=e,a=new Uint8ClampedArray(t*n*4),s=new Float32Array(t*n);for(let d=0;d<t*n;d++){const e=4*d;s[d]=(.299*r[e]+.587*r[e+1]+.114*r[e+2])/255}const o=new Float32Array(t*n);for(let d=0;d<n;d++){let e=0;for(let n=1;n<t;n++){const r=d*t+n;e+=s[r]-s[r-1],o[r]=e}}let i=1/0,l=-1/0;for(let d=0;d<o.length;d++)i=Math.min(i,o[d]),l=Math.max(l,o[d]);const c=l-i||1;for(let d=0;d<t*n;d++){const e=1-(o[d]-i)/c,t=Math.round(255*e),n=4*d;a[n]=t,a[n+1]=t,a[n+2]=t,a[n+3]=255}return new ImageData(a,t,n)}dispose(){this.traditionalGen&&(this.traditionalGen.dispose(),this.traditionalGen=null)}}const K=4096;async function V(e){if(!e.type.match(/^image\/(png|jpeg|webp)$/))throw new Error("Unsupported file type. Use PNG, JPEG, or WebP.");const t=URL.createObjectURL(e);try{return await async function(e){const t=await function(e){return new Promise((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=()=>n(new Error("Failed to load image")),r.src=e})}(e);return function(e){let{width:t,height:n}=e;if(t>K||n>K){const e=Math.min(K/t,K/n);t=Math.floor(t*e),n=Math.floor(n*e),console.warn(`Image resized to ${t}x${n} (max 4096px)`)}const r=document.createElement("canvas");r.width=t,r.height=n;const a=r.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("Failed to get 2D context");return a.drawImage(e,0,0,t,n),a.getImageData(0,0,t,n)}(t)}(t)}finally{URL.revokeObjectURL(t)}}function Y(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context");return n.putImageData(e,0,0),new Promise((e,n)=>{t.toBlob(t=>{t?e(t):n(new Error("Failed to create blob"))},"image/png",1)})}async function J(e,t){!function(e,t){const n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=t,r.click(),URL.revokeObjectURL(n)}(await Y(e),t)}function Q(e,t){t.width=e.width,t.height=e.height;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context");n.putImageData(e,0,0)}const Z=[{name:"preprocessing",weight:.1},{name:"inference",weight:.7},{name:"postprocessing",weight:.1},{name:"complete",weight:.1}];class ee{container;bar;label;detail;startTime=0;stages;isVisible=!1;constructor(e,t=Z){this.stages=t,this.container=document.createElement("div"),this.container.className="progress-container",this.container.style.cssText="\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      padding: 16px;\n      background: #2a2a4a;\n      border-radius: 8px;\n      margin: 16px 0;\n    ",this.label=document.createElement("div"),this.label.className="progress-label",this.label.style.cssText="\n      display: flex;\n      justify-content: space-between;\n      font-size: 14px;\n      color: #ccc;\n    ",this.label.innerHTML='<span class="stage">Initializing...</span><span class="percent">0%</span>';const n=document.createElement("div");n.className="progress-track",n.style.cssText="\n      height: 8px;\n      background: #3a3a5a;\n      border-radius: 4px;\n      overflow: hidden;\n    ",this.bar=document.createElement("div"),this.bar.className="progress-bar",this.bar.style.cssText="\n      height: 100%;\n      width: 0%;\n      background: linear-gradient(90deg, #5a5aff, #8a8aff);\n      border-radius: 4px;\n      transition: width 0.2s ease-out;\n    ",n.appendChild(this.bar),this.detail=document.createElement("div"),this.detail.className="progress-detail",this.detail.style.cssText="\n      font-size: 12px;\n      color: #888;\n      text-align: center;\n    ",this.container.appendChild(this.label),this.container.appendChild(n),this.container.appendChild(this.detail),e.appendChild(this.container)}show(){this.startTime=performance.now(),this.container.style.display="flex",this.isVisible=!0,this.update("preprocessing",0)}hide(){this.container.style.display="none",this.isVisible=!1}update(e,t){if(!this.isVisible)return;let n=0,r=!1;for(const c of this.stages){if(c.name===e){n+=c.weight*t,r=!0;break}n+=c.weight}r||(n=t);const a=Math.round(100*n);this.bar.style.width=`${a}%`;const s=this.formatStageName(e),o=`${a}%`;this.label.innerHTML=`<span class="stage">${s}</span><span class="percent">${o}</span>`;const i=performance.now()-this.startTime,l=this.formatTime(i);if(n>.1&&n<1){const e=i/n-i,t=this.formatTime(e);this.detail.textContent=`Elapsed: ${l} | Remaining: ~${t}`}else this.detail.textContent=`Elapsed: ${l}`}complete(){const e=performance.now()-this.startTime,t=this.formatTime(e);this.bar.style.width="100%",this.label.innerHTML='<span class="stage">Complete</span><span class="percent">100%</span>',this.detail.textContent=`Total time: ${t}`,this.bar.style.background="linear-gradient(90deg, #4a8a4a, #6aca6a)",setTimeout(()=>this.hide(),2e3)}error(e){this.bar.style.background="#aa4a4a",this.label.innerHTML='<span class="stage">Error</span><span class="percent">--</span>',this.detail.textContent=e,this.detail.style.color="#f88"}reset(){this.bar.style.width="0%",this.bar.style.background="linear-gradient(90deg, #5a5aff, #8a8aff)",this.detail.style.color="#888",this.hide()}destroy(){this.container.remove()}formatStageName(e){switch(e){case"preprocessing":return"Preprocessing image...";case"inference":return"Running AI inference...";case"postprocessing":return"Post-processing output...";case"complete":return"Complete";default:return e.charAt(0).toUpperCase()+e.slice(1)+"..."}}formatTime(e){if(e<1e3)return`${Math.round(e)}ms`;const t=e/1e3;if(t<60)return`${t.toFixed(1)}s`;return`${Math.floor(t/60)}m ${Math.round(t%60)}s`}}class te{container;config;aiAvailable;onChangeCallback=null;constructor(e,t,n=!1){this.container=e,this.config={...t},this.aiAvailable=n,this.render()}onChange(e){this.onChangeCallback=e}setAIAvailable(e){this.aiAvailable=e,this.render()}getConfig(){return{...this.config}}setConfig(e){this.config={...this.config,...e},this.render()}render(){this.container.innerHTML="",this.container.className="channel-controls",this.container.style.cssText="\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n      gap: 15px;\n      padding: 15px;\n      background: #2a3a4a;\n      border-radius: 8px;\n      margin-bottom: 20px;\n    ",this.container.appendChild(this.createInfoDisplay("Albedo","Shadow/Highlight Reduction")),this.container.appendChild(this.createMethodSelect("Normal Map","normalMethod",this.config.normalMethod,this.aiAvailable)),this.container.appendChild(this.createInfoDisplay("Roughness","Variance-based")),this.container.appendChild(this.createInfoDisplay("Metallic","Color Heuristics")),this.container.appendChild(this.createHeightSelect()),this.aiAvailable&&this.container.appendChild(this.createQualitySelect())}createInfoDisplay(e,t){const n=document.createElement("div");n.className="control-group",n.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    ";const r=document.createElement("label");r.textContent=e,r.style.cssText="font-size: 12px; color: #aaa;";const a=document.createElement("div");return a.style.cssText="\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: #8a8aaa;\n      border-radius: 4px;\n      font-size: 14px;\n    ",a.textContent=t,n.appendChild(r),n.appendChild(a),n}createMethodSelect(e,t,n,r){const a=document.createElement("div");a.className="control-group",a.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    ";const s=document.createElement("label");s.textContent=e,s.style.cssText="font-size: 12px; color: #aaa;";const o=document.createElement("select");o.style.cssText="\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    ";const i=document.createElement("option");i.value="traditional",i.textContent="Traditional","traditional"===n&&(i.selected=!0),o.appendChild(i);const l=document.createElement("option");return l.value="ai",l.textContent=r?"AI Enhanced":"AI (unavailable)",l.disabled=!r,"ai"===n&&(l.selected=!0),o.appendChild(l),o.addEventListener("change",()=>{this.config.normalMethod=o.value,this.notifyChange({normalMethod:o.value})}),a.appendChild(s),a.appendChild(o),a}createHeightSelect(){const e=document.createElement("div");e.className="control-group",e.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    ";const t=document.createElement("label");t.textContent="Height Map",t.style.cssText="font-size: 12px; color: #aaa;";const n=document.createElement("select");n.style.cssText="\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    ";const r=[{value:"none",label:"None"},{value:"integrated",label:"From Normal (Integrated)"},{value:"sobel",label:"From Color (Sobel)"}];for(const a of r){const e=document.createElement("option");e.value=a.value,e.textContent=a.label,this.config.heightMethod===a.value&&(e.selected=!0),n.appendChild(e)}return n.addEventListener("change",()=>{this.config.heightMethod=n.value,this.notifyChange({heightMethod:n.value})}),e.appendChild(t),e.appendChild(n),e}createQualitySelect(){const e=document.createElement("div");e.className="control-group",e.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    ";const t=document.createElement("label");t.textContent="AI Quality",t.style.cssText="font-size: 12px; color: #aaa;";const n=document.createElement("select");n.style.cssText="\n      padding: 8px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n    ";for(const[r,a]of Object.entries(z)){const e=document.createElement("option");e.value=r,e.textContent=`${a.name} - ${a.expectedTime}`,this.config.aiQualityPreset.name===a.name&&(e.selected=!0),n.appendChild(e)}return n.addEventListener("change",()=>{const e=n.value;this.config.aiQualityPreset=z[e],this.notifyChange({aiQualityPreset:z[e]})}),e.appendChild(t),e.appendChild(n),e}notifyChange(e){this.onChangeCallback&&this.onChangeCallback({config:e})}}class ne{container;config;onChangeCallback=null;constructor(e,t){this.container=e,this.config={...t},this.render()}onChange(e){this.onChangeCallback=e}getConfig(){return{...this.config}}render(){this.container.innerHTML="",this.container.className="preview-controls",this.container.style.cssText="\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n      gap: 10px;\n      padding: 10px;\n      background: #2a2a4a;\n      border-radius: 8px;\n      margin-bottom: 10px;\n    ",this.container.appendChild(this.createGeometrySelect()),this.container.appendChild(this.createAutoRotateToggle()),this.container.appendChild(this.createSlider("Tiling X","tilingX",1,8,1,this.config.tiling[0])),this.container.appendChild(this.createSlider("Tiling Y","tilingY",1,8,1,this.config.tiling[1])),this.container.appendChild(this.createSlider("Light","lightIntensity",0,5,.1,this.config.lightIntensity)),this.container.appendChild(this.createSlider("Ambient","ambientIntensity",0,2,.1,this.config.ambientIntensity))}createGeometrySelect(){const e=document.createElement("div");e.style.cssText="display: flex; flex-direction: column; gap: 3px;";const t=document.createElement("label");t.textContent="Shape",t.style.cssText="font-size: 11px; color: #888;";const n=document.createElement("select");n.style.cssText="\n      padding: 6px;\n      background: #3a3a5a;\n      border: none;\n      color: white;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 12px;\n    ";const r=[{value:"sphere",label:"Sphere"},{value:"cube",label:"Cube"},{value:"plane",label:"Plane"}];for(const a of r){const e=document.createElement("option");e.value=a.value,e.textContent=a.label,this.config.geometry===a.value&&(e.selected=!0),n.appendChild(e)}return n.addEventListener("change",()=>{this.config.geometry=n.value,this.notifyChange({geometry:this.config.geometry})}),e.appendChild(t),e.appendChild(n),e}createAutoRotateToggle(){const e=document.createElement("div");e.style.cssText="display: flex; flex-direction: column; gap: 3px;";const t=document.createElement("label");t.textContent="Auto-Rotate",t.style.cssText="font-size: 11px; color: #888;";const n=document.createElement("input");return n.type="checkbox",n.checked=this.config.autoRotate,n.style.cssText="width: 18px; height: 18px; cursor: pointer;",n.addEventListener("change",()=>{this.config.autoRotate=n.checked,this.notifyChange({autoRotate:this.config.autoRotate})}),e.appendChild(t),e.appendChild(n),e}createSlider(e,t,n,r,a,s){const o=document.createElement("div");o.style.cssText="display: flex; flex-direction: column; gap: 3px;";const i=document.createElement("label");i.textContent=`${e}: ${s.toFixed(1)}`,i.style.cssText="font-size: 11px; color: #888;";const l=document.createElement("input");return l.type="range",l.min=String(n),l.max=String(r),l.step=String(a),l.value=String(s),l.style.cssText="width: 100%;",l.addEventListener("input",()=>{const n=parseFloat(l.value);i.textContent=`${e}: ${n.toFixed(1)}`,"tilingX"===t?(this.config.tiling=[n,this.config.tiling[1]],this.notifyChange({tiling:this.config.tiling})):"tilingY"===t?(this.config.tiling=[this.config.tiling[0],n],this.notifyChange({tiling:this.config.tiling})):"lightIntensity"===t?(this.config.lightIntensity=n,this.notifyChange({lightIntensity:n})):"ambientIntensity"===t&&(this.config.ambientIntensity=n,this.notifyChange({ambientIntensity:n}))}),o.appendChild(i),o.appendChild(l),o}notifyChange(e){this.onChangeCallback&&this.onChangeCallback({config:e})}}var re=(e=>(e.UNAUTHORIZED="UNAUTHORIZED",e.FORBIDDEN="FORBIDDEN",e.NOT_FOUND="NOT_FOUND",e.RATE_LIMITED="RATE_LIMITED",e.UPLOAD_FAILED="UPLOAD_FAILED",e.CONVERSION_FAILED="CONVERSION_FAILED",e.MATERIAL_CREATE_FAILED="MATERIAL_CREATE_FAILED",e.LIVELINK_ERROR="LIVELINK_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.UNKNOWN="UNKNOWN",e))(re||{});class ae extends Error{constructor(e,t,n,r=!1,a){super(e),this.code=t,this.statusCode=n,this.recoverable=r,this.suggestion=a,this.name="ThreeDverseError"}}const se="pbr_gen_3dverse_auth";class oe{config;userApiKey=null;user=null;state="unauthenticated";stateCallbacks=new Set;constructor(e={}){this.config={apiUrl:e.apiUrl||"https://api.3dverse.com/app/v1",clientId:e.clientId,publicApiKey:e.publicApiKey,userApiKey:e.userApiKey},this.restoreFromStorage(),e.userApiKey&&this.setApiKey(e.userApiKey)}getState(){return this.state}getUser(){return this.user}isAuthenticated(){return"authenticated"===this.state&&null!==this.userApiKey}onStateChange(e){return this.stateCallbacks.add(e),e(this.state,this.user),()=>this.stateCallbacks.delete(e)}setApiKey(e){this.userApiKey=e,this.user={userId:"api-key-user",displayName:"API Key User",expiresAt:Date.now()+31536e6},this.setState("authenticated"),this.persistToStorage()}async validateApiKey(){if(!this.userApiKey)return!1;try{this.setState("authenticating");const e=await fetch(`${this.config.apiUrl}/folders`,{method:"GET",headers:this.getAuthHeaders()});if(e.ok)return this.setState("authenticated"),!0;throw 401===e.status?(this.logout(),new ae("Invalid API key",re.UNAUTHORIZED,401,!0,"Please check your API key and try again")):new ae(`API validation failed: ${e.status}`,re.UNKNOWN,e.status,!0)}catch(e){if(e instanceof ae)throw e;throw this.setState("error"),new ae("Network error during validation",re.NETWORK_ERROR,void 0,!0,"Check your internet connection")}}async loginWithApiKey(e){this.setApiKey(e),await this.validateApiKey()}logout(){this.userApiKey=null,this.user=null,this.setState("unauthenticated"),this.clearStorage()}getAuthHeaders(){if(!this.userApiKey)throw new ae("Not authenticated",re.UNAUTHORIZED,401,!0,"Please login first");return{api_key:this.userApiKey}}getApiUrl(){return this.config.apiUrl}async request(e,t={}){if(!this.isAuthenticated())throw new ae("Not authenticated",re.UNAUTHORIZED,401,!0,"Please login first");const n=`${this.config.apiUrl}${e}`,r={...this.getAuthHeaders(),...t.headers},a=await fetch(n,{...t,headers:r});if(a.ok||await this.handleApiError(a),204!==a.status)return a.json()}async handleApiError(e){let t=`API error: ${e.status}`,n=re.UNKNOWN;try{t=(await e.json()).message||t}catch{}switch(e.status){case 401:n=re.UNAUTHORIZED,this.logout();break;case 403:n=re.FORBIDDEN;break;case 404:n=re.NOT_FOUND;break;case 429:n=re.RATE_LIMITED}throw new ae(t,n,e.status,429===e.status||e.status>=500)}setState(e){this.state=e;for(const t of this.stateCallbacks)t(this.state,this.user)}persistToStorage(){if(this.userApiKey)try{const e={apiKey:this.userApiKey,user:this.user};localStorage.setItem(se,JSON.stringify(e))}catch{}}restoreFromStorage(){try{const e=localStorage.getItem(se);if(e){const t=JSON.parse(e);t.apiKey&&t.user&&(this.userApiKey=t.apiKey,this.user=t.user,this.state="authenticated")}}catch{}}clearStorage(){try{localStorage.removeItem(se)}catch{}}}let ie=null;function le(e){return ie||(ie=new oe(e)),ie}class ce{auth;cachedFolders=new Map;constructor(e){this.auth=e||le()}async listRootFolders(){return this.listFolders()}async listFolders(e=!1){const t="all";if(!e&&this.cachedFolders.has(t))return this.cachedFolders.get(t);try{const e=(await this.auth.request("/folders")||[]).map(e=>({uuid:e.folder_id,name:e.name,parentUuid:null,createdAt:e.created_at,updatedAt:e.updated_at||e.created_at}));return e.sort((e,t)=>e.name.localeCompare(t.name)),this.cachedFolders.set(t,e),e}catch(n){if(n instanceof ae)throw n;throw new ae("Failed to list folders",re.NETWORK_ERROR,void 0,!0)}}async getFolder(e){try{const t=await this.auth.request(`/folders/${e}`);return{uuid:t.folder_id,name:t.name,parentUuid:null,createdAt:t.created_at,updatedAt:t.updated_at||t.created_at}}catch(t){if(t instanceof ae)throw t;throw new ae("Failed to get folder",re.NETWORK_ERROR,void 0,!0)}}async createFolder(e,t){try{const n=t?`/folders/${t}/folders`:"/folders",r=await this.auth.request(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})}),a={uuid:r.folder_id,name:r.name,parentUuid:t||null,createdAt:r.created_at,updatedAt:r.updated_at||r.created_at};return this.cachedFolders.clear(),a}catch(n){if(n instanceof ae)throw n;throw new ae("Failed to create folder",re.NETWORK_ERROR,void 0,!0)}}clearCache(){this.cachedFolders.clear()}async searchFolders(e){const t=await this.listFolders(),n=e.toLowerCase();return t.filter(e=>e.name.toLowerCase().includes(n))}}let de=null;function he(){return de||(de=new ce),de}const ue=2e3;class pe{auth;constructor(e){this.auth=e||le()}async uploadPBRMaps(e,t,n,r){const a=[{key:"basecolor",imageData:e.basecolor,suffix:"_basecolor"},{key:"normal",imageData:e.normal,suffix:"_normal"},{key:"roughness",imageData:e.roughness,suffix:"_roughness"},{key:"metallic",imageData:e.metallic,suffix:"_metallic"}];e.height&&a.push({key:"height",imageData:e.height,suffix:"_height"});const s=[];for(const d of a){const e=`${n}${d.suffix}.png`;r?.({channel:d.key,progress:0,status:`Uploading ${d.key}...`});try{const n=await this.uploadTexture(d.imageData,t,e);s.push({key:d.key,filename:e,jobId:n.jobId}),r?.({channel:d.key,progress:.3,status:`${d.key} uploaded`,jobId:n.jobId})}catch(c){const e=c instanceof Error?c.message:"Upload failed";throw new ae(`Failed to upload ${d.key}: ${e}`,re.UPLOAD_FAILED,void 0,!0)}}for(const d of s)r?.({channel:d.key,progress:.5,status:"Converting...",jobId:d.jobId});const o={},i=[...s];let l=0;for(;i.length>0&&l<60;){await this.sleep(ue),l++;for(let e=i.length-1;e>=0;e--){const n=i[e];try{const a=await this.findAssetInFolder(t,n.filename);a&&(o[n.key]=a,i.splice(e,1),r?.({channel:n.key,progress:1,status:"Ready",jobId:n.jobId}))}catch{}}}if(i.length>0)throw new ae(`Conversion timed out for: ${i.map(e=>e.key).join(", ")}`,re.CONVERSION_FAILED,void 0,!0);return o}async uploadTexture(e,t,n){const r=await Y(e),a=new FormData;a.append("file",r,n);const s=this.auth.getApiUrl(),o=await fetch(`${s}/folders/${t}/source-files`,{method:"POST",headers:this.auth.getAuthHeaders(),body:a});if(!o.ok){const e=await o.text();throw new ae(`Upload failed: ${o.status} - ${e}`,re.UPLOAD_FAILED,o.status)}return{jobId:(await o.json()).upload_task_id,filename:n,status:"pending",progress:0}}async getUploadStatus(e){const t=this.auth.getApiUrl(),n=await fetch(`${t}/upload-tasks/${e}`,{method:"GET",headers:this.auth.getAuthHeaders()});if(404===n.status)return null;if(!n.ok)throw new ae(`Failed to get upload status: ${n.status}`,re.UPLOAD_FAILED,n.status);const r=await n.json();let a,s="pending",o=0;switch(r.status){case"pending":s="pending",o=.25;break;case"processing":s="processing",o=.5;break;case"uploaded":s="complete",o=1,a=r.generated_assets?.find(e=>"texture"===e.type)?.asset_id}return{jobId:e,filename:"",status:s,progress:o,assetUuid:a,errorMessage:r.error}}async waitForConversion(e,t,n){let r=0,a=0;for(await this.sleep(500);r<60;){const s=await this.getUploadStatus(e);if(null!==s){if("complete"===s.status&&s.assetUuid)return s.assetUuid;if("failed"===s.status)throw new ae(`Conversion failed: ${s.errorMessage||"Unknown error"}`,re.CONVERSION_FAILED,void 0,!1);await this.sleep(ue),r++}else{if(a++,a>=5){if(t&&n){const e=await this.findAssetInFolder(t,n);if(e)return e}throw new ae("Upload task not found - may have completed but asset not located",re.UPLOAD_FAILED,404,!0,"Try uploading again")}await this.sleep(ue),r++}}throw new ae("Conversion timed out",re.CONVERSION_FAILED,void 0,!0,"Try uploading a smaller texture")}async findAssetInFolder(e,t){try{const n=this.auth.getApiUrl(),r=t.replace(/\.[^.]+$/,""),a=await fetch(`${n}/folders/${e}/source-files`,{method:"GET",headers:this.auth.getAuthHeaders()});if(a.ok){const e=await a.json(),t=(Array.isArray(e)?e:e.source_files||[]).find(e=>e.name?.startsWith(r));if(t)return t.main_asset?.asset_id?t.main_asset.asset_id:null}const s=await fetch(`${n}/folders/${e}/assets`,{method:"GET",headers:this.auth.getAuthHeaders()});if(!s.ok)return null;const o=await s.json(),i=(o.textures||[]).find(e=>e.name.startsWith(r));return i?.asset_id||null}catch{return null}}sleep(e){return new Promise(t=>setTimeout(t,e))}}let me=null;function ge(){return me||(me=new pe),me}class fe{auth;constructor(e){this.auth=e||le()}async createPBRMaterial(e){const t=e.shaderRef||"f2a549e5-4f72-4cef-a5ab-48873c209e0c",n=this.buildMaterialDataJson(e.textures,e.properties),r=this.buildConstantsJson(e.textures),a={name:e.name,shaderRef:t,dataJson:n,isDoubleSided:!1};r&&(a.constantsJson=r);const s=this.auth.getApiUrl(),o=await fetch(`${s}/folders/${e.folderUuid}/assets/materials`,{method:"POST",headers:{...this.auth.getAuthHeaders(),"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok){const e=await o.text();throw new ae(`Failed to create material: ${o.status} - ${e}`,re.MATERIAL_CREATE_FAILED,o.status)}const i=await o.json();return{uuid:i.asset_id,name:e.name,type:"material",folderUuid:e.folderUuid,createdAt:i.created_at||(new Date).toISOString(),updatedAt:i.updated_at||(new Date).toISOString(),metadata:{shaderRef:t,dataJson:n,constantsJson:r||void 0}}}buildMaterialDataJson(e,t){const n={albedoTexture:e.basecolor,normalTexture:e.normal,roughnessTexture:e.roughness,metallicTexture:e.metallic,albedo:[1,1,1,1],roughness:t?.roughnessFactor??1,metallic:t?.metallicFactor??1,normal:t?.normalScale??1,emissive:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1};return e.height&&(n.heightMapTexture=e.height),t?.tiling&&(n.textureTransform={scale:t.tiling,offset:[0,0],rotation:0}),n}buildConstantsJson(e){const t={};return e.height&&(t.MATERIAL_PARALLAX=!0),Object.keys(t).length>0?t:null}async updateMaterial(e,t){const n={};t.name&&(n.name=t.name),(t.textures||t.properties)&&(n.data_json=this.buildMaterialDataJson(t.textures,t.properties));const r=this.auth.getApiUrl(),a=await fetch(`${r}/assets/${e}`,{method:"PATCH",headers:{...this.auth.getAuthHeaders(),"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok){const e=await a.text();throw new ae(`Failed to update material: ${a.status} - ${e}`,re.MATERIAL_CREATE_FAILED,a.status)}}async getMaterial(e){const t=this.auth.getApiUrl(),n=await fetch(`${t}/assets/${e}`,{method:"GET",headers:this.auth.getAuthHeaders()});if(!n.ok)throw new ae(`Failed to get material: ${n.status}`,re.NOT_FOUND,n.status);const r=await n.json();return{uuid:r.asset_id,name:r.name,type:"material",folderUuid:r.folder_id,createdAt:r.created_at,updatedAt:r.updated_at,metadata:{shaderRef:r.shader_ref,dataJson:r.data_json}}}async deleteMaterial(e){const t=this.auth.getApiUrl(),n=await fetch(`${t}/assets/${e}`,{method:"DELETE",headers:this.auth.getAuthHeaders()});if(!n.ok&&404!==n.status)throw new ae(`Failed to delete material: ${n.status}`,re.UNKNOWN,n.status)}}let be=null;function ye(){return be||(be=new fe),be}async function xe(e,t,n,r){if(!le().isAuthenticated())throw new Error("Not authenticated with 3dverse");const a=ge(),s=await a.uploadPBRMaps(e,t,n,r),o=ye();return{textures:s,material:await o.createPBRMaterial({name:n,folderUuid:t,textures:s})}}const ve=Object.freeze(Object.defineProperty({__proto__:null,FolderBrowser:ce,MaterialCreator:fe,TextureUploader:pe,ThreeDverseAuth:oe,ThreeDverseError:ae,ThreeDverseErrorCode:re,getAuth:le,getFolderBrowser:he,getMaterialCreator:ye,getTextureUploader:ge,uploadAndCreateMaterial:xe},Symbol.toStringTag,{value:"Module"}));class Ee{container;_config;callbacks=new Set;unsubscribeAuth=null;panelEl=null;inputEl=null;buttonEl=null;statusEl=null;errorEl=null;constructor(e,t={}){this.container=e,this._config={showRememberMe:!0,autoValidate:!1,...t},this.render(),this.subscribeToAuth()}getConfig(){return{...this._config}}onLogin(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}show(){this.panelEl&&this.panelEl.classList.remove("hidden")}hide(){this.panelEl&&this.panelEl.classList.add("hidden")}refresh(){this.render(),this.subscribeToAuth()}dispose(){this.unsubscribeAuth&&this.unsubscribeAuth(),this.container.innerHTML="",this.callbacks.clear()}render(){this.panelEl=document.createElement("div"),this.panelEl.className="login-panel",this.panelEl.innerHTML='\n      <div class="login-panel__header">\n        <h3>3dverse Connection</h3>\n      </div>\n      <div class="login-panel__content">\n        <div class="login-panel__status"></div>\n        <div class="login-panel__form">\n          <label for="apiKeyInput">API Key</label>\n          <input\n            type="password"\n            id="apiKeyInput"\n            placeholder="Enter your 3dverse API key"\n            autocomplete="off"\n          />\n          <button type="button" class="login-btn">Connect</button>\n        </div>\n        <div class="login-panel__error"></div>\n        <div class="login-panel__help">\n          <a href="https://console.3dverse.com/settings/api-keys" target="_blank" rel="noopener">\n            Get your API key from 3dverse Console\n          </a>\n        </div>\n      </div>\n    ',this.applyStyles(),this.inputEl=this.panelEl.querySelector("#apiKeyInput"),this.buttonEl=this.panelEl.querySelector(".login-btn"),this.statusEl=this.panelEl.querySelector(".login-panel__status"),this.errorEl=this.panelEl.querySelector(".login-panel__error"),this.buttonEl?.addEventListener("click",()=>this.handleLogin()),this.inputEl?.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()}),this.container.appendChild(this.panelEl)}applyStyles(){if(!document.getElementById("login-panel-styles")){const e=document.createElement("style");e.id="login-panel-styles",e.textContent="\n        .login-panel {\n          background: #2a2a4a;\n          border-radius: 8px;\n          padding: 15px;\n          margin-bottom: 20px;\n        }\n        .login-panel.hidden {\n          display: none;\n        }\n        .login-panel__header h3 {\n          margin: 0 0 10px;\n          font-size: 14px;\n          color: #fff;\n        }\n        .login-panel__status {\n          font-size: 12px;\n          margin-bottom: 10px;\n        }\n        .login-panel__status.connected {\n          color: #8f8;\n        }\n        .login-panel__status.disconnected {\n          color: #888;\n        }\n        .login-panel__status.connecting {\n          color: #ff8;\n        }\n        .login-panel__form {\n          display: flex;\n          gap: 10px;\n          align-items: flex-end;\n        }\n        .login-panel__form.hidden {\n          display: none;\n        }\n        .login-panel__form label {\n          font-size: 12px;\n          color: #aaa;\n          display: block;\n          margin-bottom: 4px;\n        }\n        .login-panel__form input {\n          flex: 1;\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #1a1a2e;\n          color: #fff;\n          font-size: 14px;\n        }\n        .login-panel__form input:focus {\n          outline: none;\n          border-color: #7878ff;\n        }\n        .login-btn {\n          padding: 8px 16px;\n          background: #5a5aaa;\n          border: none;\n          border-radius: 4px;\n          color: white;\n          font-size: 14px;\n          cursor: pointer;\n          white-space: nowrap;\n        }\n        .login-btn:hover {\n          background: #6a6acc;\n        }\n        .login-btn:disabled {\n          background: #3a3a5a;\n          cursor: not-allowed;\n        }\n        .logout-btn {\n          padding: 6px 12px;\n          background: #5a3a3a;\n          border: none;\n          border-radius: 4px;\n          color: white;\n          font-size: 12px;\n          cursor: pointer;\n          margin-left: 10px;\n        }\n        .logout-btn:hover {\n          background: #6a4a4a;\n        }\n        .login-panel__error {\n          color: #f88;\n          font-size: 12px;\n          margin-top: 10px;\n        }\n        .login-panel__error:empty {\n          display: none;\n        }\n        .login-panel__help {\n          margin-top: 10px;\n          font-size: 11px;\n        }\n        .login-panel__help a {\n          color: #7878ff;\n          text-decoration: none;\n        }\n        .login-panel__help a:hover {\n          text-decoration: underline;\n        }\n      ",document.head.appendChild(e)}}subscribeToAuth(){const e=le();this.unsubscribeAuth=e.onStateChange((e,t)=>{this.updateUI(e,t)})}updateUI(e,t){if(!(this.statusEl&&this.inputEl&&this.buttonEl&&this.panelEl))return;const n=this.panelEl.querySelector(".login-panel__form");switch(e){case"authenticated":this.statusEl.className="login-panel__status connected",this.statusEl.innerHTML=`\n          Connected as ${t?.displayName||"API Key User"}\n          <button class="logout-btn">Disconnect</button>\n        `,n?.classList.add("hidden");const e=this.statusEl.querySelector(".logout-btn");e?.addEventListener("click",()=>this.handleLogout());break;case"authenticating":this.statusEl.className="login-panel__status connecting",this.statusEl.textContent="Connecting...",this.buttonEl.disabled=!0,this.inputEl.disabled=!0;break;case"error":this.statusEl.className="login-panel__status disconnected",this.statusEl.textContent="Connection failed",this.buttonEl.disabled=!1,this.inputEl.disabled=!1,n?.classList.remove("hidden");break;default:this.statusEl.className="login-panel__status disconnected",this.statusEl.textContent="Not connected",this.buttonEl.disabled=!1,this.inputEl.disabled=!1,n?.classList.remove("hidden")}}async handleLogin(){if(!this.inputEl||!this.errorEl)return;const e=this.inputEl.value.trim();if(e){this.errorEl.textContent="";try{const t=le();await t.loginWithApiKey(e),this.inputEl.value="",this.notifyCallbacks({success:!0,user:t.getUser()||void 0})}catch(t){const e=t instanceof ae?t.message:"Connection failed";this.errorEl.textContent=e,this.notifyCallbacks({success:!1,error:e})}}else this.errorEl.textContent="Please enter an API key"}handleLogout(){le().logout(),this.notifyCallbacks({success:!1})}notifyCallbacks(e){for(const t of this.callbacks)t(e)}}class we{container;config;callbacks=new Set;selectedFolder=null;folders=[];isLoading=!1;pickerEl=null;selectEl=null;createBtnEl=null;refreshBtnEl=null;statusEl=null;constructor(e,t={}){this.container=e,this.config={allowCreate:!0,placeholder:"Select a folder",...t},this.render()}onSelect(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}getSelectedFolder(){return this.selectedFolder}async refresh(){await this.loadFolders(!0)}setEnabled(e){this.selectEl&&(this.selectEl.disabled=!e),this.createBtnEl&&(this.createBtnEl.disabled=!e),this.refreshBtnEl&&(this.refreshBtnEl.disabled=!e)}show(){this.pickerEl&&this.pickerEl.classList.remove("hidden")}hide(){this.pickerEl&&this.pickerEl.classList.add("hidden")}dispose(){this.container.innerHTML="",this.callbacks.clear()}render(){this.pickerEl=document.createElement("div"),this.pickerEl.className="folder-picker",this.pickerEl.innerHTML=`\n      <div class="folder-picker__header">\n        <label>Destination Folder</label>\n      </div>\n      <div class="folder-picker__content">\n        <select class="folder-select">\n          <option value="">Loading folders...</option>\n        </select>\n        <button type="button" class="folder-refresh-btn" title="Refresh folders">\n          <span class="icon">&#8635;</span>\n        </button>\n        ${this.config.allowCreate?'\n          <button type="button" class="folder-create-btn" title="Create new folder">\n            <span class="icon">+</span>\n          </button>\n        ':""}\n      </div>\n      <div class="folder-picker__status"></div>\n    `,this.applyStyles(),this.selectEl=this.pickerEl.querySelector(".folder-select"),this.refreshBtnEl=this.pickerEl.querySelector(".folder-refresh-btn"),this.createBtnEl=this.pickerEl.querySelector(".folder-create-btn"),this.statusEl=this.pickerEl.querySelector(".folder-picker__status"),this.selectEl?.addEventListener("change",()=>this.handleSelect()),this.refreshBtnEl?.addEventListener("click",()=>this.loadFolders(!0)),this.createBtnEl?.addEventListener("click",()=>this.handleCreate()),this.container.appendChild(this.pickerEl),this.loadFolders()}applyStyles(){if(!document.getElementById("folder-picker-styles")){const e=document.createElement("style");e.id="folder-picker-styles",e.textContent="\n        .folder-picker {\n          margin-bottom: 15px;\n        }\n        .folder-picker.hidden {\n          display: none;\n        }\n        .folder-picker__header label {\n          font-size: 12px;\n          color: #aaa;\n          display: block;\n          margin-bottom: 4px;\n        }\n        .folder-picker__content {\n          display: flex;\n          gap: 8px;\n          align-items: center;\n        }\n        .folder-select {\n          flex: 1;\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #1a1a2e;\n          color: #fff;\n          font-size: 14px;\n          cursor: pointer;\n        }\n        .folder-select:focus {\n          outline: none;\n          border-color: #7878ff;\n        }\n        .folder-select:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .folder-refresh-btn,\n        .folder-create-btn {\n          padding: 8px 12px;\n          border: 1px solid #4a4a6a;\n          border-radius: 4px;\n          background: #2a2a4a;\n          color: #fff;\n          font-size: 16px;\n          cursor: pointer;\n        }\n        .folder-refresh-btn:hover,\n        .folder-create-btn:hover {\n          background: #3a3a5a;\n        }\n        .folder-refresh-btn:disabled,\n        .folder-create-btn:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .folder-refresh-btn.loading .icon {\n          animation: spin 1s linear infinite;\n        }\n        @keyframes spin {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        .folder-picker__status {\n          font-size: 11px;\n          color: #888;\n          margin-top: 4px;\n        }\n        .folder-picker__status:empty {\n          display: none;\n        }\n        .folder-picker__status.error {\n          color: #f88;\n        }\n      ",document.head.appendChild(e)}}async loadFolders(e=!1){if(!this.isLoading){this.isLoading=!0,this.refreshBtnEl&&this.refreshBtnEl.classList.add("loading"),this.statusEl&&(this.statusEl.textContent="",this.statusEl.className="folder-picker__status");try{const t=he();if(this.folders=await t.listFolders(e),this.updateSelect(),this.config.defaultFolderUuid){const e=this.folders.find(e=>e.uuid===this.config.defaultFolderUuid);e&&(this.selectedFolder=e,this.selectEl&&(this.selectEl.value=e.uuid))}}catch(t){const e=t instanceof ae?t.message:"Failed to load folders";this.statusEl&&(this.statusEl.textContent=e,this.statusEl.className="folder-picker__status error"),this.selectEl&&(this.selectEl.innerHTML=`<option value="">${this.config.placeholder}</option>`)}finally{this.isLoading=!1,this.refreshBtnEl&&this.refreshBtnEl.classList.remove("loading")}}}updateSelect(){if(this.selectEl){this.selectEl.innerHTML=`<option value="">${this.config.placeholder}</option>`;for(const e of this.folders){const t=document.createElement("option");t.value=e.uuid,t.textContent=e.name,this.selectEl.appendChild(t)}}}handleSelect(){if(!this.selectEl)return;const e=this.selectEl.value;if(!e)return void(this.selectedFolder=null);const t=this.folders.find(t=>t.uuid===e);t&&(this.selectedFolder=t,this.notifyCallbacks({folder:t}))}async handleCreate(){const e=prompt("Enter folder name:");if(e){this.statusEl&&(this.statusEl.textContent="Creating folder...",this.statusEl.className="folder-picker__status");try{const t=he(),n=await t.createFolder(e.trim());await this.loadFolders(!0),this.selectedFolder=n,this.selectEl&&(this.selectEl.value=n.uuid),this.notifyCallbacks({folder:n}),this.statusEl&&(this.statusEl.textContent=`Created folder: ${n.name}`)}catch(t){const e=t instanceof ae?t.message:"Failed to create folder";this.statusEl&&(this.statusEl.textContent=e,this.statusEl.className="folder-picker__status error")}}}notifyCallbacks(e){for(const t of this.callbacks)t(e)}}class _e{container;callbacks=new Set;state="idle";statusEl=null;channelProgressEls=new Map;overallProgressEl=null;messageEl=null;resultEl=null;constructor(e){this.container=e,this.render()}onChange(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}getState(){return this.state}start(e){this.state="uploading",this.reset(),this.setActiveChannels(e||["basecolor","normal","roughness","metallic"]),this.show(),this.updateMessage("Preparing upload...")}setActiveChannels(e){const t=["basecolor","normal","roughness","metallic","height"];for(const n of t){const t=this.channelProgressEls.get(n);t&&(e.includes(n)?t.style.display="flex":t.style.display="none")}}updateProgress(e){this.updateChannelProgress(e.channel,e.progress,e.status),this.updateMessage(e.status),this.updateOverallProgress()}complete(e,t){this.state="complete";const n=["basecolor","normal","roughness","metallic","height"];for(const r of n)e[r]&&this.updateChannelProgress(r,1,"Complete");this.updateOverallProgress(),this.updateMessage("Upload complete!"),this.showResult(e,t),this.notifyCallbacks(this.state,{textures:e,material:t})}error(e){this.state="error",this.updateMessage(`Error: ${e}`),this.messageEl&&this.messageEl.classList.add("error"),this.notifyCallbacks(this.state,e)}reset(){this.state="idle",this.channelProgressEls.forEach(e=>{const t=e.querySelector(".channel-progress-fill"),n=e.querySelector(".channel-status");t&&(t.style.width="0%"),n&&(n.textContent="Pending")}),this.overallProgressEl&&(this.overallProgressEl.style.width="0%"),this.messageEl&&(this.messageEl.textContent="",this.messageEl.classList.remove("error")),this.resultEl&&this.resultEl.classList.add("hidden")}show(){this.statusEl&&this.statusEl.classList.remove("hidden")}hide(){this.statusEl&&this.statusEl.classList.add("hidden")}dispose(){this.container.innerHTML="",this.callbacks.clear(),this.channelProgressEls.clear()}render(){this.statusEl=document.createElement("div"),this.statusEl.className="upload-status hidden",this.statusEl.innerHTML=`\n      <div class="upload-status__header">\n        <h4>Uploading to 3dverse</h4>\n      </div>\n      <div class="upload-status__progress-container">\n        ${["basecolor","normal","roughness","metallic","height"].map(e=>`\n            <div class="channel-progress" data-channel="${e}">\n              <span class="channel-name">${e}</span>\n              <div class="channel-progress-bar">\n                <div class="channel-progress-fill"></div>\n              </div>\n              <span class="channel-status">Pending</span>\n            </div>\n          `).join("")}\n        <div class="overall-progress">\n          <span class="channel-name">Overall</span>\n          <div class="channel-progress-bar overall">\n            <div class="channel-progress-fill"></div>\n          </div>\n          <span class="channel-status"></span>\n        </div>\n      </div>\n      <div class="upload-status__message"></div>\n      <div class="upload-status__result hidden">\n        <h5>Created Material</h5>\n        <div class="result-info"></div>\n      </div>\n    `,this.applyStyles(),this.messageEl=this.statusEl.querySelector(".upload-status__message"),this.resultEl=this.statusEl.querySelector(".upload-status__result"),this.overallProgressEl=this.statusEl.querySelector(".overall-progress .channel-progress-fill");this.statusEl.querySelectorAll(".channel-progress[data-channel]").forEach(e=>{const t=e.getAttribute("data-channel");t&&this.channelProgressEls.set(t,e)}),this.container.appendChild(this.statusEl)}applyStyles(){if(!document.getElementById("upload-status-styles")){const e=document.createElement("style");e.id="upload-status-styles",e.textContent="\n        .upload-status {\n          background: #2a2a4a;\n          border-radius: 8px;\n          padding: 15px;\n          margin-bottom: 20px;\n        }\n        .upload-status.hidden {\n          display: none;\n        }\n        .upload-status__header h4 {\n          margin: 0 0 15px;\n          font-size: 14px;\n          color: #fff;\n        }\n        .upload-status__progress-container {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n        }\n        .channel-progress {\n          display: flex;\n          align-items: center;\n          gap: 10px;\n        }\n        .channel-progress .channel-name {\n          width: 80px;\n          font-size: 12px;\n          color: #aaa;\n          text-transform: capitalize;\n        }\n        .channel-progress-bar {\n          flex: 1;\n          height: 8px;\n          background: #1a1a2e;\n          border-radius: 4px;\n          overflow: hidden;\n        }\n        .channel-progress-bar.overall {\n          height: 12px;\n        }\n        .channel-progress-fill {\n          height: 100%;\n          background: #5a8aaa;\n          border-radius: 4px;\n          width: 0%;\n          transition: width 0.3s ease;\n        }\n        .channel-progress.complete .channel-progress-fill {\n          background: #5a8a5a;\n        }\n        .channel-progress.error .channel-progress-fill {\n          background: #8a5a5a;\n        }\n        .overall-progress .channel-progress-fill {\n          background: #7878ff;\n        }\n        .channel-progress .channel-status {\n          width: 80px;\n          font-size: 11px;\n          color: #888;\n          text-align: right;\n        }\n        .upload-status__message {\n          margin-top: 15px;\n          font-size: 12px;\n          color: #aaa;\n          text-align: center;\n        }\n        .upload-status__message.error {\n          color: #f88;\n        }\n        .upload-status__result {\n          margin-top: 15px;\n          padding-top: 15px;\n          border-top: 1px solid #3a3a5a;\n        }\n        .upload-status__result.hidden {\n          display: none;\n        }\n        .upload-status__result h5 {\n          margin: 0 0 10px;\n          font-size: 12px;\n          color: #8f8;\n        }\n        .result-info {\n          font-size: 11px;\n          color: #888;\n        }\n        .result-info .uuid {\n          font-family: monospace;\n          background: #1a1a2e;\n          padding: 2px 6px;\n          border-radius: 3px;\n        }\n      ",document.head.appendChild(e)}}updateChannelProgress(e,t,n){const r=this.channelProgressEls.get(e);if(!r)return;const a=r.querySelector(".channel-progress-fill"),s=r.querySelector(".channel-status");a&&(a.style.width=`${Math.round(100*t)}%`),s&&(s.textContent=n),r.classList.remove("complete","error"),t>=1&&r.classList.add("complete")}updateOverallProgress(){if(!this.overallProgressEl)return;let e=0,t=0;this.channelProgressEls.forEach((n,r)=>{if("height"===r){const e=n.querySelector(".channel-status");if("Pending"===e?.textContent)return}const a=n.querySelector(".channel-progress-fill");if(a){const n=parseFloat(a.style.width)||0;e++,t+=n/100}});const n=e>0?t/e*100:0;this.overallProgressEl.style.width=`${n}%`}updateMessage(e){this.messageEl&&(this.messageEl.textContent=e)}showResult(e,t){if(!this.resultEl)return;const n=this.resultEl.querySelector(".result-info");if(!n)return;let r=`<p>Textures uploaded: ${Object.keys(e).length}</p>`;t&&(r+=`\n        <p>Material: ${t.name}</p>\n        <p>UUID: <span class="uuid">${t.uuid}</span></p>\n      `),n.innerHTML=r,this.resultEl.classList.remove("hidden")}notifyCallbacks(e,t){for(const n of this.callbacks)n(e,t)}}const Te={"open-file":{key:"o",ctrl:!0,description:"Open file"},"export-all":{key:"s",ctrl:!0,shift:!0,description:"Export all maps"},"export-basecolor":{key:"1",alt:!0,description:"Export basecolor"},"export-normal":{key:"2",alt:!0,description:"Export normal map"},"export-roughness":{key:"3",alt:!0,description:"Export roughness"},"export-metallic":{key:"4",alt:!0,description:"Export metallic"},"export-height":{key:"5",alt:!0,description:"Export height"},"toggle-ai":{key:"a",ctrl:!0,description:"Toggle AI normal generation"},"toggle-preview":{key:"p",ctrl:!0,description:"Toggle 3D preview"},regenerate:{key:"r",ctrl:!0,description:"Regenerate maps"},"upload-3dverse":{key:"u",ctrl:!0,shift:!0,description:"Upload to 3dverse"},"toggle-help":{key:"/",ctrl:!0,description:"Show keyboard shortcuts"},"increase-quality":{key:"+",ctrl:!0,description:"Increase quality"},"decrease-quality":{key:"-",ctrl:!0,description:"Decrease quality"}};function Ae(e,t){return e.key.toLowerCase()===t.key.toLowerCase()&&(!!t.ctrl===e.ctrlKey&&(!!t.shift===e.shiftKey&&(!!t.alt===e.altKey&&!!t.meta===e.metaKey)))}function Ce(e){const t=[],n=navigator.platform.toLowerCase().includes("mac");e.ctrl&&t.push(n?"Cmd":"Ctrl"),e.alt&&t.push(n?"Option":"Alt"),e.shift&&t.push("Shift"),e.meta&&t.push(n?"Cmd":"Win");let r=e.key.toUpperCase();return" "===r&&(r="Space"),"/"===r&&(r="?"),t.push(r),t.join("+")}class Se{shortcuts=new Map;handlers=new Map;enabled=!0;boundHandler;constructor(){for(const[e,t]of Object.entries(Te))this.shortcuts.set(e,{...t});this.boundHandler=this.handleKeyDown.bind(this)}start(){document.addEventListener("keydown",this.boundHandler)}stop(){document.removeEventListener("keydown",this.boundHandler)}setEnabled(e){this.enabled=e}on(e,t){return this.handlers.set(e,t),()=>this.handlers.delete(e)}onAll(e){const t=[];for(const[n,r]of Object.entries(e))r&&t.push(this.on(n,r));return()=>t.forEach(e=>e())}setShortcut(e,t){const n=this.shortcuts.get(e);n&&this.shortcuts.set(e,{...n,...t})}resetToDefaults(){for(const[e,t]of Object.entries(Te))this.shortcuts.set(e,{...t})}getShortcuts(){return new Map(this.shortcuts)}getFormattedShortcut(e){const t=this.shortcuts.get(e);return t?Ce(t):""}handleKeyDown(e){if(!this.enabled)return;const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable){const t=["toggle-help"];if(!this.findMatchingAction(e,t))return}for(const[n,r]of this.shortcuts)if(Ae(e,r)){const t=this.handlers.get(n);if(t)return e.preventDefault(),e.stopPropagation(),void t()}}findMatchingAction(e,t){for(const n of t){const t=this.shortcuts.get(n);if(t&&Ae(e,t))return n}return null}saveToStorage(){const e={};for(const[t,n]of this.shortcuts)e[t]=n;localStorage.setItem("pbr-keyboard-shortcuts",JSON.stringify(e))}loadFromStorage(){try{const e=localStorage.getItem("pbr-keyboard-shortcuts");if(e){const t=JSON.parse(e);for(const[e,n]of Object.entries(t))this.shortcuts.has(e)&&this.shortcuts.set(e,n)}}catch{console.warn("Failed to load keyboard shortcuts from storage")}}}class ke{container;visible=!1;constructor(e=document.body){this.container=document.createElement("div"),this.container.className="shortcuts-help-dialog hidden",this.container.innerHTML=this.render(),e.appendChild(this.container),this.container.addEventListener("click",e=>{e.target===this.container&&this.hide()});const t=this.container.querySelector(".close-btn");t?.addEventListener("click",()=>this.hide()),this.applyStyles()}show(e){this.updateContent(e),this.container.classList.remove("hidden"),this.visible=!0}hide(){this.container.classList.add("hidden"),this.visible=!1}toggle(e){this.visible?this.hide():this.show(e)}isVisible(){return this.visible}render(){return'\n      <div class="shortcuts-dialog-content">\n        <div class="shortcuts-dialog-header">\n          <h2>Keyboard Shortcuts</h2>\n          <button class="close-btn">&times;</button>\n        </div>\n        <div class="shortcuts-list"></div>\n      </div>\n    '}updateContent(e){const t=this.container.querySelector(".shortcuts-list");if(!t)return;const n={File:["open-file","export-all"],Export:["export-basecolor","export-normal","export-roughness","export-metallic","export-height"],Generation:["toggle-ai","regenerate","increase-quality","decrease-quality"],View:["toggle-preview","toggle-help"],"3dverse":["upload-3dverse"]};let r="";for(const[a,s]of Object.entries(n)){r+=`<div class="shortcuts-category"><h3>${a}</h3>`;for(const t of s){const n=e.get(t);n&&(r+=`\n            <div class="shortcut-row">\n              <span class="shortcut-desc">${n.description}</span>\n              <span class="shortcut-key">${Ce(n)}</span>\n            </div>\n          `)}r+="</div>"}t.innerHTML=r}applyStyles(){if(document.getElementById("shortcuts-help-styles"))return;const e=document.createElement("style");e.id="shortcuts-help-styles",e.textContent="\n      .shortcuts-help-dialog {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.7);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10000;\n        backdrop-filter: blur(4px);\n      }\n      .shortcuts-help-dialog.hidden {\n        display: none;\n      }\n      .shortcuts-dialog-content {\n        background: #2a2a4a;\n        border-radius: 12px;\n        max-width: 500px;\n        width: 90%;\n        max-height: 80vh;\n        overflow: auto;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n      }\n      .shortcuts-dialog-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 16px 20px;\n        border-bottom: 1px solid #3a3a5a;\n      }\n      .shortcuts-dialog-header h2 {\n        margin: 0;\n        font-size: 18px;\n        color: #fff;\n      }\n      .shortcuts-dialog-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 24px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .shortcuts-dialog-header .close-btn:hover {\n        color: #fff;\n      }\n      .shortcuts-list {\n        padding: 16px 20px;\n      }\n      .shortcuts-category {\n        margin-bottom: 16px;\n      }\n      .shortcuts-category h3 {\n        font-size: 12px;\n        color: #888;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        margin: 0 0 8px 0;\n      }\n      .shortcut-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 8px 0;\n        border-bottom: 1px solid #3a3a5a;\n      }\n      .shortcut-row:last-child {\n        border-bottom: none;\n      }\n      .shortcut-desc {\n        color: #ccc;\n        font-size: 14px;\n      }\n      .shortcut-key {\n        background: #3a3a5a;\n        color: #fff;\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        font-family: monospace;\n      }\n    ",document.head.appendChild(e)}destroy(){this.container.remove()}}let Re=null,Me=null;class Ie{statusListeners=new Set;prefetchListeners=new Set;currentStatus=null;constructor(){"undefined"!=typeof window&&(window.addEventListener("online",()=>this.updateStatus()),window.addEventListener("offline",()=>this.updateStatus()))}async getStatus(){const e=R(),t=await e.listCached(),n=await e.getCacheSize(),r=["deepbump_fp16","deepbump_int8"].some(e=>t.includes(e));return this.currentStatus={isOnline:navigator.onLine,modelsReady:r,cachedModels:t,cacheSizeBytes:n},this.currentStatus}async isModelCached(e){return R().isCached(e)}async prefetchModels(e){const t=F(),n=await t.getAvailableModels();if(0===n.length)return void console.warn("No models available for prefetch");const r=new Map;for(const s of n)r.set(s.id,{modelId:s.id,progress:0,status:"pending"});e?.(r),this.notifyPrefetchListeners(r);for(const s of n)try{r.set(s.id,{modelId:s.id,progress:0,status:"downloading"}),e?.(r),this.notifyPrefetchListeners(r),await t.loadModelData(s,t=>{r.set(s.id,{modelId:s.id,progress:t.progress,status:"downloading"}),e?.(r),this.notifyPrefetchListeners(r)}),s.externalDataPath&&await t.loadExternalData(s),r.set(s.id,{modelId:s.id,progress:1,status:"cached"}),e?.(r),this.notifyPrefetchListeners(r)}catch(a){r.set(s.id,{modelId:s.id,progress:0,status:"error",error:a instanceof Error?a.message:"Unknown error"}),e?.(r),this.notifyPrefetchListeners(r)}await this.updateStatus()}async clearCache(){const e=F();await e.clearCache(),await this.updateStatus()}async getCacheStats(){return F().getCacheStats()}formatCacheSize(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:e<1073741824?`${(e/1048576).toFixed(1)} MB`:`${(e/1073741824).toFixed(2)} GB`}async canWorkOffline(){return(await this.getStatus()).modelsReady}onStatusChange(e){return this.statusListeners.add(e),this.currentStatus&&e(this.currentStatus),()=>this.statusListeners.delete(e)}onPrefetchProgress(e){return this.prefetchListeners.add(e),()=>this.prefetchListeners.delete(e)}async updateStatus(){const e=await this.getStatus();this.statusListeners.forEach(t=>t(e))}notifyPrefetchListeners(e){this.prefetchListeners.forEach(t=>t(e))}}let Le=null;function Pe(){return Le||(Le=new Ie),Le}const Fe={showCacheSize:!0,showModelList:!0,compact:!1};class De{container;config;visible=!1;progressMap=new Map;unsubscribe=null;constructor(e,t={}){this.config={...Fe,...t},this.container=document.createElement("div"),this.container.className="download-progress hidden",e.appendChild(this.container),this.applyStyles(),this.render();const n=Pe();this.unsubscribe=n.onPrefetchProgress(e=>{this.progressMap=e,this.updateProgress()})}show(){this.container.classList.remove("hidden"),this.visible=!0,this.updateProgress()}hide(){this.container.classList.add("hidden"),this.visible=!1}isVisible(){return this.visible}async startPrefetch(){this.show();const e=Pe();await e.prefetchModels(e=>{this.progressMap=e,this.updateProgress()});Array.from(this.progressMap.values()).every(e=>"cached"===e.status||"error"===e.status)&&this.showCompletion()}render(){this.container.innerHTML='\n      <div class="download-progress-header">\n        <h3>Model Cache</h3>\n        <button class="close-btn">&times;</button>\n      </div>\n      <div class="download-progress-content">\n        <div class="cache-status"></div>\n        <div class="model-list"></div>\n        <div class="progress-actions">\n          <button class="prefetch-btn">Download for Offline</button>\n          <button class="clear-cache-btn">Clear Cache</button>\n        </div>\n      </div>\n    ';const e=this.container.querySelector(".close-btn");e?.addEventListener("click",()=>this.hide());const t=this.container.querySelector(".prefetch-btn");t?.addEventListener("click",()=>this.startPrefetch());const n=this.container.querySelector(".clear-cache-btn");n?.addEventListener("click",()=>this.handleClearCache()),this.updateCacheStatus()}async updateCacheStatus(){const e=this.container.querySelector(".cache-status");if(!e)return;const t=Pe(),n=await t.getStatus(),r=t.formatCacheSize(n.cacheSizeBytes);e.innerHTML=`\n      <div class="cache-info">\n        <span class="status-indicator ${n.modelsReady?"ready":"not-ready"}"></span>\n        <span class="status-text">\n          ${n.modelsReady?"Ready for offline use":"Models not cached"}\n        </span>\n      </div>\n      <div class="cache-size">\n        <span>Cache size: ${r}</span>\n        <span class="online-status ${n.isOnline?"online":"offline"}">\n          ${n.isOnline?"Online":"Offline"}\n        </span>\n      </div>\n    `}updateProgress(){const e=this.container.querySelector(".model-list");if(!e)return;if(0===this.progressMap.size)return void this.updateCacheStatus();let t="";for(const[,n]of this.progressMap){const e=n.status,r=Math.round(100*n.progress);t+=`\n        <div class="model-item ${e}">\n          <div class="model-info">\n            <span class="model-name">${n.modelId}</span>\n            <span class="model-status">${this.getStatusText(n)}</span>\n          </div>\n          <div class="progress-bar-container">\n            <div class="progress-bar" style="width: ${r}%"></div>\n          </div>\n        </div>\n      `}e.innerHTML=t}getStatusText(e){switch(e.status){case"pending":return"Waiting...";case"downloading":return`${Math.round(100*e.progress)}%`;case"cached":return"Cached";case"error":return e.error||"Error";default:return""}}showCompletion(){const e=this.container.querySelector(".model-list");if(!e)return;const t=Array.from(this.progressMap.values()).some(e=>"error"===e.status);e.innerHTML+=t?'\n        <div class="completion-message error">\n          Some models failed to download. Check connection and try again.\n        </div>\n      ':'\n        <div class="completion-message success">\n          All models cached. Ready for offline use!\n        </div>\n      ',this.updateCacheStatus()}async handleClearCache(){const e=this.container.querySelector(".clear-cache-btn");e&&(e.disabled=!0,e.textContent="Clearing...");try{const e=Pe();await e.clearCache(),this.progressMap.clear(),this.updateProgress(),await this.updateCacheStatus()}finally{e&&(e.disabled=!1,e.textContent="Clear Cache")}}applyStyles(){if(document.getElementById("download-progress-styles"))return;const e=document.createElement("style");e.id="download-progress-styles",e.textContent="\n      .download-progress {\n        background: #2a2a4a;\n        border-radius: 8px;\n        margin-bottom: 20px;\n        overflow: hidden;\n      }\n      .download-progress.hidden {\n        display: none;\n      }\n      .download-progress-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 16px;\n        background: #3a3a5a;\n      }\n      .download-progress-header h3 {\n        margin: 0;\n        font-size: 14px;\n        color: #fff;\n      }\n      .download-progress-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .download-progress-header .close-btn:hover {\n        color: #fff;\n      }\n      .download-progress-content {\n        padding: 16px;\n      }\n      .cache-status {\n        margin-bottom: 12px;\n      }\n      .cache-info {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 8px;\n      }\n      .status-indicator {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: #888;\n      }\n      .status-indicator.ready {\n        background: #4a8;\n      }\n      .status-indicator.not-ready {\n        background: #a84;\n      }\n      .status-text {\n        font-size: 14px;\n        color: #ccc;\n      }\n      .cache-size {\n        display: flex;\n        justify-content: space-between;\n        font-size: 12px;\n        color: #888;\n      }\n      .online-status {\n        padding: 2px 8px;\n        border-radius: 10px;\n        font-size: 11px;\n      }\n      .online-status.online {\n        background: rgba(68, 170, 136, 0.2);\n        color: #4a8;\n      }\n      .online-status.offline {\n        background: rgba(170, 136, 68, 0.2);\n        color: #a84;\n      }\n      .model-list {\n        margin-bottom: 12px;\n      }\n      .model-item {\n        margin-bottom: 10px;\n        padding: 10px;\n        background: #1a1a2e;\n        border-radius: 6px;\n      }\n      .model-info {\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 6px;\n      }\n      .model-name {\n        font-size: 13px;\n        color: #ccc;\n        font-family: monospace;\n      }\n      .model-status {\n        font-size: 12px;\n        color: #888;\n      }\n      .model-item.cached .model-status {\n        color: #4a8;\n      }\n      .model-item.error .model-status {\n        color: #a44;\n      }\n      .progress-bar-container {\n        height: 4px;\n        background: #3a3a5a;\n        border-radius: 2px;\n        overflow: hidden;\n      }\n      .progress-bar {\n        height: 100%;\n        background: linear-gradient(90deg, #5a7aff, #7a5aff);\n        border-radius: 2px;\n        transition: width 0.3s ease;\n      }\n      .model-item.cached .progress-bar {\n        background: #4a8;\n      }\n      .model-item.error .progress-bar {\n        background: #a44;\n      }\n      .progress-actions {\n        display: flex;\n        gap: 10px;\n      }\n      .prefetch-btn, .clear-cache-btn {\n        flex: 1;\n        padding: 8px 16px;\n        border: none;\n        border-radius: 4px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n      .prefetch-btn {\n        background: #5a7aff;\n        color: white;\n      }\n      .prefetch-btn:hover:not(:disabled) {\n        background: #6a8aff;\n      }\n      .prefetch-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      .clear-cache-btn {\n        background: #3a3a5a;\n        color: #ccc;\n      }\n      .clear-cache-btn:hover:not(:disabled) {\n        background: #4a4a6a;\n      }\n      .clear-cache-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      .completion-message {\n        margin-top: 12px;\n        padding: 10px;\n        border-radius: 6px;\n        font-size: 13px;\n        text-align: center;\n      }\n      .completion-message.success {\n        background: rgba(68, 170, 136, 0.1);\n        color: #4a8;\n        border: 1px solid rgba(68, 170, 136, 0.3);\n      }\n      .completion-message.error {\n        background: rgba(170, 68, 68, 0.1);\n        color: #a44;\n        border: 1px solid rgba(170, 68, 68, 0.3);\n      }\n    ",document.head.appendChild(e)}destroy(){this.unsubscribe?.(),this.container.remove()}}var Ne=(e=>(e.INFO="info",e.WARNING="warning",e.ERROR="error",e.FATAL="fatal",e))(Ne||{});class Oe extends Error{constructor(e,t,n="error",r=!0,a="retry",s,o){super(e),this.code=t,this.severity=n,this.recoverable=r,this.recoveryAction=a,this.suggestion=s,this.details=o,this.name="PBRGeneratorError",this.timestamp=Date.now()}timestamp;toUserMessage(){return{UNKNOWN_ERROR:"An unexpected error occurred.",NETWORK_ERROR:"Network connection failed. Check your internet.",TIMEOUT_ERROR:"Operation timed out. Try again.",WEBGPU_NOT_SUPPORTED:"WebGPU is not supported. Using fallback mode.",WEBGL2_NOT_SUPPORTED:"WebGL2 is not supported. Please use a modern browser.",GPU_CONTEXT_LOST:"GPU context was lost. Refreshing may help.",SHADER_COMPILATION_ERROR:"Shader compilation failed. Try reloading.",MODEL_NOT_FOUND:"AI model not found. Try refreshing the page.",MODEL_LOAD_FAILED:"Failed to load AI model. Try again.",MODEL_CORRUPT:"Model file is corrupted. Clearing cache may help.",INFERENCE_OOM:"Out of memory. Try a smaller image or lower quality.",INFERENCE_FAILED:"AI inference failed. Try again or use traditional mode.",WORKER_ERROR:"Background worker error. Reloading may help.",SESSION_NOT_READY:"AI session not ready. Please wait.",IMAGE_LOAD_FAILED:"Failed to load image. Check the file format.",IMAGE_TOO_LARGE:"Image too large. Use an image 4096x4096 or smaller.",IMAGE_INVALID_FORMAT:"Invalid image format. Use PNG, JPEG, or WebP.",GENERATION_FAILED:"Failed to generate PBR maps. Try again.",AUTH_FAILED:"3dverse authentication failed.",AUTH_EXPIRED:"Session expired. Please log in again.",AUTH_INVALID_KEY:"Invalid API key. Check your credentials.",UPLOAD_FAILED:"Upload failed. Check connection and try again.",UPLOAD_QUOTA_EXCEEDED:"Storage quota exceeded.",MATERIAL_CREATE_FAILED:"Failed to create material.",FOLDER_NOT_FOUND:"Folder not found.",API_ERROR:"3dverse API error.",CACHE_ERROR:"Cache error. Clearing cache may help.",INDEXEDDB_ERROR:"Storage error. Try a different browser.",QUOTA_EXCEEDED:"Storage quota exceeded. Clear cache."}[this.code]||this.message}}class Ue{errorLog=[];maxLogSize=100;listeners=new Set;handle(e){const t=this.normalize(e);return this.log(t),this.notify(t),t}normalize(e){return e instanceof Oe?e:e instanceof Error?this.classifyError(e):"string"==typeof e?new Oe(e,"UNKNOWN_ERROR","error",!0,"retry"):new Oe("An unknown error occurred","UNKNOWN_ERROR","error",!0,"retry",void 0,{originalError:e})}classifyError(e){const t=e.message.toLowerCase(),n=e.name.toLowerCase();return"typeerror"===n&&t.includes("fetch")?new Oe(e.message,"NETWORK_ERROR","error",!0,"retry","Check your internet connection"):t.includes("timeout")||"timeouterror"===n?new Oe(e.message,"TIMEOUT_ERROR","error",!0,"retry"):t.includes("out of memory")||t.includes("oom")||t.includes("allocation")?new Oe(e.message,"INFERENCE_OOM","error",!0,"reduce-quality","Try using a smaller image or lower quality setting"):t.includes("context lost")||t.includes("webgl")?new Oe(e.message,"GPU_CONTEXT_LOST","fatal",!0,"reload-page"):t.includes("indexeddb")||t.includes("quota")?new Oe(e.message,"INDEXEDDB_ERROR","warning",!0,"clear-cache"):new Oe(e.message,"UNKNOWN_ERROR","error",!0,"retry",void 0,{stack:e.stack})}log(e){this.errorLog.push(e),this.errorLog.length>this.maxLogSize&&this.errorLog.shift();("fatal"===e.severity||"error"===e.severity?console.error:"warning"===e.severity?console.warn:console.info)(`[${e.code}]`,e.message,e.details||"")}notify(e){this.listeners.forEach(t=>{try{t(e)}catch{console.error("Error in error listener")}})}onError(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getErrorLog(){return[...this.errorLog]}clearLog(){this.errorLog=[]}}let Be=null;function $e(){return Be||(Be=new Ue),Be}const ze={position:"top",autoDismissMs:5e3,maxVisible:3};class Ge{container;config;errors=[];nextId=1;unsubscribe=null;constructor(e,t={}){this.config={...ze,...t},this.container=document.createElement("div"),this.container.className=`error-boundary error-boundary-${this.config.position}`,e.appendChild(this.container),this.applyStyles();const n=$e();this.unsubscribe=n.onError(e=>this.showError(e))}showError(e){for(;this.errors.length>=(this.config.maxVisible||3);){const e=this.errors.shift();e&&this.dismissError(e)}const t=this.nextId++,n=this.createErrorElement(t,e);this.container.appendChild(n),requestAnimationFrame(()=>{n.classList.add("visible")});const r={id:t,error:e,element:n};e.severity!==Ne.FATAL&&this.config.autoDismissMs&&this.config.autoDismissMs>0&&(r.dismissTimeout=setTimeout(()=>{this.dismiss(t)},this.config.autoDismissMs)),this.errors.push(r)}dismiss(e){const t=this.errors.findIndex(t=>t.id===e);if(-1===t)return;const n=this.errors[t];this.dismissError(n),this.errors.splice(t,1)}clearAll(){for(const e of this.errors)this.dismissError(e);this.errors=[]}createErrorElement(e,t){const n=document.createElement("div");n.className=`error-item error-${t.severity}`,n.dataset.errorId=String(e);const r=this.getSeverityIcon(t.severity),a=this.createActionButton(e,t.recoveryAction,t.recoverable);n.innerHTML=`\n      <div class="error-icon">${r}</div>\n      <div class="error-content">\n        <div class="error-message">${t.toUserMessage()}</div>\n        ${t.suggestion?`<div class="error-suggestion">${t.suggestion}</div>`:""}\n      </div>\n      <div class="error-actions">\n        ${a}\n        <button class="dismiss-btn" title="Dismiss">&times;</button>\n      </div>\n    `;const s=n.querySelector(".dismiss-btn");s?.addEventListener("click",()=>this.dismiss(e));const o=n.querySelector(".recovery-btn");return o?.addEventListener("click",()=>this.executeRecovery(e,t.recoveryAction)),n}getSeverityIcon(e){switch(e){case Ne.INFO:return'<svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';case Ne.WARNING:return'<svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 2L2 22h20L12 2z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';case Ne.ERROR:case Ne.FATAL:return'<svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';default:return""}}createActionButton(e,t,n){if(!n||"none"===t)return"";return`<button class="recovery-btn">${{retry:"Retry","retry-with-fallback":"Try Fallback","reload-page":"Reload Page","clear-cache":"Clear Cache","reduce-quality":"Lower Quality","use-smaller-image":"Use Smaller","re-authenticate":"Log In Again","contact-support":"Get Help",none:""}[t]||"Retry"}</button>`}executeRecovery(e,t){switch(t){case"reload-page":window.location.reload();break;case"clear-cache":this.clearCacheAndRetry();break;case"re-authenticate":window.dispatchEvent(new CustomEvent("pbr-reauthenticate"));break;default:window.dispatchEvent(new CustomEvent("pbr-error-retry",{detail:{id:e}}))}this.dismiss(e)}async clearCacheAndRetry(){try{const{getModelCache:e}=await t(async()=>{const{getModelCache:e}=await Promise.resolve().then(()=>M);return{getModelCache:e}},void 0),n=e();await n.clearAll(),window.dispatchEvent(new CustomEvent("pbr-error-retry"))}catch(e){console.error("Failed to clear cache:",e)}}dismissError(e){e.dismissTimeout&&clearTimeout(e.dismissTimeout),e.element.classList.remove("visible"),e.element.classList.add("dismissing"),setTimeout(()=>{e.element.remove()},300)}applyStyles(){if(document.getElementById("error-boundary-styles"))return;const e=document.createElement("style");e.id="error-boundary-styles",e.textContent="\n      .error-boundary {\n        position: fixed;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 9999;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        max-width: 500px;\n        width: calc(100% - 40px);\n        pointer-events: none;\n      }\n      .error-boundary-top {\n        top: 20px;\n      }\n      .error-boundary-bottom {\n        bottom: 20px;\n      }\n      .error-boundary-inline {\n        position: relative;\n        transform: none;\n        left: auto;\n      }\n      .error-item {\n        display: flex;\n        align-items: flex-start;\n        gap: 12px;\n        padding: 12px 16px;\n        background: #2a2a4a;\n        border-radius: 8px;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);\n        opacity: 0;\n        transform: translateY(-20px);\n        transition: opacity 0.3s, transform 0.3s;\n        pointer-events: auto;\n      }\n      .error-item.visible {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      .error-item.dismissing {\n        opacity: 0;\n        transform: translateY(-20px);\n      }\n      .error-info {\n        border-left: 3px solid #5a7aff;\n      }\n      .error-warning {\n        border-left: 3px solid #ff9a5a;\n      }\n      .error-error {\n        border-left: 3px solid #ff5a5a;\n      }\n      .error-fatal {\n        border-left: 3px solid #ff2a2a;\n        background: #3a2a2a;\n      }\n      .error-icon {\n        flex-shrink: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      .error-info .error-icon {\n        color: #5a7aff;\n      }\n      .error-warning .error-icon {\n        color: #ff9a5a;\n      }\n      .error-error .error-icon,\n      .error-fatal .error-icon {\n        color: #ff5a5a;\n      }\n      .error-content {\n        flex: 1;\n        min-width: 0;\n      }\n      .error-message {\n        font-size: 14px;\n        color: #eee;\n        line-height: 1.4;\n      }\n      .error-suggestion {\n        margin-top: 4px;\n        font-size: 12px;\n        color: #888;\n      }\n      .error-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        flex-shrink: 0;\n      }\n      .recovery-btn {\n        padding: 4px 10px;\n        background: #5a7aff;\n        border: none;\n        border-radius: 4px;\n        color: white;\n        font-size: 12px;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .recovery-btn:hover {\n        background: #6a8aff;\n      }\n      .dismiss-btn {\n        padding: 2px 6px;\n        background: transparent;\n        border: none;\n        color: #666;\n        font-size: 18px;\n        cursor: pointer;\n        line-height: 1;\n      }\n      .dismiss-btn:hover {\n        color: #aaa;\n      }\n    ",document.head.appendChild(e)}destroy(){this.unsubscribe?.(),this.clearAll(),this.container.remove()}}let He=null;class qe{container;items=[];nextId=1;processing=!1;callbacks;visible=!1;constructor(e,t){this.callbacks=t,this.container=document.createElement("div"),this.container.className="batch-processor hidden",e.appendChild(this.container),this.applyStyles(),this.render()}show(){this.container.classList.remove("hidden"),this.visible=!0}hide(){this.container.classList.add("hidden"),this.visible=!1}toggle(){this.visible?this.hide():this.show()}isVisible(){return this.visible}addFiles(e){for(const t of e)t.type.startsWith("image/")&&this.items.push({id:this.nextId++,file:t,status:"pending",progress:0});this.updateItemList(),this.updateStats(),this.updateButtons()}removeItem(e){const t=this.items.findIndex(t=>t.id===e);-1!==t&&"processing"!==this.items[t].status&&(this.items.splice(t,1),this.updateItemList(),this.updateStats(),this.updateButtons())}clearAll(){this.processing||(this.items=[],this.updateItemList(),this.updateStats(),this.updateButtons())}async startProcessing(){if(this.processing)return;if(0===this.items.length)return;this.processing=!0,this.updateButtons();for(const n of this.items)if("complete"!==n.status){n.status="processing",n.progress=0,this.updateItem(n.id);try{const e=await this.callbacks.onProcess(n.file);n.input=e.input,n.maps=e.maps,n.status="complete",n.progress=1}catch(t){n.status="error",n.error=t instanceof Error?t.message:"Unknown error"}this.updateItem(n.id),this.updateStats()}this.processing=!1,this.updateButtons();const e={totalItems:this.items.length,completed:this.items.filter(e=>"complete"===e.status).length,failed:this.items.filter(e=>"error"===e.status).length,items:this.items};this.callbacks.onComplete(e)}async exportAll(e=["basecolor","normal","roughness","metallic"]){const t=this.items.filter(e=>"complete"===e.status);for(const n of t)await this.callbacks.onExport(n,e)}isProcessing(){return this.processing}getStats(){return{total:this.items.length,pending:this.items.filter(e=>"pending"===e.status).length,complete:this.items.filter(e=>"complete"===e.status).length,error:this.items.filter(e=>"error"===e.status).length}}render(){this.container.innerHTML='\n      <div class="batch-header">\n        <h3>Batch Processing</h3>\n        <button class="close-btn">&times;</button>\n      </div>\n      <div class="batch-content">\n        <div class="batch-drop-zone">\n          <p>Drop multiple images here</p>\n          <p class="hint">or click to select files</p>\n          <input type="file" multiple accept="image/png,image/jpeg,image/webp" class="batch-file-input">\n        </div>\n        <div class="batch-stats">\n          <span class="stat-item">Total: <span class="stat-total">0</span></span>\n          <span class="stat-item">Pending: <span class="stat-pending">0</span></span>\n          <span class="stat-item">Complete: <span class="stat-complete">0</span></span>\n          <span class="stat-item">Error: <span class="stat-error">0</span></span>\n        </div>\n        <div class="batch-item-list"></div>\n        <div class="batch-actions">\n          <button class="start-btn" disabled>Start Processing</button>\n          <button class="export-btn" disabled>Export All</button>\n          <button class="clear-btn" disabled>Clear</button>\n        </div>\n      </div>\n    ';const e=this.container.querySelector(".close-btn");e?.addEventListener("click",()=>this.hide());const t=this.container.querySelector(".batch-drop-zone"),n=this.container.querySelector(".batch-file-input");t.addEventListener("click",()=>n.click()),t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>{t.classList.remove("dragover")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover"),e.dataTransfer?.files&&this.addFiles(e.dataTransfer.files)}),n.addEventListener("change",()=>{n.files&&(this.addFiles(n.files),n.value="")});const r=this.container.querySelector(".start-btn");r?.addEventListener("click",()=>this.startProcessing());const a=this.container.querySelector(".export-btn");a?.addEventListener("click",()=>this.exportAll());const s=this.container.querySelector(".clear-btn");s?.addEventListener("click",()=>this.clearAll())}updateItemList(){const e=this.container.querySelector(".batch-item-list");if(!e)return;if(0===this.items.length)return void(e.innerHTML='<p class="no-items">No items in queue</p>');e.innerHTML=this.items.map(e=>`\n      <div class="batch-item batch-item-${e.status}" data-id="${e.id}">\n        <div class="item-info">\n          <span class="item-name">${this.truncateFilename(e.file.name)}</span>\n          <span class="item-size">${this.formatSize(e.file.size)}</span>\n        </div>\n        <div class="item-status">\n          ${this.getStatusIndicator(e)}\n        </div>\n        <button class="remove-btn" title="Remove" ${"processing"===e.status?"disabled":""}>\n          &times;\n        </button>\n      </div>\n    `).join("");e.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".batch-item"),n=parseInt(t?.getAttribute("data-id")||"0",10);n&&this.removeItem(n)})})}updateItem(e){const t=this.items.find(t=>t.id===e);if(!t)return;const n=this.container.querySelector(`.batch-item[data-id="${e}"]`);if(!n)return;n.className=`batch-item batch-item-${t.status}`;const r=n.querySelector(".item-status");r&&(r.innerHTML=this.getStatusIndicator(t))}getStatusIndicator(e){switch(e.status){case"pending":return'<span class="status-badge pending">Pending</span>';case"processing":return'<span class="status-badge processing">Processing...</span>';case"complete":return'<span class="status-badge complete">Done</span>';case"error":return`<span class="status-badge error" title="${e.error||""}">Error</span>`;default:return""}}updateStats(){const e=this.getStats(),t=this.container.querySelector(".stat-total"),n=this.container.querySelector(".stat-pending"),r=this.container.querySelector(".stat-complete"),a=this.container.querySelector(".stat-error");t&&(t.textContent=String(e.total)),n&&(n.textContent=String(e.pending)),r&&(r.textContent=String(e.complete)),a&&(a.textContent=String(e.error))}updateButtons(){const e=this.container.querySelector(".start-btn"),t=this.container.querySelector(".export-btn"),n=this.container.querySelector(".clear-btn"),r=this.items.some(e=>"pending"===e.status||"error"===e.status),a=this.items.some(e=>"complete"===e.status);e&&(e.disabled=this.processing||!r,e.textContent=this.processing?"Processing...":"Start Processing"),t&&(t.disabled=this.processing||!a),n&&(n.disabled=this.processing||0===this.items.length)}truncateFilename(e,t=30){if(e.length<=t)return e;const n=e.split(".").pop()||"";return`${e.slice(0,-(n.length+1)).slice(0,t-n.length-4)+"..."}.${n}`}formatSize(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}applyStyles(){if(document.getElementById("batch-processor-styles"))return;const e=document.createElement("style");e.id="batch-processor-styles",e.textContent="\n      .batch-processor {\n        background: #2a2a4a;\n        border-radius: 8px;\n        margin-bottom: 20px;\n        overflow: hidden;\n      }\n      .batch-processor.hidden {\n        display: none;\n      }\n      .batch-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 16px;\n        background: #3a3a5a;\n      }\n      .batch-header h3 {\n        margin: 0;\n        font-size: 14px;\n        color: #fff;\n      }\n      .batch-header .close-btn {\n        background: none;\n        border: none;\n        color: #888;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        line-height: 1;\n      }\n      .batch-header .close-btn:hover {\n        color: #fff;\n      }\n      .batch-content {\n        padding: 16px;\n      }\n      .batch-drop-zone {\n        border: 2px dashed #4a4a6a;\n        border-radius: 8px;\n        padding: 30px;\n        text-align: center;\n        cursor: pointer;\n        transition: border-color 0.2s, background 0.2s;\n        margin-bottom: 16px;\n      }\n      .batch-drop-zone:hover, .batch-drop-zone.dragover {\n        border-color: #7878ff;\n        background: rgba(120, 120, 255, 0.05);\n      }\n      .batch-drop-zone p {\n        margin: 0;\n        color: #888;\n      }\n      .batch-drop-zone .hint {\n        font-size: 12px;\n        margin-top: 8px;\n      }\n      .batch-file-input {\n        display: none;\n      }\n      .batch-stats {\n        display: flex;\n        gap: 16px;\n        padding: 10px 0;\n        border-bottom: 1px solid #3a3a5a;\n        margin-bottom: 12px;\n        font-size: 13px;\n      }\n      .stat-item {\n        color: #888;\n      }\n      .stat-total, .stat-pending, .stat-complete, .stat-error {\n        color: #fff;\n        font-weight: 500;\n      }\n      .stat-complete {\n        color: #4a8;\n      }\n      .stat-error {\n        color: #a44;\n      }\n      .batch-item-list {\n        max-height: 300px;\n        overflow-y: auto;\n        margin-bottom: 16px;\n      }\n      .no-items {\n        text-align: center;\n        color: #666;\n        padding: 20px;\n      }\n      .batch-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px;\n        background: #1a1a2e;\n        border-radius: 6px;\n        margin-bottom: 8px;\n      }\n      .batch-item:last-child {\n        margin-bottom: 0;\n      }\n      .item-info {\n        flex: 1;\n        min-width: 0;\n      }\n      .item-name {\n        display: block;\n        font-size: 13px;\n        color: #ccc;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n      .item-size {\n        font-size: 11px;\n        color: #666;\n      }\n      .status-badge {\n        padding: 3px 8px;\n        border-radius: 10px;\n        font-size: 11px;\n        white-space: nowrap;\n      }\n      .status-badge.pending {\n        background: #3a3a5a;\n        color: #888;\n      }\n      .status-badge.processing {\n        background: rgba(90, 122, 255, 0.2);\n        color: #5a7aff;\n      }\n      .status-badge.complete {\n        background: rgba(68, 170, 136, 0.2);\n        color: #4a8;\n      }\n      .status-badge.error {\n        background: rgba(170, 68, 68, 0.2);\n        color: #a44;\n      }\n      .batch-item .remove-btn {\n        background: none;\n        border: none;\n        color: #666;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px;\n        line-height: 1;\n      }\n      .batch-item .remove-btn:hover:not(:disabled) {\n        color: #a44;\n      }\n      .batch-item .remove-btn:disabled {\n        cursor: not-allowed;\n        opacity: 0.3;\n      }\n      .batch-actions {\n        display: flex;\n        gap: 10px;\n      }\n      .batch-actions button {\n        flex: 1;\n        padding: 10px;\n        border: none;\n        border-radius: 4px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n      .start-btn {\n        background: #5a7aff;\n        color: white;\n      }\n      .start-btn:hover:not(:disabled) {\n        background: #6a8aff;\n      }\n      .export-btn {\n        background: #5a8a5a;\n        color: white;\n      }\n      .export-btn:hover:not(:disabled) {\n        background: #6a9a6a;\n      }\n      .clear-btn {\n        background: #3a3a5a;\n        color: #ccc;\n      }\n      .clear-btn:hover:not(:disabled) {\n        background: #4a4a6a;\n      }\n      .batch-actions button:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n    ",document.head.appendChild(e)}destroy(){this.container.remove()}}const je={geometry:"sphere",tiling:[1,1],offset:[0,0],autoRotate:!0,rotationSpeed:.5,lightDirection:[1,1,1],lightColor:[1,1,1],lightIntensity:2,ambientColor:[.3,.4,.5],ambientIntensity:.5};class We{canvas;gl;program=null;uniforms=null;vao=null;geometry=null;geometryType="sphere";basecolorTexture=null;normalTexture=null;roughnessTexture=null;metallicTexture=null;config;rotation=0;animationId=null;lastFrameTime=0;cameraDistance=3;cameraRotationX=.3;cameraRotationY=0;isDragging=!1;lastMouseX=0;lastMouseY=0;constructor(e,t={}){this.canvas=e,this.config={...je,...t};const n=e.getContext("webgl2",{antialias:!0,alpha:!1,premultipliedAlpha:!1});if(!n)throw new Error("WebGL2 not supported");this.gl=n,this.initializeShaders(),this.initializeGeometry(),this.setupInteraction(),this.startRenderLoop()}initializeShaders(){const e=this.gl,t=this.compileShader(e.VERTEX_SHADER,"#version 300 es\nprecision highp float;\n\n// Attributes\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texcoord;\nin vec4 a_tangent;\n\n// Uniforms\nuniform mat4 u_modelMatrix;\nuniform mat4 u_viewMatrix;\nuniform mat4 u_projectionMatrix;\nuniform mat3 u_normalMatrix;\n\n// Varyings\nout vec3 v_worldPosition;\nout vec3 v_worldNormal;\nout vec2 v_texcoord;\nout mat3 v_TBN;\n\nvoid main() {\n  // World space position\n  vec4 worldPos = u_modelMatrix * vec4(a_position, 1.0);\n  v_worldPosition = worldPos.xyz;\n\n  // World space normal\n  v_worldNormal = normalize(u_normalMatrix * a_normal);\n\n  // Texture coordinates\n  v_texcoord = a_texcoord;\n\n  // TBN matrix for normal mapping\n  vec3 T = normalize(u_normalMatrix * a_tangent.xyz);\n  vec3 N = v_worldNormal;\n  // Re-orthogonalize T with respect to N\n  T = normalize(T - dot(T, N) * N);\n  vec3 B = cross(N, T) * a_tangent.w;\n  v_TBN = mat3(T, B, N);\n\n  gl_Position = u_projectionMatrix * u_viewMatrix * worldPos;\n}\n"),n=this.compileShader(e.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\n\n// Constants\nconst float PI = 3.14159265359;\nconst float EPSILON = 0.0001;\n\n// PBR Textures\nuniform sampler2D u_basecolorMap;\nuniform sampler2D u_normalMap;\nuniform sampler2D u_roughnessMap;\nuniform sampler2D u_metallicMap;\n\n// Texture enable flags\nuniform bool u_useBasecolorMap;\nuniform bool u_useNormalMap;\nuniform bool u_useRoughnessMap;\nuniform bool u_useMetallicMap;\n\n// Material fallback values\nuniform vec3 u_baseColor;\nuniform float u_roughness;\nuniform float u_metallic;\n\n// Environment\nuniform vec3 u_lightDirection;\nuniform vec3 u_lightColor;\nuniform float u_lightIntensity;\nuniform vec3 u_ambientColor;\nuniform float u_ambientIntensity;\n\n// Camera\nuniform vec3 u_cameraPosition;\n\n// Texture tiling\nuniform vec2 u_textureTiling;\nuniform vec2 u_textureOffset;\n\n// Varyings\nin vec3 v_worldPosition;\nin vec3 v_worldNormal;\nin vec2 v_texcoord;\nin mat3 v_TBN;\n\n// Output\nout vec4 fragColor;\n\n// Normal Distribution Function (GGX/Trowbridge-Reitz)\nfloat distributionGGX(vec3 N, vec3 H, float roughness) {\n  float a = roughness * roughness;\n  float a2 = a * a;\n  float NdotH = max(dot(N, H), 0.0);\n  float NdotH2 = NdotH * NdotH;\n\n  float num = a2;\n  float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n  denom = PI * denom * denom;\n\n  return num / max(denom, EPSILON);\n}\n\n// Geometry Function (Schlick-GGX)\nfloat geometrySchlickGGX(float NdotV, float roughness) {\n  float r = roughness + 1.0;\n  float k = (r * r) / 8.0;\n\n  float num = NdotV;\n  float denom = NdotV * (1.0 - k) + k;\n\n  return num / max(denom, EPSILON);\n}\n\n// Geometry Function (Smith)\nfloat geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {\n  float NdotV = max(dot(N, V), 0.0);\n  float NdotL = max(dot(N, L), 0.0);\n  float ggx2 = geometrySchlickGGX(NdotV, roughness);\n  float ggx1 = geometrySchlickGGX(NdotL, roughness);\n\n  return ggx1 * ggx2;\n}\n\n// Fresnel (Schlick approximation)\nvec3 fresnelSchlick(float cosTheta, vec3 F0) {\n  return F0 + (1.0 - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);\n}\n\n// Fresnel with roughness for ambient\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n  return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);\n}\n\nvoid main() {\n  // Calculate tiled texture coordinates\n  vec2 uv = v_texcoord * u_textureTiling + u_textureOffset;\n\n  // Sample textures or use fallback values\n  vec3 albedo = u_useBasecolorMap ? texture(u_basecolorMap, uv).rgb : u_baseColor;\n  float roughness = u_useRoughnessMap ? texture(u_roughnessMap, uv).r : u_roughness;\n  float metallic = u_useMetallicMap ? texture(u_metallicMap, uv).r : u_metallic;\n\n  // Clamp roughness to avoid division issues\n  roughness = clamp(roughness, 0.04, 1.0);\n\n  // Get normal from map or geometry\n  vec3 N;\n  if (u_useNormalMap) {\n    vec3 tangentNormal = texture(u_normalMap, uv).rgb * 2.0 - 1.0;\n    N = normalize(v_TBN * tangentNormal);\n  } else {\n    N = normalize(v_worldNormal);\n  }\n\n  // View direction\n  vec3 V = normalize(u_cameraPosition - v_worldPosition);\n\n  // Light direction (directional light)\n  vec3 L = normalize(-u_lightDirection);\n\n  // Half vector\n  vec3 H = normalize(V + L);\n\n  // Calculate reflectance at normal incidence\n  // Dielectric: 0.04, Metal: albedo\n  vec3 F0 = vec3(0.04);\n  F0 = mix(F0, albedo, metallic);\n\n  // Cook-Torrance BRDF\n  float NDF = distributionGGX(N, H, roughness);\n  float G = geometrySmith(N, V, L, roughness);\n  vec3 F = fresnelSchlick(max(dot(H, V), 0.0), F0);\n\n  // Specular and diffuse components\n  vec3 kS = F;\n  vec3 kD = vec3(1.0) - kS;\n  kD *= 1.0 - metallic; // Metals have no diffuse\n\n  // Specular BRDF\n  vec3 numerator = NDF * G * F;\n  float denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, L), 0.0) + EPSILON;\n  vec3 specular = numerator / denominator;\n\n  // Direct lighting\n  float NdotL = max(dot(N, L), 0.0);\n  vec3 Lo = (kD * albedo / PI + specular) * u_lightColor * u_lightIntensity * NdotL;\n\n  // Ambient (simplified IBL approximation)\n  vec3 kSAmbient = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n  vec3 kDAmbient = 1.0 - kSAmbient;\n  kDAmbient *= 1.0 - metallic;\n\n  vec3 diffuseAmbient = kDAmbient * albedo * u_ambientColor * u_ambientIntensity;\n\n  // Simple ambient specular (reflection approximation)\n  vec3 R = reflect(-V, N);\n  float reflectionMix = 1.0 - roughness;\n  vec3 specularAmbient = kSAmbient * u_ambientColor * u_ambientIntensity * reflectionMix * 0.5;\n\n  vec3 ambient = diffuseAmbient + specularAmbient;\n\n  // Final color\n  vec3 color = ambient + Lo;\n\n  // HDR tonemapping (Reinhard)\n  color = color / (color + vec3(1.0));\n\n  // Gamma correction\n  color = pow(color, vec3(1.0 / 2.2));\n\n  fragColor = vec4(color, 1.0);\n}\n"),r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error(`Shader program link failed: ${e.getProgramInfoLog(r)}`);e.deleteShader(t),e.deleteShader(n),this.program=r,this.uniforms={modelMatrix:e.getUniformLocation(r,"u_modelMatrix"),viewMatrix:e.getUniformLocation(r,"u_viewMatrix"),projectionMatrix:e.getUniformLocation(r,"u_projectionMatrix"),normalMatrix:e.getUniformLocation(r,"u_normalMatrix"),cameraPosition:e.getUniformLocation(r,"u_cameraPosition"),basecolorMap:e.getUniformLocation(r,"u_basecolorMap"),normalMap:e.getUniformLocation(r,"u_normalMap"),roughnessMap:e.getUniformLocation(r,"u_roughnessMap"),metallicMap:e.getUniformLocation(r,"u_metallicMap"),useBasecolorMap:e.getUniformLocation(r,"u_useBasecolorMap"),useNormalMap:e.getUniformLocation(r,"u_useNormalMap"),useRoughnessMap:e.getUniformLocation(r,"u_useRoughnessMap"),useMetallicMap:e.getUniformLocation(r,"u_useMetallicMap"),baseColor:e.getUniformLocation(r,"u_baseColor"),roughness:e.getUniformLocation(r,"u_roughness"),metallic:e.getUniformLocation(r,"u_metallic"),lightDirection:e.getUniformLocation(r,"u_lightDirection"),lightColor:e.getUniformLocation(r,"u_lightColor"),lightIntensity:e.getUniformLocation(r,"u_lightIntensity"),ambientColor:e.getUniformLocation(r,"u_ambientColor"),ambientIntensity:e.getUniformLocation(r,"u_ambientIntensity"),textureTiling:e.getUniformLocation(r,"u_textureTiling"),textureOffset:e.getUniformLocation(r,"u_textureOffset")}}compileShader(e,t){const n=this.gl,r=n.createShader(e);if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){const e=n.getShaderInfoLog(r);throw n.deleteShader(r),new Error(`Shader compilation failed: ${e}`)}return r}initializeGeometry(){this.setGeometry(this.config.geometry)}createVAO(e){const t=this.gl,n=t.createVertexArray();t.bindVertexArray(n);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e.positions,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,3,t.FLOAT,!1,0,0);const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,e.normals,t.STATIC_DRAW),t.enableVertexAttribArray(1),t.vertexAttribPointer(1,3,t.FLOAT,!1,0,0);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,e.texcoords,t.STATIC_DRAW),t.enableVertexAttribArray(2),t.vertexAttribPointer(2,2,t.FLOAT,!1,0,0);const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e.tangents,t.STATIC_DRAW),t.enableVertexAttribArray(3),t.vertexAttribPointer(3,4,t.FLOAT,!1,0,0);const i=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW),t.bindVertexArray(null),n}setupInteraction(){this.canvas.addEventListener("mousedown",e=>{this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}),this.canvas.addEventListener("mousemove",e=>{if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,n=e.clientY-this.lastMouseY;this.cameraRotationY+=.01*t,this.cameraRotationX+=.01*n,this.cameraRotationX=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.cameraRotationX)),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}),this.canvas.addEventListener("mouseup",()=>{this.isDragging=!1}),this.canvas.addEventListener("mouseleave",()=>{this.isDragging=!1}),this.canvas.addEventListener("wheel",e=>{e.preventDefault(),this.cameraDistance+=.01*e.deltaY,this.cameraDistance=Math.max(1.5,Math.min(10,this.cameraDistance))})}setGeometry(e){switch(this.geometryType=e,e){case"sphere":this.geometry=function(e=1,t=32,n=16){const r=[],a=[],s=[],o=[],i=[];for(let l=0;l<=n;l++){const i=l/n,c=i*Math.PI,d=Math.sin(c),h=Math.cos(c);for(let n=0;n<=t;n++){const l=n/t,c=l*Math.PI*2,u=Math.sin(c),p=Math.cos(c),m=e*d*p,g=e*h,f=e*d*u;r.push(m,g,f),a.push(d*p,h,d*u),s.push(l,1-i);const b=-u,y=0,x=p;o.push(b,y,x,1)}}for(let l=0;l<n;l++)for(let e=0;e<t;e++){const n=l*(t+1)+e,r=n+1,a=n+t+1,s=a+1;i.push(n,r,a),i.push(r,s,a)}return{positions:new Float32Array(r),normals:new Float32Array(a),texcoords:new Float32Array(s),tangents:new Float32Array(o),indices:new Uint16Array(i),vertexCount:r.length/3,indexCount:i.length}}(1,64,32);break;case"cube":this.geometry=function(e=1){const t=e/2;return{positions:new Float32Array([-t,-t,t,t,-t,t,t,t,t,-t,t,t,t,-t,-t,-t,-t,-t,-t,t,-t,t,t,-t,-t,t,t,t,t,t,t,t,-t,-t,t,-t,-t,-t,-t,t,-t,-t,t,-t,t,-t,-t,t,t,-t,t,t,-t,-t,t,t,-t,t,t,t,-t,-t,-t,-t,-t,t,-t,t,t,-t,t,-t]),normals:new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]),texcoords:new Float32Array([0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]),tangents:new Float32Array([1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,-1,0,0,1,-1,0,0,1,-1,0,0,1,-1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,0,0,-1,1,0,0,-1,1,0,0,-1,1,0,0,-1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1]),indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),vertexCount:24,indexCount:36}}(1.5);break;case"plane":this.geometry=function(e=2,t=2,n=1,r=1){const a=[],s=[],o=[],i=[],l=[],c=e/2,d=t/2;for(let h=0;h<=r;h++){const l=h/r,u=l*t-d;for(let t=0;t<=n;t++){const r=t/n,d=r*e-c;a.push(d,0,u),s.push(0,1,0),o.push(r,l),i.push(1,0,0,1)}}for(let h=0;h<r;h++)for(let e=0;e<n;e++){const t=h*(n+1)+e,r=t+1,a=t+n+1,s=a+1;l.push(t,r,a),l.push(r,s,a)}return{positions:new Float32Array(a),normals:new Float32Array(s),texcoords:new Float32Array(o),tangents:new Float32Array(i),indices:new Uint16Array(l),vertexCount:a.length/3,indexCount:l.length}}(2,2,1,1)}this.vao&&this.gl.deleteVertexArray(this.vao),this.vao=this.createVAO(this.geometry)}setMaps(e){const t=this.gl;this.basecolorTexture&&t.deleteTexture(this.basecolorTexture),this.normalTexture&&t.deleteTexture(this.normalTexture),this.roughnessTexture&&t.deleteTexture(this.roughnessTexture),this.metallicTexture&&t.deleteTexture(this.metallicTexture),this.basecolorTexture=this.createTextureFromImageData(e.basecolor),this.normalTexture=this.createTextureFromImageData(e.normal),this.roughnessTexture=this.createTextureFromImageData(e.roughness),this.metallicTexture=this.createTextureFromImageData(e.metallic)}createTextureFromImageData(e){const t=this.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,e.width,e.height,0,t.RGBA,t.UNSIGNED_BYTE,e.data),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),n}setConfig(e){this.config={...this.config,...e},e.geometry&&e.geometry!==this.geometryType&&this.setGeometry(e.geometry)}startRenderLoop(){const e=t=>{const n=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.config.autoRotate&&!this.isDragging&&(this.rotation+=this.config.rotationSpeed*n),this.render(),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)}render(){const e=this.gl,t=this.canvas;if(t.width===t.clientWidth&&t.height===t.clientHeight||(t.width=t.clientWidth,t.height=t.clientHeight),e.viewport(0,0,t.width,t.height),e.clearColor(.1,.1,.15,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),!(this.program&&this.vao&&this.geometry&&this.uniforms))return;e.useProgram(this.program),e.bindVertexArray(this.vao);const n=t.width/t.height,r=this.perspectiveMatrix(Math.PI/4,n,.1,100),a=this.cameraDistance*Math.sin(this.cameraRotationY)*Math.cos(this.cameraRotationX),s=this.cameraDistance*Math.sin(this.cameraRotationX),o=this.cameraDistance*Math.cos(this.cameraRotationY)*Math.cos(this.cameraRotationX),i=this.lookAtMatrix([a,s,o],[0,0,0],[0,1,0]),l=this.rotationMatrix(this.rotation,[0,1,0]),c=this.normalMatrixFromModel(l);e.uniformMatrix4fv(this.uniforms.projectionMatrix,!1,r),e.uniformMatrix4fv(this.uniforms.viewMatrix,!1,i),e.uniformMatrix4fv(this.uniforms.modelMatrix,!1,l),e.uniformMatrix3fv(this.uniforms.normalMatrix,!1,c),e.uniform3f(this.uniforms.cameraPosition,a,s,o),e.uniform3fv(this.uniforms.lightDirection,this.config.lightDirection),e.uniform3fv(this.uniforms.lightColor,this.config.lightColor),e.uniform1f(this.uniforms.lightIntensity,this.config.lightIntensity),e.uniform3fv(this.uniforms.ambientColor,this.config.ambientColor),e.uniform1f(this.uniforms.ambientIntensity,this.config.ambientIntensity),e.uniform2fv(this.uniforms.textureTiling,this.config.tiling),e.uniform2fv(this.uniforms.textureOffset,this.config.offset),this.bindTexture(0,this.basecolorTexture,this.uniforms.basecolorMap,this.uniforms.useBasecolorMap),this.bindTexture(1,this.normalTexture,this.uniforms.normalMap,this.uniforms.useNormalMap),this.bindTexture(2,this.roughnessTexture,this.uniforms.roughnessMap,this.uniforms.useRoughnessMap),this.bindTexture(3,this.metallicTexture,this.uniforms.metallicMap,this.uniforms.useMetallicMap),e.uniform3f(this.uniforms.baseColor,.8,.8,.8),e.uniform1f(this.uniforms.roughness,.5),e.uniform1f(this.uniforms.metallic,0),e.drawElements(e.TRIANGLES,this.geometry.indexCount,e.UNSIGNED_SHORT,0),e.bindVertexArray(null)}bindTexture(e,t,n,r){const a=this.gl;a.activeTexture(a.TEXTURE0+e),t?(a.bindTexture(a.TEXTURE_2D,t),a.uniform1i(n,e),a.uniform1i(r,1)):(a.bindTexture(a.TEXTURE_2D,null),a.uniform1i(r,0))}perspectiveMatrix(e,t,n,r){const a=1/Math.tan(e/2),s=1/(n-r);return new Float32Array([a/t,0,0,0,0,a,0,0,0,0,(r+n)*s,-1,0,0,2*r*n*s,0])}lookAtMatrix(e,t,n){const r=this.normalize([e[0]-t[0],e[1]-t[1],e[2]-t[2]]),a=this.normalize(this.cross(n,r)),s=this.cross(r,a);return new Float32Array([a[0],s[0],r[0],0,a[1],s[1],r[1],0,a[2],s[2],r[2],0,-this.dot(a,e),-this.dot(s,e),-this.dot(r,e),1])}rotationMatrix(e,t){const[n,r,a]=this.normalize(t),s=Math.cos(e),o=Math.sin(e),i=1-s;return new Float32Array([i*n*n+s,i*n*r+o*a,i*n*a-o*r,0,i*n*r-o*a,i*r*r+s,i*r*a+o*n,0,i*n*a+o*r,i*r*a-o*n,i*a*a+s,0,0,0,0,1])}normalMatrixFromModel(e){return new Float32Array([e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]])}normalize(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>0?[e[0]/t,e[1]/t,e[2]/t]:[0,0,0]}cross(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]}dot(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}dispose(){this.animationId&&cancelAnimationFrame(this.animationId);const e=this.gl;this.program&&e.deleteProgram(this.program),this.vao&&e.deleteVertexArray(this.vao),this.basecolorTexture&&e.deleteTexture(this.basecolorTexture),this.normalTexture&&e.deleteTexture(this.normalTexture),this.roughnessTexture&&e.deleteTexture(this.roughnessTexture),this.metallicTexture&&e.deleteTexture(this.metallicTexture)}}class Xe{metrics=new Map;activeTimers=new Map;maxHistoryPerMetric=100;enabled=!0;setEnabled(e){this.enabled=e}start(e){this.enabled&&this.activeTimers.set(e,performance.now())}end(e,t){if(!this.enabled)return 0;const n=this.activeTimers.get(e);if(void 0===n)return console.warn(`No timer started for: ${e}`),0;const r=performance.now(),a=r-n;return this.activeTimers.delete(e),this.record(e,n,r,a,t),a}time(e,t,n){if(!this.enabled)return t();this.start(e);try{const r=t();return this.end(e,n),r}catch(r){throw this.end(e,{...n,error:!0}),r}}async timeAsync(e,t,n){if(!this.enabled)return t();this.start(e);try{const r=await t();return this.end(e,n),r}catch(r){throw this.end(e,{...n,error:!0}),r}}record(e,t,n,r,a){this.metrics.has(e)||this.metrics.set(e,[]);const s=this.metrics.get(e);for(s.push({name:e,startTime:t,endTime:n,duration:r,metadata:a});s.length>this.maxHistoryPerMetric;)s.shift()}getStats(e){const t=this.metrics.get(e);if(!t||0===t.length)return null;const n=t.map(e=>e.duration),r=n.reduce((e,t)=>e+t,0);return{count:n.length,totalMs:r,minMs:Math.min(...n),maxMs:Math.max(...n),avgMs:r/n.length,lastMs:n[n.length-1]}}getMetricNames(){return Array.from(this.metrics.keys())}getAllStats(){const e=new Map;for(const t of this.metrics.keys()){const n=this.getStats(t);n&&e.set(t,n)}return e}logSummary(){console.group("Performance Summary");for(const[e,t]of this.getAllStats())console.log(`${e}: avg=${t.avgMs.toFixed(1)}ms, min=${t.minMs.toFixed(1)}ms, max=${t.maxMs.toFixed(1)}ms, count=${t.count}`);console.groupEnd()}clear(){this.metrics.clear(),this.activeTimers.clear()}export(){const e={};for(const[t,n]of this.metrics)e[t]={history:n,stats:this.getStats(t)};return{exportedAt:Date.now(),metrics:e}}}let Ke=null;const Ve=document.getElementById("capabilities"),Ye=document.getElementById("dropZone"),Je=document.getElementById("fileInput"),Qe=document.getElementById("controls"),Ze=document.getElementById("previewGrid"),et=document.getElementById("status"),tt=document.getElementById("preview3DSection"),nt=document.getElementById("previewCanvas"),rt=document.getElementById("previewControlsContainer"),at=document.getElementById("inputCanvas"),st=document.getElementById("basecolorCanvas"),ot=document.getElementById("normalCanvas"),it=document.getElementById("roughnessCanvas"),lt=document.getElementById("metallicCanvas"),ct=document.getElementById("heightCanvas"),dt=document.getElementById("heightPreviewItem"),ht=document.getElementById("shadowReduction"),ut=document.getElementById("highlightReduction"),pt=document.getElementById("normalStrength"),mt=document.getElementById("roughnessScale"),gt=document.getElementById("roughnessOffset"),ft=document.getElementById("metallicThreshold"),bt=document.getElementById("shadowReductionValue"),yt=document.getElementById("highlightReductionValue"),xt=document.getElementById("normalStrengthValue"),vt=document.getElementById("roughnessScaleValue"),Et=document.getElementById("roughnessOffsetValue"),wt=document.getElementById("metallicThresholdValue"),_t=document.getElementById("exportInput"),Tt=document.getElementById("exportBasecolor"),At=document.getElementById("exportNormal"),Ct=document.getElementById("exportRoughness"),St=document.getElementById("exportMetallic"),kt=document.getElementById("exportHeight");let Rt=null,Mt=null,It=null,Lt=null,Pt=null,Ft="texture",Dt=null,Nt=null,Ot=!1,Ut=!1,Bt=z.quality;const $t={normalStrength:1,roughnessScale:1,roughnessOffset:0,metallicThreshold:.5,shadowReduction:.5,highlightReduction:.3};let zt={...W},Gt=null,Ht=null,qt=null,jt=null,Wt=null,Xt=null,Kt=null,Vt=null;function Yt(){const e=document.getElementById("uploadTo3dverseBtn"),t=document.getElementById("materialNameInput"),n=le().isAuthenticated(),r=null!==Vt,a=null!==Lt,s=t.value.trim().length>0;e.disabled=!(n&&r&&a&&s),Ft&&!t.value&&(t.placeholder=`Material name (e.g., ${Ft})`)}async function Jt(){if(!Lt||!Vt)return void sn("No maps or folder selected");const e=document.getElementById("materialNameInput"),n=document.getElementById("createSubfolderCheckbox"),r=e.value.trim()||Ft;document.getElementById("uploadTo3dverseBtn").disabled=!0;try{let e=Vt.uuid;if(n?.checked&&r){sn(`Creating subfolder "${r}"...`);const{getFolderBrowser:n}=await t(async()=>{const{getFolderBrowser:e}=await Promise.resolve().then(()=>ve);return{getFolderBrowser:e}},void 0),s=n();try{e=(await s.createFolder(r,Vt.uuid)).uuid,sn("Subfolder created, uploading...")}catch(a){console.warn("Could not create subfolder, using parent folder:",a)}}sn("Uploading to 3dverse...");const s={...Lt,normal:Ut&&Pt?Pt:Lt.normal},o=["basecolor","normal","roughness","metallic"];s.height&&o.push("height"),Kt?.start(o);const i=await xe(s,e,r,e=>{Kt?.updateProgress(e),sn(e.status)});Kt?.complete(i.textures,i.material),sn(`Material "${i.material.name}" created successfully!`)}catch(a){const e=a instanceof ae||a instanceof Error?a.message:"Upload failed";Kt?.error(e),sn(`Upload error: ${e}`)}finally{Yt()}}function Qt(){return Rt||(Rt=new d),Rt}function Zt(){if(!It)return;const e=performance.now();sn("Generating PBR maps (traditional)...");try{const t=Qt().generate(It,$t);Lt={...t,height:null},Q(It,at),Q(Lt.basecolor,st),Q(Lt.roughness,it),Q(Lt.metallic,lt),tn(),nn(),Yt();sn(`Generated in ${(performance.now()-e).toFixed(1)}ms (${It.width}x${It.height})`)}catch(t){console.error("Generation failed:",t),sn(`Error: ${t instanceof Error?t.message:"Unknown error"}`)}}async function en(){if(!It||!Mt)return;const e=performance.now();sn("Generating PBR maps...");const t="ai"===zt.normalMethod;t&&Gt?.show();try{Lt=await Mt.generate(It,$t,(e,n,r)=>{t&&Gt?.update(r,n),sn(r)}),Q(It,at),Q(Lt.basecolor,st),Q(Lt.normal,ot),Q(Lt.roughness,it),Q(Lt.metallic,lt),Lt.height?(Q(Lt.height,ct),dt.classList.remove("hidden")):dt.classList.add("hidden"),nn(),Yt(),t&&Gt?.complete();sn(`Generated in ${(performance.now()-e).toFixed(1)}ms (${It.width}x${It.height})`)}catch(n){console.error("Generation failed:",n),t&&Gt?.error(n instanceof Error?n.message:"Unknown error"),sn(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}}function tn(){Lt&&(Q(Ut&&Pt?Pt:Lt.normal,ot),nn())}function nn(){if(!jt||!Lt)return;const e={...Lt,normal:Ut&&Pt?Pt:Lt.normal};jt.setMaps(e)}async function rn(){if(It){Gt?.show();try{sn("Initializing AI model...");const t=q();await t.initialize(),sn("Running AI inference..."),Pt=await t.generateNormalMap(It,Bt,(e=Gt,(t,n)=>{e.update(t,n)})),Gt?.complete(),Ut=!0,tn(),sn("AI normal map generated successfully")}catch(t){console.error("AI generation failed:",t),Gt?.error(t instanceof Error?t.message:"Unknown error"),sn(`AI Error: ${t instanceof Error?t.message:"Unknown error"}`),Ut=!1,tn()}var e}else sn("Load an image first")}async function an(e){sn("Loading image...");try{It=await V(e),Ft=e.name.replace(/\.[^.]+$/,""),Pt=null,Ut=!1,Qe.classList.remove("hidden"),Ze.classList.remove("hidden"),tt.classList.remove("hidden");const t=document.getElementById("channelControls");t?.classList.remove("hidden");const n=document.getElementById("materialNameInput");n&&(n.placeholder=`Material name (e.g., ${Ft})`),Zt()}catch(t){console.error("Failed to load image:",t),sn(`Error: ${t instanceof Error?t.message:"Failed to load image"}`)}}function sn(e){et.textContent=e}function on(e,t){t.textContent=e.value}Ye.addEventListener("click",()=>Je.click()),Je.addEventListener("change",()=>{const e=Je.files?.[0];e&&an(e)}),Ye.addEventListener("dragover",e=>{e.preventDefault(),Ye.classList.add("dragover")}),Ye.addEventListener("dragleave",()=>{Ye.classList.remove("dragover")}),Ye.addEventListener("drop",e=>{e.preventDefault(),Ye.classList.remove("dragover");const t=e.dataTransfer?.files[0];t&&an(t)}),document.addEventListener("paste",async e=>{const t=await async function(e){const t=e.clipboardData?.items;if(!t)return null;for(const n of t)if(n.type.match(/^image\//)){const e=n.getAsFile();if(e)return V(e)}return null}(e);t&&(It=t,Ft="pasted",Pt=null,Ut=!1,Qe.classList.remove("hidden"),Ze.classList.remove("hidden"),tt.classList.remove("hidden"),document.getElementById("channelControls")?.classList.remove("hidden"),Zt())}),ht.addEventListener("input",()=>{$t.shadowReduction=parseFloat(ht.value),on(ht,bt),Zt()}),ut.addEventListener("input",()=>{$t.highlightReduction=parseFloat(ut.value),on(ut,yt),Zt()}),pt.addEventListener("input",()=>{$t.normalStrength=parseFloat(pt.value),on(pt,xt),Zt()}),mt.addEventListener("input",()=>{$t.roughnessScale=parseFloat(mt.value),on(mt,vt),Zt()}),gt.addEventListener("input",()=>{$t.roughnessOffset=parseFloat(gt.value),on(gt,Et),Zt()}),ft.addEventListener("input",()=>{$t.metallicThreshold=parseFloat(ft.value),on(ft,wt),Zt()}),_t.addEventListener("click",async()=>{It&&await J(It,`${Ft}_input.png`)}),Tt.addEventListener("click",async()=>{Lt&&await J(Lt.basecolor,`${Ft}_basecolor.png`)}),At.addEventListener("click",async()=>{const e=Ut&&Pt?Pt:Lt?.normal;if(e){const t=Ut&&Pt?"_normal_ai":"_normal";await J(e,`${Ft}${t}.png`)}}),Ct.addEventListener("click",async()=>{Lt&&await J(Lt.roughness,`${Ft}_roughness.png`)}),St.addEventListener("click",async()=>{Lt&&await J(Lt.metallic,`${Ft}_metallic.png`)}),kt.addEventListener("click",async()=>{Lt?.height&&await J(Lt.height,`${Ft}_height.png`)}),on(ht,bt),on(ut,yt),on(pt,xt),on(mt,vt),on(gt,Et),on(ft,wt),He||(He=new Ge(document.body));const ln=$e(),cn=(Ke||(Ke=new Xe),Ke),dn=Pe(),hn=(Re||(Re=new Se,Re.loadFromStorage()),Re),un=(Me||(Me=new ke),Me);let pn=null;function mn(){It?"ai"===zt.normalMethod?en():Zt():sn("No input image")}function gn(e){const t=Object.keys(z),n=t.findIndex(e=>z[e]===Bt),r=Math.max(0,Math.min(t.length-1,n+e));Bt=z[t[r]],sn(`Quality: ${Bt.name}`)}!async function(){Ve.textContent="Detecting capabilities...";try{Dt=await u(),Nt=x(Dt),Ot=await j();const e=await async function(){try{const e=x(await u());if(!e)return null;const t=F(),n=E((await t.getAvailableModels()).filter(e=>e.id.startsWith($)),e);if(!n)return null;let r;switch(e){case"webgpu-fp16":r="2-5 seconds";break;case"webgpu-fp32":r="5-10 seconds";break;case"webnn":r="5-15 seconds";break;case"wasm":r="20-60 seconds";break;default:r="Unknown"}return{backend:e,model:n.id,expectedTime:r}}catch{return null}}();!function(e,t,n){const r=[];r.push(`<span class="feature ${e.webgpu?"active":"inactive"}">WebGPU${e.webgpuFP16?" FP16":""}</span>`),r.push(`<span class="feature ${e.webnn?"active":"inactive"}">WebNN</span>`);const a=[];e.wasmSimd&&a.push("SIMD");e.wasmThreads&&a.push("Threads");r.push(`<span class="feature ${e.wasm?"active":"inactive"}">WASM${a.length?` (${a.join(", ")})`:""}</span>`),r.push(`<span class="feature ${e.webgl2?"active":"inactive"}">WebGL2</span>`);const s=Ot?'<span class="feature active">AI Ready</span>':'<span class="feature inactive">AI Unavailable</span>',o=t?function(e){switch(e){case"webgpu-fp16":return"WebGPU (FP16)";case"webgpu-fp32":return"WebGPU (FP32)";case"webnn":return"WebNN";case"wasm":return"WASM";default:return"Unknown"}}(t):"None",i=n?` (~${n.expectedTime})`:"";Ve.innerHTML=`AI Backend: <span class="backend">${o}</span>${i} | ${r.join(" ")} | ${s} | ~${e.estimatedMemoryMB}MB available`}(Dt,Nt,e),Mt=new X(zt),await Mt.initialize(),function(){const e=document.createElement("div");e.id="aiProgressContainer",e.style.marginBottom="20px",Ze.parentNode?.insertBefore(e,Ze),Gt=new ee(e)}(),function(){const e=function(){const e=document.createElement("div");return e.id="channelControls",e.className="hidden",e}();Qe.parentNode?.insertBefore(e,Qe),Ht=new te(e,zt,Ot),Ht.onChange(e=>{zt={...zt,...e.config},Mt&&Mt.setConfig(zt),void 0!==e.config.heightMethod&&("none"!==e.config.heightMethod?dt.classList.remove("hidden"):dt.classList.add("hidden")),"ai"===e.config.normalMethod&&It?rn():"traditional"===e.config.normalMethod&&It?(Ut=!1,tn()):It&&en()})}(),function(){qt=new ne(rt,je),qt.onChange(e=>{jt&&jt.setConfig(e.config)});try{jt=new We(nt)}catch(e){console.warn("Failed to initialize 3D preview:",e),tt.innerHTML='<p style="padding: 20px; color: #888;">3D preview not available</p>'}}(),function(){let e=document.getElementById("threedverseSection");e||(e=document.createElement("div"),e.id="threedverseSection",e.className="threedverse-section",Ze.parentNode?.insertBefore(e,Ze.nextSibling));e.innerHTML='\n    <h2 class="section-title">3dverse Integration</h2>\n    <div id="loginPanelContainer"></div>\n    <div id="uploadSection" class="hidden">\n      <div id="folderPickerContainer"></div>\n      <div class="upload-actions">\n        <input type="text" id="materialNameInput" placeholder="Material name" class="material-name-input" />\n        <label class="subfolder-checkbox">\n          <input type="checkbox" id="createSubfolderCheckbox" checked />\n          Create subfolder\n        </label>\n        <button id="uploadTo3dverseBtn" class="upload-btn" disabled>Upload to 3dverse</button>\n      </div>\n      <div id="uploadStatusContainer"></div>\n    </div>\n  ',function(){if(!document.getElementById("threedverse-section-styles")){const e=document.createElement("style");e.id="threedverse-section-styles",e.textContent="\n      .threedverse-section {\n        margin-top: 30px;\n        padding-top: 20px;\n        border-top: 1px solid #3a3a5a;\n      }\n      .threedverse-section .section-title {\n        font-size: 16px;\n        margin-bottom: 15px;\n        color: #fff;\n      }\n      .upload-actions {\n        display: flex;\n        gap: 10px;\n        margin-bottom: 15px;\n      }\n      .material-name-input {\n        flex: 1;\n        padding: 8px 12px;\n        border: 1px solid #4a4a6a;\n        border-radius: 4px;\n        background: #1a1a2e;\n        color: #fff;\n        font-size: 14px;\n      }\n      .material-name-input:focus {\n        outline: none;\n        border-color: #7878ff;\n      }\n      .upload-btn {\n        padding: 8px 20px;\n        background: #5a8a5a;\n        border: none;\n        border-radius: 4px;\n        color: white;\n        font-size: 14px;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .upload-btn:hover:not(:disabled) {\n        background: #6a9a6a;\n      }\n      .upload-btn:disabled {\n        background: #3a5a3a;\n        cursor: not-allowed;\n        opacity: 0.6;\n      }\n      .subfolder-checkbox {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        font-size: 12px;\n        color: #aaa;\n        cursor: pointer;\n        white-space: nowrap;\n      }\n      .subfolder-checkbox input {\n        cursor: pointer;\n      }\n    ",document.head.appendChild(e)}}();const t=document.getElementById("loginPanelContainer");Wt=new Ee(t),Wt.onLogin(e=>{e.success?(document.getElementById("uploadSection")?.classList.remove("hidden"),Xt?.refresh(),Yt()):document.getElementById("uploadSection")?.classList.add("hidden")});const n=document.getElementById("folderPickerContainer");Xt=new we(n),Xt.onSelect(e=>{Vt=e.folder,Yt()});const r=document.getElementById("uploadStatusContainer");Kt=new _e(r);const a=document.getElementById("uploadTo3dverseBtn");document.getElementById("materialNameInput").addEventListener("input",Yt),a.addEventListener("click",Jt);le().isAuthenticated()&&document.getElementById("uploadSection")?.classList.remove("hidden")}()}catch(e){console.error("Capability detection failed:",e),Ve.textContent="Capability detection failed"}}(),hn.onAll({"open-file":()=>Je.click(),"export-all":()=>async function(){if(Lt){cn.start("export-all"),sn("Exporting all maps...");try{await J(Lt.basecolor,`${Ft}_basecolor.png`);const e=Ut&&Pt?Pt:Lt.normal;await J(e,`${Ft}_normal.png`),await J(Lt.roughness,`${Ft}_roughness.png`),await J(Lt.metallic,`${Ft}_metallic.png`),Lt.height&&await J(Lt.height,`${Ft}_height.png`),sn("All maps exported")}catch(e){ln.handle(e),sn("Export failed")}cn.end("export-all")}else sn("No maps to export")}(),"export-basecolor":()=>Tt.click(),"export-normal":()=>At.click(),"export-roughness":()=>Ct.click(),"export-metallic":()=>St.click(),"export-height":()=>kt.click(),"toggle-ai":()=>{Ot?("ai"===zt.normalMethod?(zt.normalMethod="traditional",Ut=!1,tn(),sn("Switched to traditional normal generation")):(zt.normalMethod="ai",It&&rn(),sn("Switched to AI normal generation")),Ht&&Ht.setConfig(zt)):sn("AI not available")},"toggle-preview":()=>{tt.classList.contains("hidden")?(tt.classList.remove("hidden"),sn("3D preview shown")):(tt.classList.add("hidden"),sn("3D preview hidden"))},regenerate:()=>mn(),"upload-3dverse":()=>Jt(),"toggle-help":()=>un.toggle(hn.getShortcuts()),"increase-quality":()=>gn(1),"decrease-quality":()=>gn(-1)}),hn.start(),function(){const e=document.createElement("div");e.id="downloadProgressContainer",Ve.parentNode?.insertBefore(e,Ve.nextSibling),new De(e,{showCacheSize:!0,showModelList:!0})}(),function(){const e=document.createElement("div");e.id="batchProcessorContainer",Ye.parentNode?.insertBefore(e,Ye.nextSibling),pn=new qe(e,{onProcess:async e=>{const t=await V(e);return{input:t,maps:{...Qt().generate(t,$t),height:null}}},onExport:async(e,t)=>{const n=e.file.name.replace(/\.[^.]+$/,"");if(e.maps)for(const r of t){const t=e.maps[r];t&&await J(t,`${n}_${r}.png`)}},onComplete:e=>{sn(`Batch complete: ${e.completed}/${e.totalItems} successful`)}}),function(){const e=document.createElement("button");e.className="batch-toggle-btn",e.textContent="Batch Mode",e.style.cssText="\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    padding: 6px 12px;\n    background: #3a3a5a;\n    border: none;\n    border-radius: 4px;\n    color: #ccc;\n    font-size: 12px;\n    cursor: pointer;\n  ",e.addEventListener("click",()=>{pn?.toggle()}),Ye.style.position="relative",Ye.appendChild(e)}()}(),async function(){const e=await dn.getStatus();e.isOnline||(console.log("[PBR Generator] Running in offline mode"),e.modelsReady||console.warn("[PBR Generator] AI models not cached for offline use")),dn.onStatusChange(e=>{e.isOnline||e.modelsReady||sn("Offline - AI features unavailable (models not cached)")})}(),window.addEventListener("pbr-error-retry",()=>{It&&mn()}),window.addEventListener("pbr-reauthenticate",()=>{le().logout(),Wt?.refresh()}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled rejection:",e.reason),ln.handle(e.reason),e.preventDefault()}),window.addEventListener("error",e=>{console.error("Global error:",e.error),ln.handle(e.error)}),console.log("[PBR Generator] Phase 6 features initialized");
